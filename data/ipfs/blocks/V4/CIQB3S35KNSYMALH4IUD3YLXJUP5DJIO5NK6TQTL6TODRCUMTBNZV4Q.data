sh,n=B_(e,t);return W_.createV1(this.code,n)}case 1:return this;default:throw Error("Can not convert CID version ".concat(this.version," to version 1. This is a bug please report"))}}equals(e){return W_.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&((e,t)=>{if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&((e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0})(e.bytes,n.bytes)}})(e.multihash,n.multihash)}toString(e){return H_(this,e)}toJSON(){return{"/":H_(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID(".concat(this.toString(),")")}static asCID(e){if(null==e)return null;const t=e;if(t instanceof W_)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:i}=t;return new W_(e,n,r,i||eI(e,n,r.bytes))}if(!0===t[tI]){const{version:e,multihash:n,code:r}=t,i=L_(n);return W_.create(e,r,i)}return null}static create(e,t,n){if("number"!==typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==X_)throw new Error("Version 0 CID must use dag-pb (code: ".concat(X_,") block encoding"));return new W_(e,t,n,n.bytes);case 1:{const r=eI(e,t,n.bytes);return new W_(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return W_.create(0,X_,e)}static createV1(e,t){return W_.create(1,e,t)}static decode(e){const[t,n]=W_.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=W_.inspectBytes(e),n=t.size-t.multihashSize,r=SS(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=r.subarray(t.multihashSize-t.digestSize),o=new M_(t.multihashCode,t.digestSize,i,r);return[0===t.version?W_.createV0(o):W_.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=D_(e.subarray(t));return t+=r,n};let r=n(),i=X_;if(18===r?(r=0,t=0):i=n(),0!==r&&1!==r)throw new RangeError("Invalid CID version ".concat(r));const o=t,s=n(),a=n(),c=t+a;return{version:r,codec:i,multihashCode:s,digestSize:a,multihashSize:c-o,size:c}}static parse(e,t){const[n,r]=Q_(e,t),i=W_.decode(r);if(0===i.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return G_(i).set(n,e),i}}const Q_=(e,t)=>{switch(e[0]){case"Q":{const n=t||DS;return[DS.prefix,n.decode("".concat(DS.prefix).concat(e))]}case DS.prefix:{const n=t||DS;return[DS.prefix,n.decode(e)]}case ZS.prefix:{const n=t||ZS;return[ZS.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}},Y_=(e,t,n)=>{const{prefix:r}=n;if(r!==DS.prefix)throw Error("Cannot string encode V0 in ".concat(n.name," encoding"));const i=t.get(r);if(null==i){const i=n.encode(e).slice(1);return t.set(r,i),i}return i},J_=(e,t,n)=>{const{prefix:r}=n,i=t.get(r);if(null==i){const i=n.encode(e);return t.set(r,i),i}return i},X_=112,$_=18,eI=(e,t,n)=>{const r=N_(e),i=r+N_(t),o=new Uint8Array(i+n.byteLength);return O_(e,o,0),O_(t,o,r),o.set(n,i),o},tI=Symbol.for("@ipld/js-cid/CID"),nI={...ue,...ie,...le,...ne,...re,...se,...ae,...te,...ce,...oe},rI=Symbol.for("nodejs.util.inspect.custom"),iI=Object.values(nI).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),nI.identity.decoder),oI=114,sI=36,aI=37;class cI{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,fu.Cs,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=DS.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return W_.createV1(oI,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return dI(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[rI](){return"PeerId(".concat(this.toString(),")")}}class lI extends cI{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class uI extends cI{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class hI extends cI{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}function dI(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:iI,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=L_(DS.decode("z".concat(e)));return e.startsWith("12D")?new uI({multihash:t}):e.startsWith("16U")?new hI({multihash:t}):new lI({multihash:t})}return fI(iI.decode(e))}function fI(e){try{const t=L_(e);if(t.code===F_.code){if(t.digest.length===sI)return new uI({multihash:t});if(t.digest.length===aI)return new hI({multihash:t})}if(t.code===z_.code)return new lI({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==oI)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===z_.code)return new lI({multihash:e.multihash});if(t.code===F_.code){if(t.digest.length===sI)return new uI({multihash:e.multihash});if(t.digest.length===aI)return new hI({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(W_.decode(e))}throw new Error("Supplied PeerID CID is invalid")}var pI=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const gI=pI,yI=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class mI{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class vI{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return wI(this,e)}}class bI{constructor(e){this.decoders=e}or(e){return wI(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const wI=(e,t)=>new bI({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class EI{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new mI(e,t,n),this.decoder=new vI(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const AI=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new EI(t,n,r,i)},SI=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=gI(r,n);return AI({prefix:t,name:n,encode:i,decode:e=>yI(o(e))})},_I=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return AI({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},II=SI({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),CI=SI({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var TI=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=xI;)n[r++]=255&t|kI,t/=128;for(;t&RI;)n[r++]=255&t|kI,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},kI=128,RI=-128,xI=Math.pow(2,31);var PI=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&OI)<<o:(r&OI)*Math.pow(2,o),o+=7}while(r>=DI);return e.bytes=s-n,i},DI=128,OI=127;var NI=Math.pow(2,7),BI=Math.pow(2,14),LI=Math.pow(2,21),MI=Math.pow(2,28),UI=Math.pow(2,35),FI=Math.pow(2,42),KI=Math.pow(2,49),jI=Math.pow(2,56),ZI=Math.pow(2,63);const zI={encode:TI,decode:PI,encodingLength:function(e){return e<NI?1:e<BI?2:e<LI?3:e<MI?4:e<UI?5:e<FI?6:e<KI?7:e<jI?8:e<ZI?9:10}},VI=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return[zI.decode(e,t),zI.decode.bytes]},HI=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return zI.encode(e,t,n),t},qI=e=>zI.encodingLength(e),GI=(e,t)=>{const n=t.byteLength,r=qI(e),i=r+qI(n),o=new Uint8Array(i+n);return HI(e,o,0),HI(n,o,r),o.set(t,i),new QI(e,n,t,o)},WI=e=>{const t=yI(e),[n,r]=VI(t),[i,o]=VI(t.subarray(r)),s=t.subarray(r+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new QI(n,i,s,t)};class QI{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const YI=yI,JI={code:0,name:"identity",encode:YI,digest:e=>GI(0,YI(e))},XI=e=>{let{name:t,code:n,encode:r}=e;return new $I(t,n,r)};class $I{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?GI(this.code,t):t.then((e=>GI(this.code,e)))}throw Error("Unknown type, must be binary type")}}const eC=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),tC=XI({name:"sha2-256",code:18,encode:eC("SHA-256")}),nC=XI({name:"sha2-512",code:19,encode:eC("SHA-512")});function rC(e,t){let n=Uint8Array.from(e.abs().toByteArray());if(n=0===n[0]?n.subarray(1):n,null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return(0,Au.B)(n,"base64url")}function iC(e){const t=function(e,t){let n=(0,yu.m)(e,"base64urlpad");if(null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return n}(e);return new(gu().jsbn.BigInteger)((0,Au.B)(t,"base16"),16)}function oC(e){return null!=e&&("function"===typeof e.then&&"function"===typeof e.catch&&"function"===typeof e.finally)}const sC=32,aC=64,cC=32;function lC(e,t){const n=new Uint8Array(aC);for(let r=0;r<cC;r++)n[r]=e[r],n[cC+r]=t[r];return n}const uC=_I({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),hC=_I({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),dC=_I({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),fC=_I({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),pC={get(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:globalThis).crypto;if(null==e||null==e.subtle)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}},gC={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};async function yC(e,t){const n=function(e){var t,n,r,i,o,s;const a=null!==(t=null===e||void 0===e?void 0:e.algorithm)&&void 0!==t?t:"AES-GCM";let c=null!==(n=null===e||void 0===e?void 0:e.keyLength)&&void 0!==n?n:16;const l=null!==(r=null===e||void 0===e?void 0:e.nonceLength)&&void 0!==r?r:12,u=null!==(i=null===e||void 0===e?void 0:e.digest)&&void 0!==i?i:"SHA-256",h=null!==(o=null===e||void 0===e?void 0:e.saltLength)&&void 0!==o?o:16,d=null!==(s=null===e||void 0===e?void 0:e.iterations)&&void 0!==s?s:32767,f=pC.get();return c*=8,{encrypt:async function(e,t){const n=f.getRandomValues(new Uint8Array(h)),r=f.getRandomValues(new Uint8Array(l)),i={name:a,iv:r};let o;if("string"===typeof t&&(t=(0,yu.m)(t)),0===t.length){o=await f.subtle.importKey("jwk",gC,{name:"AES-GCM"},!0,["encrypt"]);try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}catch{o=await f.subtle.importKey("jwk",gC,{name:"AES-GCM"},!0,["encrypt"])}}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}const s=await f.subtle.encrypt(i,o,e);return(0,Ls.z)([n,i.iv,new Uint8Array(s)])},decrypt:async function(e,t){const n=e.subarray(0,h),r=e.subarray(h,h+l),i=e.subarray(h+l),o={name:a,iv:r};let s;if("string"===typeof t&&(t=(0,yu.m)(t)),0===t.length)try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}catch{s=await f.subtle.importKey("jwk",gC,{name:"AES-GCM"},!0,["decrypt"])}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}const p=await f.subtle.decrypt(o,s,i);return new Uint8Array(p)}}}(),r=await n.encrypt(e,t);return uC.encode(r)}var mC,vC,bC,wC;!function(e){e.RSA="RSA",e.Ed25519="Ed25519",e.Secp256k1="Secp256k1"}(mC||(mC={})),function(e){e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.Secp256k1=2]="Secp256k1"}(vC||(vC={})),function(e){e.codec=()=>bs(vC)}(mC||(mC={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),mC.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=mC.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(bC||(bC={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),mC.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=mC.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(wC||(wC={}));class EC{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=TC(e,sC)}verify(e,t){return function(e,t,n){return ql.verify(t,n instanceof Uint8Array?n:n.subarray(),e)}(this._key,t,e)}marshal(){return this._key}get bytes(){return bC.encode({Type:mC.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=tC.digest(this.bytes);return oC(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}}class AC{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=TC(e,aC),this._publicKey=TC(t,sC)}sign(e){return function(e,t){const n=e.subarray(0,cC);return ql.sign(t instanceof Uint8Array?t:t.subarray(),n)}(this._key,e)}get public(){return new EC(this._publicKey)}marshal(){return this._key}get bytes(){return wC.encode({Type:mC.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const e=tC.digest(this.bytes);let t;return oC(e)?({bytes:t}=await e):t=e.bytes,t}async id(){const e=JI.digest(this.public.bytes);return II.encode(e.bytes).substring(1)}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return yC(this.bytes,e);throw new fu.sv("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function SC(e){if(e.length>aC){const t=(e=TC(e,aC+sC)).subarray(0,aC),n=e.subarray(aC,e.length);return new AC(t,n)}const t=(e=TC(e,aC)).subarray(0,aC),n=e.subarray(sC);return new AC(t,n)}function _C(e){return e=TC(e,sC),new EC(e)}async function IC(){const{privateKey:e,publicKey:t}=function(){const e=ql.utils.randomPrivateKey(),t=ql.getPublicKey(e);return{privateKey:lC(e,t),publicKey:t}}();return new AC(e,t)}async function CC(e){const{privateKey:t,publicKey:n}=function(e){if(e.length!==cC)throw new TypeError('"seed" must be 32 bytes in length.');if(!(e instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const t=e,n=ql.getPublicKey(t);return{privateKey:lC(t,n),publicKey:n}}(e);return new AC(t,n)}function TC(e,t){var n;if((e=Uint8Array.from(null!==(n=e)&&void 0!==n?n:[])).length!==t)throw new fu.sv("Key must be a Uint8Array of length ".concat(t,", got ").concat(e.length),"ERR_INVALID_KEY_TYPE");return e}const kC={"P-256":256,"P-384":384,"P-521":521};Object.keys(kC).join(" / ");function RC(e,t){return t.map((t=>iC(e[t])))}async function xC(e){const t=[await pC.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await DC(e)],n=await PC({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function PC(e){if(null==e.privateKey||null==e.publicKey)throw new fu.sv("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([pC.get().subtle.exportKey("jwk",e.privateKey),pC.get().subtle.exportKey("jwk",e.publicKey)])}async function DC(e){return pC.get().subtle.importKey("jwk",{kty:e.kty,n:e.n,e:e.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function OC(e,t,n,r){const i=t?function(e){return gu().pki.setRsaPublicKey(...RC(e,["n","e"]))}(e):function(e){return gu().pki.setRsaPrivateKey(...RC(e,["n","e","d","p","q","dp","dq","qi"]))}(e),o=r((0,Au.B)(n instanceof Uint8Array?n:n.subarray(),"ascii"),i);return(0,yu.m)(o,"ascii")}function NC(e){if("RSA"!==e.kty)throw new fu.sv("invalid key type","ERR_INVALID_KEY_TYPE");if(null==e.n)throw new fu.sv("invalid key modulus","ERR_INVALID_KEY_MODULUS");return 8*(0,yu.m)(e.n,"base64url").length}const BC=8192;class LC{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=e}verify(e,t){return async function(e,t,n){const r=await pC.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return pC.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,t,n instanceof Uint8Array?n:n.subarray())}(this._key,t,e)}marshal(){return function(e){if(null==e.n||null==e.e)throw new fu.sv("JWK was missing components","ERR_INVALID_PARAMETERS");const t=gu().pki.publicKeyToAsn1({n:iC(e.n),e:iC(e.e)});return(0,yu.m)(gu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return bC.encode({Type:mC.RSA,Data:this.marshal()}).subarray()}encrypt(e){return OC(this._key,!0,e,((e,t)=>t.encrypt(e)))}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=tC.digest(this.bytes);return oC(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}}class MC{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=t}genSecret(){return function(e){if(isNaN(e)||e<=0)throw new fu.sv("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return _c(e)}(16)}sign(e){return async function(e,t){const n=await pC.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await pC.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,t instanceof Uint8Array?t:t.subarray());return new Uint8Array(r,0,r.byteLength)}(this._key,e)}get public(){if(null==this._publicKey)throw new fu.sv("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new LC(this._publicKey)}decrypt(e){return OC(this._key,!1,e,((e,t)=>t.decrypt(e)))}marshal(){return function(e){if(null==e.n||null==e.e||null==e.d||null==e.p||null==e.q||null==e.dp||null==e.dq||null==e.qi)throw new fu.sv("JWK was missing components","ERR_INVALID_PARAMETERS");const t=gu().pki.privateKeyToAsn1({n:iC(e.n),e:iC(e.e),d:iC(e.d),p:iC(e.p),q:iC(e.q),dP:iC(e.dp),dQ:iC(e.dq),qInv:iC(e.qi)});return(0,yu.m)(gu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return wC.encode({Type:mC.RSA,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=tC.digest(this.bytes);return oC(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}async id(){const e=await this.public.hash();return(0,Au.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"pkcs-8";if("pkcs-8"===t){const t=new(gu().util.ByteBuffer)(this.marshal()),n=gu().asn1.fromDer(t),r=gu().pki.privateKeyFromAsn1(n),i={algorithm:"aes256",count:1e4,saltSize:16,prfAlgorithm:"sha512"};return gu().pki.encryptRsaPrivateKey(r,e,i)}if("libp2p-key"===t)return yC(this.bytes,e);throw new fu.sv("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}async function UC(e){const t=function(e){const t=gu().asn1.fromDer((0,Au.B)(e,"ascii")),n=gu().pki.privateKeyFromAsn1(t);return{kty:"RSA",n:rC(n.n),e:rC(n.e),d:rC(n.d),p:rC(n.p),q:rC(n.q),dp:rC(n.dP),dq:rC(n.dQ),qi:rC(n.qInv),alg:"RS256"}}(e);if(NC(t)>BC)throw new fu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const n=await xC(t);return new MC(n.privateKey,n.publicKey)}function FC(e){const t=function(e){const t=gu().asn1.fromDer((0,Au.B)(e,"ascii")),n=gu().pki.publicKeyFromAsn1(t);return{kty:"RSA",n:rC(n.n),e:rC(n.e)}}(e);if(NC(t)>BC)throw new fu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new LC(t)}async function KC(e){if(NC(e)>BC)throw new fu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await xC(e);return new MC(t.privateKey,t.publicKey)}async function jC(e){if(e>BC)throw new fu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await async function(e){const t=await pC.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:e,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await PC(t);return{privateKey:n[0],publicKey:n[1]}}(e);return new MC(t.privateKey,t.publicKey)}function ZC(e){try{Eh.ProjectivePoint.fromHex(e)}catch(t){throw new fu.sv(String(t),"ERR_INVALID_PUBLIC_KEY")}}class zC{constructor(e){(0,Yo.Z)(this,"_key",void 0),ZC(e),this._key=e}verify(e,t){return function(e,t,n){const r=tC.digest(n instanceof Uint8Array?n:n.subarray());if(oC(r))return r.then((n=>{let{digest:r}=n;return Eh.verify(t,r,e)})).catch((e=>{throw new fu.sv(String(e),"ERR_INVALID_INPUT")}));try{return Eh.verify(t,r.digest,e)}catch(i){throw new fu.sv(String(i),"ERR_INVALID_INPUT")}}(this._key,t,e)}marshal(){return e=this._key,Eh.ProjectivePoint.fromHex(e).toRawBytes(!0);var e}get bytes(){return bC.encode({Type:mC.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const e=tC.digest(this.bytes);let t;return oC(e)?({bytes:t}=await e):t=e.bytes,t}}class VC{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=null!==t&&void 0!==t?t:function(e){try{return Eh.getPublicKey(e,!0)}catch(t){throw new fu.sv(String(t),"ERR_INVALID_PRIVATE_KEY")}}(e),function(e){try{Eh.getPublicKey(e,!0)}catch(t){throw new fu.sv(String(t),"ERR_INVALID_PRIVATE_KEY")}}(this._key),ZC(this._publicKey)}sign(e){return function(e,t){const n=tC.digest(t instanceof Uint8Array?t:t.subarray());if(oC(n))return n.then((t=>{let{digest:n}=t;return Eh.sign(n,e).toDERRawBytes()})).catch((e=>{throw new fu.sv(String(e),"ERR_INVALID_INPUT")}));try{return Eh.sign(n.digest,e).toDERRawBytes()}catch(r){throw new fu.sv(String(r),"ERR_INVALID_INPUT")}}(this._key,e)}get public(){return new zC(this._publicKey)}marshal(){return this._key}get bytes(){return wC.encode({Type:mC.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=tC.digest(this.bytes);return oC(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}async id(){const e=await this.public.hash();return(0,Au.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return yC(this.bytes,e);throw new fu.sv("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function HC(e){return new VC(e)}function qC(e){return new zC(e)}async function GC(){const e=Eh.utils.randomPrivateKey();return new VC(e)}const WC={rsa:we,ed25519:be,secp256k1:Ee};function QC(e){const t=Object.keys(WC).join(" / ");return new fu.sv("invalid or unsupported key type ".concat(e,". Must be ").concat(t),"ERR_UNSUPPORTED_KEY_TYPE")}async function YC(e){var t,n;const r=wC.decode(e),i=null!==(t=r.Data)&&void 0!==t?t:new Uint8Array;switch(r.Type){case mC.RSA:return WC.rsa.unmarshalRsaPrivateKey(i);case mC.Ed25519:return WC.ed25519.unmarshalEd25519PrivateKey(i);case mC.Secp256k1:return WC.secp256k1.unmarshalSecp256k1PrivateKey(i);default:throw QC(null!==(n=r.Type)&&void 0!==n?n:"RSA")}}const JC=SI({prefix:"9",name:"base10",alphabet:"0123456789"}),XC=_I({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),$C=_I({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),eT=_I({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),tT=Array.from("\ud83d\ude80\ud83e\ude90\u2604\ud83d\udef0\ud83c\udf0c\ud83c\udf11\ud83c\udf12\ud83c\udf13\ud83c\udf14\ud83c\udf15\ud83c\udf16\ud83c\udf17\ud83c\udf18\ud83c\udf0d\ud83c\udf0f\ud83c\udf0e\ud83d\udc09\u2600\ud83d\udcbb\ud83d\udda5\ud83d\udcbe\ud83d\udcbf\ud83d\ude02\u2764\ud83d\ude0d\ud83e\udd23\ud83d\ude0a\ud83d\ude4f\ud83d\udc95\ud83d\ude2d\ud83d\ude18\ud83d\udc4d\ud83d\ude05\ud83d\udc4f\ud83d\ude01\ud83d\udd25\ud83e\udd70\ud83d\udc94\ud83d\udc96\ud83d\udc99\ud83d\ude22\ud83e\udd14\ud83d\ude06\ud83d\ude44\ud83d\udcaa\ud83d\ude09\u263a\ud83d\udc4c\ud83e\udd17\ud83d\udc9c\ud83d\ude14\ud83d\ude0e\ud83d\ude07\ud83c\udf39\ud83e\udd26\ud83c\udf89\ud83d\udc9e\u270c\u2728\ud83e\udd37\ud83d\ude31\ud83d\ude0c\ud83c\udf38\ud83d\ude4c\ud83d\ude0b\ud83d\udc97\ud83d\udc9a\ud83d\ude0f\ud83d\udc9b\ud83d\ude42\ud83d\udc93\ud83e\udd29\ud83d\ude04\ud83d\ude00\ud83d\udda4\ud83d\ude03\ud83d\udcaf\ud83d\ude48\ud83d\udc47\ud83c\udfb6\ud83d\ude12\ud83e\udd2d\u2763\ud83d\ude1c\ud83d\udc8b\ud83d\udc40\ud83d\ude2a\ud83d\ude11\ud83d\udca5\ud83d\ude4b\ud83d\ude1e\ud83d\ude29\ud83d\ude21\ud83e\udd2a\ud83d\udc4a\ud83e\udd73\ud83d\ude25\ud83e\udd24\ud83d\udc49\ud83d\udc83\ud83d\ude33\u270b\ud83d\ude1a\ud83d\ude1d\ud83d\ude34\ud83c\udf1f\ud83d\ude2c\ud83d\ude43\ud83c\udf40\ud83c\udf37\ud83d\ude3b\ud83d\ude13\u2b50\u2705\ud83e\udd7a\ud83c\udf08\ud83d\ude08\ud83e\udd18\ud83d\udca6\u2714\ud83d\ude23\ud83c\udfc3\ud83d\udc90\u2639\ud83c\udf8a\ud83d\udc98\ud83d\ude20\u261d\ud83d\ude15\ud83c\udf3a\ud83c\udf82\ud83c\udf3b\ud83d\ude10\ud83d\udd95\ud83d\udc9d\ud83d\ude4a\ud83d\ude39\ud83d\udde3\ud83d\udcab\ud83d\udc80\ud83d\udc51\ud83c\udfb5\ud83e\udd1e\ud83d\ude1b\ud83d\udd34\ud83d\ude24\ud83c\udf3c\ud83d\ude2b\u26bd\ud83e\udd19\u2615\ud83c\udfc6\ud83e\udd2b\ud83d\udc48\ud83d\ude2e\ud83d\ude46\ud83c\udf7b\ud83c\udf43\ud83d\udc36\ud83d\udc81\ud83d\ude32\ud83c\udf3f\ud83e\udde1\ud83c\udf81\u26a1\ud83c\udf1e\ud83c\udf88\u274c\u270a\ud83d\udc4b\ud83d\ude30\ud83e\udd28\ud83d\ude36\ud83e\udd1d\ud83d\udeb6\ud83d\udcb0\ud83c\udf53\ud83d\udca2\ud83e\udd1f\ud83d\ude41\ud83d\udea8\ud83d\udca8\ud83e\udd2c\u2708\ud83c\udf80\ud83c\udf7a\ud83e\udd13\ud83d\ude19\ud83d\udc9f\ud83c\udf31\ud83d\ude16\ud83d\udc76\ud83e\udd74\u25b6\u27a1\u2753\ud83d\udc8e\ud83d\udcb8\u2b07\ud83d\ude28\ud83c\udf1a\ud83e\udd8b\ud83d\ude37\ud83d\udd7a\u26a0\ud83d\ude45\ud83d\ude1f\ud83d\ude35\ud83d\udc4e\ud83e\udd32\ud83e\udd20\ud83e\udd27\ud83d\udccc\ud83d\udd35\ud83d\udc85\ud83e\uddd0\ud83d\udc3e\ud83c\udf52\ud83d\ude17\ud83e\udd11\ud83c\udf0a\ud83e\udd2f\ud83d\udc37\u260e\ud83d\udca7\ud83d\ude2f\ud83d\udc86\ud83d\udc46\ud83c\udfa4\ud83d\ude47\ud83c\udf51\u2744\ud83c\udf34\ud83d\udca3\ud83d\udc38\ud83d\udc8c\ud83d\udccd\ud83e\udd40\ud83e\udd22\ud83d\udc45\ud83d\udca1\ud83d\udca9\ud83d\udc50\ud83d\udcf8\ud83d\udc7b\ud83e\udd10\ud83e\udd2e\ud83c\udfbc\ud83e\udd75\ud83d\udea9\ud83c\udf4e\ud83c\udf4a\ud83d\udc7c\ud83d\udc8d\ud83d\udce3\ud83e\udd42"),nT=tT.reduce(((e,t,n)=>(e[n]=t,e)),[]),rT=tT.reduce(((e,t,n)=>(e[t.codePointAt(0)]=n,e)),[]);const iT=AI({prefix:"\ud83d\ude80",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+=nT[t]),"")},decode:function(e){const t=[];for(const n of e){const e=rT[n.codePointAt(0)];if(void 0===e)throw new Error("Non-base256emoji character: ".concat(n));t.push(e)}return new Uint8Array(t)}}),oT=_I({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),sT=_I({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),aT=_I({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),cT=_I({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),lT=_I({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),uT=_I({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),hT=_I({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),dT=_I({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),fT=_I({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),pT=SI({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),gT=SI({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),yT=_I({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),mT=AI({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),vT=new TextEncoder,bT=new TextDecoder,wT="json",ET=512,AT=e=>vT.encode(JSON.stringify(e)),ST=e=>JSON.parse(bT.decode(e)),_T="raw",IT=85,CT=e=>yI(e),TT=e=>yI(e),kT=(e,t)=>{const{bytes:n,version:r}=e;return 0===r?OT(n,xT(e),t||II.encoder):NT(n,xT(e),t||oT.encoder)},RT=new WeakMap,xT=e=>{const t=RT.get(e);if(null==t){const t=new Map;return RT.set(e,t),t}return t};class PT{constructor(e,t,n,r){this.code=t,this.version=e,this.multihash=n,this.bytes=r,this["/"]=r}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==BT)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==LT)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return PT.createV0(t)}default:throw Error("Can not convert CID version ".concat(this.version," to version 0. This is a bug please report"))}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=GI(e,t);return PT.createV1(this.code,n)}case 1:return this;default:throw Error("Can not convert CID version ".concat(this.version," to version 1. This is a bug please report"))}}equals(e){return PT.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&((e,t)=>{if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&((e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0})(e.bytes,n.bytes)}})(e.multihash,n.multihash)}toString(e){return kT(this,e)}toJSON(){return{"/":kT(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID(".concat(this.toString(),")")}static asCID(e){if(null==e)return null;const t=e;if(t instanceof PT)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:i}=t;return new PT(e,n,r,i||MT(e,n,r.bytes))}if(!0===t[UT]){const{version:e,multihash:n,code:r}=t,i=WI(n);return PT.create(e,r,i)}return null}static create(e,t,n){if("number"!==typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==BT)throw new Error("Version 0 CID must use dag-pb (code: ".concat(BT,") block encoding"));return new PT(e,t,n,n.bytes);case 1:{const r=MT(e,t,n.bytes);return new PT(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return PT.create(0,BT,e)}static createV1(e,t){return PT.create(1,e,t)}static decode(e){const[t,n]=PT.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=PT.inspectBytes(e),n=t.size-t.multihashSize,r=yI(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=r.subarray(t.multihashSize-t.digestSize),o=new QI(t.multihashCode,t.digestSize,i,r);return[0===t.version?PT.createV0(o):PT.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=VI(e.subarray(t));return t+=r,n};let r=n(),i=BT;if(18===r?(r=0,t=0):i=n(),0!==r&&1!==r)throw new RangeError("Invalid CID version ".concat(r));const o=t,s=n(),a=n(),c=t+a;return{version:r,codec:i,multihashCode:s,digestSize:a,multihashSize:c-o,size:c}}static parse(e,t){const[n,r]=DT(e,t),i=PT.decode(r);if(0===i.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return xT(i).set(n,e),i}}const DT=(e,t)=>{switch(e[0]){case"Q":{const n=t||II;return[II.prefix,n.decode("".concat(II.prefix).concat(e))]}case II.prefix:{const n=t||II;return[II.prefix,n.decode(e)]}case oT.prefix:{const n=t||oT;return[oT.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}},OT=(e,t,n)=>{const{prefix:r}=n;if(r!==II.prefix)throw Error("Cannot string encode V0 in ".concat(n.name," encoding"));const i=t.get(r);if(null==i){const i=n.encode(e).slice(1);return t.set(r,i),i}return i},NT=(e,t,n)=>{const{prefix:r}=n,i=t.get(r);if(null==i){const i=n.encode(e);return t.set(r,i),i}return i},BT=112,LT=18,MT=(e,t,n)=>{const r=qI(e),i=r+qI(t),o=new Uint8Array(i+n.byteLength);return HI(e,o,0),HI(t,o,r),o.set(n,i),o},UT=Symbol.for("@ipld/js-cid/CID"),FT={...Re,..._e,...ke,...Ae,...Se,...Ce,...Te,...ge,...ve,...Ie},KT=Symbol.for("nodejs.util.inspect.custom"),jT=Object.values(FT).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),FT.identity.decoder),ZT=114,zT=36,VT=37;class HT{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,fu.Cs,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=II.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return PT.createV1(ZT,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return function(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:jT,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=WI(II.decode("z".concat(e)));return e.startsWith("12D")?new GT({multihash:t}):e.startsWith("16U")?new WT({multihash:t}):new qT({multihash:t})}return QT(jT.decode(e))}(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[KT](){return"PeerId(".concat(this.toString(),")")}}class qT extends HT{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class GT extends HT{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class WT extends HT{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}function QT(e){try{const t=WI(e);if(t.code===JI.code){if(t.digest.length===zT)return new GT({multihash:t});if(t.digest.length===VT)return new WT({multihash:t})}if(t.code===tC.code)return new qT({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==ZT)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===tC.code)return new qT({multihash:e.multihash});if(t.code===JI.code){if(t.digest.length===zT)return new GT({multihash:e.multihash});if(t.digest.length===VT)return new WT({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(PT.decode(e))}throw new Error("Supplied PeerID CID is invalid")}const YT="ERR_SIGNATURE_NOT_VALID";var JT;!function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.publicKey&&e.publicKey.byteLength>0&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.payloadType&&e.payloadType.byteLength>0&&(t.uint32(18),t.bytes(e.payloadType)),null!=e.payload&&e.payload.byteLength>0&&(t.uint32(26),t.bytes(e.payload)),null!=e.signature&&e.signature.byteLength>0&&(t.uint32(42),t.bytes(e.signature)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.publicKey=e.bytes();break;case 2:n.payloadType=e.bytes();break;case 3:n.payload=e.bytes();break;case 5:n.signature=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(JT||(JT={}));class XT{constructor(e){(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"payloadType",void 0),(0,Yo.Z)(this,"payload",void 0),(0,Yo.Z)(this,"signature",void 0),(0,Yo.Z)(this,"marshaled",void 0);const{peerId:t,payloadType:n,payload:r,signature:i}=e;this.peerId=t,this.payloadType=n,this.payload=r,this.signature=i}marshal(){if(null==this.peerId.publicKey)throw new Error("Missing public key");return null==this.marshaled&&(this.marshaled=JT.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return(0,Ms.f)(this.marshal(),e.marshal())}async validate(e){const t=$T(e,this.payloadType,this.payload);if(null==this.peerId.publicKey)throw new Error("Missing public key");const n=function(e){var t,n;const r=bC.decode(e),i=null!==(t=r.Data)&&void 0!==t?t:new Uint8Array;switch(r.Type){case mC.RSA:return WC.rsa.unmarshalRsaPublicKey(i);case mC.Ed25519:return WC.ed25519.unmarshalEd25519PublicKey(i);case mC.Secp256k1:return WC.secp256k1.unmarshalSecp256k1PublicKey(i);default:throw QC(null!==(n=r.Type)&&void 0!==n?n:"unknown")}}(this.peerId.publicKey);return n.verify(t.subarray(),this.signature)}}(0,Yo.Z)(XT,"createFromProtobuf",(async e=>{const t=JT.decode(e),n=await async function(e,t){return e.length===zT?new GT({multihash:GI(JI.code,e),privateKey:t}):e.length===VT?new WT({multihash:GI(JI.code,e),privateKey:t}):new qT({multihash:await tC.digest(e),publicKey:e,privateKey:t})}(t.publicKey);return new XT({peerId:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})})),(0,Yo.Z)(XT,"seal",(async(e,t)=>{if(null==t.privateKey)throw new Error("Missing private key");const n=e.domain,r=e.codec,i=e.marshal(),o=$T(n,r,i),s=await YC(t.privateKey),a=await s.sign(o.subarray());return new XT({peerId:t,payloadType:r,payload:i,signature:a})})),(0,Yo.Z)(XT,"openAndCertify",(async(e,t)=>{const n=await XT.createFromProtobuf(e);if(!await n.validate(t))throw new fu.sv("envelope signature is not valid for the given domain",YT);return n}));const $T=(e,t,n)=>{const r=(0,yu.m)(e),i=Bs.cv(r.byteLength),o=Bs.cv(t.length),s=Bs.cv(n.length);return new Zs(i,r,o,t,s,n)};const ek=Uint8Array.from([3,1]);var tk;!function(e){let t,n;!function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={multiaddr:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();if(t>>>3===1)n.multiaddr=e.bytes();else e.skipType(7&t)}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(t=e.AddressInfo||(e.AddressInfo={})),e.codec=()=>(null==n&&(n=ws((function(t,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==r.lengthDelimited&&n.fork(),null!=t.peerId&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),null!=t.seq&&0n!==t.seq&&(n.uint32(16),n.uint64(t.seq)),null!=t.addresses)for(const i of t.addresses)n.uint32(26),e.AddressInfo.codec().encode(i,n);!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={peerId:new Uint8Array(0),seq:0n,addresses:[]},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.peerId=t.bytes();break;case 2:r.seq=t.uint64();break;case 3:r.addresses.push(e.AddressInfo.codec().decode(t,t.uint32()));break;default:t.skipType(7&n)}}return r}))),n),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(tk||(tk={}));class nk{constructor(e){(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"multiaddrs",void 0),(0,Yo.Z)(this,"seqNumber",void 0),(0,Yo.Z)(this,"domain",nk.DOMAIN),(0,Yo.Z)(this,"codec",nk.CODEC),(0,Yo.Z)(this,"marshaled",void 0);const{peerId:t,multiaddrs:n,seqNumber:r}=e;this.peerId=t,this.multiaddrs=null!==n&&void 0!==n?n:[],this.seqNumber=null!==r&&void 0!==r?r:BigInt(Date.now())}marshal(){return null==this.marshaled&&(this.marshaled=tk.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map((e=>({multiaddr:e.bytes})))})),this.marshaled}equals(e){return e instanceof nk&&(!!this.peerId.equals(e.peerId)&&(this.seqNumber===e.seqNumber&&!!function(e,t){const n=(e,t)=>e.toString().localeCompare(t.toString());return e.length===t.length&&(t.sort(n),e.sort(n).every(((e,n)=>t[n].equals(e))))}(this.multiaddrs,e.multiaddrs)))}}function rk(e,t){const n=la(e,t),r={read:async(e,t)=>{const r=await n.read(t);return e.decode(r)},write:async(e,t,r)=>{await n.write(t.encode(e),r)},writeV:async(e,t,r)=>{await n.writeV(e.map((e=>t.encode(e))),r)},pb:e=>({read:async t=>r.read(e,t),write:async(t,n)=>r.write(t,e,n),writeV:async(t,n)=>r.writeV(t,e,n),unwrap:()=>r}),unwrap:()=>n.unwrap()};return r}(0,Yo.Z)(nk,"createFromProtobuf",(e=>{var t;const n=tk.decode(e),r=QT(n.peerId),i=(null!==(t=n.addresses)&&void 0!==t?t:[]).map((e=>(0,ng.HM)(e.multiaddr))),o=n.seq;return new nk({peerId:r,multiaddrs:i,seqNumber:o})})),(0,Yo.Z)(nk,"DOMAIN","libp2p-peer-record"),(0,Yo.Z)(nk,"CODEC",ek);BigInt(1<<17);const ik="/libp2p/circuit/relay/0.2.0/hop",ok="/libp2p/circuit/relay/0.2.0/stop",sk="ERR_RELAYED_DIAL";var ak,ck,lk,uk,hk,dk,fk,pk;function gk(e){const t=e*BigInt(1e3),n=(new Date).getTime();return Number(t-BigInt(n))}!function(e){let t,n,r;!function(e){e.RESERVE="RESERVE",e.CONNECT="CONNECT",e.STATUS="STATUS"}(t=e.Type||(e.Type={})),function(e){e[e.RESERVE=0]="RESERVE",e[e.CONNECT=1]="CONNECT",e[e.STATUS=2]="STATUS"}(n||(n={})),function(e){e.codec=()=>bs(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=ws((function(t,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.peer&&(n.uint32(18),lk.codec().encode(t.peer,n)),null!=t.reservation&&(n.uint32(26),uk.codec().encode(t.reservation,n)),null!=t.limit&&(n.uint32(34),hk.codec().encode(t.limit,n)),null!=t.status&&(n.uint32(40),dk.codec().encode(t.status,n)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.type=e.Type.codec().decode(t);break;case 2:r.peer=lk.codec().decode(t,t.uint32());break;case 3:r.reservation=uk.codec().decode(t,t.uint32());break;case 4:r.limit=hk.codec().decode(t,t.uint32());break;case 5:r.status=dk.codec().decode(t);break;default:t.skipType(7&n)}}return r}))),r),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(ak||(ak={})),function(e){let t,n,r;!function(e){e.CONNECT="CONNECT",e.STATUS="STATUS"}(t=e.Type||(e.Type={})),function(e){e[e.CONNECT=0]="CONNECT",e[e.STATUS=1]="STATUS"}(n||(n={})),function(e){e.codec=()=>bs(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=ws((function(t,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.peer&&(n.uint32(18),lk.codec().encode(t.peer,n)),null!=t.limit&&(n.uint32(26),hk.codec().encode(t.limit,n)),null!=t.status&&(n.uint32(32),dk.codec().encode(t.status,n)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.type=e.Type.codec().decode(t);break;case 2:r.peer=lk.codec().decode(t,t.uint32());break;case 3:r.limit=hk.codec().decode(t,t.uint32());break;case 4:r.status=dk.codec().decode(t);break;default:t.skipType(7&n)}}return r}))),r),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(ck||(ck={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.id&&e.id.byteLength>0&&(t.uint32(10),t.bytes(e.id)),null!=e.addrs)for(const r of e.addrs)t.uint32(18),t.bytes(r);!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={id:new Uint8Array(0),addrs:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.id=e.bytes();break;case 2:n.addrs.push(e.bytes());break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(lk||(lk={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.expire&&0n!==e.expire&&(t.uint32(8),t.uint64(e.expire)),null!=e.addrs)for(const r of e.addrs)t.uint32(18),t.bytes(r);null!=e.voucher&&(t.uint32(26),t.bytes(e.voucher)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={expire:0n,addrs:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.expire=e.uint64();break;case 2:n.addrs.push(e.bytes());break;case 3:n.voucher=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(uk||(uk={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.duration&&(t.uint32(8),t.uint32(e.duration)),null!=e.data&&(t.uint32(16),t.uint64(e.data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.duration=e.uint32();break;case 2:n.data=e.uint64();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(hk||(hk={})),function(e){e.UNUSED="UNUSED",e.OK="OK",e.RESERVATION_REFUSED="RESERVATION_REFUSED",e.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONNECTION_FAILED="CONNECTION_FAILED",e.NO_RESERVATION="NO_RESERVATION",e.MALFORMED_MESSAGE="MALFORMED_MESSAGE",e.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"}(dk||(dk={})),function(e){e[e.UNUSED=0]="UNUSED",e[e.OK=100]="OK",e[e.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",e[e.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",e[e.PERMISSION_DENIED=202]="PERMISSION_DENIED",e[e.CONNECTION_FAILED=203]="CONNECTION_FAILED",e[e.NO_RESERVATION=204]="NO_RESERVATION",e[e.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",e[e.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"}(fk||(fk={})),function(e){e.codec=()=>bs(fk)}(dk||(dk={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.relay&&e.relay.byteLength>0&&(t.uint32(10),t.bytes(e.relay)),null!=e.peer&&e.peer.byteLength>0&&(t.uint32(18),t.bytes(e.peer)),null!=e.expiration&&0n!==e.expiration&&(t.uint32(24),t.uint64(e.expiration)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={relay:new Uint8Array(0),peer:new Uint8Array(0),expiration:0n},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.relay=e.bytes();break;case 2:n.peer=e.bytes();break;case 3:n.expiration=e.uint64();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(pk||(pk={}));n(99158);Object.prototype.toString,new Set(["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed"]);var yk=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const mk=yk,vk=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class bk{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class wk{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return Ak(this,e)}}class Ek{constructor(e){this.decoders=e}or(e){return Ak(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const Ak=(e,t)=>new Ek({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class Sk{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new bk(e,t,n),this.decoder=new wk(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const _k=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new Sk(t,n,r,i)},Ik=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=mk(r,n);return _k({prefix:t,name:n,encode:i,decode:e=>vk(o(e))})},Ck=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return _k({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},Tk=Ik({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),kk=Ik({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),Rk=Ik({prefix:"9",name:"base10",alphabet:"0123456789"}),xk=Ck({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Pk=Ck({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Dk=Ck({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Ok=Array.from("\ud83d\ude80\ud83e\ude90\u2604\ud83d\udef0\ud83c\udf0c\ud83c\udf11\ud83c\udf12\ud83c\udf13\ud83c\udf14\ud83c\udf15\ud83c\udf16\ud83c\udf17\ud83c\udf18\ud83c\udf0d\ud83c\udf0f\ud83c\udf0e\ud83d\udc09\u2600\ud83d\udcbb\ud83d\udda5\ud83d\udcbe\ud83d\udcbf\ud83d\ude02\u2764\ud83d\ude0d\ud83e\udd23\ud83d\ude0a\ud83d\ude4f\ud83d\udc95\ud83d\ude2d\ud83d\ude18\ud83d\udc4d\ud83d\ude05\ud83d\udc4f\ud83d\ude01\ud83d\udd25\ud83e\udd70\ud83d\udc94\ud83d\udc96\ud83d\udc99\ud83d\ude22\ud83e\udd14\ud83d\ude06\ud83d\ude44\ud83d\udcaa\ud83d\ude09\u263a\ud83d\udc4c\ud83e\udd17\ud83d\udc9c\ud83d\ude14\ud83d\ude0e\ud83d\ude07\ud83c\udf39\ud83e\udd26\ud83c\udf89\ud83d\udc9e\u270c\u2728\ud83e\udd37\ud83d\ude31\ud83d\ude0c\ud83c\udf38\ud83d\ude4c\ud83d\ude0b\ud83d\udc97\ud83d\udc9a\ud83d\ude0f\ud83d\udc9b\ud83d\ude42\ud83d\udc93\ud83e\udd29\ud83d\ude04\ud83d\ude00\ud83d\udda4\ud83d\ude03\ud83d\udcaf\ud83d\ude48\ud83d\udc47\ud83c\udfb6\ud83d\ude12\ud83e\udd2d\u2763\ud83d\ude1c\ud83d\udc8b\ud83d\udc40\ud83d\ude2a\ud83d\ude11\ud83d\udca5\ud83d\ude4b\ud83d\ude1e\ud83d\ude29\ud83d\ude21\ud83e\udd2a\ud83d\udc4a\ud83e\udd73\ud83d\ude25\ud83e\udd24\ud83d\udc49\ud83d\udc83\ud83d\ude33\u270b\ud83d\ude1a\ud83d\ude1d\ud83d\ude34\ud83c\udf1f\ud83d\ude2c\ud83d\ude43\ud83c\udf40\ud83c\udf37\ud83d\ude3b\ud83d\ude13\u2b50\u2705\ud83e\udd7a\ud83c\udf08\ud83d\ude08\ud83e\udd18\ud83d\udca6\u2714\ud83d\ude23\ud83c\udfc3\ud83d\udc90\u2639\ud83c\udf8a\ud83d\udc98\ud83d\ude20\u261d\ud83d\ude15\ud83c\udf3a\ud83c\udf82\ud83c\udf3b\ud83d\ude10\ud83d\udd95\ud83d\udc9d\ud83d\ude4a\ud83d\ude39\ud83d\udde3\ud83d\udcab\ud83d\udc80\ud83d\udc51\ud83c\udfb5\ud83e\udd1e\ud83d\ude1b\ud83d\udd34\ud83d\ude24\ud83c\udf3c\ud83d\ude2b\u26bd\ud83e\udd19\u2615\ud83c\udfc6\ud83e\udd2b\ud83d\udc48\ud83d\ude2e\ud83d\ude46\ud83c\udf7b\ud83c\udf43\ud83d\udc36\ud83d\udc81\ud83d\ude32\ud83c\udf3f\ud83e\udde1\ud83c\udf81\u26a1\ud83c\udf1e\ud83c\udf88\u274c\u270a\ud83d\udc4b\ud83d\ude30\ud83e\udd28\ud83d\ude36\ud83e\udd1d\ud83d\udeb6\ud83d\udcb0\ud83c\udf53\ud83d\udca2\ud83e\udd1f\ud83d\ude41\ud83d\udea8\ud83d\udca8\ud83e\udd2c\u2708\ud83c\udf80\ud83c\udf7a\ud83e\udd13\ud83d\ude19\ud83d\udc9f\ud83c\udf31\ud83d\ude16\ud83d\udc76\ud83e\udd74\u25b6\u27a1\u2753\ud83d\udc8e\ud83d\udcb8\u2b07\ud83d\ude28\ud83c\udf1a\ud83e\udd8b\ud83d\ude37\ud83d\udd7a\u26a0\ud83d\ude45\ud83d\ude1f\ud83d\ude35\ud83d\udc4e\ud83e\udd32\ud83e\udd20\ud83e\udd27\ud83d\udccc\ud83d\udd35\ud83d\udc85\ud83e\uddd0\ud83d\udc3e\ud83c\udf52\ud83d\ude17\ud83e\udd11\ud83c\udf0a\ud83e\udd2f\ud83d\udc37\u260e\ud83d\udca7\ud83d\ude2f\ud83d\udc86\ud83d\udc46\ud83c\udfa4\ud83d\ude47\ud83c\udf51\u2744\ud83c\udf34\ud83d\udca3\ud83d\udc38\ud83d\udc8c\ud83d\udccd\ud83e\udd40\ud83e\udd22\ud83d\udc45\ud83d\udca1\ud83d\udca9\ud83d\udc50\ud83d\udcf8\ud83d\udc7b\ud83e\udd10\ud83e\udd2e\ud83c\udfbc\ud83e\udd75\ud83d\udea9\ud83c\udf4e\ud83c\udf4a\ud83d\udc7c\ud83d\udc8d\ud83d\udce3\ud83e\udd42"),Nk=Ok.reduce(((e,t,n)=>(e[n]=t,e)),[]),Bk=Ok.reduce(((e,t,n)=>(e[t.codePointAt(0)]=n,e)),[]);const Lk=_k({prefix:"\ud83d\ude80",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+=Nk[t]),"")},decode:function(e){const t=[];for(const n of e){const e=Bk[n.codePointAt(0)];if(void 0===e)throw new Error("Non-base256emoji character: ".concat(n));t.push(e)}return new Uint8Array(t)}}),Mk=Ck({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Uk=Ck({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Fk=Ck({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Kk=Ck({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),jk=Ck({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Zk=Ck({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),zk=Ck({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Vk=Ck({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Hk=Ck({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),qk=Ik({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Gk=Ik({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Wk=Ck({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Qk=Ck({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Yk=Ck({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Jk=Ck({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),Xk=Ck({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),$k=_k({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),eR=new TextEncoder,tR=new TextDecoder,nR="json",rR=512,iR=e=>eR.encode(JSON.stringify(e)),oR=e=>JSON.parse(tR.decode(e)),sR="raw",aR=85,cR=e=>vk(e),lR=e=>vk(e);var uR=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=fR;)n[r++]=255&t|hR,t/=128;for(;t&dR;)n[r++]=255&t|hR,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},hR=128,dR=-128,fR=Math.pow(2,31);var pR=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&yR)<<o:(r&yR)*Math.pow(2,o),o+=7}while(r>=gR);return e.bytes=s-n,i},gR=128,yR=127;var mR=Math.pow(2,7),vR=Math.pow(2,14),bR=Math.pow(2,21),wR=Math.pow(2,28),ER=Math.pow(2,35),AR=Math.pow(2,42),SR=Math.pow(2,49),_R=Math.pow(2,56),IR=Math.pow(2,63);const CR={encode:uR,decode:pR,encodingLength:function(e){return e<mR?1:e<vR?2:e<bR?3:e<wR?4:e<ER?5:e<AR?6:e<SR?7:e<_R?8:e<IR?9:10}},TR=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return[CR.decode(e,t),CR.decode.bytes]},kR=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return CR.encode(e,t,n),t},RR=e=>CR.encodingLength(e),xR=(e,t)=>{const n=t.byteLength,r=RR(e),i=r+RR(n),o=new Uint8Array(i+n);return kR(e,o,0),kR(n,o,r),o.set(t,i),new DR(e,n,t,o)},PR=e=>{const t=vk(e),[n,r]=TR(t),[i,o]=TR(t.subarray(r)),s=t.subarray(r+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new DR(n,i,s,t)};class DR{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const OR=vk,NR={code:0,name:"identity",encode:OR,digest:e=>xR(0,OR(e))},BR=e=>{let{name:t,code:n,encode:r}=e;return new LR(t,n,r)};class LR{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?xR(this.code,t):t.then((e=>xR(this.code,e)))}throw Error("Unknown type, must be binary type")}}const MR=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),UR=BR({name:"sha2-256",code:18,encode:MR("SHA-256")}),FR=BR({name:"sha2-512",code:19,encode:MR("SHA-512")}),KR=(e,t)=>{const{bytes:n,version:r}=e;return 0===r?HR(n,ZR(e),t||Tk.encoder):qR(n,ZR(e),t||Mk.encoder)},jR=new WeakMap,ZR=e=>{const t=jR.get(e);if(null==t){const t=new Map;return jR.set(e,t),t}return t};class zR{constructor(e,t,n,r){this.code=t,this.version=e,this.multihash=n,this.bytes=r,this["/"]=r}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==GR)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==WR)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return zR.createV0(t)}default:throw Error("Can not convert CID version ".concat(this.version," to version 0. This is a bug please report"))}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=xR(e,t);return zR.createV1(this.code,n)}case 1:return this;default:throw Error("Can not convert CID version ".concat(this.version," to version 1. This is a bug please report"))}}equals(e){return zR.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&((e,t)=>{if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&((e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0})(e.bytes,n.bytes)}})(e.multihash,n.multihash)}toString(e){return KR(this,e)}toJSON(){return{"/":KR(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID(".concat(this.toString(),")")}static asCID(e){if(null==e)return null;const t=e;if(t instanceof zR)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:i}=t;return new zR(e,n,r,i||QR(e,n,r.bytes))}if(!0===t[YR]){const{version:e,multihash:n,code:r}=t,i=PR(n);return zR.create(e,r,i)}return null}static create(e,t,n){if("number"!==typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==GR)throw new Error("Version 0 CID must use dag-pb (code: ".concat(GR,") block encoding"));return new zR(e,t,n,n.bytes);case 1:{const r=QR(e,t,n.bytes);return new zR(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return zR.create(0,GR,e)}static createV1(e,t){return zR.create(1,e,t)}static decode(e){const[t,n]=zR.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=zR.inspectBytes(e),n=t.size-t.multihashSize,r=vk(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=r.subarray(t.multihashSize-t.digestSize),o=new DR(t.multihashCode,t.digestSize,i,r);return[0===t.version?zR.createV0(o):zR.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=TR(e.subarray(t));return t+=r,n};let r=n(),i=GR;if(18===r?(r=0,t=0):i=n(),0!==r&&1!==r)throw new RangeError("Invalid CID version ".concat(r));const o=t,s=n(),a=n(),c=t+a;return{version:r,codec:i,multihashCode:s,digestSize:a,multihashSize:c-o,size:c}}static parse(e,t){const[n,r]=VR(e,t),i=zR.decode(r);if(0===i.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return ZR(i).set(n,e),i}}const VR=(e,t)=>{switch(e[0]){case"Q":{const n=t||Tk;return[Tk.prefix,n.decode("".concat(Tk.prefix).concat(e))]}case Tk.prefix:{const n=t||Tk;return[Tk.prefix,n.decode(e)]}case Mk.prefix:{const n=t||Mk;return[Mk.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}},HR=(e,t,n)=>{const{prefix:r}=n;if(r!==Tk.prefix)throw Error("Cannot string encode V0 in ".concat(n.name," encoding"));const i=t.get(r);if(null==i){const i=n.encode(e).slice(1);return t.set(r,i),i}return i},qR=(e,t,n)=>{const{prefix:r}=n,i=t.get(r);if(null==i){const i=n.encode(e);return t.set(r,i),i}return i},GR=112,WR=18,QR=(e,t,n)=>{const r=RR(e),i=r+RR(t),o=new Uint8Array(i+n.byteLength);return kR(e,o,0),kR(t,o,r),o.set(n,i),o},YR=Symbol.for("@ipld/js-cid/CID"),JR={...je,...Be,...Ke,...Oe,...Ne,...Me,...Ue,...De,...Fe,...Le},XR=Symbol.for("nodejs.util.inspect.custom"),$R=Object.values(JR).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),JR.identity.decoder),ex=114,tx=36,nx=37;class rx{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,fu.Cs,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=Tk.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return zR.createV1(ex,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return ax(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[XR](){return"PeerId(".concat(this.toString(),")")}}class ix extends rx{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class ox extends rx{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class sx extends rx{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}function ax(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:$R,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=PR(Tk.decode("z".concat(e)));return e.startsWith("12D")?new ox({multihash:t}):e.startsWith("16U")?new sx({multihash:t}):new ix({multihash:t})}return function(e){try{const t=PR(e);if(t.code===NR.code){if(t.digest.length===tx)return new ox({multihash:t});if(t.digest.length===nx)return new sx({multihash:t})}if(t.code===UR.code)return new ix({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==ex)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===UR.code)return new ix({multihash:e.multihash});if(t.code===NR.code){if(t.digest.length===tx)return new ox({multihash:e.multihash});if(t.digest.length===nx)return new sx({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(zR.decode(e))}throw new Error("Supplied PeerID CID is invalid")}($R.decode(e))}function cx(e,t){const n={[Symbol.iterator]:()=>n,next:()=>{const n=e.next(),r=n.value;if(!0===n.done||null==r){return{done:!0,value:void 0}}return{done:!1,value:t(r)}}};return n}class lx{constructor(e){if((0,Yo.Z)(this,"map",void 0),this.map=new Map,null!=e)for(const[t,n]of e.entries())this.map.set(t.toString(),n)}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){this.map.delete(e.toString())}entries(){return cx(this.map.entries(),(e=>[ax(e[0]),e[1]]))}forEach(e){this.map.forEach(((t,n)=>{e(t,ax(n),this)}))}get(e){return this.map.get(e.toString())}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),t)}keys(){return cx(this.map.keys(),(e=>ax(e)))}values(){return this.map.values()}get size(){return this.map.size}}class ux{constructor(e){if((0,Yo.Z)(this,"set",void 0),this.set=new Set,null!=e)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return cx(this.set.entries(),(e=>{const t=ax(e[0]);return[t,t]}))}forEach(e){this.set.forEach((t=>{const n=ax(t);e(n,n,this)}))}has(e){return this.set.has(e.toString())}values(){return cx(this.set.values(),(e=>ax(e)))}intersection(e){const t=new ux;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new ux;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new ux;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}Symbol.iterator;class hx extends fu.Le{constructor(e){super(),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"contentRouting",void 0),(0,Yo.Z)(this,"registrar",void 0),(0,Yo.Z)(this,"started",void 0),(0,Yo.Z)(this,"topologyId",void 0),(0,Yo.Z)(this,"log",void 0),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.contentRouting=e.contentRouting,this.registrar=e.registrar}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(ik,{notifyOnTransient:!0,onConnect:e=>{this.safeDispatchEvent("relay:discover",{detail:e})}}),this.discover().catch((e=>{this.log.error("error listening on relays",e)})),this.started=!0}stop(){null!=this.topologyId&&this.registrar.unregister(this.topologyId),this.started=!1}async discover(){this.log("searching peer store for relays");const e=await this.peerStore.all({filters:[e=>e.protocols.includes(ik)],orders:[()=>Math.random()<.5?1:-1]});for(const n of e)this.log("found relay peer %p in content peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);try{this.log("searching content routing for relays");const e=await async function(e){const t=(new TextEncoder).encode(e),n=await z_.digest(t);return W_.createV0(n)}("/libp2p/relay");let t=0;for await(const n of this.contentRouting.findProviders(e))if(n.multiaddrs.length>0&&!n.id.equals(this.peerId)){const e=n.id;t++,await this.peerStore.merge(e,{multiaddrs:n.multiaddrs}),this.log("found relay peer %p in content routing",e),this.safeDispatchEvent("relay:discover",{detail:e})}this.log("found %d relay peers in content routing",t)}catch(t){this.log.error("failed when finding relays on the network",t)}}}var dx=n(44743),fx=n(58271);var px=new WeakMap;class gx{constructor(){(0,dx.Z)(this,px,{writable:!0,value:[]})}enqueue(e,t){var n;const r=null===t||void 0===t?void 0:t.peerId,i=null!==(n=null===t||void 0===t?void 0:t.priority)&&void 0!==n?n:0;if(null==r)throw new fu.sv("missing peer id",fu.Mb);const o={priority:i,peerId:r,run:e};if(this.size>0&&(0,fx.Z)(this,px)[this.size-1].priority>=i)return void(0,fx.Z)(this,px).push(o);const s=function(e,t,n){let r=0,i=e.length;for(;i>0;){const o=Math.trunc(i/2);let s=r+o;n(e[s],t)<=0?(r=++s,i-=o+1):i=o}return r}((0,fx.Z)(this,px),o,((e,t)=>t.priority-e.priority));(0,fx.Z)(this,px).splice(s,0,o)}dequeue(){const e=(0,fx.Z)(this,px).shift();return null===e||void 0===e?void 0:e.run}filter(e){if(null!=e.peerId){const t=e.peerId;return(0,fx.Z)(this,px).filter((e=>t.equals(e.peerId))).map((e=>e.run))}return(0,fx.Z)(this,px).filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return(0,fx.Z)(this,px).length}}class yx extends Bm.Z{constructor(){super({...arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},queueClass:gx})}hasJob(e){return this.sizeBy({peerId:e})>0}}var mx=new WeakSet,vx=new WeakSet;class bx extends fu.Le{constructor(e,t){var n,r,i,o;super(),Qd(this,vx),Qd(this,mx),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"connectionManager",void 0),(0,Yo.Z)(this,"transportManager",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"events",void 0),(0,Yo.Z)(this,"reserveQueue",void 0),(0,Yo.Z)(this,"reservations",void 0),(0,Yo.Z)(this,"maxDiscoveredRelays",void 0),(0,Yo.Z)(this,"maxReservationQueueLength",void 0),(0,Yo.Z)(this,"reservationCompletionTimeout",void 0),(0,Yo.Z)(this,"started",void 0),(0,Yo.Z)(this,"log",void 0),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new lx,this.maxDiscoveredRelays=null!==(n=null===t||void 0===t?void 0:t.discoverRelays)&&void 0!==n?n:0,this.maxReservationQueueLength=null!==(r=null===t||void 0===t?void 0:t.maxReservationQueueLength)&&void 0!==r?r:100,this.reservationCompletionTimeout=null!==(i=null===t||void 0===t?void 0:t.reservationCompletionTimeout)&&void 0!==i?i:1e4,this.started=!1,this.reserveQueue=new yx({concurrency:null!==(o=null===t||void 0===t?void 0:t.reservationConcurrency)&&void 0!==o?o:1}),this.events.addEventListener("peer:disconnect",(e=>{Yd(this,vx,Ex).call(this,e.detail)}))}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.reserveQueue.clear(),this.reservations.forEach((e=>{let{timeout:t}=e;clearTimeout(t)})),this.reservations.clear(),this.started=!1}async addRelay(e,t){this.peerId.equals(e)?this.log("not trying to use self as relay"):this.reserveQueue.size>this.maxReservationQueueLength?this.log("not adding relay as the queue is full"):this.reserveQueue.hasJob(e)?this.log("relay peer is already in the reservation queue"):(this.log("add relay %p",e),await this.reserveQueue.add((async()=>{try{const n=this.reservations.get(e);if(null!=n){if(gk(n.reservation.expire)>6e5)return void this.log("already have reservation on relay peer %p and it expires in more than 10 minutes",e);clearTimeout(n.timeout),this.reservations.delete(e)}if("discovered"===t&&[...this.reservations.values()].reduce(((e,t)=>("discovered"===t.type&&e++,e)),0)>=this.maxDiscoveredRelays)return void this.log("already have enough discovered relays");const r=AbortSignal.timeout(this.reservationCompletionTimeout),i=await this.connectionManager.openConnection(e,{signal:r});if(i.remoteAddr.protoNames().includes("p2p-circuit"))return void this.log("not creating reservation over relayed connection");const o=await Yd(this,mx,wx).call(this,i,{signal:r});this.log("created reservation on relay peer %p",e);const s=gk(o.expire),a=Math.min(Math.max(s-3e5,3e4),Math.pow(2,31)-1),c=setTimeout((()=>{this.addRelay(e,t).catch((t=>{this.log.error("could not refresh reservation to relay %p",e,t)}))}),a);this.reservations.set(e,{timeout:c,reservation:o,type:t}),await this.peerStore.merge(e,{tags:{"circuit-relay-relay":{value:1,ttl:s}}}),await this.transportManager.listen([(0,ng.HM)("/p2p/".concat(e.toString(),"/p2p-circuit"))])}catch(n){this.log.error("could not reserve slot on %p",e,n);const t=this.reservations.get(e);null!=t&&clearTimeout(t.timeout),this.reservations.delete(e)}}),{peerId:e}))}hasReservation(e){return this.reservations.has(e)}getReservation(e){var t;return null===(t=this.reservations.get(e))||void 0===t?void 0:t.reservation}}async function wx(e,t){var n,r;null===(n=t.signal)||void 0===n||n.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const i=await e.newStream(ik,t),o=rk(i).pb(ak);let s;await o.write({type:ak.Type.RESERVE},t);try{s=await o.read(t)}catch(c){throw this.log.error("error parsing reserve message response from %p because",e.remotePeer,c),i.abort(c),c}finally{await i.close()}if(s.status===dk.OK&&null!=s.reservation){let t=!1;const n=e.remoteAddr.bytes;for(const e of s.reservation.addrs)if((0,Ms.f)(n,e)){t=!0;break}return t||s.reservation.addrs.push(n),s.reservation}const a="reservation failed with status ".concat(null!==(r=s.status)&&void 0!==r?r:"undefined");throw this.log.error(a),new Error(a)}function Ex(e){const t=this.reservations.get(e);null!=t&&(this.log("connection to relay %p closed, removing reservation from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),this.safeDispatchEvent("relay:removed",{detail:e}),this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{})))}function Ax(e){const{stream:t,remoteAddr:n,logger:r}=e,i=r.forComponent("libp2p:stream:converter");let o=!1,s=!1;const a=t.close.bind(t);t.close=async e=>{await a(e),h(!0)};const c=t.abort.bind(t);t.abort=e=>{c(e),h(!0)};const l=t.sink.bind(t);t.sink=async e=>{try{await l(e)}catch(t){"aborted"!==t.type&&i(t)}finally{s=!0,h()}};const u={log:i,sink:t.sink,source:async function*(){try{for await(const e of t.source)e instanceof Uint8Array?yield e:yield*e}finally{o=!0,h()}}(),remoteAddr:n,timeline:{open:Date.now(),close:void 0},close:t.close,abort:t.abort};function h(e){!0===e&&(o=!0,s=!0),o&&s&&null==u.timeline.close&&(u.timeline.close=Date.now())}return u}const Sx=eP("dns4"),_x=eP("dns6"),Ix=eP("dnsaddr"),Cx=$x(eP("dns"),Ix,Sx,_x),Tx=$x(eP("ip4"),eP("ip6")),kx=$x(Xx(Tx,eP("tcp")),Xx(Cx,eP("tcp"))),Rx=Xx(Tx,eP("udp")),xx=Xx(Rx,eP("utp")),Px=Xx(Rx,eP("quic")),Dx=Xx(Rx,eP("quic-v1")),Ox=$x(Xx(kx,eP("ws")),Xx(Cx,eP("ws"))),Nx=$x(Xx(Ox,eP("p2p")),Ox),Bx=$x(Xx(kx,eP("wss")),Xx(Cx,eP("wss")),Xx(kx,eP("tls"),eP("ws")),Xx(Cx,eP("tls"),eP("ws"))),Lx=$x(Xx(Bx,eP("p2p")),Bx),Mx=$x(Xx(kx,eP("http")),Xx(Tx,eP("http")),Xx(Cx,eP("http"))),Ux=$x(Xx(kx,eP("https")),Xx(Tx,eP("https")),Xx(Cx,eP("https"))),Fx=Xx(Rx,eP("webrtc-direct"),eP("certhash")),Kx=$x(Xx(Fx,eP("p2p")),Fx),jx=Xx(Dx,eP("webtransport"),eP("certhash"),eP("certhash")),Zx=$x(Xx(jx,eP("p2p")),jx),zx=$x(Xx(Nx,eP("p2p-webrtc-star"),eP("p2p")),Xx(Lx,eP("p2p-webrtc-star"),eP("p2p")),Xx(Nx,eP("p2p-webrtc-star")),Xx(Lx,eP("p2p-webrtc-star"))),Vx=($x(Xx(Nx,eP("p2p-websocket-star"),eP("p2p")),Xx(Lx,eP("p2p-websocket-star"),eP("p2p")),Xx(Nx,eP("p2p-websocket-star")),Xx(Lx,eP("p2p-websocket-star"))),$x(Xx(Mx,eP("p2p-webrtc-direct"),eP("p2p")),Xx(Ux,eP("p2p-webrtc-direct"),eP("p2p")),Xx(Mx,eP("p2p-webrtc-direct")),Xx(Ux,eP("p2p-webrtc-direct")))),Hx=$x(Ox,Bx,Mx,Ux,zx,Vx,kx,xx,Px,Cx,Kx,Zx),qx=($x(Xx(Hx,eP("p2p-stardust"),eP("p2p")),Xx(Hx,eP("p2p-stardust"))),$x(Xx(Hx,eP("p2p")),zx,Vx,Kx,Zx,eP("p2p"))),Gx=$x(Xx(qx,eP("p2p-circuit"),qx),Xx(qx,eP("p2p-circuit")),Xx(eP("p2p-circuit"),qx),Xx(Hx,eP("p2p-circuit")),Xx(eP("p2p-circuit"),Hx),eP("p2p-circuit")),Wx=()=>$x(Xx(Gx,Wx),Gx),Qx=Wx(),Yx=$x(Xx(Qx,qx,Qx),Xx(qx,Qx),Xx(Qx,qx),Qx,qx);$x(Xx(Qx,eP("webrtc"),eP("p2p")),Xx(Qx,eP("webrtc")),Xx(Hx,eP("webrtc"),eP("p2p")),Xx(Hx,eP("webrtc")),eP("webrtc"));function Jx(e){return function(t){let n;try{n=(0,ng.HM)(t)}catch(i){return!1}const r=e(n.protoNames());return null!==r&&(!0===r||!1===r?r:0===r.length)}}function Xx(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];function r(e){if(e.length<t.length)return null;let n=e;return t.some((t=>(n="function"===typeof t?t().partialMatch(e):t.partialMatch(e),Array.isArray(n)&&(e=n),null===n))),n}return{toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:Jx(r),partialMatch:r}}function $x(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];function r(e){let n=null;return t.some((t=>{const r="function"===typeof t?t().partialMatch(e):t.partialMatch(e);return null!=r&&(n=r,!0)})),n}return{toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:Jx(r),partialMatch:r}}function eP(e){const t=e;return{toString:function(){return t},matches:function(e){let n;try{n=(0,ng.HM)(e)}catch(i){return!1}const r=n.protoNames();return 1===r.length&&r[0]===t},partialMatch:function(e){return 0===e.length?null:e[0]===t?e.slice(1):null}}}var tP=new WeakSet;class nP extends fu.Le{constructor(e){super(),Qd(this,tP),(0,Yo.Z)(this,"connectionManager",void 0),(0,Yo.Z)(this,"relayStore",void 0),(0,Yo.Z)(this,"listeningAddrs",void 0),(0,Yo.Z)(this,"log",void 0),(0,Yo.Z)(this,"_onRemoveRelayPeer",(e=>{Yd(this,tP,rP).call(this,e.detail)})),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.relayStore=e.relayStore,this.listeningAddrs=new lx,this.relayStore.addEventListener("relay:removed",this._onRemoveRelayPeer)}async listen(e){this.log("listen on %a",e);const t=e.decapsulate("/p2p-circuit"),n=await this.connectionManager.openConnection(t);if(!this.relayStore.hasReservation(n.remotePeer))return this.log("making reservation on peer %p",n.remotePeer),void await this.relayStore.addRelay(n.remotePeer,"configured");const r=this.relayStore.getReservation(n.remotePeer);if(null==r)throw new fu.sv("Did not have reservation after making reservation","ERR_NO_RESERVATION");this.listeningAddrs.has(n.remotePeer)?this.log("already listening on relay %p",n.remotePeer):(this.listeningAddrs.set(n.remotePeer,r.addrs.map((e=>(0,ng.HM)(e).encapsulate("/p2p-circuit")))),this.safeDispatchEvent("listening",{}))}getAddrs(){return[...this.listeningAddrs.values()].flat()}async close(){}}function rP(e){const t=this.listeningAddrs.has(e);this.log("relay peer removed %p - had reservation",e,t),this.listeningAddrs.delete(e),t&&(this.log.trace("removing relay event listener for peer %p",e),this.relayStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),this.safeDispatchEvent("close",{}))}const iP=300,oP=300,sP=3e4;class aP{constructor(e,t){var n,r,i;(0,Yo.Z)(this,"discovery",void 0),(0,Yo.Z)(this,"registrar",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"connectionManager",void 0),(0,Yo.Z)(this,"transportManager",void 0),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"upgrader",void 0),(0,Yo.Z)(this,"addressManager",void 0),(0,Yo.Z)(this,"connectionGater",void 0),(0,Yo.Z)(this,"reservationStore",void 0),(0,Yo.Z)(this,"logger",void 0),(0,Yo.Z)(this,"maxInboundStopStreams",void 0),(0,Yo.Z)(this,"maxOutboundStopStreams",void 0),(0,Yo.Z)(this,"stopTimeout",void 0),(0,Yo.Z)(this,"started",void 0),(0,Yo.Z)(this,"log",void 0),(0,Yo.Z)(this,fu.SF,!0),(0,Yo.Z)(this,Symbol.toStringTag,"libp2p/circuit-relay-v2"),this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=null!==(n=t.maxInboundStopStreams)&&void 0!==n?n:iP,this.maxOutboundStopStreams=null!==(r=t.maxOutboundStopStreams)&&void 0!==r?r:oP,this.stopTimeout=null!==(i=t.stopTimeout)&&void 0!==i?i:sP,null!=t.discoverRelays&&t.discoverRelays>0&&(this.discovery=new hx(e),this.discovery.addEventListener("relay:discover",(e=>{this.reservationStore.addRelay(e.detail,"discovered").catch((t=>{this.log.error("could not add discovered relay %p",e.detail,t)}))}))),this.reservationStore=new bx(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",(()=>{var e;null===(e=this.discovery)||void 0===e||e.discover().catch((e=>{this.log.error("could not discover relays",e)}))})),this.started=!1}isStarted(){return this.started}async start(){var e;await this.reservationStore.start(),await(null===(e=this.discovery)||void 0===e?void 0:e.start()),await this.registrar.handle(ok,(e=>{this.onStop(e).catch((t=>{this.log.error("error while handling STOP protocol",t),e.stream.abort(t)}))}),{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnTransientConnection:!0}),this.started=!0}async stop(){var e;null===(e=this.discovery)||void 0===e||e.stop(),await this.reservationStore.stop(),await this.registrar.unhandle(ok),this.started=!1}async dial(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(1!==e.protoCodes().filter((e=>290===e)).length){const t="Invalid circuit relay address";throw this.log.error(t,e),new fu.sv(t,sk)}const n=e.toString().split("/p2p-circuit"),r=(0,ng.HM)(n[0]),i=(0,ng.HM)(n[n.length-1]),o=r.getPeerId(),s=i.getPeerId();if(null==o||null==s){const t="Circuit relay dial to ".concat(e.toString()," failed as address did not have peer ids");throw this.log.error(t),new fu.sv(t,sk)}const a=dI(o),c=dI(s);let l=!1;let u,h=this.connectionManager.getConnections(a)[0];null==h&&(await this.peerStore.merge(a,{multiaddrs:[r]}),h=await this.connectionManager.openConnection(a,t),l=!0);try{return u=await h.newStream(ik),await this.connectV2({stream:u,connection:h,destinationPeer:c,destinationAddr:i,relayAddr:r,ma:e,disconnectOnFailure:l})}catch(d){throw this.log.error("circuit relay dial to destination %p via relay %p failed",c,a,d),null!=u&&u.abort(d),l&&await h.close(),d}}async connectV2(e){let{stream:t,connection:n,destinationPeer:r,destinationAddr:i,relayAddr:o,ma:s,disconnectOnFailure:a}=e;try{const e=rk(t),n=e.pb(ak);await n.write({type:ak.Type.CONNECT,peer:{id:r.toBytes(),addrs:[(0,ng.HM)(i).bytes]}});const a=await n.read();var c,l;if(a.status!==dk.OK)throw new fu.sv("failed to connect via relay with status ".concat(null!==(c=null===a||void 0===a||null===(l=a.status)||void 0===l?void 0:l.toString())&&void 0!==c?c:"undefined"),"ERR_HOP_REQUEST_FAILED");const u=Ax({stream:e.unwrap(),remoteAddr:s,localAddr:o.encapsulate("/p2p-circuit/p2p/".concat(this.peerId.toString())),logger:this.logger});return this.log("new outbound transient connection %a",u.remoteAddr),await this.upgrader.upgradeOutbound(u,{transient:!0})}catch(u){throw this.log.error("Circuit relay dial to destination ".concat(r.toString()," via relay ").concat(n.remotePeer.toString()," failed"),u),a&&await n.close(),u}}createListener(e){return function(e){return new nP(e)}({connectionManager:this.connectionManager,relayStore:this.reservationStore,logger:this.logger})}filter(e){return(e=Array.isArray(e)?e:[e]).filter((e=>Qx.matches(e)))}async onStop(e){var t,n;let{connection:r,stream:i}=e;if(!this.reservationStore.hasReservation(r.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([r.remoteAddr.encapsulate("/p2p-circuit")])}catch(d){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",d)}const o=AbortSignal.timeout(this.stopTimeout),s=rk(i).pb(ck),a=await s.read({signal:o});if(this.log("new circuit relay v2 stop stream from %p with type %s",r.remotePeer,a.type),void 0===(null===a||void 0===a?void 0:a.type))return this.log.error("type was missing from circuit v2 stop protocol request from %s",r.remotePeer),await s.write({type:ck.Type.STATUS,status:dk.MALFORMED_MESSAGE},{signal:o}),void await i.close();if(a.type!==ck.Type.CONNECT)return this.log.error("invalid stop connect request via peer %p",r.remotePeer),await s.write({type:ck.Type.STATUS,status:dk.UNEXPECTED_MESSAGE},{signal:o}),void await i.close();if(!(e=>{if(null==e.peer)return!1;try{e.peer.addrs.forEach(ng.HM)}catch{return!1}return!0})(a))return this.log.error("invalid stop connect request via peer %p",r.remotePeer),await s.write({type:ck.Type.STATUS,status:dk.MALFORMED_MESSAGE},{signal:o}),void await i.close();const c=fI(a.peer.id);if(!0===await(null===(t=(n=this.connectionGater).denyInboundRelayedConnection)||void 0===t?void 0:t.call(n,r.remotePeer,c)))return this.log.error("connection gater denied inbound relayed connection from %p",r.remotePeer),await s.write({type:ck.Type.STATUS,status:dk.PERMISSION_DENIED},{signal:o}),void await i.close();this.log.trace("sending success response to %p",r.remotePeer),await s.write({type:ck.Type.STATUS,status:dk.OK},{signal:o});const l=r.remoteAddr.encapsulate("/p2p-circuit/p2p/".concat(c.toString())),u=this.addressManager.getAddresses()[0],h=Ax({stream:s.unwrap().unwrap(),remoteAddr:l,localAddr:u,logger:this.logger});this.log("new inbound transient connection %a",h.remoteAddr),await this.upgrader.upgradeInbound(h,{transient:!0}),this.log("%s connection %a upgraded","inbound",h.remoteAddr)}}function cP(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t=>new aP(t,e)}var lP=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const uP=lP,hP=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class dP{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class fP{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return gP(this,e)}}class pP{constructor(e){this.decoders=e}or(e){return gP(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const gP=(e,t)=>new pP({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class yP{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new dP(e,t,n),this.decoder=new fP(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const mP=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new yP(t,n,r,i)},vP=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=uP(r,n);return mP({prefix:t,name:n,encode:i,decode:e=>hP(o(e))})},bP=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return mP({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},wP=vP({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),EP=vP({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),AP=vP({prefix:"9",name:"base10",alphabet:"0123456789"}),SP=bP({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),_P=bP({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),IP=bP({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),CP=Array.from("\ud83d\ude80\ud83e\ude90\u2604\ud83d\udef0\ud83c\udf0c\ud83c\udf11\ud83c\udf12\ud83c\udf13\ud83c\udf14\ud83c\udf15\ud83c\udf16\ud83c\udf17\ud83c\udf18\ud83c\udf0d\ud83c\udf0f\ud83c\udf0e\ud83d\udc09\u2600\ud83d\udcbb\ud83d\udda5\ud83d\udcbe\ud83d\udcbf\ud83d\ude02\u2764\ud83d\ude0d\ud83e\udd23\ud83d\ude0a\ud83d\ude4f\ud83d\udc95\ud83d\ude2d\ud83d\ude18\ud83d\udc4d\ud83d\ude05\ud83d\udc4f\ud83d\ude01\ud83d\udd25\ud83e\udd70\ud83d\udc94\ud83d\udc96\ud83d\udc99\ud83d\ude22\ud83e\udd14\ud83d\ude06\ud83d\ude44\ud83d\udcaa\ud83d\ude09\u263a\ud83d\udc4c\ud83e\udd17\ud83d\udc9c\ud83d\ude14\ud83d\ude0e\ud83d\ude07\ud83c\udf39\ud83e\udd26\ud83c\udf89\ud83d\udc9e\u270c\u2728\ud83e\udd37\ud83d\ude31\ud83d\ude0c\ud83c\udf38\ud83d\ude4c\ud83d\ude0b\ud83d\udc97\ud83d\udc9a\ud83d\ude0f\ud83d\udc9b\ud83d\ude42\ud83d\udc93\ud83e\udd29\ud83d\ude04\ud83d\ude00\ud83d\udda4\ud83d\ude03\ud83d\udcaf\ud83d\ude48\ud83d\udc47\ud83c\udfb6\ud83d\ude12\ud83e\udd2d\u2763\ud83d\ude1c\ud83d\udc8b\ud83d\udc40\ud83d\ude2a\ud83d\ude11\ud83d\udca5\ud83d\ude4b\ud83d\ude1e\ud83d\ude29\ud83d\ude21\ud83e\udd2a\ud83d\udc4a\ud83e\udd73\ud83d\ude25\ud83e\udd24\ud83d\udc49\ud83d\udc83\ud83d\ude33\u270b\ud83d\ude1a\ud83d\ude1d\ud83d\ude34\ud83c\udf1f\ud83d\ude2c\ud83d\ude43\ud83c\udf40\ud83c\udf37\ud83d\ude3b\ud83d\ude13\u2b50\u2705\ud83e\udd7a\ud83c\udf08\ud83d\ude08\ud83e\udd18\ud83d\udca6\u2714\ud83d\ude23\ud83c\udfc3\ud83d\udc90\u2639\ud83c\udf8a\ud83d\udc98\ud83d\ude20\u261d\ud83d\ude15\ud83c\udf3a\ud83c\udf82\ud83c\udf3b\ud83d\ude10\ud83d\udd95\ud83d\udc9d\ud83d\ude4a\ud83d\ude39\ud83d\udde3\ud83d\udcab\ud83d\udc80\ud83d\udc51\ud83c\udfb5\ud83e\udd1e\ud83d\ude1b\ud83d\udd34\ud83d\ude24\ud83c\udf3c\ud83d\ude2b\u26bd\ud83e\udd19\u2615\ud83c\udfc6\ud83e\udd2b\ud83d\udc48\ud83d\ude2e\ud83d\ude46\ud83c\udf7b\ud83c\udf43\ud83d\udc36\ud83d\udc81\ud83d\ude32\ud83c\udf3f\ud83e\udde1\ud83c\udf81\u26a1\ud83c\udf1e\ud83c\udf88\u274c\u270a\ud83d\udc4b\ud83d\ude30\ud83e\udd28\ud83d\ude36\ud83e\udd1d\ud83d\udeb6\ud83d\udcb0\ud83c\udf53\ud83d\udca2\ud83e\udd1f\ud83d\ude41\ud83d\udea8\ud83d\udca8\ud83e\udd2c\u2708\ud83c\udf80\ud83c\udf7a\ud83e\udd13\ud83d\ude19\ud83d\udc9f\ud83c\udf31\ud83d\ude16\ud83d\udc76\ud83e\udd74\u25b6\u27a1\u2753\ud83d\udc8e\ud83d\udcb8\u2b07\ud83d\ude28\ud83c\udf1a\ud83e\udd8b\ud83d\ude37\ud83d\udd7a\u26a0\ud83d\ude45\ud83d\ude1f\ud83d\ude35\ud83d\udc4e\ud83e\udd32\ud83e\udd20\ud83e\udd27\ud83d\udccc\ud83d\udd35\ud83d\udc85\ud83e\uddd0\ud83d\udc3e\ud83c\udf52\ud83d\ude17\ud83e\udd11\ud83c\udf0a\ud83e\udd2f\ud83d\udc37\u260e\ud83d\udca7\ud83d\ude2f\ud83d\udc86\ud83d\udc46\ud83c\udfa4\ud83d\ude47\ud83c\udf51\u2744\ud83c\udf34\ud83d\udca3\ud83d\udc38\ud83d\udc8c\ud83d\udccd\ud83e\udd40\ud83e\udd22\ud83d\udc45\ud83d\udca1\ud83d\udca9\ud83d\udc50\ud83d\udcf8\ud83d\udc7b\ud83e\udd10\ud83e\udd2e\ud83c\udfbc\ud83e\udd75\ud83d\udea9\ud83c\udf4e\ud83c\udf4a\ud83d\udc7c\ud83d\udc8d\ud83d\udce3\ud83e\udd42"),TP=CP.reduce(((e,t,n)=>(e[n]=t,e)),[]),kP=CP.reduce(((e,t,n)=>(e[t.codePointAt(0)]=n,e)),[]);const RP=mP({prefix:"\ud83d\ude80",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+=TP[t]),"")},decode:function(e){const t=[];for(const n of e){const e=kP[n.codePointAt(0)];if(void 0===e)throw new Error("Non-base256emoji character: ".concat(n));t.push(e)}return new Uint8Array(t)}}),xP=bP({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),PP=bP({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),DP=bP({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),OP=bP({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),NP=bP({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),BP=bP({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),LP=bP({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),MP=bP({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),UP=bP({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),FP=vP({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),KP=vP({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),jP=bP({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),ZP=bP({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),zP=bP({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),VP=bP({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),HP=bP({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),qP=mP({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),GP=new TextEncoder,WP=new TextDecoder,QP="json",YP=512,JP=e=>GP.encode(JSON.stringify(e)),XP=e=>JSON.parse(WP.decode(e)),$P="raw",eD=85,tD=e=>hP(e),nD=e=>hP(e);var rD=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=sD;)n[r++]=255&t|iD,t/=128;for(;t&oD;)n[r++]=255&t|iD,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},iD=128,oD=-128,sD=Math.pow(2,31);var aD=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&lD)<<o:(r&lD)*Math.pow(2,o),o+=7}while(r>=cD);return e.bytes=s-n,i},cD=128,lD=127;var uD=Math.pow(2,7),hD=Math.pow(2,14),dD=Math.pow(2,21),fD=Math.pow(2,28),pD=Math.pow(2,35),gD=Math.pow(2,42),yD=Math.pow(2,49),mD=Math.pow(2,56),vD=Math.pow(2,63);const bD={encode:rD,decode:aD,encodingLength:function(e){return e<uD?1:e<hD?2:e<dD?3:e<fD?4:e<pD?5:e<gD?6:e<yD?7:e<mD?8:e<vD?9:10}},wD=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return[bD.decode(e,t),bD.decode.bytes]},ED=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return bD.encode(e,t,n),t},AD=e=>bD.encodingLength(e),SD=(e,t)=>{const n=t.byteLength,r=AD(e),i=r+AD(n),o=new Uint8Array(i+n);return ED(e,o,0),ED(n,o,r),o.set(t,i),new ID(e,n,t,o)},_D=e=>{const t=hP(e),[n,r]=wD(t),[i,o]=wD(t.subarray(r)),s=t.subarray(r+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new ID(n,i,s,t)};class ID{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const CD=hP,TD={code:0,name:"identity",encode:CD,digest:e=>SD(0,CD(e))},kD=e=>{let{name:t,code:n,encode:r}=e;return new RD(t,n,r)};class RD{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?SD(this.code,t):t.then((e=>SD(this.code,e)))}throw Error("Unknown type, must be binary type")}}const xD=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),PD=kD({name:"sha2-256",code:18,encode:xD("SHA-256")}),DD=kD({name:"sha2-512",code:19,encode:xD("SHA-512")}),OD=(e,t)=>{const{bytes:n,version:r}=e;return 0===r?UD(n,BD(e),t||wP.encoder):FD(n,BD(e),t||xP.encoder)},ND=new WeakMap,BD=e=>{const t=ND.get(e);if(null==t){const t=new Map;return ND.set(e,t),t}return t};class LD{constructor(e,t,n,r){this.code=t,this.version=e,this.multihash=n,this.bytes=r,this["/"]=r}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==KD)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==jD)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return LD.createV0(t)}default:throw Error("Can not convert CID version ".concat(this.version," to version 0. This is a bug please report"))}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=SD(e,t);return LD.createV1(this.code,n)}case 1:return this;default:throw Error("Can not convert CID version ".concat(this.version," to version 1. This is a bug please report"))}}equals(e){return LD.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&((e,t)=>{if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&((e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0})(e.bytes,n.bytes)}})(e.multihash,n.multihash)}toString(e){return OD(this,e)}toJSON(){return{"/":OD(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID(".concat(this.toString(),")")}static asCID(e){if(null==e)return null;const t=e;if(t instanceof LD)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:i}=t;return new LD(e,n,r,i||ZD(e,n,r.bytes))}if(!0===t[zD]){const{version:e,multihash:n,code:r}=t,i=_D(n);return LD.create(e,r,i)}return null}static create(e,t,n){if("number"!==typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==KD)throw new Error("Version 0 CID must use dag-pb (code: ".concat(KD,") block encoding"));return new LD(e,t,n,n.bytes);case 1:{const r=ZD(e,t,n.bytes);return new LD(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return LD.create(0,KD,e)}static createV1(e,t){return LD.create(1,e,t)}static decode(e){const[t,n]=LD.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=LD.inspectBytes(e),n=t.size-t.multihashSize,r=hP(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=r.subarray(t.multihashSize-t.digestSize),o=new ID(t.multihashCode,t.digestSize,i,r);return[0===t.version?LD.createV0(o):LD.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=wD(e.subarray(t));return t+=r,n};let r=n(),i=KD;if(18===r?(r=0,t=0):i=n(),0!==r&&1!==r)throw new RangeError("Invalid CID version ".concat(r));const o=t,s=n(),a=n(),c=t+a;return{version:r,codec:i,multihashCode:s,digestSize:a,multihashSize:c-o,size:c}}static parse(e,t){const[n,r]=MD(e,t),i=LD.decode(r);if(0===i.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return BD(i).set(n,e),i}}const MD=(e,t)=>{switch(e[0]){case"Q":{const n=t||wP;return[wP.prefix,n.decode("".concat(wP.prefix).concat(e))]}case wP.prefix:{const n=t||wP;return[wP.prefix,n.decode(e)]}case xP.prefix:{const n=t||xP;return[xP.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}},UD=(e,t,n)=>{const{prefix:r}=n;if(r!==wP.prefix)throw Error("Cannot string encode V0 in ".concat(n.name," encoding"));const i=t.get(r);if(null==i){const i=n.encode(e).slice(1);return t.set(r,i),i}return i},FD=(e,t,n)=>{const{prefix:r}=n,i=t.get(r);if(null==i){const i=n.encode(e);return t.set(r,i),i}return i},KD=112,jD=18,ZD=(e,t,n)=>{const r=AD(e),i=r+AD(t),o=new Uint8Array(i+n.byteLength);return ED(e,o,0),ED(t,o,r),o.set(n,i),o},zD=Symbol.for("@ipld/js-cid/CID"),VD={...tt,...Qe,...et,...Ge,...We,...Je,...Xe,...qe,...$e,...Ye},HD=Symbol.for("nodejs.util.inspect.custom"),qD=Object.values(VD).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),VD.identity.decoder),GD=114,WD=36,QD=37;class YD{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,fu.Cs,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=wP.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return LD.createV1(GD,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return function(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:qD,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=_D(wP.decode("z".concat(e)));return e.startsWith("12D")?new XD({multihash:t}):e.startsWith("16U")?new $D({multihash:t}):new JD({multihash:t})}return function(e){try{const t=_D(e);if(t.code===TD.code){if(t.digest.length===WD)return new XD({multihash:t});if(t.digest.length===QD)return new $D({multihash:t})}if(t.code===PD.code)return new JD({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==GD)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===PD.code)return new JD({multihash:e.multihash});if(t.code===TD.code){if(t.digest.length===WD)return new XD({multihash:e.multihash});if(t.digest.length===QD)return new $D({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(LD.decode(e))}throw new Error("Supplied PeerID CID is invalid")}(qD.decode(e))}(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[HD](){return"PeerId(".concat(this.toString(),")")}}class JD extends YD{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class XD extends YD{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class $D extends YD{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}async function eO(e,t){return e.length===WD?new XD({multihash:SD(TD.code,e),privateKey:t}):e.length===QD?new $D({multihash:SD(TD.code,e),privateKey:t}):new JD({multihash:await PD.digest(e),publicKey:e,privateKey:t})}var tO=n(25546),nO=n(82193),rO=n.n(nO);const iO="object"===typeof window&&"object"===typeof document&&9===document.nodeType,oO=rO()(),sO=iO&&!oO,aO=oO&&!iO,cO=oO&&iO,lO="undefined"!==typeof globalThis.process&&"undefined"!==typeof globalThis.process.release&&"node"===globalThis.process.release.name&&!oO,uO="function"===typeof importScripts&&"undefined"!==typeof self&&"undefined"!==typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,hO=("undefined"!==typeof globalThis.process&&"undefined"!==typeof globalThis.process.env&&globalThis.process.env.NODE_ENV,"undefined"!==typeof navigator&&"ReactNative"===navigator.product);var dO;!function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.protocolVersion&&(t.uint32(42),t.string(e.protocolVersion)),null!=e.agentVersion&&(t.uint32(50),t.string(e.agentVersion)),null!=e.publicKey&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.listenAddrs)for(const r of e.listenAddrs)t.uint32(18),t.bytes(r);if(null!=e.observedAddr&&(t.uint32(34),t.bytes(e.observedAddr)),null!=e.protocols)for(const r of e.protocols)t.uint32(26),t.string(r);null!=e.signedPeerRecord&&(t.uint32(66),t.bytes(e.signedPeerRecord)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={listenAddrs:[],protocols:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 5:n.protocolVersion=e.string();break;case 6:n.agentVersion=e.string();break;case 1:n.publicKey=e.bytes();break;case 2:n.listenAddrs.push(e.bytes());break;case 4:n.observedAddr=e.bytes();break;case 3:n.protocols.push(e.string());break;case 8:n.signedPeerRecord=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(dO||(dO={}));const fO=8192,pO="ipfs",gO=6e4,yO=1,mO=1,vO=1,bO=1,wO=10,EO=8192,AO=!0,SO=!0;var _O=new WeakSet;class IO{constructor(e){var t,n,r,i,o,s,a,c,l,u,h,d,f;let p=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Qd(this,_O),(0,Yo.Z)(this,"identifyProtocolStr",void 0),(0,Yo.Z)(this,"identifyPushProtocolStr",void 0),(0,Yo.Z)(this,"host",void 0),(0,Yo.Z)(this,"started",void 0),(0,Yo.Z)(this,"timeout",void 0),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"registrar",void 0),(0,Yo.Z)(this,"connectionManager",void 0),(0,Yo.Z)(this,"addressManager",void 0),(0,Yo.Z)(this,"maxInboundStreams",void 0),(0,Yo.Z)(this,"maxOutboundStreams",void 0),(0,Yo.Z)(this,"maxPushIncomingStreams",void 0),(0,Yo.Z)(this,"maxPushOutgoingStreams",void 0),(0,Yo.Z)(this,"maxIdentifyMessageSize",void 0),(0,Yo.Z)(this,"maxObservedAddresses",void 0),(0,Yo.Z)(this,"events",void 0),(0,Yo.Z)(this,"runOnTransientConnection",void 0),(0,Yo.Z)(this,"log",void 0),this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.events=e.events,this.log=e.logger.forComponent("libp2p:identify"),this.identifyProtocolStr="/".concat(null!==(t=p.protocolPrefix)&&void 0!==t?t:pO,"/").concat("id","/").concat("1.0.0"),this.identifyPushProtocolStr="/".concat(null!==(n=p.protocolPrefix)&&void 0!==n?n:pO,"/").concat("id/push","/").concat("1.0.0"),this.timeout=null!==(r=p.timeout)&&void 0!==r?r:gO,this.maxInboundStreams=null!==(i=p.maxInboundStreams)&&void 0!==i?i:yO,this.maxOutboundStreams=null!==(o=p.maxOutboundStreams)&&void 0!==o?o:mO,this.maxPushIncomingStreams=null!==(s=p.maxPushIncomingStreams)&&void 0!==s?s:vO,this.maxPushOutgoingStreams=null!==(a=p.maxPushOutgoingStreams)&&void 0!==a?a:bO,this.maxIdentifyMessageSize=null!==(c=p.maxIdentifyMessageSize)&&void 0!==c?c:EO,this.maxObservedAddresses=null!==(l=p.maxObservedAddresses)&&void 0!==l?l:wO,this.runOnTransientConnection=null!==(u=p.runOnTransientConnection)&&void 0!==u?u:SO,this.host={protocolVersion:"".concat(null!==(h=p.protocolPrefix)&&void 0!==h?h:pO,"/").concat("0.1.0"),agentVersion:null!==(d=p.agentVersion)&&void 0!==d?d:"".concat(e.nodeInfo.name,"/").concat(e.nodeInfo.version)},(null!==(f=p.runOnConnectionOpen)&&void 0!==f?f:AO)&&e.events.addEventListener("connection:open",(e=>{const t=e.detail;this.identify(t).catch((e=>{this.log.error("error during identify trigged by connection:open",e)}))})),e.events.addEventListener("self:peer:update",(e=>{this.push().catch((e=>{this.log.error(e)}))})),this.host.agentVersion==="".concat(e.nodeInfo.name,"/").concat(e.nodeInfo.version)&&(lO||aO?this.host.agentVersion+=" UserAgent=".concat(globalThis.process.version):(sO||uO||cO||hO)&&(this.host.agentVersion+=" UserAgent=".concat(globalThis.navigator.userAgent)))}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:(0,yu.m)(this.host.agentVersion),ProtocolVersion:(0,yu.m)(this.host.protocolVersion)}}),await this.registrar.handle(this.identifyProtocolStr,(e=>{this._handleIdentify(e).catch((e=>{this.log.error(e)}))}),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),await this.registrar.handle(this.identifyPushProtocolStr,(e=>{this._handlePush(e).catch((e=>{this.log.error(e)}))}),{maxInboundStreams:this.maxPushIncomingStreams,maxOutboundStreams:this.maxPushOutgoingStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.identifyProtocolStr),await this.registrar.unhandle(this.identifyPushProtocolStr),this.started=!1}async pushToConnections(e){var t,n;const r=this.addressManager.getAddresses().map((e=>e.decapsulateCode((0,ng.a_)("p2p").code))),i=new nk({peerId:this.peerId,multiaddrs:r}),o=await XT.seal(i,this.peerId),s=this.registrar.getProtocols(),a=await this.peerStore.get(this.peerId),c=(0,Au.B)(null!==(t=a.metadata.get("AgentVersion"))&&void 0!==t?t:(0,yu.m)(this.host.agentVersion)),l=(0,Au.B)(null!==(n=a.metadata.get("ProtocolVersion"))&&void 0!==n?n:(0,yu.m)(this.host.protocolVersion)),u=e.map((async e=>{let t;const n=AbortSignal.timeout(this.timeout);(0,fu.Wp)(1/0,n);try{var i;t=await e.newStream(this.identifyPushProtocolStr,{signal:n,runOnTransientConnection:this.runOnTransientConnection});const a=rk(t,{maxDataLength:null!==(i=this.maxIdentifyMessageSize)&&void 0!==i?i:fO}).pb(dO);await a.write({listenAddrs:r.map((e=>e.bytes)),signedPeerRecord:o.marshal(),protocols:s,agentVersion:c,protocolVersion:l},{signal:n}),await t.close({signal:n})}catch(u){var a;this.log.error("could not push identify update to peer",u),null===(a=t)||void 0===a||a.abort(u)}}));await Promise.all(u)}async push(){if(!this.isStarted())return;const e=[];await Promise.all(this.connectionManager.getConnections().map((async t=>{try{if(!(await this.peerStore.get(t.remotePeer)).protocols.includes(this.identifyPushProtocolStr))return;e.push(t)}catch(n){if(n.code!==fu.Vc)throw n}}))),await this.pushToConnections(e)}async _identify(e){let t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(null==n.signal){const e=AbortSignal.timeout(this.timeout);(0,fu.Wp)(1/0,e),n={...n,signal:e}}try{var r;t=await e.newStream(this.identifyProtocolStr,{...n,runOnTransientConnection:this.runOnTransientConnection});const i=rk(t,{maxDataLength:null!==(r=this.maxIdentifyMessageSize)&&void 0!==r?r:fO}).pb(dO),o=await i.read(n);return await t.close(n),o}catch(o){var i;throw this.log.error("error while reading identify message",o),null===(i=t)||void 0===i||i.abort(o),o}}async identify(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=await this._identify(e,n),{publicKey:i,protocols:o,observedAddr:s}=r;if(null==i)throw new fu.sv("public key was missing from identify message","ERR_MISSING_PUBLIC_KEY");const a=await eO(i);if(!e.remotePeer.equals(a))throw new fu.sv("identified peer does not match the expected peer","ERR_INVALID_PEER");if(this.peerId.equals(a))throw new fu.sv("identified peer is our own peer id?","ERR_INVALID_PEER");const c=function(e){if(null!=e&&e.length>0)try{return(0,ng.HM)(e)}catch{}}(s);return this.log("identify completed for peer %p and protocols %o",a,o),this.log("our observed address is %a",c),null!=c&&this.addressManager.getObservedAddrs().length<(null!==(t=this.maxObservedAddresses)&&void 0!==t?t:1/0)&&(this.log("storing our observed address %a",c),this.addressManager.addObservedAddr(c)),Yd(this,_O,CO).call(this,e,r)}async _handleIdentify(e){const{connection:t,stream:n}=e,r=AbortSignal.timeout(this.timeout);(0,fu.Wp)(1/0,r);try{var i;const e=null!==(i=this.peerId.publicKey)&&void 0!==i?i:new Uint8Array(0),o=await this.peerStore.get(this.peerId),s=this.addressManager.getAddresses().map((e=>e.decapsulateCode((0,ng.a_)("p2p").code)));let a=o.peerRecordEnvelope;if(s.length>0&&null==a){const e=new nk({peerId:this.peerId,multiaddrs:s});a=(await XT.seal(e,this.peerId)).marshal().subarray()}let c=t.remoteAddr.bytes;tO.Iq.matches(t.remoteAddr)||(c=void 0);const l=rk(n).pb(dO);await l.write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:e,listenAddrs:s.map((e=>e.bytes)),signedPeerRecord:a,observedAddr:c,protocols:o.protocols},{signal:r}),await n.close({signal:r})}catch(o){this.log.error("could not respond to identify request",o),n.abort(o)}}async _handlePush(e){const{connection:t,stream:n}=e;try{var r;if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");const e={signal:AbortSignal.timeout(this.timeout)},i=rk(n,{maxDataLength:null!==(r=this.maxIdentifyMessageSize)&&void 0!==r?r:fO}).pb(dO),o=await i.read(e);await n.close(e),await Yd(this,_O,CO).call(this,t,o)}catch(i){return this.log.error("received invalid message",i),void n.abort(i)}this.log("handled push from %p",t.remotePeer)}}async function CO(e,t){if(this.log("received identify from %p",e.remotePeer),null==t)throw new fu.sv("message was null or undefined","ERR_INVALID_MESSAGE");const n={};if(t.listenAddrs.length>0&&(n.addresses=t.listenAddrs.map((e=>({isCertified:!1,multiaddr:(0,ng.HM)(e)})))),t.protocols.length>0&&(n.protocols=t.protocols),null!=t.publicKey){n.publicKey=t.publicKey;if(!(await eO(t.publicKey)).equals(e.remotePeer))throw new fu.sv("public key did not match remote PeerId","ERR_INVALID_PUBLIC_KEY")}let r;if(null!=t.signedPeerRecord){this.log("received signedPeerRecord from %p",e.remotePeer);let i=t.signedPeerRecord;const s=await XT.openAndCertify(i,nk.DOMAIN);let a,c=nk.createFromProtobuf(s.payload);if(!c.peerId.equals(s.peerId))throw new fu.sv("signing key does not match PeerId in the PeerRecord","ERR_INVALID_SIGNING_KEY");if(!e.remotePeer.equals(c.peerId))throw new fu.sv("signing key does not match remote PeerId","ERR_INVALID_PEER_RECORD_KEY");try{a=await this.peerStore.get(c.peerId)}catch(o){if("ERR_NOT_FOUND"!==o.code)throw o}if(null!=a&&(n.metadata=a.metadata,null!=a.peerRecordEnvelope)){const e=await XT.createFromProtobuf(a.peerRecordEnvelope),t=nk.createFromProtobuf(e.payload);t.seqNumber>=c.seqNumber&&(this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",t.seqNumber,c.seqNumber),c=t,i=a.peerRecordEnvelope)}n.peerRecordEnvelope=i,n.addresses=c.multiaddrs.map((e=>({isCertified:!0,multiaddr:e}))),r={seq:c.seqNumber,addresses:c.multiaddrs}}else this.log("%p did not send a signed peer record",e.remotePeer);if(this.log("patching %p with",e.remotePeer,n),await this.peerStore.patch(e.remotePeer,n),null!=t.agentVersion||null!=t.protocolVersion){const n={};null!=t.agentVersion&&(n.AgentVersion=(0,yu.m)(t.agentVersion)),null!=t.protocolVersion&&(n.ProtocolVersion=(0,yu.m)(t.protocolVersion)),this.log("merging %p metadata",e.remotePeer,n),await this.peerStore.merge(e.remotePeer,{metadata:n})}const i={peerId:e.remotePeer,protocolVersion:t.protocolVersion,agentVersion:t.agentVersion,publicKey:t.publicKey,listenAddrs:t.listenAddrs.map((e=>(0,ng.HM)(e))),observedAddr:null==t.observedAddr?void 0:(0,ng.HM)(t.observedAddr),protocols:t.protocols,signedPeerRecord:r,connection:e};return this.events.safeDispatchEvent("peer:identify",{detail:i}),i}function TO(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t=>new IO(t,e)}var kO=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const RO=kO,xO=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class PO{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class DO{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return NO(this,e)}}class OO{constructor(e){this.decoders=e}or(e){return NO(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const NO=(e,t)=>new OO({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class BO{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new PO(e,t,n),this.decoder=new DO(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const LO=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new BO(t,n,r,i)},MO=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=RO(r,n);return LO({prefix:t,name:n,encode:i,decode:e=>xO(o(e))})},UO=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return LO({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},FO=MO({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),KO=MO({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),jO=MO({prefix:"9",name:"base10",alphabet:"0123456789"}),ZO=UO({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),zO=UO({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),VO=UO({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),HO=Array.from("\ud83d\ude80\ud83e\ude90\u2604\ud83d\udef0\ud83c\udf0c\ud83c\udf11\ud83c\udf12\ud83c\udf13\ud83c\udf14\ud83c\udf15\ud83c\udf16\ud83c\udf17\ud83c\udf18\ud83c\udf0d\ud83c\udf0f\ud83c\udf0e\ud83d\udc09\u2600\ud83d\udcbb\ud83d\udda5\ud83d\udcbe\ud83d\udcbf\ud83d\ude02\u2764\ud83d\ude0d\ud83e\udd23\ud83d\ude0a\ud83d\ude4f\ud83d\udc95\ud83d\ude2d\ud83d\ude18\ud83d\udc4d\ud83d\ude05\ud83d\udc4f\ud83d\ude01\ud83d\udd25\ud83e\udd70\ud83d\udc94\ud83d\udc96\ud83d\udc99\ud83d\ude22\ud83e\udd14\ud83d\ude06\ud83d\ude44\ud83d\udcaa\ud83d\ude09\u263a\ud83d\udc4c\ud83e\udd17\ud83d\udc9c\ud83d\ude14\ud83d\ude0e\ud83d\ude07\ud83c\udf39\ud83e\udd26\ud83c\udf89\ud83d\udc9e\u270c\u2728\ud83e\udd37\ud83d\ude31\ud83d\ude0c\ud83c\udf38\ud83d\ude4c\ud83d\ude0b\ud83d\udc97\ud83d\udc9a\ud83d\ude0f\ud83d\udc9b\ud83d\ude42\ud83d\udc93\ud83e\udd29\ud83d\ude04\ud83d\ude00\ud83d\udda4\ud83d\ude03\ud83d\udcaf\ud83d\ude48\ud83d\udc47\ud83c\udfb6\ud83d\ude12\ud83e\udd2d\u2763\ud83d\ude1c\ud83d\udc8b\ud83d\udc40\ud83d\ude2a\ud83d\ude11\ud83d\udca5\ud83d\ude4b\ud83d\ude1e\ud83d\ude29\ud83d\ude21\ud83e\udd2a\ud83d\udc4a\ud83e\udd73\ud83d\ude25\ud83e\udd24\ud83d\udc49\ud83d\udc83\ud83d\ude33\u270b\ud83d\ude1a\ud83d\ude1d\ud83d\ude34\ud83c\udf1f\ud83d\ude2c\ud83d\ude43\ud83c\udf40\ud83c\udf37\ud83d\ude3b\ud83d\ude13\u2b50\u2705\ud83e\udd7a\ud83c\udf08\ud83d\ude08\ud83e\udd18\ud83d\udca6\u2714\ud83d\ude23\ud83c\udfc3\ud83d\udc90\u2639\ud83c\udf8a\ud83d\udc98\ud83d\ude20\u261d\ud83d\ude15\ud83c\udf3a\ud83c\udf82\ud83c\udf3b\ud83d\ude10\ud83d\udd95\ud83d\udc9d\ud83d\ude4a\ud83d\ude39\ud83d\udde3\ud83d\udcab\ud83d\udc80\ud83d\udc51\ud83c\udfb5\ud83e\udd1e\ud83d\ude1b\ud83d\udd34\ud83d\ude24\ud83c\udf3c\ud83d\ude2b\u26bd\ud83e\udd19\u2615\ud83c\udfc6\ud83e\udd2b\ud83d\udc48\ud83d\ude2e\ud83d\ude46\ud83c\udf7b\ud83c\udf43\ud83d\udc36\ud83d\udc81\ud83d\ude32\ud83c\udf3f\ud83e\udde1\ud83c\udf81\u26a1\ud83c\udf1e\ud83c\udf88\u274c\u270a\ud83d\udc4b\ud83d\ude30\ud83e\udd28\ud83d\ude36\ud83e\udd1d\ud83d\udeb6\ud83d\udcb0\ud83c\udf53\ud83d\udca2\ud83e\udd1f\ud83d\ude41\ud83d\udea8\ud83d\udca8\ud83e\udd2c\u2708\ud83c\udf80\ud83c\udf7a\ud83e\udd13\ud83d\ude19\ud83d\udc9f\ud83c\udf31\ud83d\ude16\ud83d\udc76\ud83e\udd74\u25b6\u27a1\u2753\ud83d\udc8e\ud83d\udcb8\u2b07\ud83d\ude28\ud83c\udf1a\ud83e\udd8b\ud83d\ude37\ud83d\udd7a\u26a0\ud83d\ude45\ud83d\ude1f\ud83d\ude35\ud83d\udc4e\ud83e\udd32\ud83e\udd20\ud83e\udd27\ud83d\udccc\ud83d\udd35\ud83d\udc85\ud83e\uddd0\ud83d\udc3e\ud83c\udf52\ud83d\ude17\ud83e\udd11\ud83c\udf0a\ud83e\udd2f\ud83d\udc37\u260e\ud83d\udca7\ud83d\ude2f\ud83d\udc86\ud83d\udc46\ud83c\udfa4\ud83d\ude47\ud83c\udf51\u2744\ud83c\udf34\ud83d\udca3\ud83d\udc38\ud83d\udc8c\ud83d\udccd\ud83e\udd40\ud83e\udd22\ud83d\udc45\ud83d\udca1\ud83d\udca9\ud83d\udc50\ud83d\udcf8\ud83d\udc7b\ud83e\udd10\ud83e\udd2e\ud83c\udfbc\ud83e\udd75\ud83d\udea9\ud83c\udf4e\ud83c\udf4a\ud83d\udc7c\ud83d\udc8d\ud83d\udce3\ud83e\udd42"),qO=HO.reduce(((e,t,n)=>(e[n]=t,e)),[]),GO=HO.reduce(((e,t,n)=>(e[t.codePointAt(0)]=n,e)),[]);const WO=LO({prefix:"\ud83d\ude80",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+=qO[t]),"")},decode:function(e){const t=[];for(const n of e){const e=GO[n.codePointAt(0)];if(void 0===e)throw new Error("Non-base256emoji character: ".concat(n));t.push(e)}return new Uint8Array(t)}}),QO=UO({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),YO=UO({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),JO=UO({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),XO=UO({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),$O=UO({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),eN=UO({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),tN=UO({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),nN=UO({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),rN=UO({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),iN=MO({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),oN=MO({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),sN=UO({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),aN=UO({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),cN=UO({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),lN=UO({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),uN=UO({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),hN=LO({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),dN=new TextEncoder,fN=new TextDecoder,pN="json",gN=512,yN=e=>dN.encode(JSON.stringify(e)),mN=e=>JSON.parse(fN.decode(e)),vN="raw",bN=85,wN=e=>xO(e),EN=e=>xO(e);var AN=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=IN;)n[r++]=255&t|SN,t/=128;for(;t&_N;)n[r++]=255&t|SN,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},SN=128,_N=-128,IN=Math.pow(2,31);var CN=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&kN)<<o:(r&kN)*Math.pow(2,o),o+=7}while(r>=TN);return e.bytes=s-n,i},TN=128,kN=127;var RN=Math.pow(2,7),xN=Math.pow(2,14),PN=Math.pow(2,21),DN=Math.pow(2,28),ON=Math.pow(2,35),NN=Math.pow(2,42),BN=Math.pow(2,49),LN=Math.pow(2,56),MN=Math.pow(2,63);const UN={encode:AN,decode:CN,encodingLength:function(e){return e<RN?1:e<xN?2:e<PN?3:e<DN?4:e<ON?5:e<NN?6:e<BN?7:e<LN?8:e<MN?9:10}},FN=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return[UN.decode(e,t),UN.decode.bytes]},KN=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return UN.encode(e,t,n),t},jN=e=>UN.encodingLength(e),ZN=(e,t)=>{const n=t.byteLength,r=jN(e),i=r+jN(n),o=new Uint8Array(i+n);return KN(e,o,0),KN(n,o,r),o.set(t,i),new VN(e,n,t,o)},zN=e=>{const t=xO(e),[n,r]=FN(t),[i,o]=FN(t.subarray(r)),s=t.subarray(r+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new VN(n,i,s,t)};class VN{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const HN=xO,qN={code:0,name:"identity",encode:HN,digest:e=>ZN(0,HN(e))},GN=e=>{let{name:t,code:n,encode:r}=e;return new WN(t,n,r)};class WN{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?ZN(this.code,t):t.then((e=>ZN(this.code,e)))}throw Error("Unknown type, must be binary type")}}const QN=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),YN=GN({name:"sha2-256",code:18,encode:QN("SHA-256")}),JN=GN({name:"sha2-512",code:19,encode:QN("SHA-512")}),XN=(e,t)=>{const{bytes:n,version:r}=e;return 0===r?rB(n,eB(e),t||FO.encoder):iB(n,eB(e),t||QO.encoder)},$N=new WeakMap,eB=e=>{const t=$N.get(e);if(null==t){const t=new Map;return $N.set(e,t),t}return t};class tB{constructor(e,t,n,r){this.code=t,this.version=e,this.multihash=n,this.bytes=r,this["/"]=r}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==oB)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==sB)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return tB.createV0(t)}default:throw Error("Can not convert CID version ".concat(this.version," to version 0. This is a bug please report"))}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=ZN(e,t);return tB.createV1(this.code,n)}case 1:return this;default:throw Error("Can not convert CID version ".concat(this.version," to version 1. This is a bug please report"))}}equals(e){return tB.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&((e,t)=>{if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&((e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0})(e.bytes,n.bytes)}})(e.multihash,n.multihash)}toString(e){return XN(this,e)}toJSON(){return{"/":XN(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID(".concat(this.toString(),")")}static asCID(e){if(null==e)return null;const t=e;if(t instanceof tB)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:i}=t;return new tB(e,n,r,i||aB(e,n,r.bytes))}if(!0===t[cB]){const{version:e,multihash:n,code:r}=t,i=zN(n);return tB.create(e,r,i)}return null}static create(e,t,n){if("number"!==typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==oB)throw new Error("Version 0 CID must use dag-pb (code: ".concat(oB,") block encoding"));return new tB(e,t,n,n.bytes);case 1:{const r=aB(e,t,n.bytes);return new tB(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return tB.create(0,oB,e)}static createV1(e,t){return tB.create(1,e,t)}static decode(e){const[t,n]=tB.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=tB.inspectBytes(e),n=t.size-t.multihashSize,r=xO(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=r.subarray(t.multihashSize-t.digestSize),o=new VN(t.multihashCode,t.digestSize,i,r);return[0===t.version?tB.createV0(o):tB.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=FN(e.subarray(t));return t+=r,n};let r=n(),i=oB;if(18===r?(r=0,t=0):i=n(),0!==r&&1!==r)throw new RangeError("Invalid CID version ".concat(r));const o=t,s=n(),a=n(),c=t+a;return{version:r,codec:i,multihashCode:s,digestSize:a,multihashSize:c-o,size:c}}static parse(e,t){const[n,r]=nB(e,t),i=tB.decode(r);if(0===i.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return eB(i).set(n,e),i}}const nB=(e,t)=>{switch(e[0]){case"Q":{const n=t||FO;return[FO.prefix,n.decode("".concat(FO.prefix).concat(e))]}case FO.prefix:{const n=t||FO;return[FO.prefix,n.decode(e)]}case QO.prefix:{const n=t||QO;return[QO.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}},rB=(e,t,n)=>{const{prefix:r}=n;if(r!==FO.prefix)throw Error("Cannot string encode V0 in ".concat(n.name," encoding"));const i=t.get(r);if(null==i){const i=n.encode(e).slice(1);return t.set(r,i),i}return i},iB=(e,t,n)=>{const{prefix:r}=n,i=t.get(r);if(null==i){const i=n.encode(e);return t.set(r,i),i}return i},oB=112,sB=18,aB=(e,t,n)=>{const r=jN(e),i=r+jN(t),o=new Uint8Array(i+n.byteLength);return KN(e,o,0),KN(t,o,r),o.set(n,i),o},cB=Symbol.for("@ipld/js-cid/CID"),lB={...gt,...lt,...pt,...at,...ct,...ht,...dt,...st,...ft,...ut},uB=Symbol.for("nodejs.util.inspect.custom"),hB=Object.values(lB).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),lB.identity.decoder),dB=114,fB=36,pB=37;class gB{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,fu.Cs,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=FO.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return tB.createV1(dB,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return bB(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[uB](){return"PeerId(".concat(this.toString(),")")}}class yB extends gB{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class mB extends gB{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class vB extends gB{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}function bB(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:hB,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=zN(FO.decode("z".concat(e)));return e.startsWith("12D")?new mB({multihash:t}):e.startsWith("16U")?new vB({multihash:t}):new yB({multihash:t})}return function(e){try{const t=zN(e);if(t.code===qN.code){if(t.digest.length===fB)return new mB({multihash:t});if(t.digest.length===pB)return new vB({multihash:t})}if(t.code===YN.code)return new yB({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==dB)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===YN.code)return new yB({multihash:e.multihash});if(t.code===qN.code){if(t.digest.length===fB)return new mB({multihash:e.multihash});if(t.digest.length===pB)return new vB({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(tB.decode(e))}throw new Error("Supplied PeerID CID is invalid")}(hB.decode(e))}var wB;!function(e){e.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",e.ERR_DATA_CHANNEL="ERR_DATA_CHANNEL",e.ERR_CONNECTION_CLOSED="ERR_CONNECTION_CLOSED",e.ERR_HASH_NOT_SUPPORTED="ERR_HASH_NOT_SUPPORTED",e.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",e.ERR_INVALID_FINGERPRINT="ERR_INVALID_FINGERPRINT",e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",e.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",e.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS"}(wB||(wB={}));class EB extends fu.sv{constructor(e,t){super("WebRTC transport error: ".concat(e),null!==t&&void 0!==t?t:""),this.name="WebRTCTransportError"}}class AB extends EB{constructor(e,t){super("[stream: ".concat(e,"] data channel error: ").concat(t),wB.ERR_DATA_CHANNEL),this.name="WebRTC/DataChannelError"}}function SB(e,t){return new AB(e,t)}class _B extends EB{constructor(e){super("There was a problem with the Multiaddr which was passed in: ".concat(e),wB.ERR_INVALID_MULTIADDR),this.name="WebRTC/InappropriateMultiaddrError"}}function IB(e){return new _B(e)}class CB extends EB{constructor(e){super("There was a problem with a provided argument: ".concat(e),wB.ERR_INVALID_PARAMETERS),this.name="WebRTC/InvalidArgumentError"}}function TB(e){return new CB(e)}class kB extends EB{constructor(e,t){super('Invalid fingerprint "'.concat(e,'" within ').concat(t),wB.ERR_INVALID_FINGERPRINT),this.name="WebRTC/InvalidFingerprintError"}}function RB(e,t){return new kB(e,t)}class xB extends EB{constructor(e){super("A method (".concat(e,") was called though it has been intentionally left unimplemented."),wB.ERR_NOT_IMPLEMENTED),this.name="WebRTC/UnimplementedError"}}class PB extends EB{constructor(e){super("unsupported hash algorithm: ".concat(e),wB.ERR_HASH_NOT_SUPPORTED),this.name="WebRTC/UnsupportedHashAlgorithmError"}}var DB=n(1426),OB=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))},NB=function(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"},BB=function(e){this.version=e,this.type="node",this.name="node",this.os=DB.platform},LB=function(e,t,n,r){this.name=e,this.version=t,this.os=n,this.bot=r,this.type="bot-device"},MB=function(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null},UB=function(){this.type="react-native",this.name="react-native",this.version=null,this.os=null},FB=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,KB=3,jB=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/]],ZB=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function zB(e){return e?HB(e):"undefined"===typeof document&&"undefined"!==typeof navigator&&"ReactNative"===navigator.product?new UB:"undefined"!==typeof navigator?HB(navigator.userAgent):function(){var e="undefined"!==typeof DB&&DB.version;return e?new BB(DB.version.slice(1)):null}()}function VB(e){return""!==e&&jB.reduce((function(t,n){var r=n[0],i=n[1];if(t)return t;var o=i.exec(e);return!!o&&[r,o]}),!1)}function HB(e){var t=VB(e);if(!t)return null;var n=t[0],r=t[1];if("searchbot"===n)return new MB;var i=r[1]&&r[1].split(".").join("_").split("_").slice(0,3);i?i.length<KB&&(i=OB(OB([],i,!0),function(e){for(var t=[],n=0;n<e;n++)t.push("0");return t}(KB-i.length),!0)):i=[];var o=i.join("."),s=function(e){for(var t=0,n=ZB.length;t<n;t++){var r=ZB[t],i=r[0];if(r[1].exec(e))return i}return null}(e),a=FB.exec(e);return a&&a[1]?new LB(n,o,s,a[1]):new NB(n,o,s)}class qB extends Error{constructor(e){super(e),this.name="TimeoutError"}}class GB extends Error{constructor(e){super(),this.name="AbortError",this.message=e}}const WB=e=>void 0===globalThis.DOMException?new GB(e):new DOMException(e),QB=e=>{const t=void 0===e.reason?WB("This operation was aborted."):e.reason;return t instanceof Error?t:WB(t)};function YB(e,t){const{milliseconds:n,fallback:r,message:i,customTimers:o={setTimeout:setTimeout,clearTimeout:clearTimeout}}=t;let s;const a=new Promise(((a,c)=>{if("number"!==typeof n||1!==Math.sign(n))throw new TypeError("Expected `milliseconds` to be a positive number, got `".concat(n,"`"));if(t.signal){const{signal:e}=t;e.aborted&&c(QB(e)),e.addEventListener("abort",(()=>{c(QB(e))}))}if(n===Number.POSITIVE_INFINITY)return void e.then(a,c);const l=new qB;s=o.setTimeout.call(void 0,(()=>{if(r)try{a(r())}catch(t){c(t)}else"function"===typeof e.cancel&&e.cancel(),!1===i?a():i instanceof Error?c(i):(l.message=null!==i&&void 0!==i?i:"Promise timed out after ".concat(n," milliseconds"),c(l))}),n),(async()=>{try{a(await e)}catch(t){c(t)}})()})).finally((()=>{a.clear()}));return a.clear=()=>{o.clearTimeout.call(void 0,s),s=void 0},a}const JB=zB(),XB=null!=JB&&"firefox"===JB.name,$B=async function*(){},eL=async e=>{},tL=3e4;class nL{constructor(e,t){(0,Yo.Z)(this,"log",void 0),(0,Yo.Z)(this,"peerConnection",void 0),(0,Yo.Z)(this,"remoteAddr",void 0),(0,Yo.Z)(this,"timeline",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"source",$B()),(0,Yo.Z)(this,"sink",eL),this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;const n=this.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",this.peerConnection.connectionState,"initial state",n),"disconnected"!==this.peerConnection.connectionState&&"failed"!==this.peerConnection.connectionState&&"closed"!==this.peerConnection.connectionState||(this.timeline.close=Date.now())}}async close(e){var t;this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),null===(t=this.metrics)||void 0===t||t.increment({close:!0})}abort(e){var t;this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),null===(t=this.metrics)||void 0===t||t.increment({abort:!0})}}function rL(e){return null!=e[Symbol.asyncIterator]}const iL=e=>{const t=Bs.P$(e),n=(0,Us.E)(t);return Bs.cv(e,n),iL.bytes=t,n};function oL(e,t){var n,r;const i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:iL;function*o(e){const t=i(e.byteLength);t instanceof Uint8Array?yield t:yield*t,e instanceof Uint8Array?yield e:yield*e}return rL(e)?async function*(){for await(const t of e)yield*o(t)}():function*(){for(const t of e)yield*o(t)}()}iL.bytes=0,oL.single=(e,t)=>{var n,r;const i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:iL;return new Zs(i(e.byteLength),e)};var sL;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(sL||(sL={}));const aL=e=>{const t=Bs.Jx(e);return aL.bytes=Bs.P$(t),t};function cL(e,t){var n,r,i;const o=new Zs;let s=sL.LENGTH,a=-1;const c=null!==(n=null===t||void 0===t?void 0:t.lengthDecoder)&&void 0!==n?n:aL,l=null!==(r=null===t||void 0===t?void 0:t.maxLengthLength)&&void 0!==r?r:8,u=null!==(i=null===t||void 0===t?void 0:t.maxDataLength)&&void 0!==i?i:4194304;function*h(){for(;o.byteLength>0;){if(s===sL.LENGTH)try{if(a=c(o),a<0)throw Xo()(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(a>u)throw Xo()(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const e=c.bytes;o.consume(e),null!=(null===t||void 0===t?void 0:t.onLength)&&t.onLength(a),s=sL.DATA}catch(e){if(e instanceof RangeError){if(o.byteLength>l)throw Xo()(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw e}if(s===sL.DATA){if(o.byteLength<a)break;const e=o.sublist(0,a);o.consume(a),null!=(null===t||void 0===t?void 0:t.onData)&&t.onData(e),yield e,s=sL.LENGTH}}}return rL(e)?async function*(){for await(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}aL.bytes=0,cL.fromReader=(e,t)=>{let n=1;return cL(async function*(){for(;;)try{const{done:t,value:r}=await e.next(n);if(!0===t)return;null!=r&&(yield r)}catch(t){if("ERR_UNDER_READ"===t.code)return{done:!0,value:null};throw t}finally{n=1}}(),{...null!==t&&void 0!==t?t:{},onLength:e=>{n=e}})};class lL{constructor(e){if((0,Yo.Z)(this,"buffer",void 0),(0,Yo.Z)(this,"mask",void 0),(0,Yo.Z)(this,"top",void 0),(0,Yo.Z)(this,"btm",void 0),(0,Yo.Z)(this,"next",void 0),!(e>0)||0!==(e-1&e))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return void 0===this.buffer[this.btm]}}class uL{constructor(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,Yo.Z)(this,"size",void 0),(0,Yo.Z)(this,"hwm",void 0),(0,Yo.Z)(this,"head",void 0),(0,Yo.Z)(this,"tail",void 0),this.hwm=null!==(e=t.splitLimit)&&void 0!==e?e:16,this.head=new lL(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return null!=(null===e||void 0===e?void 0:e.byteLength)?e.byteLength:1}push(e){if(null!=(null===e||void 0===e?void 0:e.value)&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new lL(2*this.head.buffer.length),this.head.push(e)}}shift(){var e;let t=this.tail.shift();if(void 0===t&&null!=this.tail.next){const e=this.tail.next;this.tail.next=null,this.tail=e,t=this.tail.shift()}return null!=(null===(e=t)||void 0===e?void 0:e.value)&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}}class hL extends Error{constructor(e,t){super(null!==e&&void 0!==e?e:"The operation was aborted"),(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"code",void 0),this.type="aborted",this.code=null!==t&&void 0!==t?t:"ABORT_ERR"}}function dL(){return fL((e=>{const t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}function fL(e,t){var n;let r,i,o,s=(t=null!==(n=t)&&void 0!==n?n:{}).onEnd,a=new uL,c=Ws();const l=e=>null!=i?i(e):(a.push(e),r),u=e=>{var n;if(o)return r;if(!0!==(null===(n=t)||void 0===n?void 0:n.objectMode)&&null==(null===e||void 0===e?void 0:e.byteLength))throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:e})},h=e=>o?r:(o=!0,null!=e?(e=>(a=new uL,null!=i?i({error:e}):(a.push({error:e}),r)))(e):l({done:!0}));if(r={[Symbol.asyncIterator](){return this},next:async()=>{try{return a.isEmpty()?o?{done:!0}:await new Promise(((t,n)=>{i=o=>{i=null,a.push(o);try{t(e(a))}catch(s){n(s)}return r}})):e(a)}finally{a.isEmpty()&&queueMicrotask((()=>{c.resolve(),c=Ws()}))}},return:()=>(a=new uL,h(),{done:!0}),throw:e=>(h(e),{done:!0}),push:u,end:h,get readableLength(){return a.size},onEmpty:async e=>{const t=null===e||void 0===e?void 0:e.signal;if(null===t||void 0===t||t.throwIfAborted(),a.isEmpty())return;let n,r;null!=t&&(n=new Promise(((e,n)=>{r=()=>{n(new hL)},t.addEventListener("abort",r)})));try{await Promise.race([c.promise,n])}finally{null!=r&&null!=t&&(null===t||void 0===t||t.removeEventListener("abort",r))}}},null==s)return r;const d=r;return r={[Symbol.asyncIterator](){return this},next:()=>d.next(),throw:e=>(d.throw(e),null!=s&&(s(e),s=void 0),{done:!0}),return:()=>(d.return(),null!=s&&(s(),s=void 0),{done:!0}),push:u,end:e=>(d.end(e),null!=s&&(s(e),s=void 0),r),get readableLength(){return d.readableLength},onEmpty:e=>d.onEmpty(e)},r}const pL=e=>{const t=e.on||e.addListener||e.addEventListener,n=e.off||e.removeListener||e.removeEventListener;if(!t||!n)throw new TypeError("Emitter is not compatible");return{addListener:t.bind(e),removeListener:n.bind(e)}};function gL(e,t,n){"function"===typeof n&&(n={filter:n});const r=function(e,t,n){let r;const i=new Promise(((i,o)=>{var s;if(!((n={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...n}).count>=0)||n.count!==Number.POSITIVE_INFINITY&&!Number.isInteger(n.count))throw new TypeError("The `count` option should be at least 0 or more");null===(s=n.signal)||void 0===s||s.throwIfAborted();const a=[t].flat(),c=[],{addListener:l,removeListener:u}=pL(e),h=function(){for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];const s=n.multiArgs?t:t[0];n.filter&&!n.filter(s)||(c.push(s),n.count===c.length&&(r(),i(c)))},d=e=>{r(),o(e)};r=()=>{for(const e of a)u(e,h);for(const e of n.rejectionEvents)u(e,d)};for(const e of a)l(e,h);for(const e of n.rejectionEvents)l(e,d);n.signal&&n.signal.addEventListener("abort",(()=>{d(n.signal.reason)}),{once:!0}),n.resolveImmediately&&i(c)}));if(i.cancel=r,"number"===typeof n.timeout){const e=YB(i,{milliseconds:n.timeout});return e.cancel=r,e}return i}(e,t,n={...n,count:1,resolveImmediately:!1}),i=r.then((e=>e[0]));return i.cancel=r.cancel,i}var yL;!function(e){let t,n,r;!function(e){e.FIN="FIN",e.STOP_SENDING="STOP_SENDING",e.RESET="RESET",e.FIN_ACK="FIN_ACK"}(t=e.Flag||(e.Flag={})),function(e){e[e.FIN=0]="FIN",e[e.STOP_SENDING=1]="STOP_SENDING",e[e.RESET=2]="RESET",e[e.FIN_ACK=3]="FIN_ACK"}(n||(n={})),function(e){e.codec=()=>bs(n)}(t=e.Flag||(e.Flag={})),e.codec=()=>(null==r&&(r=ws((function(t,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.flag&&(n.uint32(8),e.Flag.codec().encode(t.flag,n)),null!=t.message&&(n.uint32(18),n.bytes(t.message)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.flag=e.Flag.codec().decode(t);break;case 2:r.message=t.bytes();break;default:t.skipType(7&n)}}return r}))),r),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(yL||(yL={}));class mL extends Ud{constructor(e){var t,n,r,i,o;const s=e.onEnd;switch(e.onEnd=e=>{this.log.trace("readable and writeable ends closed",this.status),Promise.resolve((async()=>{if(null==this.timeline.abort&&null===this.timeline.reset)try{await YB(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(e){this.log.error("error receiving FIN_ACK",e)}})).then((()=>{this.incomingData.end(),null===s||void 0===s||s(e)})).catch((e=>{this.log.error("error ending stream",e)}))},super(e),(0,Yo.Z)(this,"channel",void 0),(0,Yo.Z)(this,"incomingData",void 0),(0,Yo.Z)(this,"maxBufferedAmount",void 0),(0,Yo.Z)(this,"bufferedAmountLowEventTimeout",void 0),(0,Yo.Z)(this,"maxMessageSize",void 0),(0,Yo.Z)(this,"receiveFinAck",void 0),(0,Yo.Z)(this,"finAckTimeout",void 0),(0,Yo.Z)(this,"openTimeout",void 0),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=dL(),this.bufferedAmountLowEventTimeout=null!==(t=e.bufferedAmountLowEventTimeout)&&void 0!==t?t:3e4,this.maxBufferedAmount=null!==(n=e.maxBufferedAmount)&&void 0!==n?n:16777216,this.maxMessageSize=(null!==(r=e.maxMessageSize)&&void 0!==r?r:16384)-5-2,this.receiveFinAck=Ws(),this.finAckTimeout=null!==(i=e.closeTimeout)&&void 0!==i?i:5e3,this.openTimeout=null!==(o=e.openTimeout)&&void 0!==o?o:5e3,this.channel.readyState){case"open":this.timeline.open=(new Date).getTime();break;case"closed":case"closing":void 0!==this.timeline.close&&0!==this.timeline.close||(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new fu.sv("Unknown datachannel state","ERR_INVALID_STATE")}this.channel.onopen=e=>{this.timeline.open=(new Date).getTime()},this.channel.onclose=e=>{this.receiveFinAck.resolve(),this.close().catch((e=>{this.log.error("error closing stream after channel closed",e)}))},this.channel.onerror=e=>{const t=e.error;this.abort(t)},this.channel.onmessage=async e=>{const{data:t}=e;null!==t&&0!==t.byteLength&&this.incomingData.push(new Uint8Array(t,0,t.byteLength))};const a=this;Promise.resolve().then((async()=>{for await(const e of cL(this.incomingData)){const t=a.processIncomingProtobuf(e);null!=t&&a.sourcePush(new Zs(t))}})).catch((e=>{this.log.error("error processing incoming data channel messages",e)}))}sendNewStream(){}async _sendMessage(e){if((!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this.channel.bufferedAmount>this.maxBufferedAmount)try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await gL(this.channel,"bufferedamountlow",{timeout:this.bufferedAmountLowEventTimeout})}catch(t){if(t instanceof qB)throw new fu.sv("Timed out waiting for DataChannel buffer to clear after ".concat(this.bufferedAmountLowEventTimeout,"ms"),"ERR_BUFFER_CLEAR_TIMEOUT");throw t}if("closed"===this.channel.readyState||"closing"===this.channel.readyState)throw new fu.sv("Invalid datachannel state - ".concat(this.channel.readyState),"ERR_INVALID_STATE");"open"!==this.channel.readyState&&(this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await gL(this.channel,"open",{timeout:this.openTimeout}),this.log('channel state is now "%s", sending data',this.channel.readyState)),this.channel.send(e.subarray())}async sendData(e){for(e=e.sublist();e.byteLength>0;){const t=Math.min(e.byteLength,this.maxMessageSize),n=e.subarray(0,t),r=yL.encode({message:n}),i=oL.single(r);await this._sendMessage(i),e.consume(t)}}async sendReset(){await this._sendFlag(yL.Flag.RESET)}async sendCloseWrite(e){if(await this._sendFlag(yL.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await Ys(this.receiveFinAck.promise,null===e||void 0===e?void 0:e.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorCode:"ERR_FIN_ACK_NOT_RECEIVED"})}catch(t){this.log.error("failed to await FIN_ACK",t)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){await this._sendFlag(yL.Flag.STOP_SENDING)}processIncomingProtobuf(e){const t=yL.decode(e);if(void 0!==t.flag&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===yL.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(yL.Flag.FIN_ACK).catch((e=>{this.log.error("error sending FIN_ACK immediately",e)}))),t.flag===yL.Flag.RESET&&this.reset(),t.flag===yL.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===yL.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),"ready"===this.readStatus)return t.message}async _sendFlag(e){if("open"!==this.channel.readyState)return this.log.trace('not sending flag %s because channel is "%s" and not "open"',this.channel.readyState,e.toString()),!1;this.log.trace("sending flag %s",e.toString());const t=yL.encode({flag:e}),n=oL.single(t);try{return await this._sendMessage(n,!1),!0}catch(r){this.log.error("could not send flag %s",e.toString(),r)}return!1}}function vL(e){const{channel:t,direction:n}=e;return new mL({id:"inbound"===n?"i".concat(t.id):"r".concat(t.id),log:e.logger.forComponent("libp2p:webrtc:stream:".concat(n,":").concat(t.id)),...e})}const bL="/webrtc";class wL{constructor(e,t){var n,r;(0,Yo.Z)(this,"protocol",void 0),(0,Yo.Z)(this,"peerConnection",void 0),(0,Yo.Z)(this,"bufferedStreams",[]),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"dataChannelOptions",void 0),(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"log",void 0),this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=null!==(n=t.protocol)&&void 0!==n?n:bL,this.dataChannelOptions=null!==(r=t.dataChannelOptions)&&void 0!==r?r:{},this.log=e.logger.forComponent("libp2p:webrtc:datachannelmuxerfactory"),this.peerConnection.ondatachannel=t=>{let{channel:n}=t;if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',n.id),"init"===n.label)return this.log.trace("closing early init channel"),void n.close();const r={},i=vL({channel:n,direction:"inbound",onEnd:e=>{r.onEnd(e)},logger:e.logger,...this.dataChannelOptions});r.stream=i,r.channel=n,r.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter((e=>e.stream.id!==i.id))},this.bufferedStreams.push(r)}}createStreamMuxer(e){return new AL(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}}var EL=new WeakSet;class AL{constructor(e,t){var n,r;Qd(this,EL),(0,Yo.Z)(this,"init",void 0),(0,Yo.Z)(this,"streams",void 0),(0,Yo.Z)(this,"protocol",void 0),(0,Yo.Z)(this,"log",void 0),(0,Yo.Z)(this,"peerConnection",void 0),(0,Yo.Z)(this,"dataChannelOptions",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"logger",void 0),(0,Yo.Z)(this,"source",$B()),(0,Yo.Z)(this,"sink",eL),this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map((e=>e.stream)),this.peerConnection=t.peerConnection,this.protocol=null!==(n=t.protocol)&&void 0!==n?n:bL,this.metrics=t.metrics,this.dataChannelOptions=null!==(r=t.dataChannelOptions)&&void 0!==r?r:{},this.peerConnection.ondatachannel=e=>{var n,r;let{channel:i}=e;if(this.log.trace("incoming datachannel with channel id %d",i.id),"init"===i.label)return this.log.trace("closing init channel"),void i.close();const o=vL({channel:i,direction:"inbound",onEnd:()=>{this.log("incoming channel %s ended with state %s",i.id,i.readyState),Yd(this,EL,SL).call(this,o,i)},logger:this.logger,...this.dataChannelOptions});this.streams.push(o),null===(n=this.metrics)||void 0===n||n.increment({incoming_stream:!0}),null===t||void 0===t||null===(r=t.onIncomingStream)||void 0===r||r.call(t,o)},this.init.streams.length>0&&queueMicrotask((()=>{this.init.streams.forEach((e=>{var t,n,r;e.onEnd=()=>{this.log("incoming early channel %s ended with state %s",e.channel.id,e.channel.readyState),Yd(this,EL,SL).call(this,e.stream,e.channel)},null===(t=this.metrics)||void 0===t||t.increment({incoming_stream:!0}),null===(n=this.init)||void 0===n||null===(r=n.onIncomingStream)||void 0===r||r.call(n,e.stream)}))}))}async close(e){try{await Promise.all(this.streams.map((async t=>t.close(e))))}catch(t){this.abort(t)}}abort(e){for(const t of this.streams)t.abort(e)}newStream(){var e;const t=this.peerConnection.createDataChannel("");this.log.trace("opened outgoing datachannel with channel id %s",t.id);const n=vL({channel:t,direction:"outbound",onEnd:()=>{this.log("outgoing channel %s ended with state %s",t.id,t.readyState),Yd(this,EL,SL).call(this,n,t)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(n),null===(e=this.metrics)||void 0===e||e.increment({outgoing_stream:!0}),n}}function SL(e,t){var n,r,i;this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:tL,r=arguments.length>3?arguments[3]:void 0;"open"===e.readyState&&Promise.resolve().then((async()=>{if(e.bufferedAmount>0){r.log("%s drain channel with %d buffered bytes",t,e.bufferedAmount);const i=Ws();let o=!1;e.bufferedAmountLowThreshold=0;const s=()=>{o||(r.log("%s drain channel closed before drain",t),i.resolve())};e.addEventListener("close",s,{once:!0}),e.addEventListener("bufferedamountlow",(()=>{o=!0,e.removeEventListener("close",s),i.resolve()})),await YB(i.promise,{milliseconds:n})}})).then((async()=>{"open"===e.readyState&&e.close()})).catch((e=>{r.log.error("error closing outbound stream",e)}))}(t,"".concat(e.direction," ").concat(e.id," ").concat(e.protocol),this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter((t=>t.id!==e.id)),null===(n=this.metrics)||void 0===n||n.increment({stream_end:!0}),null===(r=this.init)||void 0===r||null===(i=r.onStreamEnd)||void 0===i||i.call(r,e)}const _L=globalThis.RTCPeerConnection,IL=globalThis.RTCSessionDescription,CL=globalThis.RTCIceCandidate;var TL;!function(e){let t,n,r;!function(e){e.SDP_OFFER="SDP_OFFER",e.SDP_ANSWER="SDP_ANSWER",e.ICE_CANDIDATE="ICE_CANDIDATE"}(t=e.Type||(e.Type={})),function(e){e[e.SDP_OFFER=0]="SDP_OFFER",e[e.SDP_ANSWER=1]="SDP_ANSWER",e[e.ICE_CANDIDATE=2]="ICE_CANDIDATE"}(n||(n={})),function(e){e.codec=()=>bs(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=ws((function(t,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.data&&(n.uint32(18),n.string(t.data)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.type=e.Type.codec().decode(t);break;case 2:r.data=t.string();break;default:t.skipType(7&n)}}return r}))),r),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(TL||(TL={}));const kL=async(e,t,n,r)=>{const i=new AbortController;e.promise.then((()=>{i.abort()}),(()=>{i.abort()}));const o=function(e){const t=new globalThis.AbortController;function n(){t.abort();for(const t of e)null!=(null===t||void 0===t?void 0:t.removeEventListener)&&t.removeEventListener("abort",n)}for(const i of e){if(!0===(null===i||void 0===i?void 0:i.aborted)){n();break}null!=(null===i||void 0===i?void 0:i.addEventListener)&&i.addEventListener("abort",n)}const r=t.signal;return r.clear=function(){for(const t of e)null!=(null===t||void 0===t?void 0:t.removeEventListener)&&t.removeEventListener("abort",n)},r}([i.signal,r.signal]),s=()=>{Ld(n.unwrap().unwrap().source,r.log)};o.addEventListener("abort",s);try{for(;;){var a;const i=await Promise.race([e.promise,n.read()]);if(null==i)break;if(i.type!==TL.Type.ICE_CANDIDATE)throw new fu.sv("ICE candidate message expected","ERR_NOT_ICE_CANDIDATE");const o=JSON.parse(null!==(a=i.data)&&void 0!==a?a:"null");if(""===o||null===o){r.log.trace("end-of-candidates received");continue}const s=new CL(o);r.log.trace("%s received new ICE candidate",r.direction,s);try{await t.addIceCandidate(s)}catch(c){r.log.error("%s bad candidate received",r.direction,o,c)}}}catch(c){r.log.error("%s error parsing ICE candidate",r.direction,c)}finally{o.removeEventListener("abort",s),o.clear()}};function RL(e,t){e[XB?"oniceconnectionstatechange":"onconnectionstatechange"]=n=>{switch(XB?e.iceConnectionState:e.connectionState){case"connected":t.resolve();break;case"failed":case"disconnected":case"closed":t.reject(new fu.sv("RTCPeerConnection was closed","ERR_CONNECTION_CLOSED_BEFORE_CONNECTED"))}}}async function xL(e){let{peerConnection:t,signal:n,metrics:r,multiaddr:i,connectionManager:o,transportManager:s,log:a}=e;const{baseAddr:c}=function(e){const t=e.toString().split(DL+"/");if(2!==t.length)throw new fu.sv("webrtc protocol was not present in multiaddr",wB.ERR_INVALID_MULTIADDR);if(!t[0].includes(OL))throw new fu.sv("p2p-circuit protocol was not present in multiaddr",wB.ERR_INVALID_MULTIADDR);let n=(0,ng.HM)(t[0]);const r=(0,ng.HM)("/"+t[1]).getPeerId();if(null==r)throw new fu.sv("destination peer id was missing",wB.ERR_INVALID_MULTIADDR);const i=n.protos().pop();if(void 0===i)throw new fu.sv("invalid multiaddr",wB.ERR_INVALID_MULTIADDR);"p2p"!==i.name&&(n=n.encapsulate("/p2p/".concat(r)));return{baseAddr:n,peerId:bB(r)}}(i);null===r||void 0===r||r.dialerEvents.increment({open:!0}),a.trace("dialing base address: %a",c);const l=c.getPeerId();if(null==l)throw new fu.sv("Relay peer was missing","ERR_INVALID_ADDRESS");const u=o.getConnections(bB(l));let h,d=!1;0===u.length?(h=await s.dial(c,{signal:n}),d=!0):h=u[0];try{const e=await h.newStream(NL,{signal:n,runOnTransientConnection:!0}),r=rk(e).pb(TL),o=Ws(),s=()=>{o.reject(new fu.sv("SDP handshake aborted","ERR_SDP_HANDSHAKE_ABORTED"))};try{RL(t,o),null===n||void 0===n||n.addEventListener("abort",s);const e=t.createDataChannel("init");t.onicecandidate=e=>{var t;let{candidate:i}=e;const o=JSON.stringify(null!==(t=null===i||void 0===i?void 0:i.toJSON())&&void 0!==t?t:null);a.trace("initiator sending ICE candidate %s",o),r.write({type:TL.Type.ICE_CANDIDATE,data:o},{signal:n}).catch((e=>{a.error("error sending ICE candidate",e)}))},t.onicecandidateerror=e=>{a("initiator ICE candidate error",e)};const c=await t.createOffer();a.trace("initiator send SDP offer %s",c.sdp),await r.write({type:TL.Type.SDP_OFFER,data:c.sdp},{signal:n}),await t.setLocalDescription(c).catch((e=>{throw a.error("could not execute setLocalDescription",e),new fu.sv("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")}));const l=await r.read({signal:n});if(l.type!==TL.Type.SDP_ANSWER)throw new fu.sv("remote should send an SDP answer","ERR_SDP_HANDSHAKE_FAILED");a.trace("initiator receive SDP answer %s",l.data);const u=new IL({type:"answer",sdp:l.data});return await t.setRemoteDescription(u).catch((e=>{throw a.error("could not execute setRemoteDescription",e),new fu.sv("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")})),a.trace("initiator read candidates until connected"),await kL(o,t,r,{direction:"initiator",signal:n,log:a}),a.trace("initiator connected, closing init channel"),e.close(),a.trace("initiator closing signalling stream"),await r.unwrap().unwrap().close({signal:n}),a.trace("initiator connected to remote address %s",i),{remoteAddress:i}}catch(f){throw t.close(),e.abort(f),f}finally{null===n||void 0===n||n.removeEventListener("abort",s),t.onicecandidate=null,t.onicecandidateerror=null}}finally{if(d)try{await h.close({signal:n})}catch(f){h.abort(f)}}}class PL extends fu.Le{constructor(e,t){super(),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"transportManager",void 0),(0,Yo.Z)(this,"shutdownController",void 0),this.peerId=e.peerId,this.transportManager=e.transportManager,this.shutdownController=t.shutdownController}async listen(){this.safeDispatchEvent("listening",{})}getAddrs(){return this.transportManager.getListeners().filter((e=>e!==this)).map((e=>e.getAddrs().filter((e=>Qx.matches(e))).map((e=>e.encapsulate("/webrtc/p2p/".concat(this.peerId)))))).flat()}async close(){this.shutdownController.abort(),this.safeDispatchEvent("close",{})}}const DL="/webrtc",OL="/p2p-circuit",NL="/webrtc-signaling/0.0.1";class BL{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"init",void 0),(0,Yo.Z)(this,"log",void 0),(0,Yo.Z)(this,"_started",!1),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"shutdownController",void 0),(0,Yo.Z)(this,Symbol.toStringTag,"@libp2p/webrtc"),(0,Yo.Z)(this,fu.SF,!0),this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}isStarted(){return this._started}async start(){await this.components.registrar.handle(NL,(e=>{this._onProtocol(e).catch((t=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,t)}))}),{runOnTransientConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(NL),this._started=!1}createListener(e){return new PL(this.components,{shutdownController:this.shutdownController})}filter(e){return e.filter(tO.uF.exactMatch)}async dial(e,t){var n;this.log.trace("dialing address: %a",e);const r=new _L(this.init.rtcConfiguration),i=new wL(this.components,{peerConnection:r,dataChannelOptions:this.init.dataChannel}),{remoteAddress:o}=await xL({peerConnection:r,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log}),s=new nL(this.components,{peerConnection:r,timeline:{open:Date.now()},remoteAddr:o,metrics:null===(n=this.metrics)||void 0===n?void 0:n.dialerEvents}),a=await t.upgrader.upgradeOutbound(s,{skipProtection:!0,skipEncryption:!0,muxerFactory:i});return this._closeOnShutdown(r,s),a}async _onProtocol(e){var t;let{connection:n,stream:r}=e;const i=AbortSignal.timeout(null!==(t=this.init.inboundConnectionTimeout)&&void 0!==t?t:3e4),o=new _L(this.init.rtcConfiguration),s=new wL(this.components,{peerConnection:o,dataChannelOptions:this.init.dataChannel});try{var a;const{remoteAddress:e}=await async function(e){let{peerConnection:t,stream:n,signal:r,connection:i,log:o}=e;o.trace("new inbound signaling stream");const s=rk(n).pb(TL);try{const e=Ws(),n=Ws();r.onabort=()=>{e.reject(new fu.sv("Timed out while trying to connect","ERR_TIMEOUT"))},t.onicecandidate=t=>{let{candidate:i}=t;n.promise.then((async()=>{var e;const t=JSON.stringify(null!==(e=null===i||void 0===i?void 0:i.toJSON())&&void 0!==e?e:null);o.trace("recipient sending ICE candidate %s",t),await s.write({type:TL.Type.ICE_CANDIDATE,data:t},{signal:r})}),(t=>{o.error("cannot set candidate since sending answer failed",t),e.reject(t)}))},RL(t,e);const i=await s.read({signal:r});var a;if(i.type!==TL.Type.SDP_OFFER)throw new fu.sv("expected message type SDP_OFFER, received: ".concat(null!==(a=i.type)&&void 0!==a?a:"undefined"," "),"ERR_SDP_HANDSHAKE_FAILED");o.trace("recipient receive SDP offer %s",i.data);const c=new IL({type:"offer",sdp:i.data});await t.setRemoteDescription(c).catch((e=>{throw o.error("could not execute setRemoteDescription",e),new fu.sv("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")}));const l=await t.createAnswer().catch((e=>{throw o.error("could not execute createAnswer",e),n.reject(e),new fu.sv("Failed to create answer","ERR_SDP_HANDSHAKE_FAILED")}));o.trace("recipient send SDP answer %s",l.sdp),await s.write({type:TL.Type.SDP_ANSWER,data:l.sdp},{signal:r}),await t.setLocalDescription(l).catch((e=>{throw o.error("could not execute setLocalDescription",e),n.reject(e),new fu.sv("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")})),n.resolve(),o.trace("recipient read candidates until connected"),await kL(e,t,s,{direction:"recipient",signal:r,log:o}),o.trace("recipient connected, closing signaling stream"),await s.unwrap().unwrap().close({signal:r})}catch(l){if("connected"!==t.connectionState)throw o.error("error while handling signaling stream from peer %a",i.remoteAddr,l),t.close(),l;o("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",i.remoteAddr,l)}const c=(0,ng.HM)("/webrtc/p2p/".concat(i.remoteAddr.getPeerId()));return o.trace("recipient connected to remote address %s",c),{remoteAddress:c}}({peerConnection:o,connection:n,stream:r,signal:i,log:this.log}),t=new nL(this.components,{peerConnection:o,timeline:{open:(new Date).getTime()},remoteAddr:e,metrics:null===(a=this.metrics)||void 0===a?void 0:a.listenerEvents});this._closeOnShutdown(o,t),await this.components.upgrader.upgradeInbound(t,{skipEncryption:!0,skipProtection:!0,muxerFactory:s}),await r.close({signal:i})}catch(c){throw r.abort(c),c}}_closeOnShutdown(e,t){const n=()=>{t.close().catch((e=>{this.log.error("could not close WebRTCMultiaddrConnection",e)}))};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",(()=>{this.shutdownController.signal.removeEventListener("abort",n)}))}}function LL(){const e=Ws();let t=!1;return{sink:async n=>{if(t)throw new Error("already piped");t=!0,e.resolve(n)},source:async function*(){const t=await e.promise;yield*t}()}}const ML=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const r=[];for(const i of t)null==i[Symbol.asyncIterator]&&r.push(i);return r.length===t.length?function*(){for(const e of r)yield*e}():async function*(){const e=dL({objectMode:!0});Promise.resolve().then((async()=>{try{await Promise.all(t.map((async t=>{for await(const n of t)e.push(n)}))),e.end()}catch(n){e.end(n)}})),yield*e}()};const UL=function(){let e;for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(;n.length>0;)e=n.shift()(e);return e},FL=e=>null!=(null===e||void 0===e?void 0:e[Symbol.asyncIterator]),KL=e=>null!=(null===e||void 0===e?void 0:e[Symbol.iterator]),jL=e=>null!=e&&(null!=e.sink&&null!=e.source),ZL=e=>t=>{const n=e.sink(t);if(null!=(null===n||void 0===n?void 0:n.then)){const t=dL({objectMode:!0});let r;n.then((()=>{t.end()}),(e=>{t.end(e)}));const i=e.source;if(FL(i))r=async function*(){yield*i,t.end()};else{if(!KL(i))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");r=function*(){yield*i,t.end()}}return ML(t,r())}return e.source};var zL,VL;const HL=65535,qL=Boolean(null===(zL=globalThis.process)||void 0===zL||null===(VL=zL.env)||void 0===VL?void 0:VL.DUMP_SESSION_KEYS),GL={hashSHA256:e=>au(e),getHKDF(e,t){const n=Xl(au,t,e),r=tu(au,n,void 0,96);return[r.subarray(0,32),r.subarray(32,64),r.subarray(64,96)]},generateX25519KeyPair(){const e=Wl.utils.randomPrivateKey();return{publicKey:Wl.getPublicKey(e),privateKey:e}},generateX25519KeyPairFromSeed:e=>({publicKey:Wl.getPublicKey(e),privateKey:e}),generateX25519SharedKey:(e,t)=>Wl.getSharedSecret(e,t),chaCha20Poly1305Encrypt:(e,t,n,r)=>lc(r,t,n).encrypt(e),chaCha20Poly1305Decrypt:(e,t,n,r,i)=>lc(r,t,n).decrypt(e,i)},WL=e=>{const t=(0,Us.E)(2);return new DataView(t.buffer,t.byteOffset,t.byteLength).setUint16(0,e,!1),t};WL.bytes=2;const QL=e=>{if(e.length<2)throw RangeError("Could not decode int16BE");return e instanceof Uint8Array?new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1):e.getUint16(0)};QL.bytes=2;class YL extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"The operation was aborted"),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"type",void 0),this.code=YL.code,this.type=YL.type}}(0,Yo.Z)(YL,"code","ABORT_ERR"),(0,Yo.Z)(YL,"type","aborted");class JL extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected Peer"),(0,Yo.Z)(this,"code",void 0),this.code=JL.code}}(0,Yo.Z)(JL,"code","ERR_UNEXPECTED_PEER");class XL extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto exchange"),(0,Yo.Z)(this,"code",void 0),this.code=XL.code}}(0,Yo.Z)(XL,"code","ERR_INVALID_CRYPTO_EXCHANGE");class $L extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto transmission"),(0,Yo.Z)(this,"code",void 0),this.code=$L.code}}(0,Yo.Z)($L,"code","ERR_INVALID_CRYPTO_TRANSMISSION");class eM extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"The operation was aborted"),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"type",void 0),this.code=eM.code,this.type=eM.type}}(0,Yo.Z)(eM,"code","ABORT_ERR"),(0,Yo.Z)(eM,"type","aborted");class tM extends Error{constructor(e,t,n){var r;super(e),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"props",void 0),this.code=t,this.name=null!==(r=null===n||void 0===n?void 0:n.name)&&void 0!==r?r:"CodeError",this.props=null!==n&&void 0!==n?n:{}}}class nM extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected Peer"),(0,Yo.Z)(this,"code",void 0),this.code=nM.code}}(0,Yo.Z)(nM,"code","ERR_UNEXPECTED_PEER");class rM extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto exchange"),(0,Yo.Z)(this,"code",void 0),this.code=rM.code}}(0,Yo.Z)(rM,"code","ERR_INVALID_CRYPTO_EXCHANGE");class iM extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto transmission"),(0,Yo.Z)(this,"code",void 0),this.code=iM.code}}(0,Yo.Z)(iM,"code","ERR_INVALID_CRYPTO_TRANSMISSION");const oM=32,sM=64,aM=32;function cM(e,t){const n=new Uint8Array(sM);for(let r=0;r<aM;r++)n[r]=e[r],n[aM+r]=t[r];return n}const lM={get(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:globalThis).crypto;if(null==e||null==e.subtle)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p-crypto/blob/master/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}},uM={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};async function hM(e,t){const n=function(e){var t,n,r,i,o,s;const a=null!==(t=null===e||void 0===e?void 0:e.algorithm)&&void 0!==t?t:"AES-GCM";let c=null!==(n=null===e||void 0===e?void 0:e.keyLength)&&void 0!==n?n:16;const l=null!==(r=null===e||void 0===e?void 0:e.nonceLength)&&void 0!==r?r:12,u=null!==(i=null===e||void 0===e?void 0:e.digest)&&void 0!==i?i:"SHA-256",h=null!==(o=null===e||void 0===e?void 0:e.saltLength)&&void 0!==o?o:16,d=null!==(s=null===e||void 0===e?void 0:e.iterations)&&void 0!==s?s:32767,f=lM.get();return c*=8,{encrypt:async function(e,t){const n=f.getRandomValues(new Uint8Array(h)),r=f.getRandomValues(new Uint8Array(l)),i={name:a,iv:r};let o;if("string"===typeof t&&(t=(0,yu.m)(t)),0===t.length){o=await f.subtle.importKey("jwk",uM,{name:"AES-GCM"},!0,["encrypt"]);try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}catch{o=await f.subtle.importKey("jwk",uM,{name:"AES-GCM"},!0,["encrypt"])}}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}const s=await f.subtle.encrypt(i,o,e);return(0,Ls.z)([n,i.iv,new Uint8Array(s)])},decrypt:async function(e,t){const n=e.subarray(0,h),r=e.subarray(h,h+l),i=e.subarray(h+l),o={name:a,iv:r};let s;if("string"===typeof t&&(t=(0,yu.m)(t)),0===t.length)try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}catch{s=await f.subtle.importKey("jwk",uM,{name:"AES-GCM"},!0,["decrypt"])}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}const p=await f.subtle.decrypt(o,s,i);return new Uint8Array(p)}}}(),r=await n.encrypt(e,t);return sN.encode(r)}var dM,fM,pM,gM;!function(e){e.RSA="RSA",e.Ed25519="Ed25519",e.Secp256k1="Secp256k1"}(dM||(dM={})),function(e){e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.Secp256k1=2]="Secp256k1"}(fM||(fM={})),function(e){e.codec=()=>bs(fM)}(dM||(dM={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),dM.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=dM.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(pM||(pM={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),dM.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=dM.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(gM||(gM={}));class yM{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=AM(e,oM)}async verify(e,t){return async function(e,t,n){return ql.verify(t,n,e)}(this._key,t,e)}marshal(){return this._key}get bytes(){return pM.encode({Type:dM.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await YN.digest(this.bytes);return e}}class mM{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=AM(e,sM),this._publicKey=AM(t,oM)}async sign(e){return async function(e,t){const n=e.subarray(0,aM);return ql.sign(t,n)}(this._key,e)}get public(){return new yM(this._publicKey)}marshal(){return this._key}get bytes(){return gM.encode({Type:dM.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await YN.digest(this.bytes);return e}async id(){const e=qN.digest(this.public.bytes);return FO.encode(e.bytes).substring(1)}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return hM(this.bytes,e);throw new tM("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function vM(e){if(e.length>sM){const t=(e=AM(e,sM+oM)).subarray(0,sM),n=e.subarray(sM,e.length);return new mM(t,n)}const t=(e=AM(e,sM)).subarray(0,sM),n=e.subarray(oM);return new mM(t,n)}function bM(e){return e=AM(e,oM),new yM(e)}async function wM(){const{privateKey:e,publicKey:t}=await async function(){const e=ql.utils.randomPrivateKey(),t=ql.getPublicKey(e);return{privateKey:cM(e,t),publicKey:t}}();return new mM(e,t)}async function EM(e){const{privateKey:t,publicKey:n}=await async function(e){if(e.length!==aM)throw new TypeError('"seed" must be 32 bytes in length.');if(!(e instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const t=e,n=ql.getPublicKey(t);return{privateKey:cM(t,n),publicKey:n}}(e);return new mM(t,n)}function AM(e,t){var n;if((e=Uint8Array.from(null!==(n=e)&&void 0!==n?n:[])).length!==t)throw new tM("Key must be a Uint8Array of length ".concat(t,", got ").concat(e.length),"ERR_INVALID_KEY_TYPE");return e}function SM(e,t){let n=Uint8Array.from(e.abs().toByteArray());if(n=0===n[0]?n.subarray(1):n,null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return(0,Au.B)(n,"base64url")}function _M(e){const t=function(e,t){let n=(0,yu.m)(e,"base64urlpad");if(null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return n}(e);return new(gu().jsbn.BigInteger)((0,Au.B)(t,"base16"),16)}const IM={"P-256":256,"P-384":384,"P-521":521};Object.keys(IM).join(" / ");function CM(e,t){return t.map((t=>_M(e[t])))}async function TM(e){const t=[await lM.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await RM(e)],n=await kM({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function kM(e){if(null==e.privateKey||null==e.publicKey)throw new tM("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([lM.get().subtle.exportKey("jwk",e.privateKey),lM.get().subtle.exportKey("jwk",e.publicKey)])}async function RM(e){return lM.get().subtle.importKey("jwk",{kty:e.kty,n:e.n,e:e.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function xM(e,t,n,r){const i=t?function(e){return gu().pki.setRsaPublicKey(...CM(e,["n","e"]))}(e):function(e){return gu().pki.setRsaPrivateKey(...CM(e,["n","e","d","p","q","dp","dq","qi"]))}(e),o=r((0,Au.B)(Uint8Array.from(n),"ascii"),i);return(0,yu.m)(o,"ascii")}function PM(e){if("RSA"!==e.kty)throw new tM("invalid key type","ERR_INVALID_KEY_TYPE");if(null==e.n)throw new tM("invalid key modulus","ERR_INVALID_KEY_MODULUS");return 8*(0,yu.m)(e.n,"base64url").length}const DM=8192;class OM{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=e}async verify(e,t){return async function(e,t,n){const r=await lM.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return lM.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,t,n)}(this._key,t,e)}marshal(){return function(e){if(null==e.n||null==e.e)throw new tM("JWK was missing components","ERR_INVALID_PARAMETERS");const t=gu().pki.publicKeyToAsn1({n:_M(e.n),e:_M(e.e)});return(0,yu.m)(gu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return pM.encode({Type:dM.RSA,Data:this.marshal()}).subarray()}encrypt(e){return xM(this._key,!0,e,((e,t)=>t.encrypt(e)))}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await YN.digest(this.bytes);return e}}class NM{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=t}genSecret(){return function(e){if(isNaN(e)||e<=0)throw new tM("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return _c(e)}(16)}async sign(e){return async function(e,t){const n=await lM.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await lM.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,Uint8Array.from(t));return new Uint8Array(r,0,r.byteLength)}(this._key,e)}get public(){if(null==this._publicKey)throw new tM("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new OM(this._publicKey)}decrypt(e){return xM(this._key,!1,e,((e,t)=>t.decrypt(e)))}marshal(){return function(e){if(null==e.n||null==e.e||null==e.d||null==e.p||null==e.q||null==e.dp||null==e.dq||null==e.qi)throw new tM("JWK was missing components","ERR_INVALID_PARAMETERS");const t=gu().pki.privateKeyToAsn1({n:_M(e.n),e:_M(e.e),d:_M(e.d),p:_M(e.p),q:_M(e.q),dP:_M(e.dp),dQ:_M(e.dq),qInv:_M(e.qi)});return(0,yu.m)(gu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return gM.encode({Type:dM.RSA,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await YN.digest(this.bytes);return e}async id(){const e=await this.public.hash();return(0,Au.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"pkcs-8";if("pkcs-8"===t){const t=new(gu().util.ByteBuffer)(this.marshal()),n=gu().asn1.fromDer(t),r=gu().pki.privateKeyFromAsn1(n),i={algorithm:"aes256",count:1e4,saltSize:16,prfAlgorithm:"sha512"};return gu().pki.encryptRsaPrivateKey(r,e,i)}if("libp2p-key"===t)return hM(this.bytes,e);throw new tM("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}async function BM(e){const t=function(e){const t=gu().asn1.fromDer((0,Au.B)(e,"ascii")),n=gu().pki.privateKeyFromAsn1(t);return{kty:"RSA",n:SM(n.n),e:SM(n.e),d:SM(n.d),p:SM(n.p),q:SM(n.q),dp:SM(n.dP),dq:SM(n.dQ),qi:SM(n.qInv),alg:"RS256"}}(e);if(PM(t)>DM)throw new tM("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const n=await TM(t);return new NM(n.privateKey,n.publicKey)}function LM(e){const t=function(e){const t=gu().asn1.fromDer((0,Au.B)(e,"ascii")),n=gu().pki.publicKeyFromAsn1(t);return{kty:"RSA",n:SM(n.n),e:SM(n.e)}}(e);if(PM(t)>DM)throw new tM("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new OM(t)}async function MM(e){if(PM(e)>DM)throw new tM("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await TM(e);return new NM(t.privateKey,t.publicKey)}async function UM(e){if(e>DM)throw new tM("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await async function(e){const t=await lM.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:e,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await kM(t);return{privateKey:n[0],publicKey:n[1]}}(e);return new NM(t.privateKey,t.publicKey)}function FM(e){try{Eh.ProjectivePoint.fromHex(e)}catch(t){throw new tM(String(t),"ERR_INVALID_PUBLIC_KEY")}}class KM{constructor(e){(0,Yo.Z)(this,"_key",void 0),FM(e),this._key=e}async verify(e,t){return async function(e,t,n){try{const{digest:r}=await YN.digest(n);return Eh.verify(t,r,e)}catch(r){throw new tM(String(r),"ERR_INVALID_INPUT")}}(this._key,t,e)}marshal(){return e=this._key,Eh.ProjectivePoint.fromHex(e).toRawBytes(!0);var e}get bytes(){return pM.encode({Type:dM.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await YN.digest(this.bytes);return e}}class jM{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=null!==t&&void 0!==t?t:function(e){try{return Eh.getPublicKey(e,!0)}catch(t){throw new tM(String(t),"ERR_INVALID_PRIVATE_KEY")}}(e),function(e){try{Eh.getPublicKey(e,!0)}catch(t){throw new tM(String(t),"ERR_INVALID_PRIVATE_KEY")}}(this._key),FM(this._publicKey)}async sign(e){return async function(e,t){const{digest:n}=await YN.digest(t);try{return Eh.sign(n,e).toDERRawBytes()}catch(r){throw new tM(String(r),"ERR_INVALID_INPUT")}}(this._key,e)}get public(){return new KM(this._publicKey)}marshal(){return this._key}get bytes(){return gM.encode({Type:dM.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await YN.digest(this.bytes);return e}async id(){const e=await this.public.hash();return(0,Au.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return hM(this.bytes,e);throw new tM("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function ZM(e){return new jM(e)}function zM(e){return new KM(e)}async function VM(){const e=Eh.utils.randomPrivateKey();return new jM(e)}const HM={rsa:Et,ed25519:wt,secp256k1:At};function qM(e){const t=Object.keys(HM).join(" / ");return new tM("invalid or unsupported key type ".concat(e,". Must be ").concat(t),"ERR_UNSUPPORTED_KEY_TYPE")}async function GM(e){var t,n;const r=gM.decode(e),i=null!==(t=r.Data)&&void 0!==t?t:new Uint8Array;switch(r.Type){case dM.RSA:return HM.rsa.unmarshalRsaPrivateKey(i);case dM.Ed25519:return HM.ed25519.unmarshalEd25519PrivateKey(i);case dM.Secp256k1:return HM.secp256k1.unmarshalSecp256k1PrivateKey(i);default:throw qM(null!==(n=r.Type)&&void 0!==n?n:"RSA")}}const WM=Symbol.for("@libp2p/peer-id");const QM=Symbol.for("nodejs.util.inspect.custom"),YM=Object.values(lB).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),lB.identity.decoder),JM=114,XM=36,$M=37;class eU{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,WM,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=FO.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return tB.createV1(JM,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return function(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:YM,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=zN(FO.decode("z".concat(e)));return e.startsWith("12D")?new nU({multihash:t}):e.startsWith("16U")?new rU({multihash:t}):new tU({multihash:t})}return function(e){try{const t=zN(e);if(t.code===qN.code){if(t.digest.length===XM)return new nU({multihash:t});if(t.digest.length===$M)return new rU({multihash:t})}if(t.code===YN.code)return new tU({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==JM)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===YN.code)return new tU({multihash:e.multihash});if(t.code===qN.code){if(t.digest.length===XM)return new nU({multihash:e.multihash});if(t.digest.length===$M)return new rU({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(tB.decode(e))}throw new Error("Supplied PeerID CID is invalid")}(YM.decode(e))}(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[QM](){return"PeerId(".concat(this.toString(),")")}}class tU extends eU{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class nU extends eU{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class rU extends eU{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}async function iU(e,t){return e.length===XM?new nU({multihash:ZN(qN.code,e),privateKey:t}):e.length===$M?new rU({multihash:ZN(qN.code,e),privateKey:t}):new tU({multihash:await YN.digest(e),publicKey:e,privateKey:t})}var oU,sU;async function aU(e,t,n){const r=await async function(e,t){if(null==e.privateKey)throw new Error("PrivateKey was missing from PeerId");return(await GM(e.privateKey)).sign(t)}(e,uU(t));if(null==e.publicKey)throw new Error("PublicKey was missing from local PeerId");return function(e,t,n){return sU.encode({identityKey:e,identitySig:t,extensions:null!==n&&void 0!==n?n:{webtransportCerthashes:[]}}).subarray()}(e.publicKey,r,n)}async function cU(e){return iU(e.identityKey)}function lU(e){return sU.decode(e)}function uU(e){const t=(0,yu.m)("noise-libp2p-static-key:");return(0,Ls.z)([t,e],t.length+e.length)}async function hU(e,t,n){const r=await iU(t.identityKey);if(!r.equals(n))throw new Error("Payload identity key ".concat(r.toString()," does not match expected remote peer ").concat(n.toString()));const i=uU(e);if(null==r.publicKey)throw new Error("PublicKey was missing from PeerId");if(null==t.identitySig)throw new Error("Signature was missing from message");const o=function(e){var t,n;const r=pM.decode(e),i=null!==(t=r.Data)&&void 0!==t?t:new Uint8Array;switch(r.Type){case dM.RSA:return HM.rsa.unmarshalRsaPublicKey(i);case dM.Ed25519:return HM.ed25519.unmarshalEd25519PublicKey(i);case dM.Secp256k1:return HM.secp256k1.unmarshalSecp256k1PublicKey(i);default:throw qM(null!==(n=r.Type)&&void 0!==n?n:"unknown")}}(r.publicKey);if(!await o.verify(i,t.identitySig))throw new Error("Static key doesn't match to peer that signed payload!");return r}function dU(e){return e instanceof Uint8Array&&32===e.length}function fU(e){let t=function(e){const t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=e,t.destroy=()=>!0,t.extend=()=>t,t}("".concat(e,":trace"));return sf().enabled("".concat(e,":trace"))&&null!=sf().names.map((e=>e.toString())).find((e=>e.includes(":trace")))&&(t=sf()("".concat(e,":trace"))),Object.assign(sf()(e),{error:sf()("".concat(e,":error")),trace:t})}!function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.webtransportCerthashes)for(const r of e.webtransportCerthashes)t.uint32(10),t.bytes(r);!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={webtransportCerthashes:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();if(t>>>3===1)n.webtransportCerthashes.push(e.bytes());else e.skipType(7&t)}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(oU||(oU={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.identityKey&&e.identityKey.byteLength>0&&(t.uint32(10),t.bytes(e.identityKey)),null!=e.identitySig&&e.identitySig.byteLength>0&&(t.uint32(18),t.bytes(e.identitySig)),null!=e.extensions&&(t.uint32(34),oU.codec().encode(e.extensions,t)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={identityKey:(0,Us.u)(0),identitySig:(0,Us.u)(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.identityKey=e.bytes();break;case 2:n.identitySig=e.bytes();break;case 4:n.extensions=oU.codec().decode(e,e.uint32());break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(sU||(sU={})),sf().formatters.b=e=>null==e?"undefined":FO.baseEncode(e),sf().formatters.t=e=>null==e?"undefined":QO.baseEncode(e),sf().formatters.m=e=>null==e?"undefined":sN.baseEncode(e),sf().formatters.p=e=>null==e?"undefined":e.toString(),sf().formatters.c=e=>null==e?"undefined":e.toString(),sf().formatters.k=e=>null==e?"undefined":e.toString(),sf().formatters.a=e=>null==e?"undefined":e.toString();const pU=fU("libp2p:noise");let gU;function yU(e){e?(gU("LOCAL_PUBLIC_EPHEMERAL_KEY ".concat((0,Au.B)(e.publicKey,"hex"))),gU("LOCAL_PRIVATE_EPHEMERAL_KEY ".concat((0,Au.B)(e.privateKey,"hex")))):gU("Missing local ephemeral keys.")}function mU(e){gU("REMOTE_EPHEMERAL_PUBLIC_KEY ".concat((0,Au.B)(e,"hex")))}gU=qL?pU:Object.assign((()=>{}),{enabled:!1,trace:()=>{},error:()=>{}});class vU{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;(0,Yo.Z)(this,"n",void 0),(0,Yo.Z)(this,"bytes",void 0),(0,Yo.Z)(this,"view",void 0),this.n=e,this.bytes=(0,Us.u)(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>4294967295)throw new Error("Cipherstate has reached maximum n, a new handshake must be performed")}}class bU{constructor(e){(0,Yo.Z)(this,"crypto",void 0),this.crypto=e}encryptWithAd(e,t,n){const r=this.encrypt(e.k,e.n,t,n);return e.n.increment(),r}decryptWithAd(e,t,n,r){const{plaintext:i,valid:o}=this.decrypt(e.k,e.n,t,n,r);return o&&e.n.increment(),{plaintext:i,valid:o}}hasKey(e){return!this.isEmptyKey(e.k)}createEmptyKey(){return(0,Us.u)(32)}isEmptyKey(e){const t=this.createEmptyKey();return(0,Ms.f)(t,e)}encrypt(e,t,n,r){return t.assertValue(),this.crypto.chaCha20Poly1305Encrypt(r,t.getBytes(),n,e)}encryptAndHash(e,t){let n;return n=this.hasKey(e.cs)?this.encryptWithAd(e.cs,e.h,t):t,this.mixHash(e,n),n}decrypt(e,t,n,r,i){t.assertValue();const o=this.crypto.chaCha20Poly1305Decrypt(r,t.getBytes(),n,e,i);return o?{plaintext:o,valid:!0}:{plaintext:(0,Us.u)(0),valid:!1}}decryptAndHash(e,t){let n,r=!0;return this.hasKey(e.cs)?({plaintext:n,valid:r}=this.decryptWithAd(e.cs,e.h,t)):n=t,this.mixHash(e,t),{plaintext:n,valid:r}}dh(e,t){try{const n=this.crypto.generateX25519SharedKey(e,t);return 32===n.length?n:n.subarray(0,32)}catch(n){const e=n;return pU.error(e),(0,Us.u)(32)}}mixHash(e,t){e.h=this.getHash(e.h,t)}getHash(e,t){return this.crypto.hashSHA256((0,Ls.z)([e,t],e.length+t.length))}mixKey(e,t){const[n,r]=this.crypto.getHKDF(e.ck,t);e.cs=this.initializeKey(r),e.ck=n}initializeKey(e){return{k:e,n:new vU}}initializeSymmetric(e){const t=(0,Xh.mL)(e,"utf-8"),n=this.hashProtocolName(t),r=n,i=this.createEmptyKey();return{cs:this.initializeKey(i),ck:r,h:n}}hashProtocolName(e){if(e.length<=32){const t=(0,Us.u)(32);return t.set(e),t}return this.getHash(e,(0,Us.u)(0))}split(e){const[t,n]=this.crypto.getHKDF(e.ck,(0,Us.u)(0));return{cs1:this.initializeKey(t),cs2:this.initializeKey(n)}}writeMessageRegular(e,t){const n=this.encryptWithAd(e,(0,Us.u)(0),t);return{ne:this.createEmptyKey(),ns:(0,Us.u)(0),ciphertext:n}}readMessageRegular(e,t){return this.decryptWithAd(e,(0,Us.u)(0),t.ciphertext)}}class wU extends bU{initializeInitiator(e,t,n,r){const i=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");this.mixHash(i,e);return{ss:i,s:t,rs:n,psk:r,re:(0,Us.u)(32)}}initializeResponder(e,t,n,r){const i=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");this.mixHash(i,e);return{ss:i,s:t,rs:n,psk:r,re:(0,Us.u)(32)}}writeMessageA(e,t,n){const r=(0,Us.u)(0);e.e=void 0!==n?n:this.crypto.generateX25519KeyPair();const i=e.e.publicKey;this.mixHash(e.ss,i);return{ne:i,ns:r,ciphertext:this.encryptAndHash(e.ss,t)}}writeMessageB(e,t){e.e=this.crypto.generateX25519KeyPair();const n=e.e.publicKey;this.mixHash(e.ss,n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));const r=e.s.publicKey,i=this.encryptAndHash(e.ss,r);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));return{ne:n,ns:i,ciphertext:this.encryptAndHash(e.ss,t)}}writeMessageC(e,t){const n=e.s.publicKey,r=this.encryptAndHash(e.ss,n);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));const i=this.encryptAndHash(e.ss,t),o={ne:this.createEmptyKey(),ns:r,ciphertext:i},{cs1:s,cs2:a}=this.split(e.ss);return{h:e.ss.h,messageBuffer:o,cs1:s,cs2:a}}readMessageA(e,t){return dU(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),this.decryptAndHash(e.ss,t.ciphertext)}readMessageB(e,t){if(dU(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));const{plaintext:n,valid:r}=this.decryptAndHash(e.ss,t.ns);r&&dU(n)&&(e.rs=n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));const{plaintext:i,valid:o}=this.decryptAndHash(e.ss,t.ciphertext);return{plaintext:i,valid:r&&o}}readMessageC(e,t){const{plaintext:n,valid:r}=this.decryptAndHash(e.ss,t.ns);if(r&&dU(n)&&(e.rs=n),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));const{plaintext:i,valid:o}=this.decryptAndHash(e.ss,t.ciphertext),{cs1:s,cs2:a}=this.split(e.ss);return{h:e.ss.h,plaintext:i,valid:r&&o,cs1:s,cs2:a}}initSession(e,t,n){const r=this.createEmptyKey(),i=(0,Us.u)(32);let o;return o=e?this.initializeInitiator(t,n,i,r):this.initializeResponder(t,n,i,r),{hs:o,i:e,mc:0}}sendMessage(e,t,n){let r;if(0===e.mc)r=this.writeMessageA(e.hs,t,n);else if(1===e.mc)r=this.writeMessageB(e.hs,t);else if(2===e.mc){const{h:n,messageBuffer:i,cs1:o,cs2:s}=this.writeMessageC(e.hs,t);r=i,e.h=n,e.cs1=o,e.cs2=s}else{if(!(e.mc>2))throw new Error("Session invalid.");if(e.i){if(!e.cs1)throw new Error("CS1 (cipher state) is not defined");r=this.writeMessageRegular(e.cs1,t)}else{if(!e.cs2)throw new Error("CS2 (cipher state) is not defined");r=this.writeMessageRegular(e.cs2,t)}}return e.mc++,r}recvMessage(e,t){let n=(0,Us.u)(0),r=!1;if(0===e.mc)({plaintext:n,valid:r}=this.readMessageA(e.hs,t));else if(1===e.mc)({plaintext:n,valid:r}=this.readMessageB(e.hs,t));else if(2===e.mc){const{h:i,plaintext:o,valid:s,cs1:a,cs2:c}=this.readMessageC(e.hs,t);n=o,r=s,e.h=i,e.cs1=a,e.cs2=c}return e.mc++,{plaintext:n,valid:r}}}class EU{constructor(e,t,n,r,i,o,s,a){(0,Yo.Z)(this,"isInitiator",void 0),(0,Yo.Z)(this,"session",void 0),(0,Yo.Z)(this,"remotePeer",void 0),(0,Yo.Z)(this,"remoteExtensions",{webtransportCerthashes:[]}),(0,Yo.Z)(this,"payload",void 0),(0,Yo.Z)(this,"connection",void 0),(0,Yo.Z)(this,"xx",void 0),(0,Yo.Z)(this,"staticKeypair",void 0),(0,Yo.Z)(this,"prologue",void 0),this.isInitiator=e,this.payload=t,this.prologue=n,this.staticKeypair=i,this.connection=o,s&&(this.remotePeer=s),this.xx=null!==a&&void 0!==a?a:new wU(r),this.session=this.xx.initSession(this.isInitiator,this.prologue,this.staticKeypair)}async propose(){var e;if(e=this.session.hs.s,gU("LOCAL_STATIC_PUBLIC_KEY ".concat((0,Au.B)(e.publicKey,"hex"))),gU("LOCAL_STATIC_PRIVATE_KEY ".concat((0,Au.B)(e.privateKey,"hex"))),this.isInitiator){pU.trace("Stage 0 - Initiator starting to send first message.");const e=this.xx.sendMessage(this.session,(0,Us.u)(0));await this.connection.write(function(e){return(0,Ls.z)([e.ne,e.ciphertext],e.ne.length+e.ciphertext.length)}(e)),pU.trace("Stage 0 - Initiator finished sending first message."),yU(this.session.hs.e)}else{pU.trace("Stage 0 - Responder waiting to receive first message...");const e=function(e){if(e.length<32)throw new Error("Cannot decode stage 0 MessageBuffer: length less than 32 bytes.");return{ne:e.subarray(0,32),ciphertext:e.subarray(32,e.length),ns:(0,Us.u)(0)}}((await this.connection.read()).subarray()),{valid:t}=this.xx.recvMessage(this.session,e);if(!t)throw new XL("xx handshake stage 0 validation fail");pU.trace("Stage 0 - Responder received first message."),mU(this.session.hs.re)}}async exchange(){if(this.isInitiator){pU.trace("Stage 1 - Initiator waiting to receive first message from responder...");const n=function(e){if(e.length<80)throw new Error("Cannot decode stage 1 MessageBuffer: length less than 80 bytes.");return{ne:e.subarray(0,32),ns:e.subarray(32,80),ciphertext:e.subarray(80,e.length)}}((await this.connection.read()).subarray()),{plaintext:r,valid:i}=this.xx.recvMessage(this.session,n);if(!i)throw new XL("xx handshake stage 1 validation fail");pU.trace("Stage 1 - Initiator received the message."),mU(this.session.hs.re),e=this.session.hs.rs,gU("REMOTE_STATIC_PUBLIC_KEY ".concat((0,Au.B)(e,"hex"))),pU.trace("Initiator going to check remote's signature...");try{const e=lU(r);this.remotePeer=this.remotePeer||await cU(e),await hU(this.session.hs.rs,e,this.remotePeer),this.setRemoteNoiseExtension(e.extensions)}catch(t){throw new JL("Error occurred while verifying signed payload: ".concat(t.message))}pU.trace("All good with the signature!")}else{pU.trace("Stage 1 - Responder sending out first message with signed payload and static key.");const e=this.xx.sendMessage(this.session,this.payload);await this.connection.write(function(e){return(0,Ls.z)([e.ne,e.ns,e.ciphertext],e.ne.length+e.ns.length+e.ciphertext.length)}(e)),pU.trace("Stage 1 - Responder sent the second handshake message with signed payload."),yU(this.session.hs.e)}var e}async finish(){if(this.isInitiator){pU.trace("Stage 2 - Initiator sending third handshake message.");const e=this.xx.sendMessage(this.session,this.payload);await this.connection.write(function(e){return(0,Ls.z)([e.ns,e.ciphertext],e.ns.length+e.ciphertext.length)}(e)),pU.trace("Stage 2 - Initiator sent message with signed payload.")}else{pU.trace("Stage 2 - Responder waiting for third handshake message...");const e=function(e){if(e.length<48)throw new Error("Cannot decode stage 2 MessageBuffer: length less than 48 bytes.");return{ne:(0,Us.u)(0),ns:e.subarray(0,48),ciphertext:e.subarray(48,e.length)}}((await this.connection.read()).subarray()),{plaintext:n,valid:r}=this.xx.recvMessage(this.session,e);if(!r)throw new XL("xx handshake stage 2 validation fail");pU.trace("Stage 2 - Responder received the message, finished handshake.");try{const e=lU(n);this.remotePeer=this.remotePeer||await cU(e),await hU(this.session.hs.rs,e,this.remotePeer),this.setRemoteNoiseExtension(e.extensions)}catch(t){throw new JL("Error occurred while verifying signed payload: ".concat(t.message))}}var e;(e=this.session).cs1&&e.cs2?(gU("CIPHER_STATE_1 ".concat(e.cs1.n.getUint64()," ").concat((0,Au.B)(e.cs1.k,"hex"))),gU("CIPHER_STATE_2 ".concat(e.cs2.n.getUint64()," ").concat((0,Au.B)(e.cs2.k,"hex")))):gU("Missing cipher state.")}encrypt(e,t){const n=this.getCS(t);return this.xx.encryptWithAd(n,(0,Us.u)(0),e)}decrypt(e,t,n){const r=this.getCS(t,!1);return this.xx.decryptWithAd(r,(0,Us.u)(0),e,n)}getRemoteStaticKey(){return this.session.hs.rs}getCS(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!e.cs1||!e.cs2)throw new XL("Handshake not completed properly, cipher state does not exist.");return this.isInitiator?t?e.cs1:e.cs2:t?e.cs2:e.cs1}setRemoteNoiseExtension(e){e&&(this.remoteExtensions=e)}}class AU{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,Yo.Z)(this,"protocol","/noise"),(0,Yo.Z)(this,"crypto",void 0),(0,Yo.Z)(this,"prologue",void 0),(0,Yo.Z)(this,"staticKeys",void 0),(0,Yo.Z)(this,"extensions",void 0),(0,Yo.Z)(this,"metrics",void 0);const{staticNoiseKey:t,extensions:n,crypto:r,prologueBytes:i,metrics:o}=e;this.crypto=null!==r&&void 0!==r?r:GL,this.extensions=n,this.metrics=o?function(e){return{xxHandshakeSuccesses:e.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:e.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:e.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:e.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:e.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}(o):void 0,this.staticKeys=t?this.crypto.generateX25519KeyPairFromSeed(t):this.crypto.generateX25519KeyPair(),this.prologue=null!==i&&void 0!==i?i:(0,Us.u)(0)}async secureOutbound(e,t,n){const r=la(t,{lengthEncoder:WL,lengthDecoder:QL,maxDataLength:HL}),i=await this.performHandshake({connection:r,isInitiator:!0,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(r,i),remoteExtensions:i.remoteExtensions,remotePeer:i.remotePeer}}async secureInbound(e,t,n){const r=la(t,{lengthEncoder:WL,lengthDecoder:QL,maxDataLength:HL}),i=await this.performHandshake({connection:r,isInitiator:!1,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(r,i),remotePeer:i.remotePeer,remoteExtensions:i.remoteExtensions}}async performHandshake(e){const t=await aU(e.localPeer,this.staticKeys.publicKey,this.extensions);return this.performXXHandshake(e,t)}async performXXHandshake(e,t){const{isInitiator:n,remotePeer:r,connection:i}=e,o=new EU(n,t,this.prologue,this.crypto,this.staticKeys,i,r);try{var s;await o.propose(),await o.exchange(),await o.finish(),null===(s=this.metrics)||void 0===s||s.xxHandshakeSuccesses.increment()}catch(c){var a;if(null===(a=this.metrics)||void 0===a||a.xxHandshakeErrors.increment(),c instanceof Error)throw c.message="Error occurred during XX handshake: ".concat(c.message),c}return o}async createSecureConnection(e,t){const[n,r]=function(){const e=LL(),t=LL();return[{source:e.source,sink:t.sink},{source:t.source,sink:e.sink}]}(),i=e.unwrap();return await function(e){if(null==e)throw new Error("Empty pipeline");if(jL(e)){const t=e;e=()=>t.source}else if(KL(e)||FL(e)){const t=e;e=()=>t}for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];const i=[e,...n];if(i.length>1&&jL(i[i.length-1])&&(i[i.length-1]=i[i.length-1].sink),i.length>2)for(let o=1;o<i.length-1;o++)jL(i[o])&&(i[o]=ZL(i[o]));return UL(...i)}(n,function(e,t){return async function*(n){for await(const r of n)for(let n=0;n<r.length;n+=65519){let i=n+65519;i>r.length&&(i=r.length);const o=e.encrypt(r.subarray(n,i),e.session);null===t||void 0===t||t.encryptedPackets.increment(),yield(0,Xh.zo)([WL(o.byteLength),o],2+o.byteLength)}}}(t,this.metrics),i,(e=>cL(e,{lengthDecoder:QL})),function(e,t){return async function*(n){for await(const r of n)for(let n=0;n<r.length;n+=HL){let i=n+HL;if(i>r.length&&(i=r.length),i-16<n)throw new Error("Invalid chunk");const o=r.subarray(n,i),s=r.subarray(n,i-16),{plaintext:a,valid:c}=e.decrypt(o,e.session,s);if(!c)throw null===t||void 0===t||t.decryptErrors.increment(),new Error("Failed to validate decrypted chunk");null===t||void 0===t||t.decryptedPackets.increment(),yield a}}}(t,this.metrics),n),r}}var SU=n(53765);const _U=Object.values(lB).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)));function IU(e,t){var n;const r=null===(n=e.getConfiguration().certificates)||void 0===n?void 0:n.at(0);if(null==r||null==r.getFingerprints){t.log.trace("fetching fingerprint from local SDP");const n=e.localDescription;if(null==n)return;return function(e){var t;const n=e.match(CU);return null===n||void 0===n||null===(t=n.groups)||void 0===t?void 0:t.fingerprint}(n.sdp)}if(t.log.trace("fetching fingerprint from local certificate"),0===r.getFingerprints().length)return;const i=r.getFingerprints()[0].value;if(null==i)throw RB("","no fingerprint on local certificate");return i}const CU=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function TU(e){const t=e.stringTuples().filter((e=>e[0]===DU)).map((e=>e[1]))[0];if(void 0===t||""===t)throw IB("Couldn't find a certhash component of multiaddr: ".concat(e.toString()));return t}function kU(e){const t=_U.decode(e);return SU.decode(t)}function RU(e){switch(e){case"sha1":return"sha-1";case"sha2-256":return"sha-256";case"sha2-512":return"sha-512";default:throw new PB(e)}}function xU(e,t){const{host:n,port:r}=e.toOptions(),i=function(e){for(const t of e.protoNames())if(t.startsWith("ip"))return t.toUpperCase();return"IP6"}(e),[o]=function(e){const t=kU(TU(e)),n=RU(t.name),r=t.digest.reduce(((e,t)=>e+t.toString(16).padStart(2,"0")),""),i=r.match(/.{1,2}/g);if(null==i)throw RB(r,e.toString());return["".concat(n.toUpperCase()," ").concat(i.join(":").toUpperCase()),r]}(e);return"v=0\no=- 0 0 IN ".concat(i," ").concat(n,"\ns=-\nc=IN ").concat(i," ").concat(n,"\nt=0 0\na=ice-lite\nm=application ").concat(r," UDP/DTLS/SCTP webrtc-datachannel\na=mid:0\na=setup:passive\na=ice-ufrag:").concat(t,"\na=ice-pwd:").concat(t,"\na=fingerprint:").concat(o,"\na=sctp-port:5000\na=max-message-size:16384\na=candidate:1467250027 1 UDP 1467250027 ").concat(n," ").concat(r," typ host\r\n")}const PU=Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),DU=((0,ng.a_)("webrtc-direct").code,(0,ng.a_)("certhash").code);class OU{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"log",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"init",void 0),(0,Yo.Z)(this,Symbol.toStringTag,"@libp2p/webrtc-direct"),(0,Yo.Z)(this,fu.SF,!0),this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}async dial(e,t){const n=await this._connect(e,t);return this.log("dialing address: %a",e),n}createListener(e){throw new xB("WebRTCTransport.createListener")}filter(e){return e.filter(tO.Ih.exactMatch)}async _connect(e,t){const n=new AbortController,r=n.signal,i=e.getPeerId();if(null===i)throw IB("we need to have the remote's PeerId");const o=bB(i),s=kU(TU(e)),a=await _L.generateCertificate({name:"ECDSA",namedCurve:"P-256",hash:RU(s.name)}),c=new _L({certificates:[a]});try{var l,u,h,d;const i=new Promise(((e,t)=>{const n=c.createDataChannel("",{negotiated:!0,id:0}),r=setTimeout((()=>{var e;const r="Data channel was never opened: state: ".concat(n.readyState);this.log.error(r),null===(e=this.metrics)||void 0===e||e.dialerEvents.increment({open_error:!0}),t(SB("data",r))}),1e4);n.onopen=t=>{clearTimeout(r),e(n)},n.onerror=e=>{var n,i,o;clearTimeout(r);const s=null!==(n=null===(i=e.target)||void 0===i?void 0:i.toString())&&void 0!==n?n:"not specified",a="Error opening a data channel for handshaking: ".concat(s);this.log.error(a),null===(o=this.metrics)||void 0===o||o.dialerEvents.increment({unknown_error:!0}),t(SB("data",a))}})),a="libp2p+webrtc+v1/"+[...Array(32)].map((()=>PU.at(Math.floor(Math.random()*PU.length)))).join(""),f=function(e,t){if(void 0===e.sdp)throw TB("Can't munge a missing SDP");return e.sdp=e.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,"\na=ice-ufrag:"+t+"\n").replace(/\na=ice-pwd:[^\n]*\n/,"\na=ice-pwd:"+t+"\n"),e}(await c.createOffer(),a);await c.setLocalDescription(f);const p=function(e,t){return{type:"answer",sdp:xU(e,t)}}(e,a);await c.setRemoteDescription(p);const g=await i,y=this.components.peerId,m=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return()=>new AU(e)}({prologueBytes:this.generateNoisePrologue(c,s.code,e)})(),v=vL({channel:g,direction:"inbound",logger:this.components.logger,...null!==(l=this.init.dataChannel)&&void 0!==l?l:{}}),b={...v,sink:v.sink.bind(v),source:async function*(){for await(const e of v.source)for(const t of e)yield t}()},w=new nL(this.components,{peerConnection:c,remoteAddr:e,timeline:{open:Date.now()},metrics:null===(u=this.metrics)||void 0===u?void 0:u.dialerEvents}),E=XB?"iceconnectionstatechange":"connectionstatechange";c.addEventListener(E,(()=>{switch(c.connectionState){case"failed":case"disconnected":case"closed":w.close().catch((e=>{this.log.error("error closing connection",e)})).finally((()=>{n.abort()}))}}),{signal:r}),null===(h=this.metrics)||void 0===h||h.dialerEvents.increment({peer_connection:!0});const A=new wL(this.components,{peerConnection:c,metrics:null===(d=this.metrics)||void 0===d?void 0:d.dialerEvents,dataChannelOptions:this.init.dataChannel});return await m.secureInbound(y,b,o),await t.upgrader.upgradeOutbound(w,{skipProtection:!0,skipEncryption:!0,muxerFactory:A})}catch(f){throw c.close(),f}}generateNoisePrologue(e,t,n){var r;if(0===(null===(r=e.getConfiguration().certificates)||void 0===r?void 0:r.length))throw TB("no local certificate");const i=IU(e,{log:this.log});if(null==i)throw TB("no local fingerprint found");const o=i.trim().toLowerCase().replaceAll(":",""),s=(0,yu.m)(o,"hex"),a=SU.encode(s,t),c=_U.decode(TU(n)),l=(0,yu.m)("libp2p-webrtc-noise:");return(0,Ls.z)([l,a,c])}}function NU(e){return t=>new OU(t,e)}class BU extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"The operation was aborted"),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"type",void 0),this.code=BU.code,this.type=BU.type}}(0,Yo.Z)(BU,"code","ABORT_ERR"),(0,Yo.Z)(BU,"type","aborted");class LU extends Error{constructor(e,t,n){var r;super(e),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"props",void 0),this.code=t,this.name=null!==(r=null===n||void 0===n?void 0:n.name)&&void 0!==r?r:"CodeError",this.props=null!==n&&void 0!==n?n:{}}}class MU extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected Peer"),(0,Yo.Z)(this,"code",void 0),this.code=MU.code}}(0,Yo.Z)(MU,"code","ERR_UNEXPECTED_PEER");class UU extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto exchange"),(0,Yo.Z)(this,"code",void 0),this.code=UU.code}}(0,Yo.Z)(UU,"code","ERR_INVALID_CRYPTO_EXCHANGE");class FU extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto transmission"),(0,Yo.Z)(this,"code",void 0),this.code=FU.code}}(0,Yo.Z)(FU,"code","ERR_INVALID_CRYPTO_TRANSMISSION");const KU=Symbol.for("@libp2p/transport");var jU;!function(e){e[e.FATAL_ALL=0]="FATAL_ALL",e[e.NO_FATAL=1]="NO_FATAL"}(jU||(jU={}));var ZU=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const zU=ZU;new Uint8Array(0);class VU{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class HU{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return GU(this,e)}}class qU{constructor(e){this.decoders=e}or(e){return GU(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const GU=(e,t)=>new qU({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class WU{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new VU(e,t,n),this.decoder=new HU(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const QU=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new WU(t,n,r,i)},YU=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=zU(r,n);return QU({prefix:t,name:n,encode:i,decode:e=>(e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")})(o(e))})},JU=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return QU({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},XU=JU({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),$U=(JU({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),JU({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),JU({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),JU({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),JU({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),JU({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),JU({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),JU({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),YU({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"})),eF=(YU({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),JU({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}));JU({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),JU({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),JU({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});function tF(e){let t=function(e){const t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=e,t.destroy=()=>!0,t.extend=()=>t,t}("".concat(e,":trace"));return sf().enabled("".concat(e,":trace"))&&null!=sf().names.map((e=>e.toString())).find((e=>e.includes(":trace")))&&(t=sf()("".concat(e,":trace"))),Object.assign(sf()(e),{error:sf()("".concat(e,":error")),trace:t})}sf().formatters.b=e=>null==e?"undefined":$U.baseEncode(e),sf().formatters.t=e=>null==e?"undefined":XU.baseEncode(e),sf().formatters.m=e=>null==e?"undefined":eF.baseEncode(e),sf().formatters.p=e=>null==e?"undefined":e.toString(),sf().formatters.c=e=>null==e?"undefined":e.toString(),sf().formatters.k=e=>null==e?"undefined":e.toString(),sf().formatters.a=e=>null==e?"undefined":e.toString();var nF=n(96118);const rF=async e=>{if(e.readyState>=2)throw new Error("socket closed");1!==e.readyState&&await new Promise(((t,n)=>{function r(){e.removeEventListener("open",i),e.removeEventListener("error",o)}function i(){r(),t()}function o(t){var i;r(),n(null!==(i=t.error)&&void 0!==i?i:new Error("connect ECONNREFUSED ".concat(e.url)))}e.addEventListener("open",i),e.addEventListener("error",o)}))},iF=(e,t)=>{var n;(t=null!==(n=t)&&void 0!==n?n:{}).closeOnEnd=!1!==t.closeOnEnd;return async n=>{for await(const t of n){try{await rF(e)}catch(r){if("socket closed"===r.message)break;throw r}if(e.readyState===e.CLOSING||e.readyState===e.CLOSED)break;e.send(t)}null!=t.closeOnEnd&&e.readyState<=1&&await new Promise(((t,n)=>{e.addEventListener("close",(e=>{if(e.wasClean||1006===e.code)t();else{const t=Object.assign(new Error("ws error"),{event:e});n(t)}})),setTimeout((()=>{e.close()}))}))}};var oF=n(3634);function sF(e){var t;return e instanceof ArrayBuffer||"ArrayBuffer"===(null===e||void 0===e||null===(t=e.constructor)||void 0===t?void 0:t.name)&&"number"===typeof(null===e||void 0===e?void 0:e.byteLength)}const aF=(e,t)=>{var n;t=null!==(n=t)&&void 0!==n?n:{};const r=(e=>{e.binaryType="arraybuffer";const t=async()=>{await new Promise(((t,n)=>{if(i)return void t();if(null!=r)return void n(r);const o=t=>{e.removeEventListener("open",s),e.removeEventListener("error",a),t()},s=()=>{o(t)},a=t=>{o((()=>{var r;n(null!==(r=t.error)&&void 0!==r?r:new Error("connect ECONNREFUSED ".concat(e.url)))}))};e.addEventListener("open",s),e.addEventListener("error",a)}))},n=async function*(){const n=new oF.zN((t=>{let{push:n,stop:r,fail:i}=t;const o=e=>{let t=null;"string"===typeof e.data&&(t=(0,yu.m)(e.data)),sF(e.data)&&(t=new Uint8Array(e.data)),e.data instanceof Uint8Array&&(t=e.data),null!=t&&n(t)},s=e=>{var t;i(null!==(t=e.error)&&void 0!==t?t:new Error("Socket error"))};return e.addEventListener("message",o),e.addEventListener("error",s),e.addEventListener("close",r),()=>{e.removeEventListener("message",o),e.removeEventListener("error",s),e.removeEventListener("close",r)}}),{highWaterMark:1/0});await t();for await(const e of n)yield sF(e)?new Uint8Array(e):e}();let r,i=1===e.readyState;return e.addEventListener("open",(()=>{i=!0,r=null})),e.addEventListener("close",(()=>{i=!1,r=null})),e.addEventListener("error",(t=>{var n;i||(r=null!==(n=t.error)&&void 0!==n?n:new Error("connect ECONNREFUSED ".concat(e.url)))})),Object.assign(n,{connected:t})})(e);let i=t.remoteAddress,o=t.remotePort;if(null!=e.url)try{const t=new URL(e.url);i=t.hostname,o=parseInt(t.port,10)}catch{}if(null==i||null==o)throw new Error("Remote connection did not have address and/or port");return{sink:iF(e,t),source:r,connected:async()=>{await r.connected()},close:async()=>{e.readyState!==e.CONNECTING&&e.readyState!==e.OPEN||await new Promise((t=>{e.addEventListener("close",(()=>{t()})),e.close()}))},destroy:()=>{null!=e.terminate?e.terminate():e.close()},remoteAddress:i,remotePort:o,socket:e}},cF=WebSocket;var lF=n(16791);const uF={http:"ws",https:"wss"};function hF(e,t){var n;t=null!==(n=t)&&void 0!==n?n:{};const r=((e,t)=>(0,lF.relative)(e,t,uF,"ws"))(e,("undefined"===typeof window?"":window.location).toString()),i=new cF(r,t.websocket);return aF(i,t)}class dF extends Error{constructor(e,t){super(null!==e&&void 0!==e?e:"The operation was aborted"),this.type="aborted",this.code=null!==t&&void 0!==t?t:"ABORT_ERR"}}function fF(e,t,n){const r=null!==n&&void 0!==n?n:{},i=ad(e);return async function*(){let n;const o=()=>{null!=n&&n()};for(t.addEventListener("abort",o);;){let a;try{if(t.aborted){const{abortMessage:e,abortCode:t}=r;throw new dF(e,t)}const e=new Promise(((e,t)=>{n=()=>{const{abortMessage:e,abortCode:n}=r;t(new dF(e,n))}}));a=await Promise.race([e,i.next()]),n=null}catch(s){t.removeEventListener("abort",o);const n="aborted"===s.type&&t.aborted;if(n&&null!=r.onAbort&&r.onAbort(e),"function"===typeof i.return)try{const e=i.return();e instanceof Promise&&e.catch((e=>{null!=r.onReturnError&&r.onReturnError(e)}))}catch(s){null!=r.onReturnError&&r.onReturnError(s)}if(n&&!0===r.returnOnAbort)return;throw s}if(!0===a.done)break;yield a.value}t.removeEventListener("abort",o)}()}function pF(e,t,n){return r=>e(fF(r,t,n))}function gF(e,t,n){return{sink:pF(e.sink,t,{...n,onAbort:void 0}),source:fF(e.source,t,n)}}const yF=tF("libp2p:websockets:socket");const mF=tF("libp2p:websockets");class vF{constructor(e){(0,Yo.Z)(this,"init",void 0),(0,Yo.Z)(this,Symbol.toStringTag,"@libp2p/websockets"),(0,Yo.Z)(this,KU,!0),this.init=e}async dial(e,t){var n;mF("dialing %s",e),t=null!==(n=t)&&void 0!==n?n:{};const r=function(e,t,n){var r;const i={async sink(t){var r;null!=(null===(r=n)||void 0===r?void 0:r.signal)&&(t=fF(t,n.signal));try{await e.sink(t)}catch(i){"aborted"!==i.type&&yF.error(i)}},source:null!=(n=null!==(r=n)&&void 0!==r?r:{}).signal?fF(e.source,n.signal):e.source,remoteAddr:t,timeline:{open:Date.now()},async close(){var t;let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=Date.now();if(null==n.signal){const e=AbortSignal.timeout(500);n={...n,signal:e}}const o=()=>{const{host:e,port:t}=i.remoteAddr.toOptions();yF("timeout closing stream to %s:%s after %dms, destroying it manually",e,t,Date.now()-r),this.abort(new LU("Socket close timeout","ERR_SOCKET_CLOSE_TIMEOUT"))};null===(t=n.signal)||void 0===t||t.addEventListener("abort",o);try{await e.close()}catch(a){yF.error("error closing WebSocket gracefully",a),this.abort(a)}finally{var s;null===(s=n.signal)||void 0===s||s.removeEventListener("abort",o),i.timeline.close=Date.now()}},abort(t){const{host:n,port:r}=i.remoteAddr.toOptions();yF("timeout closing stream to %s:%s due to error",n,r,t),e.destroy(),i.timeline.close=Date.now()}};return e.socket.addEventListener("close",(()=>{null==i.timeline.close&&(i.timeline.close=Date.now())}),{once:!0}),i}(await this._connect(e,t),e);mF("new outbound connection %s",r.remoteAddr);const i=await t.upgrader.upgradeOutbound(r);return mF("outbound connection %s upgraded",r.remoteAddr),i}async _connect(e,t){var n;if(!0===(null===t||void 0===t||null===(n=t.signal)||void 0===n?void 0:n.aborted))throw new BU;const r=e.toOptions();mF("dialing %s:%s",r.host,r.port);const i=Ws(),o=hF((0,nF.k)(e),this.init);if(o.socket.addEventListener("error",(()=>{const t=new LU("Could not connect to ".concat(e.toString()),"ERR_CONNECTION_FAILED");mF.error("connection error:",t),i.reject(t)})),null==t.signal)return await Promise.race([o.connected(),i.promise]),mF("connected %s",e),o;let s;const a=new Promise(((e,n)=>{var r,i;s=()=>{n(new BU),o.close().catch((e=>{mF.error("error closing raw socket",e)}))},!0!==(null===t||void 0===t||null===(r=t.signal)||void 0===r?void 0:r.aborted)?null===t||void 0===t||null===(i=t.signal)||void 0===i||i.addEventListener("abort",s):s()}));try{await Promise.race([a,i.promise,o.connected()])}finally{var c;if(null!=s)null===t||void 0===t||null===(c=t.signal)||void 0===c||c.removeEventListener("abort",s)}return mF("connected %s",e),o}createListener(e){return function(){throw new Error("WebSocket Servers can not be created in the browser!")}(this.init)}filter(e){var t,n;return e=Array.isArray(e)?e:[e],null!=(null===(t=this.init)||void 0===t?void 0:t.filter)?null===(n=this.init)||void 0===n?void 0:n.filter(e):sO||uO?function(e){return e.filter((e=>{if(e.protoCodes().includes(290))return!1;const t=e.decapsulateCode(421);return Lx.matches(t)}))}(e):function(e){return e.filter((e=>{if(e.protoCodes().includes(290))return!1;const t=e.decapsulateCode(421);return Nx.matches(t)||Lx.matches(t)}))}(e)}}function bF(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return()=>new vF(e)}function wF(e){return null!=e[Symbol.asyncIterator]}const EF=e=>{const t=Bs.P$(e),n=(0,Us.E)(t);return Bs.cv(e,n),EF.bytes=t,n};EF.bytes=0;var AF;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(AF||(AF={}));const SF=e=>{const t=Bs.Jx(e);return SF.bytes=Bs.P$(t),t};function _F(e,t){var n,r,i;const o=new Zs;let s=AF.LENGTH,a=-1;const c=null!==(n=null===t||void 0===t?void 0:t.lengthDecoder)&&void 0!==n?n:SF,l=null!==(r=null===t||void 0===t?void 0:t.maxLengthLength)&&void 0!==r?r:8,u=null!==(i=null===t||void 0===t?void 0:t.maxDataLength)&&void 0!==i?i:4194304;function*h(){for(;o.byteLength>0;){if(s===AF.LENGTH)try{if(a=c(o),a<0)throw Xo()(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(a>u)throw Xo()(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const e=c.bytes;o.consume(e),null!=(null===t||void 0===t?void 0:t.onLength)&&t.onLength(a),s=AF.DATA}catch(e){if(e instanceof RangeError){if(o.byteLength>l)throw Xo()(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw e}if(s===AF.DATA){if(o.byteLength<a)break;const e=o.sublist(0,a);o.consume(a),null!=(null===t||void 0===t?void 0:t.onData)&&t.onData(e),yield e,s=AF.LENGTH}}}return wF(e)?async function*(){for await(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}function IF(){const e=Ws();let t=!1;return{sink:async n=>{if(t)throw new Error("already piped");t=!0,e.resolve(n)},source:async function*(){const t=await e.promise;yield*t}()}}SF.bytes=0,_F.fromReader=(e,t)=>{let n=1;return _F(async function*(){for(;;)try{const{done:t,value:r}=await e.next(n);if(!0===t)return;null!=r&&(yield r)}catch(t){if("ERR_UNDER_READ"===t.code)return{done:!0,value:null};throw t}finally{n=1}}(),{...null!==t&&void 0!==t?t:{},onLength:e=>{n=e}})};class CF{constructor(e){if((0,Yo.Z)(this,"buffer",void 0),(0,Yo.Z)(this,"mask",void 0),(0,Yo.Z)(this,"top",void 0),(0,Yo.Z)(this,"btm",void 0),(0,Yo.Z)(this,"next",void 0),!(e>0)||0!==(e-1&e))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return void 0===this.buffer[this.btm]}}class TF{constructor(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,Yo.Z)(this,"size",void 0),(0,Yo.Z)(this,"hwm",void 0),(0,Yo.Z)(this,"head",void 0),(0,Yo.Z)(this,"tail",void 0),this.hwm=null!==(e=t.splitLimit)&&void 0!==e?e:16,this.head=new CF(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return null!=(null===e||void 0===e?void 0:e.byteLength)?e.byteLength:1}push(e){if(null!=(null===e||void 0===e?void 0:e.value)&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new CF(2*this.head.buffer.length),this.head.push(e)}}shift(){var e;let t=this.tail.shift();if(void 0===t&&null!=this.tail.next){const e=this.tail.next;this.tail.next=null,this.tail=e,t=this.tail.shift()}return null!=(null===(e=t)||void 0===e?void 0:e.value)&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}}class kF extends Error{constructor(e,t){super(null!==e&&void 0!==e?e:"The operation was aborted"),(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"code",void 0),this.type="aborted",this.code=null!==t&&void 0!==t?t:"ABORT_ERR"}}function RF(){return xF((e=>{const t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}function xF(e,t){var n;let r,i,o,s=(t=null!==(n=t)&&void 0!==n?n:{}).onEnd,a=new TF,c=Ws();const l=e=>null!=i?i(e):(a.push(e),r),u=e=>{var n;if(o)return r;if(!0!==(null===(n=t)||void 0===n?void 0:n.objectMode)&&null==(null===e||void 0===e?void 0:e.byteLength))throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:e})},h=e=>o?r:(o=!0,null!=e?(e=>(a=new TF,null!=i?i({error:e}):(a.push({error:e}),r)))(e):l({done:!0}));if(r={[Symbol.asyncIterator](){return this},next:async()=>{try{return a.isEmpty()?o?{done:!0}:await new Promise(((t,n)=>{i=o=>{i=null,a.push(o);try{t(e(a))}catch(s){n(s)}return r}})):e(a)}finally{a.isEmpty()&&queueMicrotask((()=>{c.resolve(),c=Ws()}))}},return:()=>(a=new TF,h(),{done:!0}),throw:e=>(h(e),{done:!0}),push:u,end:h,get readableLength(){return a.size},onEmpty:async e=>{const t=null===e||void 0===e?void 0:e.signal;if(null===t||void 0===t||t.throwIfAborted(),a.isEmpty())return;let n,r;null!=t&&(n=new Promise(((e,n)=>{r=()=>{n(new kF)},t.addEventListener("abort",r)})));try{await Promise.race([c.promise,n])}finally{null!=r&&null!=t&&(null===t||void 0===t||t.removeEventListener("abort",r))}}},null==s)return r;const d=r;return r={[Symbol.asyncIterator](){return this},next:()=>d.next(),throw:e=>(d.throw(e),null!=s&&(s(e),s=void 0),{done:!0}),return:()=>(d.return(),null!=s&&(s(),s=void 0),{done:!0}),push:u,end:e=>(d.end(e),null!=s&&(s(e),s=void 0),r),get readableLength(){return d.readableLength},onEmpty:e=>d.onEmpty(e)},r}const PF=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const r=[];for(const i of t)null==i[Symbol.asyncIterator]&&r.push(i);return r.length===t.length?function*(){for(const e of r)yield*e}():async function*(){const e=RF({objectMode:!0});Promise.resolve().then((async()=>{try{await Promise.all(t.map((async t=>{for await(const n of t)e.push(n)}))),e.end()}catch(n){e.end(n)}})),yield*e}()};const DF=function(){let e;for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(;n.length>0;)e=n.shift()(e);return e},OF=e=>null!=(null===e||void 0===e?void 0:e[Symbol.asyncIterator]),NF=e=>null!=(null===e||void 0===e?void 0:e[Symbol.iterator]),BF=e=>null!=e&&(null!=e.sink&&null!=e.source),LF=e=>t=>{const n=e.sink(t);if(null!=(null===n||void 0===n?void 0:n.then)){const t=RF({objectMode:!0});let r;n.then((()=>{t.end()}),(e=>{t.end(e)}));const i=e.source;if(OF(i))r=async function*(){yield*i,t.end()};else{if(!NF(i))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");r=function*(){yield*i,t.end()}}return PF(t,r())}return e.source};var MF,UF;const FF=65535,KF=Boolean(null===(MF=globalThis.process)||void 0===MF||null===(UF=MF.env)||void 0===UF?void 0:UF.DUMP_SESSION_KEYS),jF={hashSHA256:e=>au(e),getHKDF(e,t){const n=Xl(au,t,e),r=tu(au,n,void 0,96);return[r.subarray(0,32),r.subarray(32,64),r.subarray(64,96)]},generateX25519KeyPair(){const e=Wl.utils.randomPrivateKey();return{publicKey:Wl.getPublicKey(e),privateKey:e}},generateX25519KeyPairFromSeed:e=>({publicKey:Wl.getPublicKey(e),privateKey:e}),generateX25519SharedKey:(e,t)=>Wl.getSharedSecret(e,t),chaCha20Poly1305Encrypt:(e,t,n,r)=>lc(r,t,n).encrypt(e),chaCha20Poly1305Decrypt:(e,t,n,r,i)=>lc(r,t,n).decrypt(e,i)},ZF=e=>{const t=(0,Us.E)(2);return new DataView(t.buffer,t.byteOffset,t.byteLength).setUint16(0,e,!1),t};ZF.bytes=2;const zF=e=>{if(e.length<2)throw RangeError("Could not decode int16BE");return e instanceof Uint8Array?new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1):e.getUint16(0)};zF.bytes=2;class VF extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"The operation was aborted"),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"type",void 0),this.code=VF.code,this.type=VF.type}}(0,Yo.Z)(VF,"code","ABORT_ERR"),(0,Yo.Z)(VF,"type","aborted");class HF extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected Peer"),(0,Yo.Z)(this,"code",void 0),this.code=HF.code}}(0,Yo.Z)(HF,"code","ERR_UNEXPECTED_PEER");class qF extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto exchange"),(0,Yo.Z)(this,"code",void 0),this.code=qF.code}}(0,Yo.Z)(qF,"code","ERR_INVALID_CRYPTO_EXCHANGE");class GF extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto transmission"),(0,Yo.Z)(this,"code",void 0),this.code=GF.code}}(0,Yo.Z)(GF,"code","ERR_INVALID_CRYPTO_TRANSMISSION");class WF extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"The operation was aborted"),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"type",void 0),this.code=WF.code,this.type=WF.type}}(0,Yo.Z)(WF,"code","ABORT_ERR"),(0,Yo.Z)(WF,"type","aborted");class QF extends Error{constructor(e,t,n){var r;super(e),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"props",void 0),this.code=t,this.name=null!==(r=null===n||void 0===n?void 0:n.name)&&void 0!==r?r:"CodeError",this.props=null!==n&&void 0!==n?n:{}}}class YF extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected Peer"),(0,Yo.Z)(this,"code",void 0),this.code=YF.code}}(0,Yo.Z)(YF,"code","ERR_UNEXPECTED_PEER");class JF extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto exchange"),(0,Yo.Z)(this,"code",void 0),this.code=JF.code}}(0,Yo.Z)(JF,"code","ERR_INVALID_CRYPTO_EXCHANGE");class XF extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto transmission"),(0,Yo.Z)(this,"code",void 0),this.code=XF.code}}(0,Yo.Z)(XF,"code","ERR_INVALID_CRYPTO_TRANSMISSION");var $F=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const eK=$F,tK=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class nK{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class rK{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return oK(this,e)}}class iK{constructor(e){this.decoders=e}or(e){return oK(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const oK=(e,t)=>new iK({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class sK{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new nK(e,t,n),this.decoder=new rK(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const aK=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new sK(t,n,r,i)},cK=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=eK(r,n);return aK({prefix:t,name:n,encode:i,decode:e=>tK(o(e))})},lK=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return aK({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},uK=cK({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),hK=cK({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var dK=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=gK;)n[r++]=255&t|fK,t/=128;for(;t&pK;)n[r++]=255&t|fK,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},fK=128,pK=-128,gK=Math.pow(2,31);var yK=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&vK)<<o:(r&vK)*Math.pow(2,o),o+=7}while(r>=mK);return e.bytes=s-n,i},mK=128,vK=127;var bK=Math.pow(2,7),wK=Math.pow(2,14),EK=Math.pow(2,21),AK=Math.pow(2,28),SK=Math.pow(2,35),_K=Math.pow(2,42),IK=Math.pow(2,49),CK=Math.pow(2,56),TK=Math.pow(2,63);const kK={encode:dK,decode:yK,encodingLength:function(e){return e<bK?1:e<wK?2:e<EK?3:e<AK?4:e<SK?5:e<_K?6:e<IK?7:e<CK?8:e<TK?9:10}},RK=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return[kK.decode(e,t),kK.decode.bytes]},xK=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return kK.encode(e,t,n),t},PK=e=>kK.encodingLength(e),DK=(e,t)=>{const n=t.byteLength,r=PK(e),i=r+PK(n),o=new Uint8Array(i+n);return xK(e,o,0),xK(n,o,r),o.set(t,i),new NK(e,n,t,o)},OK=e=>{const t=tK(e),[n,r]=RK(t),[i,o]=RK(t.subarray(r)),s=t.subarray(r+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new NK(n,i,s,t)};class NK{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const BK=tK,LK={code:0,name:"identity",encode:BK,digest:e=>DK(0,BK(e))},MK=e=>{let{name:t,code:n,encode:r}=e;return new UK(t,n,r)};class UK{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?DK(this.code,t):t.then((e=>DK(this.code,e)))}throw Error("Unknown type, must be binary type")}}const FK=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),KK=MK({name:"sha2-256",code:18,encode:FK("SHA-256")}),jK=MK({name:"sha2-512",code:19,encode:FK("SHA-512")}),ZK=32,zK=64,VK=32;function HK(e,t){const n=new Uint8Array(zK);for(let r=0;r<VK;r++)n[r]=e[r],n[VK+r]=t[r];return n}const qK=lK({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),GK=lK({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),WK=lK({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),QK=lK({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),YK={get(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:globalThis).crypto;if(null==e||null==e.subtle)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p-crypto/blob/master/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}},JK={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};async function XK(e,t){const n=function(e){var t,n,r,i,o,s;const a=null!==(t=null===e||void 0===e?void 0:e.algorithm)&&void 0!==t?t:"AES-GCM";let c=null!==(n=null===e||void 0===e?void 0:e.keyLength)&&void 0!==n?n:16;const l=null!==(r=null===e||void 0===e?void 0:e.nonceLength)&&void 0!==r?r:12,u=null!==(i=null===e||void 0===e?void 0:e.digest)&&void 0!==i?i:"SHA-256",h=null!==(o=null===e||void 0===e?void 0:e.saltLength)&&void 0!==o?o:16,d=null!==(s=null===e||void 0===e?void 0:e.iterations)&&void 0!==s?s:32767,f=YK.get();return c*=8,{encrypt:async function(e,t){const n=f.getRandomValues(new Uint8Array(h)),r=f.getRandomValues(new Uint8Array(l)),i={name:a,iv:r};let o;if("string"===typeof t&&(t=(0,yu.m)(t)),0===t.length){o=await f.subtle.importKey("jwk",JK,{name:"AES-GCM"},!0,["encrypt"]);try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}catch{o=await f.subtle.importKey("jwk",JK,{name:"AES-GCM"},!0,["encrypt"])}}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}const s=await f.subtle.encrypt(i,o,e);return(0,Ls.z)([n,i.iv,new Uint8Array(s)])},decrypt:async function(e,t){const n=e.subarray(0,h),r=e.subarray(h,h+l),i=e.subarray(h+l),o={name:a,iv:r};let s;if("string"===typeof t&&(t=(0,yu.m)(t)),0===t.length)try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}catch{s=await f.subtle.importKey("jwk",JK,{name:"AES-GCM"},!0,["decrypt"])}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}const p=await f.subtle.decrypt(o,s,i);return new Uint8Array(p)}}}(),r=await n.encrypt(e,t);return qK.encode(r)}var $K,ej,tj,nj;!function(e){e.RSA="RSA",e.Ed25519="Ed25519",e.Secp256k1="Secp256k1"}($K||($K={})),function(e){e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.Secp256k1=2]="Secp256k1"}(ej||(ej={})),function(e){e.codec=()=>bs(ej)}($K||($K={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),$K.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=$K.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(tj||(tj={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),$K.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=$K.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(nj||(nj={}));class rj{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=lj(e,ZK)}async verify(e,t){return async function(e,t,n){return ql.verify(t,n,e)}(this._key,t,e)}marshal(){return this._key}get bytes(){return tj.encode({Type:$K.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await KK.digest(this.bytes);return e}}class ij{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=lj(e,zK),this._publicKey=lj(t,ZK)}async sign(e){return async function(e,t){const n=e.subarray(0,VK);return ql.sign(t,n)}(this._key,e)}get public(){return new rj(this._publicKey)}marshal(){return this._key}get bytes(){return nj.encode({Type:$K.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await KK.digest(this.bytes);return e}async id(){const e=LK.digest(this.public.bytes);return uK.encode(e.bytes).substring(1)}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return XK(this.bytes,e);throw new QF("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function oj(e){if(e.length>zK){const t=(e=lj(e,zK+ZK))