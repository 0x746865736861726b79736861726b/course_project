+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const r1=n1,i1=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class o1{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class s1{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return c1(this,e)}}class a1{constructor(e){this.decoders=e}or(e){return c1(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const c1=(e,t)=>new a1({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class l1{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new o1(e,t,n),this.decoder=new s1(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const u1=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new l1(t,n,r,i)},h1=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=r1(r,n);return u1({prefix:t,name:n,encode:i,decode:e=>i1(o(e))})},d1=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return u1({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},f1=h1({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),p1=h1({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),g1=h1({prefix:"9",name:"base10",alphabet:"0123456789"}),y1=d1({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),m1=d1({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),v1=d1({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),b1=Array.from("\ud83d\ude80\ud83e\ude90\u2604\ud83d\udef0\ud83c\udf0c\ud83c\udf11\ud83c\udf12\ud83c\udf13\ud83c\udf14\ud83c\udf15\ud83c\udf16\ud83c\udf17\ud83c\udf18\ud83c\udf0d\ud83c\udf0f\ud83c\udf0e\ud83d\udc09\u2600\ud83d\udcbb\ud83d\udda5\ud83d\udcbe\ud83d\udcbf\ud83d\ude02\u2764\ud83d\ude0d\ud83e\udd23\ud83d\ude0a\ud83d\ude4f\ud83d\udc95\ud83d\ude2d\ud83d\ude18\ud83d\udc4d\ud83d\ude05\ud83d\udc4f\ud83d\ude01\ud83d\udd25\ud83e\udd70\ud83d\udc94\ud83d\udc96\ud83d\udc99\ud83d\ude22\ud83e\udd14\ud83d\ude06\ud83d\ude44\ud83d\udcaa\ud83d\ude09\u263a\ud83d\udc4c\ud83e\udd17\ud83d\udc9c\ud83d\ude14\ud83d\ude0e\ud83d\ude07\ud83c\udf39\ud83e\udd26\ud83c\udf89\ud83d\udc9e\u270c\u2728\ud83e\udd37\ud83d\ude31\ud83d\ude0c\ud83c\udf38\ud83d\ude4c\ud83d\ude0b\ud83d\udc97\ud83d\udc9a\ud83d\ude0f\ud83d\udc9b\ud83d\ude42\ud83d\udc93\ud83e\udd29\ud83d\ude04\ud83d\ude00\ud83d\udda4\ud83d\ude03\ud83d\udcaf\ud83d\ude48\ud83d\udc47\ud83c\udfb6\ud83d\ude12\ud83e\udd2d\u2763\ud83d\ude1c\ud83d\udc8b\ud83d\udc40\ud83d\ude2a\ud83d\ude11\ud83d\udca5\ud83d\ude4b\ud83d\ude1e\ud83d\ude29\ud83d\ude21\ud83e\udd2a\ud83d\udc4a\ud83e\udd73\ud83d\ude25\ud83e\udd24\ud83d\udc49\ud83d\udc83\ud83d\ude33\u270b\ud83d\ude1a\ud83d\ude1d\ud83d\ude34\ud83c\udf1f\ud83d\ude2c\ud83d\ude43\ud83c\udf40\ud83c\udf37\ud83d\ude3b\ud83d\ude13\u2b50\u2705\ud83e\udd7a\ud83c\udf08\ud83d\ude08\ud83e\udd18\ud83d\udca6\u2714\ud83d\ude23\ud83c\udfc3\ud83d\udc90\u2639\ud83c\udf8a\ud83d\udc98\ud83d\ude20\u261d\ud83d\ude15\ud83c\udf3a\ud83c\udf82\ud83c\udf3b\ud83d\ude10\ud83d\udd95\ud83d\udc9d\ud83d\ude4a\ud83d\ude39\ud83d\udde3\ud83d\udcab\ud83d\udc80\ud83d\udc51\ud83c\udfb5\ud83e\udd1e\ud83d\ude1b\ud83d\udd34\ud83d\ude24\ud83c\udf3c\ud83d\ude2b\u26bd\ud83e\udd19\u2615\ud83c\udfc6\ud83e\udd2b\ud83d\udc48\ud83d\ude2e\ud83d\ude46\ud83c\udf7b\ud83c\udf43\ud83d\udc36\ud83d\udc81\ud83d\ude32\ud83c\udf3f\ud83e\udde1\ud83c\udf81\u26a1\ud83c\udf1e\ud83c\udf88\u274c\u270a\ud83d\udc4b\ud83d\ude30\ud83e\udd28\ud83d\ude36\ud83e\udd1d\ud83d\udeb6\ud83d\udcb0\ud83c\udf53\ud83d\udca2\ud83e\udd1f\ud83d\ude41\ud83d\udea8\ud83d\udca8\ud83e\udd2c\u2708\ud83c\udf80\ud83c\udf7a\ud83e\udd13\ud83d\ude19\ud83d\udc9f\ud83c\udf31\ud83d\ude16\ud83d\udc76\ud83e\udd74\u25b6\u27a1\u2753\ud83d\udc8e\ud83d\udcb8\u2b07\ud83d\ude28\ud83c\udf1a\ud83e\udd8b\ud83d\ude37\ud83d\udd7a\u26a0\ud83d\ude45\ud83d\ude1f\ud83d\ude35\ud83d\udc4e\ud83e\udd32\ud83e\udd20\ud83e\udd27\ud83d\udccc\ud83d\udd35\ud83d\udc85\ud83e\uddd0\ud83d\udc3e\ud83c\udf52\ud83d\ude17\ud83e\udd11\ud83c\udf0a\ud83e\udd2f\ud83d\udc37\u260e\ud83d\udca7\ud83d\ude2f\ud83d\udc86\ud83d\udc46\ud83c\udfa4\ud83d\ude47\ud83c\udf51\u2744\ud83c\udf34\ud83d\udca3\ud83d\udc38\ud83d\udc8c\ud83d\udccd\ud83e\udd40\ud83e\udd22\ud83d\udc45\ud83d\udca1\ud83d\udca9\ud83d\udc50\ud83d\udcf8\ud83d\udc7b\ud83e\udd10\ud83e\udd2e\ud83c\udfbc\ud83e\udd75\ud83d\udea9\ud83c\udf4e\ud83c\udf4a\ud83d\udc7c\ud83d\udc8d\ud83d\udce3\ud83e\udd42"),w1=b1.reduce(((e,t,n)=>(e[n]=t,e)),[]),E1=b1.reduce(((e,t,n)=>(e[t.codePointAt(0)]=n,e)),[]);const A1=u1({prefix:"\ud83d\ude80",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+=w1[t]),"")},decode:function(e){const t=[];for(const n of e){const e=E1[n.codePointAt(0)];if(void 0===e)throw new Error("Non-base256emoji character: ".concat(n));t.push(e)}return new Uint8Array(t)}}),S1=d1({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),_1=d1({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),I1=d1({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),C1=d1({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),T1=d1({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),k1=d1({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),R1=d1({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),x1=d1({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),P1=d1({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),D1=h1({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),O1=h1({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),N1=d1({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),B1=d1({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),L1=d1({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),M1=d1({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),U1=d1({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),F1=u1({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),K1=new TextEncoder,j1=new TextDecoder,Z1="json",z1=512,V1=e=>K1.encode(JSON.stringify(e)),H1=e=>JSON.parse(j1.decode(e)),q1="raw",G1=85,W1=e=>i1(e),Q1=e=>i1(e);var Y1=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=$1;)n[r++]=255&t|J1,t/=128;for(;t&X1;)n[r++]=255&t|J1,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},J1=128,X1=-128,$1=Math.pow(2,31);var e2=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&n2)<<o:(r&n2)*Math.pow(2,o),o+=7}while(r>=t2);return e.bytes=s-n,i},t2=128,n2=127;var r2=Math.pow(2,7),i2=Math.pow(2,14),o2=Math.pow(2,21),s2=Math.pow(2,28),a2=Math.pow(2,35),c2=Math.pow(2,42),l2=Math.pow(2,49),u2=Math.pow(2,56),h2=Math.pow(2,63);const d2={encode:Y1,decode:e2,encodingLength:function(e){return e<r2?1:e<i2?2:e<o2?3:e<s2?4:e<a2?5:e<c2?6:e<l2?7:e<u2?8:e<h2?9:10}},f2=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return[d2.decode(e,t),d2.decode.bytes]},p2=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return d2.encode(e,t,n),t},g2=e=>d2.encodingLength(e),y2=(e,t)=>{const n=t.byteLength,r=g2(e),i=r+g2(n),o=new Uint8Array(i+n);return p2(e,o,0),p2(n,o,r),o.set(t,i),new v2(e,n,t,o)},m2=e=>{const t=i1(e),[n,r]=f2(t),[i,o]=f2(t.subarray(r)),s=t.subarray(r+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new v2(n,i,s,t)};class v2{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const b2=i1,w2={code:0,name:"identity",encode:b2,digest:e=>y2(0,b2(e))},E2=e=>{let{name:t,code:n,encode:r}=e;return new A2(t,n,r)};class A2{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?y2(this.code,t):t.then((e=>y2(this.code,e)))}throw Error("Unknown type, must be binary type")}}const S2=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),_2=E2({name:"sha2-256",code:18,encode:S2("SHA-256")}),I2=E2({name:"sha2-512",code:19,encode:S2("SHA-512")}),C2=(e,t)=>{const{bytes:n,version:r}=e;return 0===r?P2(n,k2(e),t||f1.encoder):D2(n,k2(e),t||S1.encoder)},T2=new WeakMap,k2=e=>{const t=T2.get(e);if(null==t){const t=new Map;return T2.set(e,t),t}return t};class R2{constructor(e,t,n,r){this.code=t,this.version=e,this.multihash=n,this.bytes=r,this["/"]=r}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==O2)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==N2)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return R2.createV0(t)}default:throw Error("Can not convert CID version ".concat(this.version," to version 0. This is a bug please report"))}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=y2(e,t);return R2.createV1(this.code,n)}case 1:return this;default:throw Error("Can not convert CID version ".concat(this.version," to version 1. This is a bug please report"))}}equals(e){return R2.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&((e,t)=>{if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&((e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0})(e.bytes,n.bytes)}})(e.multihash,n.multihash)}toString(e){return C2(this,e)}toJSON(){return{"/":C2(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID(".concat(this.toString(),")")}static asCID(e){if(null==e)return null;const t=e;if(t instanceof R2)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:i}=t;return new R2(e,n,r,i||B2(e,n,r.bytes))}if(!0===t[L2]){const{version:e,multihash:n,code:r}=t,i=m2(n);return R2.create(e,r,i)}return null}static create(e,t,n){if("number"!==typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==O2)throw new Error("Version 0 CID must use dag-pb (code: ".concat(O2,") block encoding"));return new R2(e,t,n,n.bytes);case 1:{const r=B2(e,t,n.bytes);return new R2(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return R2.create(0,O2,e)}static createV1(e,t){return R2.create(1,e,t)}static decode(e){const[t,n]=R2.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=R2.inspectBytes(e),n=t.size-t.multihashSize,r=i1(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=r.subarray(t.multihashSize-t.digestSize),o=new v2(t.multihashCode,t.digestSize,i,r);return[0===t.version?R2.createV0(o):R2.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=f2(e.subarray(t));return t+=r,n};let r=n(),i=O2;if(18===r?(r=0,t=0):i=n(),0!==r&&1!==r)throw new RangeError("Invalid CID version ".concat(r));const o=t,s=n(),a=n(),c=t+a;return{version:r,codec:i,multihashCode:s,digestSize:a,multihashSize:c-o,size:c}}static parse(e,t){const[n,r]=x2(e,t),i=R2.decode(r);if(0===i.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return k2(i).set(n,e),i}}const x2=(e,t)=>{switch(e[0]){case"Q":{const n=t||f1;return[f1.prefix,n.decode("".concat(f1.prefix).concat(e))]}case f1.prefix:{const n=t||f1;return[f1.prefix,n.decode(e)]}case S1.prefix:{const n=t||S1;return[S1.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}},P2=(e,t,n)=>{const{prefix:r}=n;if(r!==f1.prefix)throw Error("Cannot string encode V0 in ".concat(n.name," encoding"));const i=t.get(r);if(null==i){const i=n.encode(e).slice(1);return t.set(r,i),i}return i},D2=(e,t,n)=>{const{prefix:r}=n,i=t.get(r);if(null==i){const i=n.encode(e);return t.set(r,i),i}return i},O2=112,N2=18,B2=(e,t,n)=>{const r=g2(e),i=r+g2(t),o=new Uint8Array(i+n.byteLength);return p2(e,o,0),p2(t,o,r),o.set(n,i),o},L2=Symbol.for("@ipld/js-cid/CID"),M2={...Pn,...In,...xn,...Sn,..._n,...Tn,...kn,...An,...Rn,...Cn},U2=Symbol.for("nodejs.util.inspect.custom"),F2=Object.values(M2).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),M2.identity.decoder),K2=114,j2=36,Z2=37;class z2{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,fu.Cs,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=f1.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return R2.createV1(K2,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return function(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:F2,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=m2(f1.decode("z".concat(e)));return e.startsWith("12D")?new H2({multihash:t}):e.startsWith("16U")?new q2({multihash:t}):new V2({multihash:t})}return G2(F2.decode(e))}(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[U2](){return"PeerId(".concat(this.toString(),")")}}class V2 extends z2{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class H2 extends z2{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class q2 extends z2{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}function G2(e){try{const t=m2(e);if(t.code===w2.code){if(t.digest.length===j2)return new H2({multihash:t});if(t.digest.length===Z2)return new q2({multihash:t})}if(t.code===_2.code)return new V2({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==K2)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===_2.code)return new V2({multihash:e.multihash});if(t.code===w2.code){if(t.digest.length===j2)return new H2({multihash:e.multihash});if(t.digest.length===Z2)return new q2({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(R2.decode(e))}throw new Error("Supplied PeerID CID is invalid")}const W2="lock:worker:request-read",Q2="lock:worker:release-read",Y2="lock:master:grant-read",J2="lock:worker:request-write",X2="lock:worker:release-write",$2="lock:master:grant-write",e3={},t3=e=>{e.addEventListener("message",(t=>{t3.dispatchEvent("message",e,t)})),null!=e.port&&e.port.addEventListener("message",(t=>{t3.dispatchEvent("message",e,t)}))};t3.addEventListener=(e,t)=>{null==e3[e]&&(e3[e]=[]),e3[e].push(t)},t3.removeEventListener=(e,t)=>{null!=e3[e]&&(e3[e]=e3[e].filter((e=>e===t)))},t3.dispatchEvent=function(e,t,n){null!=e3[e]&&e3[e].forEach((e=>e(t,n)))};const n3=t3,r3=(e,t,n,r,i)=>(o,s)=>{if(s.data.type!==n)return;const a={type:s.data.type,name:s.data.name,identifier:s.data.identifier};e.dispatchEvent(new MessageEvent(t,{data:{name:a.name,handler:async()=>(o.postMessage({type:i,name:a.name,identifier:a.identifier}),await new Promise((e=>{const t=n=>{if(null==n||null==n.data)return;const i=n.data.type,s=(n.data.name,n.data.identifier);i===r&&s===a.identifier&&(o.removeEventListener("message",t),e())};o.addEventListener("message",t)})))}}))},i3=(e,t,n,r)=>async()=>{const i=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:21;return crypto.getRandomValues(new Uint8Array(e)).reduce(((e,t)=>e+((t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_")),"")}();return globalThis.postMessage({type:t,identifier:i,name:e}),await new Promise((t=>{const o=s=>{if(null==s||null==s.data)return;const a=s.data.type,c=s.data.identifier;a===n&&c===i&&(globalThis.removeEventListener("message",o),t((()=>{globalThis.postMessage({type:r,identifier:i,name:e})})))};globalThis.addEventListener("message",o)}))},o3={singleProcess:!1},s3={};let a3;async function c3(e,t){let n;const r=new Promise((e=>{n=e}));return e.add((async()=>await YB((async()=>await new Promise((e=>{n((()=>{e()}))})))(),{milliseconds:t.timeout}))),await r}const l3={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function u3(e){const t=Object.assign({},l3,e);return null==a3&&(a3=(e=>{if(e=Object.assign({},o3,e),Boolean(globalThis.document)||e.singleProcess){const e=new EventTarget;return n3.addEventListener("message",r3(e,"requestReadLock",W2,Q2,Y2)),n3.addEventListener("message",r3(e,"requestWriteLock",J2,X2,$2)),e}return{isWorker:!0,readLock:e=>i3(e,W2,Y2,Q2),writeLock:e=>i3(e,J2,$2,X2)}})(t),!0!==a3.isWorker&&(a3.addEventListener("requestReadLock",(e=>{null!=s3[e.data.name]&&s3[e.data.name].readLock().then((async t=>await e.data.handler().finally((()=>t()))))})),a3.addEventListener("requestWriteLock",(async e=>{null!=s3[e.data.name]&&s3[e.data.name].writeLock().then((async t=>await e.data.handler().finally((()=>t()))))})))),null==s3[t.name]&&(s3[t.name]=((e,t)=>{if(!0===a3.isWorker)return{readLock:a3.readLock(e,t),writeLock:a3.writeLock(e,t)};const n=new Bm.Z({concurrency:1});let r;return{async readLock(){if(null!=r)return await c3(r,t);r=new Bm.Z({concurrency:t.concurrency,autoStart:!1});const e=r,i=c3(r,t);return n.add((async()=>(e.start(),await e.onIdle().then((()=>{r===e&&(r=null)}))))),await i},writeLock:async()=>(r=null,await c3(n,t))}})(t.name,t)),s3[t.name]}const h3={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS"};var d3,f3,p3;function g3(e,t){var n;const r=d3.decode(t);null!=r.publicKey&&null==e.publicKey&&(e=function(e){if("RSA"===e.type)return new V2(e);if("Ed25519"===e.type)return new H2(e);if("secp256k1"===e.type)return new q2(e);throw new fu.sv("Not a PeerId","ERR_INVALID_PARAMETERS")}({...e,publicKey:e.publicKey}));const i=new Map,o=BigInt(Date.now());for(const[s,a]of r.tags.entries())null!=a.expiry&&a.expiry<o||i.set(s,a);return{...r,id:e,addresses:r.addresses.map((e=>{let{multiaddr:t,isCertified:n}=e;return{multiaddr:(0,ng.HM)(t),isCertified:null!==n&&void 0!==n&&n}})),metadata:r.metadata,peerRecordEnvelope:null!==(n=r.peerRecordEnvelope)&&void 0!==n?n:void 0,tags:i}}!function(e){let t,n,r;!function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&e.value.byteLength>0&&(t.uint32(18),t.bytes(e.value)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={key:"",value:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.key=e.string();break;case 2:n.value=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(t=e.Peer$metadataEntry||(e.Peer$metadataEntry={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&(t.uint32(18),p3.codec().encode(e.value,t)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={key:""},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.key=e.string();break;case 2:n.value=p3.codec().decode(e,e.uint32());break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(n=e.Peer$tagsEntry||(e.Peer$tagsEntry={})),e.codec=()=>(null==r&&(r=ws((function(t,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==r.lengthDelimited&&n.fork(),null!=t.addresses)for(const e of t.addresses)n.uint32(10),f3.codec().encode(e,n);if(null!=t.protocols)for(const e of t.protocols)n.uint32(18),n.string(e);if(null!=t.publicKey&&(n.uint32(34),n.bytes(t.publicKey)),null!=t.peerRecordEnvelope&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),null!=t.metadata&&0!==t.metadata.size)for(const[i,o]of t.metadata.entries())n.uint32(50),e.Peer$metadataEntry.codec().encode({key:i,value:o},n);if(null!=t.tags&&0!==t.tags.size)for(const[i,o]of t.tags.entries())n.uint32(58),e.Peer$tagsEntry.codec().encode({key:i,value:o},n);!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={addresses:[],protocols:[],metadata:new Map,tags:new Map},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.addresses.push(f3.codec().decode(t,t.uint32()));break;case 2:r.protocols.push(t.string());break;case 4:r.publicKey=t.bytes();break;case 5:r.peerRecordEnvelope=t.bytes();break;case 6:{const n=e.Peer$metadataEntry.codec().decode(t,t.uint32());r.metadata.set(n.key,n.value);break}case 7:{const n=e.Peer$tagsEntry.codec().decode(t,t.uint32());r.tags.set(n.key,n.value);break}default:t.skipType(7&n)}}return r}))),r),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(d3||(d3={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),null!=e.isCertified&&(t.uint32(16),t.bool(e.isCertified)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={multiaddr:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.multiaddr=e.bytes();break;case 2:n.isCertified=e.bool();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(f3||(f3={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.value&&0!==e.value&&(t.uint32(8),t.uint32(e.value)),null!=e.expiry&&(t.uint32(16),t.uint64(e.expiry)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={value:0},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.value=e.uint32();break;case 2:n.expiry=e.uint64();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(p3||(p3={}));const y3="/",m3=(new TextEncoder).encode(y3),v3=m3[0];class b3{constructor(e,t){if((0,Yo.Z)(this,"_buf",void 0),"string"===typeof e)this._buf=(0,yu.m)(e);else{if(!(e instanceof Uint8Array))throw new Error("Invalid key, should be String of Uint8Array");this._buf=e}if(null==t&&(t=!0),t&&this.clean(),0===this._buf.byteLength||this._buf[0]!==v3)throw new Error("Invalid key")}toString(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"utf8";return(0,Au.B)(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return"Key(".concat(this.toString(),")")}static withNamespaces(e){return new b3(e.join(y3))}static random(){return new b3(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:21;return crypto.getRandomValues(new Uint8Array(e)).reduce(((e,t)=>e+((t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_")),"")}().replace(/-/g,""))}static asKey(e){return e instanceof Uint8Array||"string"===typeof e?new b3(e):"function"===typeof e.uint8Array?new b3(e.uint8Array()):null}clean(){if(null!=this._buf&&0!==this._buf.byteLength||(this._buf=m3),this._buf[0]!==v3){const e=new Uint8Array(this._buf.byteLength+1);e.fill(v3,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===v3;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let r=0;r<t.length;r++){if(n.length<r+1)return!1;const e=t[r],i=n[r];if(e<i)return!0;if(e>i)return!1}return t.length<n.length}reverse(){return b3.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(y3).slice(1)}type(){return function(e){const t=e.split(":");if(t.length<2)return"";return t.slice(0,-1).join(":")}(this.baseNamespace())}name(){return function(e){const t=e.split(":");return t[t.length-1]}(this.baseNamespace())}instance(e){return new b3(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(y3)||(e+=y3),e+=this.type(),new b3(e)}parent(){const e=this.list();return 1===e.length?new b3(y3):new b3(e.slice(0,-1).join(y3))}child(e){return this.toString()===y3?e:e.toString()===y3?this:new b3(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()!==this.toString()&&e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()!==this.toString()&&this.toString().startsWith(e.toString())}isTopLevel(){return 1===this.list().length}concat(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return b3.withNamespaces([...this.namespaces(),...(r=t.map((e=>e.namespaces())),[].concat(...r))]);var r}}const w3="/peers/";function E3(e){if(!(0,fu.I$)(e)||null==e.type)throw new fu.sv("Invalid PeerId",h3.ERR_INVALID_PARAMETERS);const t=e.toCID().toString();return new b3("".concat(w3).concat(t))}async function A3(e,t,n){const r=new Map;for(const o of n){var i;if(null==o)continue;if(o.multiaddr instanceof Uint8Array&&(o.multiaddr=(0,ng.HM)(o.multiaddr)),!(0,ng.h2)(o.multiaddr))throw new fu.sv("Multiaddr was invalid",h3.ERR_INVALID_PARAMETERS);if(!await t(e,o.multiaddr))continue;const n=null!==(i=o.isCertified)&&void 0!==i&&i,s=o.multiaddr.toString(),a=r.get(s);null!=a?o.isCertified=a.isCertified||n:r.set(s,{multiaddr:o.multiaddr,isCertified:n})}return[...r.values()].sort(((e,t)=>e.multiaddr.toString().localeCompare(t.multiaddr.toString()))).map((e=>{let{isCertified:t,multiaddr:n}=e;return{isCertified:t,multiaddr:n.bytes}}))}async function S3(e,t,n,r){var i,o,s,a,c,l,u;if(null==t)throw new fu.sv("Invalid PeerData",h3.ERR_INVALID_PARAMETERS);if(null!=t.publicKey&&null!=e.publicKey&&!(0,Ms.f)(t.publicKey,e.publicKey))throw new fu.sv("publicKey bytes do not match peer id publicKey bytes",h3.ERR_INVALID_PARAMETERS);const h=r.existingPeer;if(null!=h&&!e.equals(h.id))throw new fu.sv("peer id did not match existing peer id",h3.ERR_INVALID_PARAMETERS);let d=null!==(i=null===h||void 0===h?void 0:h.addresses)&&void 0!==i?i:[],f=new Set(null!==(o=null===h||void 0===h?void 0:h.protocols)&&void 0!==o?o:[]),p=null!==(s=null===h||void 0===h?void 0:h.metadata)&&void 0!==s?s:new Map,g=null!==(a=null===h||void 0===h?void 0:h.tags)&&void 0!==a?a:new Map,y=null===h||void 0===h?void 0:h.peerRecordEnvelope;if("patch"===n){if(null==t.multiaddrs&&null==t.addresses||(d=[],null!=t.multiaddrs&&d.push(...t.multiaddrs.map((e=>({isCertified:!1,multiaddr:e})))),null!=t.addresses&&d.push(...t.addresses)),null!=t.protocols&&(f=new Set(t.protocols)),null!=t.metadata){p=_3(t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata),{validate:I3})}if(null!=t.tags){g=_3(t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),{validate:C3,map:T3})}null!=t.peerRecordEnvelope&&(y=t.peerRecordEnvelope)}if("merge"===n){if(null!=t.multiaddrs&&d.push(...t.multiaddrs.map((e=>({isCertified:!1,multiaddr:e})))),null!=t.addresses&&d.push(...t.addresses),null!=t.protocols&&(f=new Set([...f,...t.protocols])),null!=t.metadata){const e=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);for(const[t,n]of e)null==n?p.delete(t):p.set(t,n);p=_3([...p.entries()],{validate:I3})}if(null!=t.tags){const e=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),n=new Map(g);for(const[t,r]of e)null==r?n.delete(t):n.set(t,r);g=_3([...n.entries()],{validate:C3,map:T3})}null!=t.peerRecordEnvelope&&(y=t.peerRecordEnvelope)}const m={addresses:await A3(e,null!==(c=r.addressFilter)&&void 0!==c?c:async()=>!0,d),protocols:[...f.values()].sort(((e,t)=>e.localeCompare(t))),metadata:p,tags:g,publicKey:null!==(l=null!==(u=null===h||void 0===h?void 0:h.id.publicKey)&&void 0!==u?u:t.publicKey)&&void 0!==l?l:e.publicKey,peerRecordEnvelope:y};return"RSA"!==e.type&&delete m.publicKey,m}function _3(e,t){const n=new Map;for(const[o,s]of e)null!=s&&t.validate(o,s);for(const[o,s]of e.sort(((e,t)=>{let[n]=e,[r]=t;return n.localeCompare(r)}))){var r,i;if(null!=s)n.set(o,null!==(r=null===(i=t.map)||void 0===i?void 0:i.call(t,o,s))&&void 0!==r?r:s)}return n}function I3(e,t){if("string"!==typeof e)throw new fu.sv("Metadata key must be a string",h3.ERR_INVALID_PARAMETERS);if(!(t instanceof Uint8Array))throw new fu.sv("Metadata value must be a Uint8Array",h3.ERR_INVALID_PARAMETERS)}function C3(e,t){if("string"!==typeof e)throw new fu.sv("Tag name must be a string",h3.ERR_INVALID_PARAMETERS);if(null!=t.value){if(parseInt("".concat(t.value),10)!==t.value)throw new fu.sv("Tag value must be an integer",h3.ERR_INVALID_PARAMETERS);if(t.value<0||t.value>100)throw new fu.sv("Tag value must be between 0-100",h3.ERR_INVALID_PARAMETERS)}if(null!=t.ttl){if(parseInt("".concat(t.ttl),10)!==t.ttl)throw new fu.sv("Tag ttl must be an integer",h3.ERR_INVALID_PARAMETERS);if(t.ttl<0)throw new fu.sv("Tag ttl must be between greater than 0",h3.ERR_INVALID_PARAMETERS)}}function T3(e,t){var n;let r;return null!=t.expiry&&(r=t.expiry),null!=t.ttl&&(r=BigInt(Date.now()+Number(t.ttl))),{value:null!==(n=t.value)&&void 0!==n?n:0,expiry:r}}function k3(e,t,n){const r=e.toString().split("/")[2],i=G2(S1.decode(r)),o=n.get(i);if(null!=o)return o;const s=g3(i,t);return n.set(i,s),s}var R3=new WeakSet,x3=new WeakSet;class P3{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Qd(this,x3),Qd(this,R3),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"datastore",void 0),(0,Yo.Z)(this,"lock",void 0),(0,Yo.Z)(this,"addressFilter",void 0),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.lock=u3({name:"peer-store",singleProcess:!0})}async has(e){return this.datastore.has(E3(e))}async delete(e){if(this.peerId.equals(e))throw new fu.sv("Cannot delete self peer",h3.ERR_INVALID_PARAMETERS);await this.datastore.delete(E3(e))}async load(e){return g3(e,await this.datastore.get(E3(e)))}async save(e,t){const{existingBuf:n,existingPeer:r}=await Yd(this,R3,D3).call(this,e),i=await S3(e,t,"patch",{addressFilter:this.addressFilter});return Yd(this,x3,O3).call(this,e,i,n,r)}async patch(e,t){const{existingBuf:n,existingPeer:r}=await Yd(this,R3,D3).call(this,e),i=await S3(e,t,"patch",{addressFilter:this.addressFilter,existingPeer:r});return Yd(this,x3,O3).call(this,e,i,n,r)}async merge(e,t){const{existingBuf:n,existingPeer:r}=await Yd(this,R3,D3).call(this,e),i=await S3(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:r});return Yd(this,x3,O3).call(this,e,i,n,r)}async*all(e){const t=new lx;for await(const{key:n,value:r}of this.datastore.query(function(e,t){var n,r;return null==e?{}:{prefix:w3,filters:(null!==(n=e.filters)&&void 0!==n?n:[]).map((e=>n=>{let{key:r,value:i}=n;return e(k3(r,i,t))})),orders:(null!==(r=e.orders)&&void 0!==r?r:[]).map((e=>(n,r)=>e(k3(n.key,n.value,t),k3(r.key,r.value,t))))}}(null!==e&&void 0!==e?e:{},t))){const e=k3(n,r,t);e.id.equals(this.peerId)||(yield e)}}}async function D3(e){try{const t=await this.datastore.get(E3(e));return{existingBuf:t,existingPeer:g3(e,t)}}catch(t){if("ERR_NOT_FOUND"!==t.code)throw t}return{}}async function O3(e,t,n,r){const i=d3.encode(t);return null!=n&&(0,Ms.f)(i,n)?{peer:g3(e,i),previous:r,updated:!1}:(await this.datastore.put(E3(e),i),{peer:g3(e,i),previous:r,updated:!0})}var N3=new WeakSet;class B3{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Qd(this,N3),(0,Yo.Z)(this,"store",void 0),(0,Yo.Z)(this,"events",void 0),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"log",void 0),this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new P3(e,t)}async forEach(e,t){this.log.trace("forEach await read lock");const n=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(const n of this.store.all(t))e(n)}finally{this.log.trace("forEach release read lock"),n()}}async all(e){this.log.trace("all await read lock");const t=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await t1(this.store.all(e))}finally{this.log.trace("all release read lock"),t()}}async delete(e){this.log.trace("delete await write lock");const t=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(e)}finally{this.log.trace("delete release write lock"),t()}}async has(e){this.log.trace("has await read lock");const t=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(e)}finally{this.log.trace("has release read lock"),t()}}async get(e){this.log.trace("get await read lock");const t=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(e)}finally{this.log.trace("get release read lock"),t()}}async save(e,t){this.log.trace("save await write lock");const n=await this.store.lock.writeLock();this.log.trace("save got write lock");try{const n=await this.store.save(e,t);return Yd(this,N3,L3).call(this,e,n),n.peer}finally{this.log.trace("save release write lock"),n()}}async patch(e,t){this.log.trace("patch await write lock");const n=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{const n=await this.store.patch(e,t);return Yd(this,N3,L3).call(this,e,n),n.peer}finally{this.log.trace("patch release write lock"),n()}}async merge(e,t){this.log.trace("merge await write lock");const n=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{const n=await this.store.merge(e,t);return Yd(this,N3,L3).call(this,e,n),n.peer}finally{this.log.trace("merge release write lock"),n()}}async consumePeerRecord(e,t){var n;const r=await XT.openAndCertify(e,nk.DOMAIN);if(!1===(null===t||void 0===t?void 0:t.equals(r.peerId)))return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",t,r.peerId),!1;const i=nk.createFromProtobuf(r.payload);let o;try{o=await this.get(r.peerId)}catch(s){if("ERR_NOT_FOUND"!==s.code)throw s}if(null!=(null===(n=o)||void 0===n?void 0:n.peerRecordEnvelope)){const e=await XT.createFromProtobuf(o.peerRecordEnvelope),t=nk.createFromProtobuf(e.payload);if(t.seqNumber>=i.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",t.seqNumber,i.seqNumber),!1}return await this.patch(i.peerId,{peerRecordEnvelope:e,addresses:i.multiaddrs.map((e=>({isCertified:!0,multiaddr:e})))}),!0}}function L3(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}const M3=aH("libp2p:address-manager"),U3=e=>e;function F3(e,t){const n=e.getPeerId();if(null!=n){X0(n).equals(t)&&(e=e.decapsulate((0,ng.HM)("/p2p/".concat(t.toString()))))}return e}class K3{constructor(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"listen",void 0),(0,Yo.Z)(this,"announce",void 0),(0,Yo.Z)(this,"observed",void 0),(0,Yo.Z)(this,"announceFilter",void 0);const{listen:r=[],announce:i=[]}=n;this.components=e,this.listen=r.map((e=>e.toString())),this.announce=new Set(i.map((e=>e.toString()))),this.observed=new Map,this.announceFilter=null!==(t=n.announceFilter)&&void 0!==t?t:U3,this._updatePeerStoreAddresses=function(e,t){let n;return function(){clearTimeout(n),n=setTimeout((function(){n=void 0,e()}),t)}}(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",(()=>{this._updatePeerStoreAddresses()})),e.events.addEventListener("transport:close",(()=>{this._updatePeerStoreAddresses()}))}_updatePeerStoreAddresses(){const e=this.getAnnounceAddrs().concat(this.components.transportManager.getAddrs()).concat([...this.observed.entries()].filter((e=>{let[t,n]=e;return n.confident})).map((e=>{let[t]=e;return(0,ng.HM)(t)}))).map((e=>e.getPeerId()===this.components.peerId.toString()?e.decapsulate("/p2p/".concat(this.components.peerId.toString())):e));this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch((e=>{M3.error("error updating addresses",e)}))}getListenAddrs(){return Array.from(this.listen).map((e=>(0,ng.HM)(e)))}getAnnounceAddrs(){return Array.from(this.announce).map((e=>(0,ng.HM)(e)))}getObservedAddrs(){return Array.from(this.observed).map((e=>{let[t]=e;return(0,ng.HM)(t)}))}addObservedAddr(e){const t=(e=F3(e,this.components.peerId)).toString();this.observed.has(t)||this.observed.set(t,{confident:!1})}confirmObservedAddr(e){var t;const n=(e=F3(e,this.components.peerId)).toString(),r=(null!==(t=this.observed.get(n))&&void 0!==t?t:{confident:!1}).confident;this.observed.set(n,{confident:!0}),r||this._updatePeerStoreAddresses()}removeObservedAddr(e){const t=(e=F3(e,this.components.peerId)).toString();this.observed.delete(t)}getAddresses(){let e=this.getAnnounceAddrs().map((e=>e.toString()));0===e.length&&(e=this.components.transportManager.getAddrs().map((e=>e.toString()))),e=e.concat(Array.from(this.observed).filter((e=>{let[t,n]=e;return n.confident})).map((e=>{let[t]=e;return t})));const t=new Set(e);return this.announceFilter(Array.from(t).map((e=>(0,ng.HM)(e)))).map((e=>{var t;return!0===(null===(t=e.protos().pop())||void 0===t?void 0:t.path)||e.getPeerId()===this.components.peerId.toString()?e:e.encapsulate("/p2p/".concat(this.components.peerId.toString()))}))}}class j3{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,Yo.Z)(this,"components",{}),(0,Yo.Z)(this,"_started",!1),this.components={};for(const[t,n]of Object.entries(e))this.components[t]=n;null==this.components.logger&&(this.components.logger=sH())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter((e=>bH(e))).map((async t=>{var n;await(null===(n=t[e])||void 0===n?void 0:n.call(t))})))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const Z3=["metrics","connectionProtector"],z3=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function V3(){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{const t=e.stringTuples();return(4===t[0][0]||41===t[0][0])&&Boolean(mS("".concat(t[0][1])))},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}}}const H3=Symbol.for("@libp2p/transport");var q3;function G3(e){try{const{address:t}=e.nodeAddress();return Boolean(mS(t))}catch{return!0}}function W3(e,t){const n=function(e,t){const n=G3(e.multiaddr),r=G3(t.multiaddr);return n&&!r?1:!n&&r?-1:0}(e,t);if(0!==n)return n;const r=function(e,t){const n=tO.dx.exactMatch(e.multiaddr),r=tO.dx.exactMatch(t.multiaddr);return n&&!r?1:!n&&r?-1:0}(e,t);if(0!==r)return r;const i=function(e,t){return e.isCertified&&!t.isCertified?-1:!e.isCertified&&t.isCertified?1:0}(e,t);return i}!function(e){e[e.FATAL_ALL=0]="FATAL_ALL",e[e.NO_FATAL=1]="NO_FATAL"}(q3||(q3={}));var Q3=n(67024),Y3=n(449),J3=n.n(Y3);function X3(e,t,n){return"".concat(e,"?name=").concat(t,"&type=").concat(n)}async function $3(e,t){const n=await fetch(e,{headers:new Headers({accept:"application/dns-json"}),signal:t});return await n.json()}function e5(e,t){return"".concat(t,"_").concat(e)}const t5=Object.assign(sf()("dns-over-http-resolver"),{error:sf()("dns-over-http-resolver:error")});const n5=class{constructor(){var e,t,n;let r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,Yo.Z)(this,"_cache",void 0),(0,Yo.Z)(this,"_TXTcache",void 0),(0,Yo.Z)(this,"_servers",void 0),(0,Yo.Z)(this,"_request",void 0),(0,Yo.Z)(this,"_abortControllers",void 0),this._cache=new(J3())({max:null!==(e=null===r||void 0===r?void 0:r.maxCache)&&void 0!==e?e:100}),this._TXTcache=new(J3())({max:null!==(t=null===r||void 0===r?void 0:r.maxCache)&&void 0!==t?t:100}),this._servers=["https://cloudflare-dns.com/dns-query","https://dns.google/resolve"],this._request=null!==(n=r.request)&&void 0!==n?n:$3,this._abortControllers=[]}cancel(){this._abortControllers.forEach((e=>{e.abort()}))}getServers(){return this._servers}_getShuffledServers(){const e=[...this._servers];for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*t),r=e[t];e[t]=e[n],e[n]=r}return e}setServers(e){this._servers=e}async resolve(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"A";switch(t){case"A":return this.resolve4(e);case"AAAA":return this.resolve6(e);case"TXT":return this.resolveTxt(e);default:throw new Error("".concat(t," is not supported"))}}async resolve4(e){const t="A",n=this._cache.get(e5(e,t));if(null!=n)return n;let r=!1;for(const o of this._getShuffledServers()){const n=new AbortController;this._abortControllers.push(n);try{const r=await this._request(X3(o,e,t),n.signal),i=r.Answer.map((e=>e.data)),s=Math.min(...r.Answer.map((e=>e.TTL)));return this._cache.set(e5(e,t),i,{ttl:s}),i}catch(i){n.signal.aborted&&(r=!0),t5.error("".concat(o," could not resolve ").concat(e," record ").concat(t))}finally{this._abortControllers=this._abortControllers.filter((e=>e!==n))}}if(r)throw Object.assign(new Error("queryA ECANCELLED"),{code:"ECANCELLED"});throw new Error("Could not resolve ".concat(e," record ").concat(t))}async resolve6(e){const t="AAAA",n=this._cache.get(e5(e,t));if(null!=n)return n;let r=!1;for(const o of this._getShuffledServers()){const n=new AbortController;this._abortControllers.push(n);try{const r=await this._request(X3(o,e,t),n.signal),i=r.Answer.map((e=>e.data)),s=Math.min(...r.Answer.map((e=>e.TTL)));return this._cache.set(e5(e,t),i,{ttl:s}),i}catch(i){n.signal.aborted&&(r=!0),t5.error("".concat(o," could not resolve ").concat(e," record ").concat(t))}finally{this._abortControllers=this._abortControllers.filter((e=>e!==n))}}if(r)throw Object.assign(new Error("queryAaaa ECANCELLED"),{code:"ECANCELLED"});throw new Error("Could not resolve ".concat(e," record ").concat(t))}async resolveTxt(e){const t="TXT",n=this._TXTcache.get(e5(e,t));if(null!=n)return n;let r=!1;for(const o of this._getShuffledServers()){const n=new AbortController;this._abortControllers.push(n);try{const r=await this._request(X3(o,e,t),n.signal),i=r.Answer.map((e=>[e.data.replace(/['"]+/g,"")])),s=Math.min(...r.Answer.map((e=>e.TTL)));return this._TXTcache.set(e5(e,t),i,{ttl:s}),i}catch(i){n.signal.aborted&&(r=!0),t5.error("".concat(o," could not resolve ").concat(e," record ").concat(t))}finally{this._abortControllers=this._abortControllers.filter((e=>e!==n))}}if(r)throw Object.assign(new Error("queryTxt ECANCELLED"),{code:"ECANCELLED"});throw new Error("Could not resolve ".concat(e," record ").concat(t))}clearCache(){this._cache.clear(),this._TXTcache.clear()}},{code:r5}=(0,Q3.Ev)("dnsaddr");async function i5(e,t={}){const n=new n5;null!=t.signal&&t.signal.addEventListener("abort",(()=>{n.cancel()}));const r=e.getPeerId(),[,i]=e.stringTuples().find((([e])=>e===r5))??[];if(null==i)throw new Error("No hostname found in multiaddr");let o=(await n.resolveTxt(`_dnsaddr.${i}`)).flat().map((e=>e.split("=")[1])).filter(Boolean);return null!=r&&(o=o.filter((e=>e.includes(r)))),o}var o5,s5;!function(e){e.NOT_STARTED_YET="The libp2p node is not started yet",e.DHT_DISABLED="DHT is not available",e.PUBSUB_DISABLED="PubSub is not available",e.CONN_ENCRYPTION_REQUIRED="At least one connection encryption module is required",e.ERR_TRANSPORTS_REQUIRED="At least one transport module is required",e.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",e.NOT_FOUND="Not found"}(o5||(o5={})),function(e){e.DHT_DISABLED="ERR_DHT_DISABLED",e.ERR_PUBSUB_DISABLED="ERR_PUBSUB_DISABLED",e.PUBSUB_NOT_STARTED="ERR_PUBSUB_NOT_STARTED",e.DHT_NOT_STARTED="ERR_DHT_NOT_STARTED",e.CONN_ENCRYPTION_REQUIRED="ERR_CONN_ENCRYPTION_REQUIRED",e.ERR_TRANSPORTS_REQUIRED="ERR_TRANSPORTS_REQUIRED",e.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",e.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",e.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",e.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",e.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",e.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",e.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",e.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",e.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",e.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",e.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",e.ERR_DIALED_SELF="ERR_DIALED_SELF",e.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",e.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",e.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",e.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",e.ERR_INVALID_KEY="ERR_INVALID_KEY",e.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_INVALID_PEER="ERR_INVALID_PEER",e.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",e.ERR_NOT_FOUND="ERR_NOT_FOUND",e.ERR_TIMEOUT="ERR_TIMEOUT",e.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",e.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",e.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",e.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",e.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",e.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",e.ERR_FIND_SELF="ERR_FIND_SELF",e.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",e.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",e.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",e.ERR_KEYCHAIN_REQUIRED="ERR_KEYCHAIN_REQUIRED",e.ERR_INVALID_CMS="ERR_INVALID_CMS",e.ERR_MISSING_KEYS="ERR_MISSING_KEYS",e.ERR_NO_KEY="ERR_NO_KEY",e.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",e.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",e.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",e.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",e.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",e.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",e.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",e.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",e.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",e.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",e.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",e.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",e.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",e.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",e.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",e.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",e.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",e.ERR_INVALID_RECORD="ERR_INVALID_RECORD",e.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",e.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",e.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",e.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",e.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED",e.ERR_TRANSFER_LIMIT_EXCEEDED="ERR_TRANSFER_LIMIT_EXCEEDED"}(s5||(s5={}));const a5={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:e=>e},connectionManager:{resolvers:{dnsaddr:i5},addressSorter:W3},transportManager:{faultTolerance:q3.FATAL_ALL}};var c5=n(57896);const l5=aH("libp2p:get-peer");function u5(e){if(P0(e))return{peerId:e,multiaddrs:[]};let t;if(Array.isArray(e)||(e=[e]),e.length>0){const n=e[0].getPeerId();t=null==n?void 0:X0(n),e.forEach((e=>{if(!(0,ng.h2)(e))throw l5.error("multiaddr %s was invalid",e),new aq("Invalid Multiaddr",s5.ERR_INVALID_MULTIADDR);const n=e.getPeerId();if(null==n){if(null!=t)throw new aq("Multiaddrs must all have the same peer id or have no peer id",s5.ERR_INVALID_PARAMETERS)}else{const e=X0(n);if(null==t||!t.equals(e))throw new aq("Multiaddrs must all have the same peer id or have no peer id",s5.ERR_INVALID_PARAMETERS)}}))}return{peerId:t,multiaddrs:e}}var h5=new WeakMap;class d5{constructor(){(0,dx.Z)(this,h5,{writable:!0,value:[]})}enqueue(e,t){var n;const r=null===t||void 0===t?void 0:t.peerId,i=null!==(n=null===t||void 0===t?void 0:t.priority)&&void 0!==n?n:0;if(null==r)throw new aq("missing peer id",s5.ERR_INVALID_PARAMETERS);const o={priority:i,peerId:r,run:e};if(this.size>0&&(0,fx.Z)(this,h5)[this.size-1].priority>=i)return void(0,fx.Z)(this,h5).push(o);const s=function(e,t,n){let r=0,i=e.length;for(;i>0;){const o=Math.trunc(i/2);let s=r+o;n(e[s],t)<=0?(r=++s,i-=o+1):i=o}return r}((0,fx.Z)(this,h5),o,((e,t)=>t.priority-e.priority));(0,fx.Z)(this,h5).splice(s,0,o)}dequeue(){const e=(0,fx.Z)(this,h5).shift();return null===e||void 0===e?void 0:e.run}filter(e){if(null!=e.peerId){const t=e.peerId;return(0,fx.Z)(this,h5).filter((e=>t.equals(e.peerId))).map((e=>e.run))}return(0,fx.Z)(this,h5).filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return(0,fx.Z)(this,h5).length}}class f5 extends Bm.Z{constructor(){super({...arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},queueClass:d5})}hasJob(e){return this.sizeBy({peerId:e})>0}}const p5=100,g5="last-dial-failure",y5={minConnections:5,maxQueueLength:100,autoDialConcurrency:25,autoDialPriority:0,autoDialInterval:5e3,autoDialPeerRetryThreshold:42e4,autoDialDiscoveredPeersDebounce:10};var m5=new WeakMap;class v5{constructor(e,t){var n,r,i,o,s,a,c;let l;(0,Yo.Z)(this,"connectionManager",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"queue",void 0),(0,Yo.Z)(this,"minConnections",void 0),(0,Yo.Z)(this,"autoDialPriority",void 0),(0,Yo.Z)(this,"autoDialIntervalMs",void 0),(0,Yo.Z)(this,"autoDialMaxQueueLength",void 0),(0,Yo.Z)(this,"autoDialPeerRetryThresholdMs",void 0),(0,Yo.Z)(this,"autoDialDiscoveredPeersDebounce",void 0),(0,Yo.Z)(this,"autoDialInterval",void 0),(0,Yo.Z)(this,"started",void 0),(0,Yo.Z)(this,"running",void 0),(0,dx.Z)(this,m5,{writable:!0,value:void 0}),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.minConnections=null!==(n=t.minConnections)&&void 0!==n?n:y5.minConnections,this.autoDialPriority=null!==(r=t.autoDialPriority)&&void 0!==r?r:y5.autoDialPriority,this.autoDialIntervalMs=null!==(i=t.autoDialInterval)&&void 0!==i?i:y5.autoDialInterval,this.autoDialMaxQueueLength=null!==(o=t.maxQueueLength)&&void 0!==o?o:y5.maxQueueLength,this.autoDialPeerRetryThresholdMs=null!==(s=t.autoDialPeerRetryThreshold)&&void 0!==s?s:y5.autoDialPeerRetryThreshold,this.autoDialDiscoveredPeersDebounce=null!==(a=t.autoDialDiscoveredPeersDebounce)&&void 0!==a?a:y5.autoDialDiscoveredPeersDebounce,CG(this,m5,e.logger.forComponent("libp2p:connection-manager:auto-dial")),this.started=!1,this.running=!1,this.queue=new f5({concurrency:null!==(c=t.autoDialConcurrency)&&void 0!==c?c:y5.autoDialConcurrency}),this.queue.addListener("error",(e=>{(0,fx.Z)(this,m5).error("error during auto-dial",e)})),e.events.addEventListener("connection:close",(()=>{this.autoDial().catch((e=>{(0,fx.Z)(this,m5).error(e)}))})),e.events.addEventListener("peer:discovery",(()=>{clearTimeout(l),l=setTimeout((()=>{this.autoDial().catch((e=>{(0,fx.Z)(this,m5).error(e)}))}),this.autoDialDiscoveredPeersDebounce)}))}isStarted(){return this.started}start(){this.autoDialInterval=setTimeout((()=>{this.autoDial().catch((e=>{(0,fx.Z)(this,m5).error("error while autodialing",e)}))}),this.autoDialIntervalMs),this.started=!0}afterStart(){this.autoDial().catch((e=>{(0,fx.Z)(this,m5).error("error while autodialing",e)}))}stop(){this.queue.clear(),clearTimeout(this.autoDialInterval),this.started=!1,this.running=!1}async autoDial(){if(!this.started)return;const e=this.connectionManager.getConnectionsMap(),t=e.size;if(t>=this.minConnections)return void(this.minConnections>0&&(0,fx.Z)(this,m5).trace("have enough connections %d/%d",t,this.minConnections));if(this.queue.size>this.autoDialMaxQueueLength)return void(0,fx.Z)(this,m5).call(this,"not enough connections %d/%d but auto dial queue is full",t,this.minConnections);if(this.running)return void(0,fx.Z)(this,m5).call(this,"not enough connections %d/%d - but skipping autodial as it is already running",t,this.minConnections);this.running=!0,(0,fx.Z)(this,m5).call(this,"not enough connections %d/%d - will dial peers to increase the number of connections",t,this.minConnections);const n=new ux(this.connectionManager.getDialQueue().map((e=>e.peerId)).filter(Boolean)),r=await this.peerStore.all({filters:[t=>0===t.addresses.length?((0,fx.Z)(this,m5).trace("not autodialing %p because they have no addresses",t.id),!1):e.has(t.id)?((0,fx.Z)(this,m5).trace("not autodialing %p because they are already connected",t.id),!1):n.has(t.id)?((0,fx.Z)(this,m5).trace("not autodialing %p because they are already being dialed",t.id),!1):!this.queue.hasJob(t.id)||((0,fx.Z)(this,m5).trace("not autodialing %p because they are already being autodialed",t.id),!1)]}),i=r.sort((()=>Math.random()>.5?1:-1)),o=new lx;for(const a of i)o.has(a.id)||o.set(a.id,[...a.tags.values()].reduce(((e,t)=>e+t.value),0));const s=i.sort(((e,t)=>{var n,r;const i=null!==(n=o.get(e.id))&&void 0!==n?n:0,s=null!==(r=o.get(t.id))&&void 0!==r?r:0;return i>s?-1:i<s?1:0})).filter((e=>{const t=e.metadata.get(g5);if(null==t)return!0;const n=parseInt((0,Au.B)(t));return!!isNaN(n)||Date.now()-n>this.autoDialPeerRetryThresholdMs}));(0,fx.Z)(this,m5).call(this,"selected %d/%d peers to dial",s.length,r.length);for(const a of s)this.queue.add((async()=>{const e=this.connectionManager.getConnectionsMap().size;if(e>=this.minConnections)return(0,fx.Z)(this,m5).call(this,"got enough connections now %d/%d",e,this.minConnections),void this.queue.clear();(0,fx.Z)(this,m5).call(this,"connecting to a peerStore stored peer %p",a.id),await this.connectionManager.openConnection(a.id,{priority:this.autoDialPriority})}),{peerId:a.id}).catch((e=>{(0,fx.Z)(this,m5).error("could not connect to peerStore stored peer",e)}));this.running=!1,this.started&&(this.autoDialInterval=setTimeout((()=>{this.autoDial().catch((e=>{(0,fx.Z)(this,m5).error("error while autodialing",e)}))}),this.autoDialIntervalMs))}}const b5={maxConnections:p5,allow:[]};var w5=new WeakMap;class E5{constructor(e){var t,n;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"maxConnections",void 0),(0,Yo.Z)(this,"connectionManager",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"allow",void 0),(0,Yo.Z)(this,"events",void 0),(0,dx.Z)(this,w5,{writable:!0,value:void 0}),this.maxConnections=null!==(t=r.maxConnections)&&void 0!==t?t:b5.maxConnections,this.allow=null!==(n=r.allow)&&void 0!==n?n:b5.allow,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,CG(this,w5,e.logger.forComponent("libp2p:connection-manager:connection-pruner")),e.events.addEventListener("connection:open",(()=>{this.maybePruneConnections().catch((e=>{(0,fx.Z)(this,w5).error(e)}))}))}async maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,n=Math.max(t-this.maxConnections,0);if((0,fx.Z)(this,w5).call(this,"checking max connections limit %d/%d",t,this.maxConnections),t<=this.maxConnections)return;(0,fx.Z)(this,w5).call(this,"max connections limit exceeded %d/%d, pruning %d connection(s)",t,this.maxConnections,n);const r=new lx;for(const a of e){const e=a.remotePeer;if(!r.has(e)){r.set(e,0);try{const t=await this.peerStore.get(e);r.set(e,[...t.tags.values()].reduce(((e,t)=>e+t.value),0))}catch(s){"ERR_NOT_FOUND"!==s.code&&(0,fx.Z)(this,w5).error("error loading peer tags",s)}}}const i=e.sort(((e,t)=>{var n,i;const o=null!==(n=r.get(e.remotePeer))&&void 0!==n?n:0,s=null!==(i=r.get(t.remotePeer))&&void 0!==i?i:0;if(o>s)return 1;if(o<s)return-1;const a=e.timeline.open,c=t.timeline.open;return a<c?1:a>c?-1:0})),o=[];for(const a of i){(0,fx.Z)(this,w5).call(this,"too many connections open - closing a connection to %p",a.remotePeer);if(this.allow.some((e=>a.remoteAddr.toString().startsWith(e.toString())))||o.push(a),o.length===n)break}await Promise.all(o.map((async e=>{try{await e.close()}catch(s){(0,fx.Z)(this,w5).error(s)}}))),this.events.safeDispatchEvent("connection:prune",{detail:o})}}async function A5(e,t){if(!e.protoNames().includes("dnsaddr"))return[e];const n=await async function(e,t){try{e=(0,ng.HM)(e.toString());return await e.resolve(t)}catch(n){return t.log.error("multiaddr ".concat(e.toString()," could not be resolved"),n),[]}}(e,t),r=(await Promise.all(n.map((async e=>A5(e,t))))).flat().reduce(((e,t)=>(null==e.find((e=>e.equals(t)))&&e.push(t),e)),[]);return t.log("resolved %s to",e,r.map((e=>e.toString()))),r}const S5={addressSorter:W3,maxParallelDials:50,maxPeerAddrsToDial:25,maxParallelDialsPerPeer:1,dialTimeout:3e4,resolvers:{dnsaddr:i5}};var _5=new WeakMap;class I5{constructor(e){var t,n,r,i,o,s,a,c;let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"pendingDials",void 0),(0,Yo.Z)(this,"queue",void 0),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"connectionGater",void 0),(0,Yo.Z)(this,"transportManager",void 0),(0,Yo.Z)(this,"addressSorter",void 0),(0,Yo.Z)(this,"maxPeerAddrsToDial",void 0),(0,Yo.Z)(this,"maxParallelDialsPerPeer",void 0),(0,Yo.Z)(this,"dialTimeout",void 0),(0,Yo.Z)(this,"inProgressDialCount",void 0),(0,Yo.Z)(this,"pendingDialCount",void 0),(0,Yo.Z)(this,"shutDownController",void 0),(0,Yo.Z)(this,"connections",void 0),(0,dx.Z)(this,_5,{writable:!0,value:void 0}),this.addressSorter=null!==(t=l.addressSorter)&&void 0!==t?t:S5.addressSorter,this.maxPeerAddrsToDial=null!==(n=l.maxPeerAddrsToDial)&&void 0!==n?n:S5.maxPeerAddrsToDial,this.maxParallelDialsPerPeer=null!==(r=l.maxParallelDialsPerPeer)&&void 0!==r?r:S5.maxParallelDialsPerPeer,this.dialTimeout=null!==(i=l.dialTimeout)&&void 0!==i?i:S5.dialTimeout,this.connections=null!==(o=l.connections)&&void 0!==o?o:new lx,CG(this,_5,e.logger.forComponent("libp2p:connection-manager:dial-queue")),this.peerId=e.peerId,this.peerStore=e.peerStore,this.connectionGater=e.connectionGater,this.transportManager=e.transportManager,this.shutDownController=new AbortController,dJ(1/0,this.shutDownController.signal),this.pendingDialCount=null===(s=e.metrics)||void 0===s?void 0:s.registerMetric("libp2p_dialler_pending_dials"),this.inProgressDialCount=null===(a=e.metrics)||void 0===a?void 0:a.registerMetric("libp2p_dialler_in_progress_dials"),this.pendingDials=[];for(const[h,d]of Object.entries(null!==(u=l.resolvers)&&void 0!==u?u:{})){var u;ng.s_.set(h,d)}this.queue=new Bm.Z({concurrency:null!==(c=l.maxParallelDials)&&void 0!==c?c:S5.maxParallelDials}),this.queue.on("add",(()=>{var e,t;null===(e=this.pendingDialCount)||void 0===e||e.update(this.queue.size),null===(t=this.inProgressDialCount)||void 0===t||t.update(this.queue.pending)})),this.queue.on("active",(()=>{var e,t;null===(e=this.pendingDialCount)||void 0===e||e.update(this.queue.size),null===(t=this.inProgressDialCount)||void 0===t||t.update(this.queue.pending)})),this.queue.on("completed",(()=>{var e,t;null===(e=this.pendingDialCount)||void 0===e||e.update(this.queue.size),null===(t=this.inProgressDialCount)||void 0===t||t.update(this.queue.pending)})),this.queue.on("error",(e=>{var t,n;(0,fx.Z)(this,_5).error("error in dial queue",e),null===(t=this.pendingDialCount)||void 0===t||t.update(this.queue.size),null===(n=this.inProgressDialCount)||void 0===n||n.update(this.queue.pending)})),this.queue.on("empty",(()=>{var e,t;null===(e=this.pendingDialCount)||void 0===e||e.update(this.queue.size),null===(t=this.inProgressDialCount)||void 0===t||t.update(this.queue.pending)})),this.queue.on("idle",(()=>{var e,t;null===(e=this.pendingDialCount)||void 0===e||e.update(this.queue.size),null===(t=this.inProgressDialCount)||void 0===t||t.update(this.queue.pending)}))}stop(){this.shutDownController.abort()}async dial(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{peerId:n,multiaddrs:r}=u5(e),i=r.map((e=>({multiaddr:e,isCertified:!1}))),o=this.createDialAbortControllers(t.signal);let s;try{s=await this.calculateMultiaddrs(n,i,{...t,signal:o})}catch(h){throw o.clear(),h}let a=Array.from(this.connections.values()).flat().find((e=>!0!==t.force&&s.find((t=>t.multiaddr.equals(e.remoteAddr)))));if(null!=a)return(0,fx.Z)(this,_5).call(this,"already connected to %a",a.remoteAddr),a;const c=this.pendingDials.find((e=>!(null==e.peerId||null==n||!e.peerId.equals(n))||s.map((e=>{let{multiaddr:t}=e;return t.toString()})).join()===e.multiaddrs.map((e=>e.toString())).join()));if(null!=c)return(0,fx.Z)(this,_5).call(this,"joining existing dial target for %p",n),o.clear(),c.promise;(0,fx.Z)(this,_5).call(this,"creating dial target for",s.map((e=>{let{multiaddr:t}=e;return t.toString()})));const l={id:"".concat(parseInt(String(1e9*Math.random()),10).toString()).concat(Date.now()),status:"queued",peerId:n,multiaddrs:s.map((e=>{let{multiaddr:t}=e;return t}))};l.promise=this.performDial(l,{...t,signal:o}).finally((()=>{this.pendingDials=this.pendingDials.filter((e=>e.id!==l.id)),o.clear()})).catch((async e=>{if((0,fx.Z)(this,_5).error("dial failed to %s",l.multiaddrs.map((e=>e.toString())).join(", "),e),null!=n)try{await this.peerStore.patch(n,{metadata:{[g5]:(0,yu.m)(Date.now().toString())}})}catch(e){(0,fx.Z)(this,_5).error("could not update last dial failure key for %p",n,e)}if(o.aborted){throw new aq(e.message,s5.ERR_TIMEOUT)}throw e})),this.pendingDials.push(l);const u=await l.promise;return a=Array.from(this.connections.values()).flat().find((e=>!0!==t.force&&(e.id!==u.id&&e.remoteAddr.equals(u.remoteAddr)))),null!=a?((0,fx.Z)(this,_5).call(this,"already connected to %a",a.remoteAddr),await u.close(),a):((0,fx.Z)(this,_5).call(this,"connection opened to %a",u.remoteAddr),u)}createDialAbortControllers(e){const t=SH([AbortSignal.timeout(this.dialTimeout),this.shutDownController.signal,e]);try{null===dJ||void 0===dJ||dJ(1/0,t)}catch{}return t}async calculateMultiaddrs(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(null!=e){var r,i;if(this.peerId.equals(e))throw new aq("Tried to dial self",s5.ERR_DIALED_SELF);if(!0===await(null===(r=(i=this.connectionGater).denyDialPeer)||void 0===r?void 0:r.call(i,e)))throw new aq("The dial request is blocked by gater.allowDialPeer",s5.ERR_PEER_DIAL_INTERCEPTED);if(0===t.length){(0,fx.Z)(this,_5).call(this,"loading multiaddrs for %p",e);try{const n=await this.peerStore.get(e);t.push(...n.addresses),(0,fx.Z)(this,_5).call(this,"loaded multiaddrs for %p",e,t.map((e=>{let{multiaddr:t}=e;return t.toString()})))}catch(h){if(h.code!==s5.ERR_NOT_FOUND)throw h}}}let o=(await Promise.all(t.map((async e=>{const t=await A5(e.multiaddr,{...n,log:(0,fx.Z)(this,_5)});return 1===t.length&&t[0].equals(e.multiaddr)?e:t.map((e=>({multiaddr:e,isCertified:!1})))})))).flat();if(null!=e){const t="/p2p/".concat(e.toString());o=o.map((e=>{const n=e.multiaddr.protos().pop();return!0===(null===n||void 0===n?void 0:n.path)?e:null==e.multiaddr.getPeerId()?{multiaddr:e.multiaddr.encapsulate(t),isCertified:e.isCertified}:e}))}const s=o.filter((t=>{if(null==this.transportManager.transportForMultiaddr(t.multiaddr))return!1;const n=t.multiaddr.getPeerId();return null==e||null==n||e.equals(n)})),a=new Map;for(const d of s){const e=d.multiaddr.toString(),t=a.get(e);null==t?a.set(e,d):t.isCertified=t.isCertified||d.isCertified||!1}const c=[...a.values()];if((0===c.length||c.length>this.maxPeerAddrsToDial)&&((0,fx.Z)(this,_5).call(this,"addresses for %p before filtering",null!==e&&void 0!==e?e:"unknown peer",o.map((e=>{let{multiaddr:t}=e;return t.toString()}))),(0,fx.Z)(this,_5).call(this,"addresses for %p after filtering",null!==e&&void 0!==e?e:"unknown peer",c.map((e=>{let{multiaddr:t}=e;return t.toString()})))),0===c.length)throw new aq("The dial request has no valid addresses",s5.ERR_NO_VALID_ADDRESSES);if(c.length>this.maxPeerAddrsToDial)throw new aq("dial with more addresses than allowed",s5.ERR_TOO_MANY_ADDRESSES);const l=[];for(const d of c)null!=this.connectionGater.denyDialMultiaddr&&await this.connectionGater.denyDialMultiaddr(d.multiaddr)||l.push(d);const u=l.sort(this.addressSorter);if(0===u.length)throw new aq("The connection gater denied all addresses in the dial request",s5.ERR_NO_VALID_ADDRESSES);return u}async performDial(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=e.multiaddrs.map((()=>new AbortController));try{const r=new Bm.Z({concurrency:this.maxParallelDialsPerPeer});r.on("error",(e=>{(0,fx.Z)(this,_5).error("error dialling",e)}));const i=await Promise.any(e.multiaddrs.map((async(i,o)=>{const s=n[o];if(null==s)throw new aq("dialAction did not come with an AbortController",s5.ERR_INVALID_PARAMETERS);const a=function(){const e=[];for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(const o of n)null!=o&&(dJ(1/0,o),e.push(o));const i=SH(e);return dJ(1/0,i),i}(s.signal,t.signal);a.addEventListener("abort",(()=>{(0,fx.Z)(this,_5).call(this,"dial to %a aborted",i)}));const c=Ws();return await r.add((async()=>{if(a.aborted)return(0,fx.Z)(this,_5).call(this,"dial to %a was aborted before reaching the head of the peer dial queue",i),void c.reject(new sq);await this.queue.add((async()=>{try{if(a.aborted)return(0,fx.Z)(this,_5).call(this,"dial to %a was aborted before reaching the head of the dial queue",i),void c.reject(new sq);e.status="active";const r=await this.transportManager.dial(i,{...t,signal:a});if(s.signal.aborted)return(0,fx.Z)(this,_5).call(this,"multiple dials succeeded, closing superfluous connection"),r.close().catch((e=>{(0,fx.Z)(this,_5).error("error closing superfluous connection",e)})),void c.reject(new sq);n[o]=void 0,n.forEach((e=>{void 0!==e&&e.abort()})),(0,fx.Z)(this,_5).call(this,"dial to %a succeeded",i),c.resolve(r)}catch(r){(0,fx.Z)(this,_5).error("error during dial of %a",i,r),c.reject(r)}}),{...t,signal:a}).catch((e=>{c.reject(e)}))}),{signal:a}).catch((e=>{c.reject(e)})).finally((()=>{a.clear()})),c.promise})));if(null==i)throw new aq("successful dial led to empty object returned from peer dial queue",s5.ERR_TRANSPORT_DIAL_FAILED);return e.status="success",i}catch(r){if(e.status="error",1===e.multiaddrs.length&&"AggregateError"===r.name)throw r.errors[0];throw r}}}const C5=5,T5=p5,k5=5,R5=10,x5=25,P5=0,D5=100;var O5=new WeakMap;class N5{constructor(e){var t,n,r,i,o,s,a,c,l,u,h,d,f,p,g;let y=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"started",void 0),(0,Yo.Z)(this,"connections",void 0),(0,Yo.Z)(this,"allow",void 0),(0,Yo.Z)(this,"deny",void 0),(0,Yo.Z)(this,"maxIncomingPendingConnections",void 0),(0,Yo.Z)(this,"incomingPendingConnections",void 0),(0,Yo.Z)(this,"maxConnections",void 0),(0,Yo.Z)(this,"dialQueue",void 0),(0,Yo.Z)(this,"autoDial",void 0),(0,Yo.Z)(this,"connectionPruner",void 0),(0,Yo.Z)(this,"inboundConnectionRateLimiter",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"events",void 0),(0,dx.Z)(this,O5,{writable:!0,value:void 0}),this.maxConnections=null!==(t=y.maxConnections)&&void 0!==t?t:T5;const m=null!==(n=y.minConnections)&&void 0!==n?n:C5;if(this.maxConnections<m)throw new aq("Connection Manager maxConnections must be greater than minConnections",s5.ERR_INVALID_PARAMETERS);this.connections=new lx,this.started=!1,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,CG(this,O5,e.logger.forComponent("libp2p:connection-manager")),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),this.allow=(null!==(r=y.allow)&&void 0!==r?r:[]).map((e=>(0,ng.HM)(e))),this.deny=(null!==(i=y.deny)&&void 0!==i?i:[]).map((e=>(0,ng.HM)(e))),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=null!==(o=y.maxIncomingPendingConnections)&&void 0!==o?o:R5,this.inboundConnectionRateLimiter=new c5.RateLimiterMemory({points:null!==(s=y.inboundConnectionThreshold)&&void 0!==s?s:k5,duration:1}),this.autoDial=new v5({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{minConnections:m,autoDialConcurrency:null!==(a=y.autoDialConcurrency)&&void 0!==a?a:x5,autoDialPriority:null!==(c=y.autoDialPriority)&&void 0!==c?c:P5,maxQueueLength:null!==(l=y.autoDialMaxQueueLength)&&void 0!==l?l:D5}),this.connectionPruner=new E5({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{maxConnections:this.maxConnections,allow:this.allow}),this.dialQueue=new I5({peerId:e.peerId,metrics:e.metrics,peerStore:e.peerStore,transportManager:e.transportManager,connectionGater:e.connectionGater,logger:e.logger},{addressSorter:null!==(u=y.addressSorter)&&void 0!==u?u:W3,maxParallelDials:null!==(h=y.maxParallelDials)&&void 0!==h?h:50,maxPeerAddrsToDial:null!==(d=y.maxPeerAddrsToDial)&&void 0!==d?d:25,maxParallelDialsPerPeer:null!==(f=y.maxParallelDialsPerPeer)&&void 0!==f?f:1,dialTimeout:null!==(p=y.dialTimeout)&&void 0!==p?p:3e4,resolvers:null!==(g=y.resolvers)&&void 0!==g?g:{dnsaddr:i5},connections:this.connections})}isStarted(){return this.started}async start(){var e,t,n;null===(e=this.metrics)||void 0===e||e.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,outbound:0};for(const t of this.connections.values())for(const n of t)"inbound"===n.direction?e.inbound++:e.outbound++;return e}}),null===(t=this.metrics)||void 0===t||t.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const r of this.connections.values())for(const i of r)for(const r of i.streams){var t,n;const i="".concat(r.direction," ").concat(null!==(t=r.protocol)&&void 0!==t?t:"unnegotiated");e[i]=(null!==(n=e[i])&&void 0!==n?n:0)+1}return e}}),null===(n=this.metrics)||void 0===n||n.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const o of this.connections.values())for(const i of o){const o={};for(const e of i.streams){var t,n;const r="".concat(e.direction," ").concat(null!==(t=e.protocol)&&void 0!==t?t:"unnegotiated");o[r]=(null!==(n=o[r])&&void 0!==n?n:0)+1}for(const[t,n]of Object.entries(o)){var r;e[t]=null!==(r=e[t])&&void 0!==r?r:[],e[t].push(n)}}const i={};for(let[o,s]of Object.entries(e)){s=s.sort(((e,t)=>e-t));const e=Math.floor(.9*s.length);i[o]=s[e]}return i}}),this.autoDial.start(),this.started=!0,(0,fx.Z)(this,O5).call(this,"started")}async afterStart(){Promise.resolve().then((async()=>{const e=await this.peerStore.all({filters:[e=>e.tags.has("keep-alive")]});await Promise.all(e.map((async e=>{await this.openConnection(e.id).catch((e=>{(0,fx.Z)(this,O5).error(e)}))})))})).catch((e=>{(0,fx.Z)(this,O5).error(e)})),this.autoDial.afterStart()}async stop(){this.dialQueue.stop(),this.autoDial.stop();const e=[];for(const t of this.connections.values())for(const n of t)e.push((async()=>{try{await n.close()}catch(e){(0,fx.Z)(this,O5).error(e)}})());(0,fx.Z)(this,O5).call(this,"closing %d connections",e.length),await Promise.all(e),this.connections.clear(),(0,fx.Z)(this,O5).call(this,"stopped")}onConnect(e){this._onConnect(e).catch((e=>{(0,fx.Z)(this,O5).error(e)}))}async _onConnect(e){const{detail:t}=e;if(!this.started)return void await t.close();const n=t.remotePeer,r=this.connections.get(n);let i=!1;null!=r?r.push(t):(i=!0,this.connections.set(n,[t])),null!=n.publicKey&&"RSA"===n.type&&await this.peerStore.patch(n,{publicKey:n.publicKey}),i&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e;if(!this.started)return;const n=t.remotePeer;let r=this.connections.get(n);null!=r&&r.length>1?(r=r.filter((e=>e.id!==t.id)),this.connections.set(n,r)):null!=r&&(this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){var t;if(null!=e)return null!==(t=this.connections.get(e))&&void 0!==t?t:[];let n=[];for(const r of this.connections.values())n=n.concat(r);return n}getConnectionsMap(){return this.connections}async openConnection(e){var t,n;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.isStarted())throw new aq("Not started",s5.ERR_NODE_NOT_STARTED);null===(t=r.signal)||void 0===t||t.throwIfAborted();const{peerId:i}=u5(e);if(null!=i&&!0!==r.force){(0,fx.Z)(this,O5).call(this,"dial %p",i);const e=this.getConnections(i).find((e=>!e.transient));if(null!=e)return(0,fx.Z)(this,O5).call(this,"had an existing non-transient connection to %p",i),e}const o=await this.dialQueue.dial(e,{...r,priority:null!==(n=r.priority)&&void 0!==n?n:50});let s=this.connections.get(o.remotePeer);null==s&&(s=[],this.connections.set(o.remotePeer,s));let a=!1;for(const c of s)c.id===o.id&&(a=!0);return a||s.push(o),o}async closeConnections(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=null!==(t=this.connections.get(e))&&void 0!==t?t:[];await Promise.all(r.map((async e=>{try{await e.close(n)}catch(t){e.abort(t)}})))}async acceptIncomingConnection(e){if(this.deny.some((t=>e.remoteAddr.toString().startsWith(t.toString()))))return(0,fx.Z)(this,O5).call(this,"connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some((t=>e.remoteAddr.toString().startsWith(t.toString()))))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return(0,fx.Z)(this,O5).call(this,"connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const t=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(t,1)}catch{return(0,fx.Z)(this,O5).call(this,"connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,t),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):((0,fx.Z)(this,O5).call(this,"connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){return this.dialQueue.pendingDials}}async function*B5(e,t){yield*zq(e,(async e=>(await t.merge(e.id,{multiaddrs:e.multiaddrs}),e)))}function L5(e){const t=new Set;return gH(e,(e=>!t.has(e.id.toString())&&(t.add(e.id.toString()),!0)))}function M5(e){try{let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return async function*(){let n=0;for await(const t of e)n++,yield t;if(n<t)throw new aq("more peers required, seen: ".concat(n,"  min: ").concat(t),"NOT_FOUND")}()}catch(t){return Promise.reject(t)}}class U5{constructor(e,t){var n;(0,Yo.Z)(this,"routers",void 0),(0,Yo.Z)(this,"started",void 0),(0,Yo.Z)(this,"components",void 0),this.routers=null!==(n=t.routers)&&void 0!==n?n:[],this.started=!1,this.components=e}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}findProviders(e){try{var t=this;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return async function*(){if(0===t.routers.length)throw new aq("No content routers available",s5.ERR_NO_ROUTERS_AVAILABLE);yield*Yq(Qq(...t.routers.map((t=>t.findProviders(e,n)))),(e=>B5(e,t.components.peerStore)),(e=>L5(e)),(e=>M5(e)))}()}catch(n){return Promise.reject(n)}}async provide(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(0===this.routers.length)throw new aq("No content routers available",s5.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map((async n=>{await n.provide(e,t)})))}async put(e,t,n){if(!this.isStarted())throw new aq(o5.NOT_STARTED_YET,s5.DHT_NOT_STARTED);await Promise.all(this.routers.map((async r=>{await r.put(e,t,n)})))}async get(e,t){if(!this.isStarted())throw new aq(o5.NOT_STARTED_YET,s5.DHT_NOT_STARTED);return Promise.any(this.routers.map((async n=>n.get(e,t))))}}const F5=function(e){if(null!=e[Symbol.asyncIterator])return(async()=>{for await(const t of e)return t})();for(const t of e)return t},K5=aH("libp2p:peer-routing");class j5{constructor(e,t){var n;(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"routers",void 0),this.components=e,this.routers=null!==(n=t.routers)&&void 0!==n?n:[]}async findPeer(e,t){if(0===this.routers.length)throw new aq("No peer routers available",s5.ERR_NO_ROUTERS_AVAILABLE);if(e.toString()===this.components.peerId.toString())throw new aq("Should not try to find self",s5.ERR_FIND_SELF);const n=await Yq(Qq(...this.routers.map((n=>async function*(){try{yield await n.findPeer(e,t)}catch(r){K5.error(r)}}()))),(e=>gH(e,Boolean)),(e=>B5(e,this.components.peerStore)),(async e=>F5(e)));if(null!=n)return n;throw new aq(o5.NOT_FOUND,s5.ERR_NOT_FOUND)}async*getClosestPeers(e,t){if(0===this.routers.length)throw new aq("No peer routers available",s5.ERR_NO_ROUTERS_AVAILABLE);yield*Yq(Qq(...this.routers.map((n=>n.getClosestPeers(e,t)))),(e=>B5(e,this.components.peerStore)),(e=>L5(e)),(e=>M5(e)))}}const Z5=aH("libp2p:registrar");class z5{constructor(e){(0,Yo.Z)(this,"topologies",void 0),(0,Yo.Z)(this,"handlers",void 0),(0,Yo.Z)(this,"components",void 0),this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(null==t)throw new aq("No handler registered for protocol ".concat(e),s5.ERR_NO_HANDLER_FOR_PROTOCOL);return t}getTopologies(e){const t=this.topologies.get(e);return null==t?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e))throw new aq("Handler already registered for protocol ".concat(e),s5.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);const r=g0.Z.bind({ignoreUndefined:!0})({maxInboundStreams:32,maxOutboundStreams:64},n);this.handlers.set(e,{handler:t,options:r}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]})}async unhandle(e){(Array.isArray(e)?e:[e]).forEach((e=>{this.handlers.delete(e)})),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(e,t){if(null==t)throw new aq("invalid topology",s5.ERR_INVALID_PARAMETERS);const n="".concat((1e9*Math.random()).toString(36)).concat(Date.now());let r=this.topologies.get(e);return null==r&&(r=new Map,this.topologies.set(e,r)),r.set(n,t),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),0===n.size&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail;this.components.peerStore.get(t).then((e=>{for(const r of e.protocols){const e=this.topologies.get(r);if(null!=e)for(const r of e.values()){var n;null===(n=r.onDisconnect)||void 0===n||n.call(r,t)}}})).catch((e=>{e.code!==s5.ERR_NOT_FOUND&&Z5.error("could not inform topologies of disconnecting peer %p",t,e)}))}_onPeerUpdate(e){var t;const{peer:n,previous:r}=e.detail,i=(null!==(t=null===r||void 0===r?void 0:r.protocols)&&void 0!==t?t:[]).filter((e=>!n.protocols.includes(e)));for(const s of i){const e=this.topologies.get(s);if(null!=e)for(const t of e.values()){var o;null===(o=t.onDisconnect)||void 0===o||o.call(t,n.id)}}}_onPeerIdentify(e){const t=e.detail.protocols,n=e.detail.connection,r=e.detail.peerId;for(const o of t){const e=this.topologies.get(o);if(null!=e)for(const t of e.values()){var i;n.transient&&!0!==t.notifyOnTransient||(null===(i=t.onConnect)||void 0===i||i.call(t,r,n))}}}}const V5=aH("libp2p:transports");class H5{constructor(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"transports",void 0),(0,Yo.Z)(this,"listeners",void 0),(0,Yo.Z)(this,"faultTolerance",void 0),(0,Yo.Z)(this,"started",void 0),this.components=e,this.started=!1,this.transports=new Map,this.listeners=oq({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=null!==(t=n.faultTolerance)&&void 0!==t?t:q3.FATAL_ALL}add(e){const t=e[Symbol.toStringTag];if(null==t)throw new aq("Transport must have a valid tag",s5.ERR_INVALID_KEY);if(this.transports.has(t))throw new aq("There is already a transport with the tag ".concat(t),s5.ERR_DUPLICATE_TRANSPORT);V5("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,n]of this.listeners)for(V5("closing listeners for %s",t);n.length>0;){const t=n.pop();null!=t&&e.push(t.close())}await Promise.all(e),V5("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const n=this.transportForMultiaddr(e);if(null==n)throw new aq("No transport available for address ".concat(String(e)),s5.ERR_TRANSPORT_UNAVAILABLE);try{return await n.dial(e,{...t,upgrader:this.components.upgrader})}catch(r){throw null==r.code&&(r.code=s5.ERR_TRANSPORT_DIAL_FAILED),r}}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}transportForMultiaddr(e){for(const t of this.transports.values()){if(t.filter([e]).length>0)return t}}async listen(e){if(!this.isStarted())throw new aq("Not started",s5.ERR_NODE_NOT_STARTED);if(null==e||0===e.length)return void V5("no addresses were provided for listening, this node is dial only");const t=[];for(const[r,i]of this.transports.entries()){const o=i.filter(e),s=[];for(const e of o){var n;V5("creating listener for %s on %a",r,e);const t=i.createListener({upgrader:this.components.upgrader});let o=null!==(n=this.listeners.get(r))&&void 0!==n?n:[];null==o&&(o=[],this.listeners.set(r,o)),o.push(t),t.addEventListener("listening",(()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:t})})),t.addEventListener("close",(()=>{const e=o.findIndex((e=>e===t));o.splice(e,1),this.components.events.safeDispatchEvent("transport:close",{detail:t})})),s.push(t.listen(e))}if(0===s.length){t.push(r);continue}if(null==(await Promise.allSettled(s)).find((e=>"fulfilled"===e.status))&&this.faultTolerance!==q3.NO_FATAL)throw new aq("Transport (".concat(r,") could not listen on any available address"),s5.ERR_NO_VALID_ADDRESSES)}if(t.length===this.transports.size){const e="no valid addresses were provided for transports [".concat(t.join(", "),"]");if(this.faultTolerance===q3.FATAL_ALL)throw new aq(e,s5.ERR_NO_VALID_ADDRESSES);V5("libp2p in dial mode only: ".concat(e))}}async remove(e){var t;const n=null!==(t=this.listeners.get(e))&&void 0!==t?t:[];V5.trace("removing transport %s",e);const r=[];for(V5.trace("closing listeners for %s",e);n.length>0;){const e=n.pop();null!=e&&r.push(e.close())}await Promise.all(r),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const q5="/multistream/1.0.0",G5=1024,W5=(0,yu.m)("\n");async function Q5(e,t,n){await e.write(t,n)}async function Y5(e,t){const n=await async function(e,t){const n=await e.read(t);if(0===n.byteLength||n.get(n.byteLength-1)!==W5[0])throw null===t||void 0===t||t.log.error("Invalid mss message - missing newline",n),new fu.sv("missing newline","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return n.sublist(0,-1)}(e,t);return(0,Au.B)(n.subarray())}async function J5(e,t,n){if(1===(t=Array.isArray(t)?[...t]:[t]).length)return function(e,t,n){const r=e.sink.bind(e),i=e.source;let o=!1,s=!1;const a=Ws();let c=!1,l=!1;const u=Ws();let h=!1,d=!1;const f=Ws(),p=la({sink:r,source:i},{...n,maxDataLength:G5});async function g(){if(s)return null===n||void 0===n||n.log.trace("optimistic: already negotiating %s stream",t),void await a.promise;s=!0;try{c||(null===n||void 0===n||n.log.trace("optimistic: doing send protocol for %s stream",t),await y()),h||(null===n||void 0===n||n.log.trace("optimistic: doing read protocol for %s stream",t),await m())}finally{s=!1,o=!0,a.resolve()}}async function y(){if(l)await u.promise;else{l=!0;try{null===n||void 0===n||n.log.trace('optimistic: write ["%s", "%s", data] in source',q5,t),await p.writeV([(0,yu.m)("".concat(q5,"\n")),(0,yu.m)("".concat(t,"\n"))]),null===n||void 0===n||n.log.trace('optimistic: wrote ["%s", "%s", data] in source',q5,t)}finally{c=!0,l=!1,u.resolve()}}}async function m(){if(d)await f.promise;else{d=!0;try{null===n||void 0===n||n.log.trace("optimistic: reading multistream select header");let e=await Y5(p,n);if(null===n||void 0===n||n.log.trace('optimistic: read multistream select header "%s"',e),e===q5&&(e=await Y5(p,n)),null===n||void 0===n||n.log.trace('optimistic: read protocol "%s", expecting "%s"',e,t),e!==t)throw new fu.sv("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}finally{h=!0,d=!1,f.resolve()}}}if(e.sink=async e=>{const{sink:r}=p.unwrap();await r(async function*(){let r=!1;for await(const i of e){if(l&&await u.promise,c)yield i;else{l=!0,null===n||void 0===n||n.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',q5,t,i.byteLength);const e="".concat(t,"\n");yield new Zs(Uint8Array.from([19]),(0,yu.m)("".concat(q5,"\n")),Bs.cv(e.length),(0,yu.m)(e),i).subarray(),null===n||void 0===n||n.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',q5,t,i.byteLength),c=!0,l=!1,u.resolve()}r=!0}r||await g()}())},e.source=async function*(){await g(),null===n||void 0===n||n.log.trace('optimistic: reading data from "%s" stream',t),yield*p.unwrap().source}(),null!=e.closeRead){const t=e.closeRead.bind(e);e.closeRead=async e=>{o||await g().catch((e=>{null===n||void 0===n||n.log.error("could not negotiate protocol before close read",e)})),await t(e)}}if(null!=e.closeWrite){const t=e.closeWrite.bind(e);e.closeWrite=async e=>{o||await g().catch((e=>{null===n||void 0===n||n.log.error("could not negotiate protocol before close write",e)})),await t(e)}}if(null!=e.close){const t=e.close.bind(e);e.close=async e=>{o||(o=!0,s=!1,a.resolve()),await t(e)}}return{stream:e,protocol:t}}(e,t[0],n);const r=la(e,{...n,maxDataLength:G5}),i=t.shift();if(null==i)throw new Error("At least one protocol must be specified");null===n||void 0===n||n.log.trace('select: write ["%s", "%s"]',q5,i);const o=(0,yu.m)("".concat(q5,"\n")),s=(0,yu.m)("".concat(i,"\n"));await async function(e,t,n){await e.writeV(t,n)}(r,[o,s],n),null===n||void 0===n||n.log.trace("select: reading multistream-select header");let a=await Y5(r,n);if(null===n||void 0===n||n.log.trace('select: read "%s"',a),a===q5&&(null===n||void 0===n||n.log.trace("select: reading protocol response"),a=await Y5(r,n),null===n||void 0===n||n.log.trace('select: read "%s"',a)),a===i)return{stream:r.unwrap(),protocol:i};for(const c of t){null===n||void 0===n||n.log.trace('select: write "%s"',c),await Q5(r,(0,yu.m)("".concat(c,"\n")),n),null===n||void 0===n||n.log.trace("select: reading protocol response");const e=await Y5(r,n);if(null===n||void 0===n||n.log.trace('select: read "%s" for "%s"',e,c),e===c)return{stream:r.unwrap(),protocol:c}}throw new fu.sv("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}function X5(e){return null!=e[Symbol.asyncIterator]}const $5=e=>{const t=Bs.P$(e),n=(0,Us.E)(t);return Bs.cv(e,n),$5.bytes=t,n};function e4(e,t){var n,r;const i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:$5;function*o(e){const t=i(e.byteLength);t instanceof Uint8Array?yield t:yield*t,e instanceof Uint8Array?yield e:yield*e}return X5(e)?async function*(){for await(const t of e)yield*o(t)}():function*(){for(const t of e)yield*o(t)}()}$5.bytes=0,e4.single=(e,t)=>{var n,r;const i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:$5;return new Zs(i(e.byteLength),e)};var t4;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(t4||(t4={}));const n4=e=>{const t=Bs.Jx(e);return n4.bytes=Bs.P$(t),t};function r4(e,t){var n,r,i;const o=new Zs;let s=t4.LENGTH,a=-1;const c=null!==(n=null===t||void 0===t?void 0:t.lengthDecoder)&&void 0!==n?n:n4,l=null!==(r=null===t||void 0===t?void 0:t.maxLengthLength)&&void 0!==r?r:8,u=null!==(i=null===t||void 0===t?void 0:t.maxDataLength)&&void 0!==i?i:4194304;function*h(){for(;o.byteLength>0;){if(s===t4.LENGTH)try{if(a=c(o),a<0)throw Xo()(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(a>u)throw Xo()(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const e=c.bytes;o.consume(e),null!=(null===t||void 0===t?void 0:t.onLength)&&t.onLength(a),s=t4.DATA}catch(e){if(e instanceof RangeError){if(o.byteLength>l)throw Xo()(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw e}if(s===t4.DATA){if(o.byteLength<a)break;const e=o.sublist(0,a);o.consume(a),null!=(null===t||void 0===t?void 0:t.onData)&&t.onData(e),yield e,s=t4.LENGTH}}}return X5(e)?async function*(){for await(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}async function i4(e,t,n){t=Array.isArray(t)?t:[t],n.log.trace("handle: available protocols %s",t);const r=la(e,{...n,maxDataLength:G5,maxLengthLength:2});for(;;){null===n||void 0===n||n.log.trace("handle: reading incoming string");const e=await Y5(r,n);if(n.log.trace('handle: read "%s"',e),e!==q5){if(t.includes(e))return n.log.trace('handle: respond with "%s" for "%s"',e,e),await Q5(r,(0,yu.m)("".concat(e,"\n")),n),n.log.trace('handle: responded with "%s" for "%s"',e,e),{stream:r.unwrap(),protocol:e};if("ls"!==e)n.log('handle: respond with "na" for "%s"',e),await Q5(r,(0,yu.m)("na\n"),n),n.log('handle: responded with "na" for "%s"',e);else{const i=new Zs(...t.map((e=>e4.single((0,yu.m)("".concat(e,"\n"))))),(0,yu.m)("\n"));n.log.trace('handle: respond with "%s" for %s',t,e),await Q5(r,i,n),n.log.trace('handle: responded with "%s" for %s',t,e)}}else n.log.trace('handle: respond with "%s" for "%s"',q5,e),await Q5(r,(0,yu.m)("".concat(q5,"\n")),n),n.log.trace('handle: responded with "%s" for "%s"',q5,e)}}n4.bytes=0,r4.fromReader=(e,t)=>{let n=1;return r4(async function*(){for(;;)try{const{done:t,value:r}=await e.next(n);if(!0===t)return;null!=r&&(yield r)}catch(t){if("ERR_UNDER_READ"===t.code)return{done:!0,value:null};throw t}finally{n=1}}(),{...null!==t&&void 0!==t?t:{},onLength:e=>{n=e}})};const o4=Symbol.for("@libp2p/connection");var s4=new WeakMap;class a4{constructor(e){var t;(0,Yo.Z)(this,"id",void 0),(0,Yo.Z)(this,"remoteAddr",void 0),(0,Yo.Z)(this,"remotePeer",void 0),(0,Yo.Z)(this,"direction",void 0),(0,Yo.Z)(this,"timeline",void 0),(0,Yo.Z)(this,"multiplexer",void 0),(0,Yo.Z)(this,"encryption",void 0),(0,Yo.Z)(this,"status",void 0),(0,Yo.Z)(this,"transient",void 0),(0,Yo.Z)(this,"tags",void 0),(0,Yo.Z)(this,"_newStream",void 0),(0,Yo.Z)(this,"_close",void 0),(0,Yo.Z)(this,"_abort",void 0),(0,Yo.Z)(this,"_getStreams",void 0),(0,dx.Z)(this,s4,{writable:!0,value:void 0}),(0,Yo.Z)(this,Symbol.toStringTag,"Connection"),(0,Yo.Z)(this,o4,!0);const{remoteAddr:n,remotePeer:r,newStream:i,close:o,abort:s,getStreams:a}=e;this.id="".concat(parseInt(String(1e9*Math.random())).toString(36)).concat(Date.now()),this.remoteAddr=n,this.remotePeer=r,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.transient=null!==(t=e.transient)&&void 0!==t&&t,CG(this,s4,e.logger.forComponent("libp2p:connection")),null==this.remoteAddr.getPeerId()&&(this.remoteAddr=this.remoteAddr.encapsulate("/p2p/".concat(this.remotePeer))),this._newStream=i,this._close=o,this._abort=s,this._getStreams=a,this.tags=[]}get streams(){return this._getStreams()}async newStream(e,t){if("closing"===this.status)throw new aq("the connection is being closed","ERR_CONNECTION_BEING_CLOSED");if("closed"===this.status)throw new aq("the connection is closed","ERR_CONNECTION_CLOSED");if(Array.isArray(e)||(e=[e]),this.transient&&!0!==(null===t||void 0===t?void 0:t.runOnTransientConnection))throw new aq("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");const n=await this._newStream(e,t);return n.direction="outbound",n}async close(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("closed"!==this.status&&"closing"!==this.status){if((0,fx.Z)(this,s4).call(this,"closing connection to %a",this.remoteAddr),this.status="closing",null==e.signal){const t=AbortSignal.timeout(500);dJ(1/0,t),e={...e,signal:t}}try{(0,fx.Z)(this,s4).trace("closing all streams"),await Promise.all(this.streams.map((async t=>t.close(e)))),(0,fx.Z)(this,s4).trace("closing underlying transport"),await this._close(e),(0,fx.Z)(this,s4).trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){(0,fx.Z)(this,s4).error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){(0,fx.Z)(this,s4).error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this.streams.forEach((t=>{t.abort(e)})),(0,fx.Z)(this,s4).error("all streams aborted",this.streams.length),this._abort(e),this.timeline.close=Date.now(),this.status="closed"}}function c4(e,t,n){let r=0;return n.streams.forEach((n=>{n.direction===t&&n.protocol===e&&r++})),r}var l4=new WeakMap;class u4{constructor(e,t){var n;(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"connectionEncryption",void 0),(0,Yo.Z)(this,"muxers",void 0),(0,Yo.Z)(this,"inboundUpgradeTimeout",void 0),(0,Yo.Z)(this,"events",void 0),(0,dx.Z)(this,l4,{writable:!0,value:void 0}),this.components=e,this.connectionEncryption=new Map,CG(this,l4,e.logger.forComponent("libp2p:upgrader")),t.connectionEncryption.forEach((e=>{this.connectionEncryption.set(e.protocol,e)})),this.muxers=new Map,t.muxers.forEach((e=>{this.muxers.set(e.protocol,e)})),this.inboundUpgradeTimeout=null!==(n=t.inboundUpgradeTimeout)&&void 0!==n?n:3e4,this.events=e.events}async shouldBlockConnection(e,t,n){const r=this.components.connectionGater[n];if(void 0!==r&&await r(e,t))throw new aq("The multiaddr connection is blocked by gater.".concat(n),s5.ERR_CONNECTION_INTERCEPTED)}async upgradeInbound(e,t){if(!await this.components.connectionManager.acceptIncomingConnection(e))throw new aq("connection denied",s5.ERR_CONNECTION_DENIED);let n,r,i,o,s;const a=AbortSignal.timeout(this.inboundUpgradeTimeout),c=()=>{e.abort(new aq("inbound upgrade timeout",s5.ERR_TIMEOUT))};a.addEventListener("abort",c,{once:!0}),dJ(1/0,a);try{var l,u,h;if(!0===await(null===(l=(u=this.components.connectionGater).denyInboundConnection)||void 0===l?void 0:l.call(u,e)))throw new aq("The multiaddr connection is blocked by gater.acceptConnection",s5.ERR_CONNECTION_INTERCEPTED);null===(h=this.components.metrics)||void 0===h||h.trackMultiaddrConnection(e),(0,fx.Z)(this,l4).call(this,"starting the inbound connection upgrade");let a=e;if(!0!==(null===t||void 0===t?void 0:t.skipProtection)){const t=this.components.connectionProtector;null!=t&&((0,fx.Z)(this,l4).call(this,"protecting the inbound connection"),a=await t.protect(e))}try{if(n=a,!0!==(null===t||void 0===t?void 0:t.skipEncryption)){({conn:n,remotePeer:r,protocol:s}=await this._encryptInbound(a));const e={...a,...n};await this.shouldBlockConnection(r,e,"denyInboundEncryptedConnection")}else{const t=e.remoteAddr.getPeerId();if(null==t)throw new aq("inbound connection that skipped encryption must have a peer id",s5.ERR_INVALID_MULTIADDR);const n=X0(t);s="native",r=n}if(i=n,null!=(null===t||void 0===t?void 0:t.muxerFactory))o=t.muxerFactory;else if(this.muxers.size>0){const e=await this._multiplexInbound({...a,...n},this.muxers);o=e.muxerFactory,i=e.stream}}catch(d){throw(0,fx.Z)(this,l4).error("Failed to upgrade inbound connection",d),d}return await this.shouldBlockConnection(r,e,"denyInboundUpgradedConnection"),(0,fx.Z)(this,l4).call(this,"Successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:s,direction:"inbound",maConn:e,upgradedConn:i,muxerFactory:o,remotePeer:r,transient:null===t||void 0===t?void 0:t.transient})}finally{a.removeEventListener("abort",c),this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){var n;const r=e.remoteAddr.getPeerId();let i,o,s,a,c,l;null!=r&&(i=X0(r),await this.shouldBlockConnection(i,e,"denyOutboundConnection")),null===(n=this.components.metrics)||void 0===n||n.trackMultiaddrConnection(e),(0,fx.Z)(this,l4).call(this,"Starting the outbound connection upgrade");let u=e;if(!0!==(null===t||void 0===t?void 0:t.skipProtection)){const t=this.components.connectionProtector;null!=t&&(u=await t.protect(e))}try{if(o=u,!0!==(null===t||void 0===t?void 0:t.skipEncryption)){({conn:o,remotePeer:s,protocol:c}=await this._encryptOutbound(u,i));const e={...u,...o};await this.shouldBlockConnection(s,e,"denyOutboundEncryptedConnection")}else{if(null==i)throw new aq("Encryption was skipped but no peer id was passed",s5.ERR_INVALID_PEER);c="native",s=i}if(a=o,null!=(null===t||void 0===t?void 0:t.muxerFactory))l=t.muxerFactory;else if(this.muxers.size>0){const e=await this._multiplexOutbound({...u,...o},this.muxers);l=e.muxerFactory,a=e.stream}}catch(h){throw(0,fx.Z)(this,l4).error("Failed to upgrade outbound connection",h),await e.close(h),h}return await this.shouldBlockConnection(s,e,"denyOutboundUpgradedConnection"),(0,fx.Z)(this,l4).call(this,"Successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:c,direction:"outbound",maConn:e,upgradedConn:a,muxerFactory:l,remotePeer:s,transient:null===t||void 0===t?void 0:t.transient})}_createConnection(e){var t,n,r=this;const{cryptoProtocol:i,direction:o,maConn:s,upgradedConn:a,remotePeer:c,muxerFactory:l,transient:u}=e;let h,d,f;null!=l&&(h=l.createStreamMuxer({direction:o,onIncomingStream:e=>{null!=f&&Promise.resolve().then((async()=>{var t;const n=this.components.registrar.getProtocols(),{stream:r,protocol:i}=await i4(e,n);if((0,fx.Z)(this,l4).call(this,"%s: incoming stream opened on %s",o,i),null==f)return;const s=function(e,t){try{const{options:n}=t.getHandler(e);return n.maxInboundStreams}catch(n){if(n.code!==s5.ERR_NO_HANDLER_FOR_PROTOCOL)throw n}return 32}(i,this.components.registrar);if(c4(i,"inbound",f)===s){const t=new aq('Too many inbound protocol streams for protocol "'.concat(i,'" - limit ').concat(s),s5.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS);throw e.abort(t),t}e.source=r.source,e.sink=r.sink,e.protocol=i,await this.components.peerStore.merge(c,{protocols:[i]}),null===(t=this.components.metrics)||void 0===t||t.trackProtocolStream(e,f),this._onStream({connection:f,stream:e,protocol:i})})).catch((async t=>{(0,fx.Z)(this,l4).error(t),null==e.timeline.close&&await e.close()}))}}),d=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(null==h)throw new aq("Stream is not multiplexed",s5.ERR_MUXER_UNAVAILABLE);(0,fx.Z)(r,l4).call(r,"%s-%s: starting new stream on %s",f.id,o,e);const n=await h.newStream();try{var i;if(null==t.signal){(0,fx.Z)(r,l4).call(r,"No abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e);const n=AbortSignal.timeout(3e4);dJ(1/0,n),t={...t,signal:n}}const{stream:o,protocol:s}=await J5(n,e,t),a=function(e,t){var n;let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{const{options:n}=t.getHandler(e);if(null!=n.maxOutboundStreams)return n.maxOutboundStreams}catch(i){if(i.code!==s5.ERR_NO_HANDLER_FOR_PROTOCOL)throw i}return null!==(n=r.maxOutboundStreams)&&void 0!==n?n:64}(s,r.components.registrar,t);if(c4(s,"outbound",f)>=a){const e=new aq('Too many outbound protocol streams for protocol "'.concat(s,'" - limit ').concat(a),s5.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw n.abort(e),e}return await r.components.peerStore.merge(c,{protocols:[s]}),n.source=o.source,n.sink=o.sink,n.protocol=s,null===(i=r.components.metrics)||void 0===i||i.trackProtocolStream(n,f),n}catch(s){if((0,fx.Z)(r,l4).error("could not create new stream for protocols %s on connection with address %a",e,f.remoteAddr,s),null==n.timeline.close&&n.abort(s),null!=s.code)throw s;throw new aq(String(s),s5.ERR_UNSUPPORTED_PROTOCOL)}},Promise.all([h.sink(a.source),a.sink(h.source)]).catch((e=>{(0,fx.Z)(this,l4).error(e)})));const p=s.timeline;s.timeline=new Proxy(p,{set:function(){return null!=f&&"close"===(arguments.length<=1?void 0:arguments[1])&&null!=(arguments.length<=2?void 0:arguments[2])&&null==p.close&&(async()=>{try{"open"===f.status&&await f.close()}catch(e){(0,fx.Z)(r,l4).error(e)}finally{r.events.safeDispatchEvent("connection:close",{detail:f})}})().catch((e=>{(0,fx.Z)(r,l4).error(e)})),Reflect.set(...arguments)}}),s.timeline.upgraded=Date.now();var g;return g={remoteAddr:s.remoteAddr,remotePeer:c,status:"open",direction:o,timeline:s.timeline,multiplexer:null===(t=h)||void 0===t?void 0:t.protocol,encryption:i,transient:u,logger:this.components.logger,newStream:null!==(n=d)&&void 0!==n?n:()=>{throw new aq("connection is not multiplexed",s5.ERR_CONNECTION_NOT_MULTIPLEXED)},getStreams:()=>null!=h?h.streams:[],close:async e=>{null!=h&&((0,fx.Z)(this,l4).trace("close muxer"),await h.close(e)),(0,fx.Z)(this,l4).trace("close maconn"),await s.close(e),(0,fx.Z)(this,l4).trace("closed maconn")},abort:e=>{s.abort(e),null!=h&&h.abort(e)}},f=new a4(g),this.events.safeDispatchEvent("connection:open",{detail:f}),f}_onStream(e){const{connection:t,stream:n,protocol:r}=e,{handler:i,options:o}=this.components.registrar.getHandler(r);if(t.transient&&!0!==o.runOnTransientConnection)throw new aq("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");i({connection:t,stream:n})}async _encryptInbound(e){const t=Array.from(this.connectionEncryption.keys());(0,fx.Z)(this,l4).call(this,"handling inbound crypto protocol selection",t);try{const{stream:n,protocol:r}=await i4(e,t,{writeBytes:!0}),i=this.connectionEncryption.get(r);if(null==i)throw new Error("no crypto module found for ".concat(r));return(0,fx.Z)(this,l4).call(this,"encrypting inbound connection..."),{...await i.secureInbound(this.components.peerId,n),protocol:r}}catch(n){throw new aq(String(n),s5.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncryption.keys());(0,fx.Z)(this,l4).call(this,"selecting outbound crypto protocol",n);try{const{stream:r,protocol:i}=await J5(e,n,{writeBytes:!0}),o=this.connectionEncryption.get(i);if(null==o)throw new Error("no crypto module found for ".concat(i));return(0,fx.Z)(this,l4).call(this,"encrypting outbound connection to %p",t),{...await o.secureOutbound(this.components.peerId,r,t),protocol:i}}catch(r){throw new aq(String(r),s5.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(e,t){const n=Array.from(t.keys());(0,fx.Z)(this,l4).call(this,"outbound selecting muxer %s",n);try{const{stream:r,protocol:i}=await J5(e,n,{writeBytes:!0});(0,fx.Z)(this,l4).call(this,"%s selected as muxer protocol",i);return{stream:r,muxerFactory:t.get(i)}}catch(r){throw(0,fx.Z)(this,l4).error("error multiplexing outbound stream",r),new aq(String(r),s5.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(e,t){const n=Array.from(t.keys());(0,fx.Z)(this,l4).call(this,"inbound handling muxers %s",n);try{const{stream:r,protocol:i}=await i4(e,n,{writeBytes:!0});return{stream:r,muxerFactory:t.get(i)}}catch(r){throw(0,fx.Z)(this,l4).error("error multiplexing inbound stream",r),new aq(String(r),s5.ERR_MUXER_UNAVAILABLE)}}}var h4,d4=new WeakMap,f4=new WeakMap,p4=new WeakSet;class g4 extends lJ{constructor(e){var t,n,r,i,o,s,a;super(),Qd(this,p4),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"contentRouting",void 0),(0,Yo.Z)(this,"peerRouting",void 0),(0,Yo.Z)(this,"keychain",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"services",void 0),(0,Yo.Z)(this,"logger",void 0),(0,Yo.Z)(this,"components",void 0),(0,dx.Z)(this,d4,{writable:!0,value:void 0}),(0,dx.Z)(this,f4,{writable:!0,value:void 0});const c=new lJ,l=c.dispatchEvent.bind(c);c.dispatchEvent=e=>{const t=l(e),n=this.dispatchEvent(new hJ(e.type,{detail:e.detail}));return t||n},dJ(1/0,c),CG(this,d4,!1),this.peerId=e.peerId,this.logger=null!==(t=e.logger)&&void 0!==t?t:sH(),CG(this,f4,this.logger.forComponent("libp2p")),this.services={};const u=this.components=function(){const e=new j3(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{});return new Proxy(e,{get(t,n,r){if("string"===typeof n&&!z3.includes(n)){const t=e.components[n];if(null==t&&!Z3.includes(n))throw new aq("".concat(n," not set"),"ERR_SERVICE_MISSING");return t}return Reflect.get(t,n,r)},set:(t,n,r)=>("string"===typeof n?e.components[n]=r:Reflect.set(t,n,r),!0)})}({peerId:e.peerId,logger:this.logger,events:c,datastore:null!==(n=e.datastore)&&void 0!==n?n:new vH,connectionGater:V3(e.connectionGater)});this.peerStore=this.configureComponent("peerStore",new B3(u,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),null!=e.metrics&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),u.events.addEventListener("peer:update",(e=>{if(null==e.detail.previous){const t={id:e.detail.peer.id,multiaddrs:e.detail.peer.addresses.map((e=>e.multiaddr)),protocols:e.detail.peer.protocols};u.events.safeDispatchEvent("peer:discovery",{detail:t})}})),null!=e.connectionProtector&&this.configureComponent("connectionProtector",e.connectionProtector(u)),this.components.upgrader=new u4(this.components,{connectionEncryption:(null!==(r=e.connectionEncryption)&&void 0!==r?r:[]).map(((e,t)=>this.configureComponent("connection-encryption-".concat(t),e(this.components)))),muxers:(null!==(i=e.streamMuxers)&&void 0!==i?i:[]).map(((e,t)=>this.configureComponent("stream-muxers-".concat(t),e(this.components)))),inboundUpgradeTimeout:e.connectionManager.inboundUpgradeTimeout}),this.configureComponent("transportManager",new H5(this.components,e.transportManager)),this.configureComponent("connectionManager",new N5(this.components,e.connectionManager)),this.configureComponent("registrar",new z5(this.components)),this.configureComponent("addressManager",new K3(this.components,e.addresses));const h=R0.generateOptions();this.keychain=this.configureComponent("keyChain",new R0(this.components,{...h,...e.keychain}));const d=(null!==(o=e.peerRouters)&&void 0!==o?o:[]).map(((e,t)=>this.configureComponent("peer-router-".concat(t),e(this.components))));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new j5(this.components,{routers:d}));const f=(null!==(s=e.contentRouters)&&void 0!==s?s:[]).map(((e,t)=>this.configureComponent("content-router-".concat(t),e(this.components))));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new U5(this.components,{routers:f})),(null!==(a=e.peerDiscovery)&&void 0!==a?a:[]).forEach(((e,t)=>{this.configureComponent("peer-discovery-".concat(t),e(this.components)).addEventListener("peer",(e=>{Yd(this,p4,y4).call(this,e)}))})),e.transports.forEach(((e,t)=>{this.components.transportManager.add(this.configureComponent("transport-".concat(t),e(this.components)))})),null!=e.services)for(const p of Object.keys(e.services)){const t=(0,e.services[p])(this.components);null!=t?(this.services[p]=t,this.configureComponent(p,t),null!=t[sJ]&&((0,fx.Z)(this,f4).call(this,"registering service %s for content routing",p),f.push(t[sJ])),null!=t[pJ]&&((0,fx.Z)(this,f4).call(this,"registering service %s for peer routing",p),d.push(t[pJ])),null!=t[fJ]&&((0,fx.Z)(this,f4).call(this,"registering service %s for peer discovery",p),t[fJ].addEventListener("peer",(e=>{Yd(this,p4,y4).call(this,e)})))):(0,fx.Z)(this,f4).error("service factory %s returned null or undefined instance",p)}}configureComponent(e,t){return null==t&&(0,fx.Z)(this,f4).error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if((0,fx.Z)(this,d4))return;CG(this,d4,!0),(0,fx.Z)(this,f4).call(this,"libp2p is starting");null==(await this.keychain.listKeys()).find((e=>"self"===e.name))&&((0,fx.Z)(this,f4).call(this,"importing self key into keychain"),await this.keychain.importPeer("self",this.components.peerId));try{var e,t,n,r;await(null===(e=(t=this.components).beforeStart)||void 0===e?void 0:e.call(t)),await this.components.start(),await(null===(n=(r=this.components).afterStart)||void 0===n?void 0:n.call(r)),this.safeDispatchEvent("start",{detail:this}),(0,fx.Z)(this,f4).call(this,"libp2p has started")}catch(i){throw(0,fx.Z)(this,f4).error("An error occurred starting libp2p",i),await this.stop(),i}}async stop(){var e,t,n,r;(0,fx.Z)(this,d4)&&((0,fx.Z)(this,f4).call(this,"libp2p is stopping"),CG(this,d4,!1),await(null===(e=(t=this.components).beforeStop)||void 0===e?void 0:e.call(t)),await this.components.stop(),await(null===(n=(r=this.components).afterStop)||void 0===n?void 0:n.call(r)),this.safeDispatchEvent("stop",{detail:this}),(0,fx.Z)(this,f4).call(this,"libp2p has stopped"))}isStarted(){return(0,fx.Z)(this,d4)}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new ux;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.components.connectionManager.openConnection(e,t)}async dialProtocol(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(null==t)throw new aq("no protocols were provided to open a stream",s5.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(0===(t=Array.isArray(t)?t:[t]).length)throw new aq("no protocols were provided to open a stream",s5.ERR_INVALID_PROTOCOLS_FOR_STREAM);return(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n;(0,ng.h2)(e)&&(e=X0(null!==(n=e.getPeerId())&&void 0!==n?n:""));await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if((0,fx.Z)(this,f4).call(this,"getPublicKey %p",e),null!=e.publicKey)return e.publicKey;const n=await this.peerStore.get(e);if(null!=n.id.publicKey)return n.id.publicKey;const r=(0,Ls.z)([(0,yu.m)("/pk/"),e.multihash.digest]),i=await this.contentRouting.get(r,t);return iJ(i),await this.peerStore.patch(e,{publicKey:i}),i}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map((async e=>{await this.components.registrar.handle(e,t,n)})))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map((async e=>{await this.components.registrar.unhandle(e)})))}async register(e,t){return this.components.registrar.register(e,t)}unregister(e){this.components.registrar.unregister(e)}}function y4(e){const{detail:t}=e;t.id.toString()!==this.peerId.toString()?this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs,protocols:t.protocols}).catch((e=>{(0,fx.Z)(this,f4).error(e)})):(0,fx.Z)(this,f4).error(new Error(s5.ERR_DISCOVERED_SELF))}async function m4(e){if(null==e.peerId){const n=e.datastore;if(null!=n)try{const t=new R0({datastore:n},(0,g0.Z)(R0.generateOptions(),e.keychain));e.peerId=await t.exportPeerId("self")}catch(t){if("ERR_NOT_FOUND"!==t.code)throw t}}return null==e.peerId&&(e.peerId=await TA()),new g4(function(e){var t,n;const r=(0,g0.Z)(a5,e);if(null==r.transports||r.transports.length<1)throw new aq(o5.ERR_TRANSPORTS_REQUIRED,s5.ERR_TRANSPORTS_REQUIRED);if(null===r.connectionProtector&&null!=(null===(t=globalThis.process)||void 0===t||null===(n=t.env)||void 0===n?void 0:n.LIBP2P_FORCE_PNET))throw new aq(o5.ERR_PROTECTOR_REQUIRED,s5.ERR_PROTECTOR_REQUIRED);return r}(e))}var v4=new WeakMap;class b4 extends EventTarget{constructor(){super(...arguments),(0,dx.Z)(this,v4,{writable:!0,value:new Map})}listenerCount(e){const t=(0,fx.Z)(this,v4).get(e);return null==t?0:t.length}addEventListener(e,t,n){var r;super.addEventListener(e,t,n);let i=(0,fx.Z)(this,v4).get(e);null==i&&(i=[],(0,fx.Z)(this,v4).set(e,i)),i.push({callback:t,once:null!==(r=!0!==n&&!1!==n&&(null===n||void 0===n?void 0:n.once))&&void 0!==r&&r})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),null!==t&&void 0!==t?t:null,n);let r=(0,fx.Z)(this,v4).get(e);null!=r&&(r=r.filter((e=>{let{callback:n}=e;return n!==t})),(0,fx.Z)(this,v4).set(e,r))}dispatchEvent(e){const t=super.dispatchEvent(e);let n=(0,fx.Z)(this,v4).get(e.type);return null==n||(n=n.filter((e=>{let{once:t}=e;return!t})),(0,fx.Z)(this,v4).set(e.type,n)),t}safeDispatchEvent(e,t){return this.dispatchEvent(new E4(e,t))}}class w4 extends Event{constructor(e,t){super(e,t),(0,Yo.Z)(this,"detail",void 0),this.detail=null===t||void 0===t?void 0:t.detail}}const E4=null!==(h4=globalThis.CustomEvent)&&void 0!==h4?h4:w4,A4="StrictSign",S4="StrictNoSign";var _4;!function(e){e.Accept="accept",e.Ignore="ignore",e.Reject="reject"}(_4||(_4={}));var I4=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const C4=I4,T4=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class k4{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class R4{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return P4(this,e)}}class x4{constructor(e){this.decoders=e}or(e){return P4(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const P4=(e,t)=>new x4({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class D4{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new k4(e,t,n),this.decoder=new R4(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const O4=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new D4(t,n,r,i)},N4=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=C4(r,n);return O4({prefix:t,name:n,encode:i,decode:e=>T4(o(e))})},B4=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return O4({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},L4=B4({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),M4=B4({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),U4=B4({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),F4=B4({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),K4=B4({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),j4=B4({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Z4=B4({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),z4=B4({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),V4=B4({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),H4=N4({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),q4=N4({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),G4=B4({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),W4=B4({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Q4=B4({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Y4=B4({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});function J4(e){let t=function(e){const t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=e,t.destroy=()=>!0,t.extend=()=>t,t}("".concat(e,":trace"));return sf().enabled("".concat(e,":trace"))&&null!=sf().names.map((e=>e.toString())).find((e=>e.includes(":trace")))&&(t=sf()("".concat(e,":trace"))),Object.assign(sf()(e),{error:sf()("".concat(e,":error")),trace:t})}sf().formatters.b=e=>null==e?"undefined":H4.baseEncode(e),sf().formatters.t=e=>null==e?"undefined":L4.baseEncode(e),sf().formatters.m=e=>null==e?"undefined":G4.baseEncode(e),sf().formatters.p=e=>null==e?"undefined":e.toString(),sf().formatters.c=e=>null==e?"undefined":e.toString(),sf().formatters.k=e=>null==e?"undefined":e.toString(),sf().formatters.a=e=>null==e?"undefined":e.toString();class X4 extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"The operation was aborted"),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"type",void 0),this.code=X4.code,this.type=X4.type}}(0,Yo.Z)(X4,"code","ABORT_ERR"),(0,Yo.Z)(X4,"type","aborted");class $4 extends Error{constructor(e,t,n){var r;super(e),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"props",void 0),this.code=t,this.name=null!==(r=null===n||void 0===n?void 0:n.name)&&void 0!==r?r:"CodeError",this.props=null!==n&&void 0!==n?n:{}}}class e6 extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected Peer"),(0,Yo.Z)(this,"code",void 0),this.code=e6.code}}(0,Yo.Z)(e6,"code","ERR_UNEXPECTED_PEER");class t6 extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto exchange"),(0,Yo.Z)(this,"code",void 0),this.code=t6.code}}(0,Yo.Z)(t6,"code","ERR_INVALID_CRYPTO_EXCHANGE");class n6 extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto transmission"),(0,Yo.Z)(this,"code",void 0),this.code=n6.code}}(0,Yo.Z)(n6,"code","ERR_INVALID_CRYPTO_TRANSMISSION");const r6=Symbol.for("@libp2p/peer-id");const i6=N4({prefix:"9",name:"base10",alphabet:"0123456789"}),o6=B4({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),s6=B4({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),a6=B4({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),c6=Array.from("\ud83d\ude80\ud83e\ude90\u2604\ud83d\udef0\ud83c\udf0c\ud83c\udf11\ud83c\udf12\ud83c\udf13\ud83c\udf14\ud83c\udf15\ud83c\udf16\ud83c\udf17\ud83c\udf18\ud83c\udf0d\ud83c\udf0f\ud83c\udf0e\ud83d\udc09\u2600\ud83d\udcbb\ud83d\udda5\ud83d\udcbe\ud83d\udcbf\ud83d\ude02\u2764\ud83d\ude0d\ud83e\udd23\ud83d\ude0a\ud83d\ude4f\ud83d\udc95\ud83d\ude2d\ud83d\ude18\ud83d\udc4d\ud83d\ude05\ud83d\udc4f\ud83d\ude01\ud83d\udd25\ud83e\udd70\ud83d\udc94\ud83d\udc96\ud83d\udc99\ud83d\ude22\ud83e\udd14\ud83d\ude06\ud83d\ude44\ud83d\udcaa\ud83d\ude09\u263a\ud83d\udc4c\ud83e\udd17\ud83d\udc9c\ud83d\ude14\ud83d\ude0e\ud83d\ude07\ud83c\udf39\ud83e\udd26\ud83c\udf89\ud83d\udc9e\u270c\u2728\ud83e\udd37\ud83d\ude31\ud83d\ude0c\ud83c\udf38\ud83d\ude4c\ud83d\ude0b\ud83d\udc97\ud83d\udc9a\ud83d\ude0f\ud83d\udc9b\ud83d\ude42\ud83d\udc93\ud83e\udd29\ud83d\ude04\ud83d\ude00\ud83d\udda4\ud83d\ude03\ud83d\udcaf\ud83d\ude48\ud83d\udc47\ud83c\udfb6\ud83d\ude12\ud83e\udd2d\u2763\ud83d\ude1c\ud83d\udc8b\ud83d\udc40\ud83d\ude2a\ud83d\ude11\ud83d\udca5\ud83d\ude4b\ud83d\ude1e\ud83d\ude29\ud83d\ude21\ud83e\udd2a\ud83d\udc4a\ud83e\udd73\ud83d\ude25\ud83e\udd24\ud83d\udc49\ud83d\udc83\ud83d\ude33\u270b\ud83d\ude1a\ud83d\ude1d\ud83d\ude34\ud83c\udf1f\ud83d\ude2c\ud83d\ude43\ud83c\udf40\ud83c\udf37\ud83d\ude3b\ud83d\ude13\u2b50\u2705\ud83e\udd7a\ud83c\udf08\ud83d\ude08\ud83e\udd18\ud83d\udca6\u2714\ud83d\ude23\ud83c\udfc3\ud83d\udc90\u2639\ud83c\udf8a\ud83d\udc98\ud83d\ude20\u261d\ud83d\ude15\ud83c\udf3a\ud83c\udf82\ud83c\udf3b\ud83d\ude10\ud83d\udd95\ud83d\udc9d\ud83d\ude4a\ud83d\ude39\ud83d\udde3\ud83d\udcab\ud83d\udc80\ud83d\udc51\ud83c\udfb5\ud83e\udd1e\ud83d\ude1b\ud83d\udd34\ud83d\ude24\ud83c\udf3c\ud83d\ude2b\u26bd\ud83e\udd19\u2615\ud83c\udfc6\ud83e\udd2b\ud83d\udc48\ud83d\ude2e\ud83d\ude46\ud83c\udf7b\ud83c\udf43\ud83d\udc36\ud83d\udc81\ud83d\ude32\ud83c\udf3f\ud83e\udde1\ud83c\udf81\u26a1\ud83c\udf1e\ud83c\udf88\u274c\u270a\ud83d\udc4b\ud83d\ude30\ud83e\udd28\ud83d\ude36\ud83e\udd1d\ud83d\udeb6\ud83d\udcb0\ud83c\udf53\ud83d\udca2\ud83e\udd1f\ud83d\ude41\ud83d\udea8\ud83d\udca8\ud83e\udd2c\u2708\ud83c\udf80\ud83c\udf7a\ud83e\udd13\ud83d\ude19\ud83d\udc9f\ud83c\udf31\ud83d\ude16\ud83d\udc76\ud83e\udd74\u25b6\u27a1\u2753\ud83d\udc8e\ud83d\udcb8\u2b07\ud83d\ude28\ud83c\udf1a\ud83e\udd8b\ud83d\ude37\ud83d\udd7a\u26a0\ud83d\ude45\ud83d\ude1f\ud83d\ude35\ud83d\udc4e\ud83e\udd32\ud83e\udd20\ud83e\udd27\ud83d\udccc\ud83d\udd35\ud83d\udc85\ud83e\uddd0\ud83d\udc3e\ud83c\udf52\ud83d\ude17\ud83e\udd11\ud83c\udf0a\ud83e\udd2f\ud83d\udc37\u260e\ud83d\udca7\ud83d\ude2f\ud83d\udc86\ud83d\udc46\ud83c\udfa4\ud83d\ude47\ud83c\udf51\u2744\ud83c\udf34\ud83d\udca3\ud83d\udc38\ud83d\udc8c\ud83d\udccd\ud83e\udd40\ud83e\udd22\ud83d\udc45\ud83d\udca1\ud83d\udca9\ud83d\udc50\ud83d\udcf8\ud83d\udc7b\ud83e\udd10\ud83e\udd2e\ud83c\udfbc\ud83e\udd75\ud83d\udea9\ud83c\udf4e\ud83c\udf4a\ud83d\udc7c\ud83d\udc8d\ud83d\udce3\ud83e\udd42"),l6=c6.reduce(((e,t,n)=>(e[n]=t,e)),[]),u6=c6.reduce(((e,t,n)=>(e[t.codePointAt(0)]=n,e)),[]);const h6=O4({prefix:"\ud83d\ude80",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+=l6[t]),"")},decode:function(e){const t=[];for(const n of e){const e=u6[n.codePointAt(0)];if(void 0===e)throw new Error("Non-base256emoji character: ".concat(n));t.push(e)}return new Uint8Array(t)}}),d6=N4({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),f6=N4({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),p6=B4({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),g6=O4({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),y6=new TextEncoder,m6=new TextDecoder,v6="json",b6=512,w6=e=>y6.encode(JSON.stringify(e)),E6=e=>JSON.parse(m6.decode(e)),A6="raw",S6=85,_6=e=>T4(e),I6=e=>T4(e);var C6=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=R6;)n[r++]=255&t|T6,t/=128;for(;t&k6;)n[r++]=255&t|T6,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},T6=128,k6=-128,R6=Math.pow(2,31);var x6=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&D6)<<o:(r&D6)*Math.pow(2,o),o+=7}while(r>=P6);return e.bytes=s-n,i},P6=128,D6=127;var O6=Math.pow(2,7),N6=Math.pow(2,14),B6=Math.pow(2,21),L6=Math.pow(2,28),M6=Math.pow(2,35),U6=Math.pow(2,42),F6=Math.pow(2,49),K6=Math.pow(2,56),j6=Math.pow(2,63);const Z6={encode:C6,decode:x6,encodingLength:function(e){return e<O6?1:e<N6?2:e<B6?3:e<L6?4:e<M6?5:e<U6?6:e<F6?7:e<K6?8:e<j6?9:10}},z6=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return[Z6.decode(e,t),Z6.decode.bytes]},V6=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Z6.encode(e,t,n),t},H6=e=>Z6.encodingLength(e),q6=(e,t)=>{const n=t.byteLength,r=H6(e),i=r+H6(n),o=new Uint8Array(i+n);return V6(e,o,0),V6(n,o,r),o.set(t,i),new W6(e,n,t,o)},G6=e=>{const t=T4(e),[n,r]=z6(t),[i,o]=z6(t.subarray(r)),s=t.subarray(r+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new W6(n,i,s,t)};class W6{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const Q6=T4,Y6={code:0,name:"identity",encode:Q6,digest:e=>q6(0,Q6(e))},J6=e=>{let{name:t,code:n,encode:r}=e;return new X6(t,n,r)};class X6{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?q6(this.code,t):t.then((e=>q6(this.code,e)))}throw Error("Unknown type, must be binary type")}}const $6=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),e8=J6({name:"sha2-256",code:18,encode:$6("SHA-256")}),t8=J6({name:"sha2-512",code:19,encode:$6("SHA-512")}),n8=(e,t)=>{const{bytes:n,version:r}=e;return 0===r?a8(n,i8(e),t||H4.encoder):c8(n,i8(e),t||L4.encoder)},r8=new WeakMap,i8=e=>{const t=r8.get(e);if(null==t){const t=new Map;return r8.set(e,t),t}return t};class o8{constructor(e,t,n,r){this.code=t,this.version=e,this.multihash=n,this.bytes=r,this["/"]=r}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==l8)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==u8)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return o8.createV0(t)}default:throw Error("Can not convert CID version ".concat(this.version," to version 0. This is a bug please report"))}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=q6(e,t);return o8.createV1(this.code,n)}case 1:return this;default:throw Error("Can not convert CID version ".concat(this.version," to version 1. This is a bug please report"))}}equals(e){return o8.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&((e,t)=>{if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&((e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0})(e.bytes,n.bytes)}})(e.multihash,n.multihash)}toString(e){return n8(this,e)}toJSON(){return{"/":n8(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID(".concat(this.toString(),")")}static asCID(e){if(null==e)return null;const t=e;if(t instanceof o8)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:i}=t;return new o8(e,n,r,i||h8(e,n,r.bytes))}if(!0===t[d8]){const{version:e,multihash:n,code:r}=t,i=G6(n);return o8.create(e,r,i)}return null}static create(e,t,n){if("number"!==typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==l8)throw new Error("Version 0 CID must use dag-pb (code: ".concat(l8,") block encoding"));return new o8(e,t,n,n.bytes);case 1:{const r=h8(e,t,n.bytes);return new o8(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return o8.create(0,l8,e)}static createV1(e,t){return o8.create(1,e,t)}static decode(e){const[t,n]=o8.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=o8.inspectBytes(e),n=t.size-t.multihashSize,r=T4(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=r.subarray(t.multihashSize-t.digestSize),o=new W6(t.multihashCode,t.digestSize,i,r);return[0===t.version?o8.createV0(o):o8.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=z6(e.subarray(t));return t+=r,n};let r=n(),i=l8;if(18===r?(r=0,t=0):i=n(),0!==r&&1!==r)throw new RangeError("Invalid CID version ".concat(r));const o=t,s=n(),a=n(),c=t+a;return{version:r,codec:i,multihashCode:s,digestSize:a,multihashSize:c-o,size:c}}static parse(e,t){const[n,r]=s8(e,t),i=o8.decode(r);if(0===i.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return i8(i).set(n,e),i}}const s8=(e,t)=>{switch(e[0]){case"Q":{const n=t||H4;return[H4.prefix,n.decode("".concat(H4.prefix).concat(e))]}case H4.prefix:{const n=t||H4;return[H4.prefix,n.decode(e)]}case L4.prefix:{const n=t||L4;return[L4.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}},a8=(e,t,n)=>{const{prefix:r}=n;if(r!==H4.prefix)throw Error("Cannot string encode V0 in ".concat(n.name," encoding"));const i=t.get(r);if(null==i){const i=n.encode(e).slice(1);return t.set(r,i),i}return i},c8=(e,t,n)=>{const{prefix:r}=n,i=t.get(r);if(null==i){const i=n.encode(e);return t.set(r,i),i}return i},l8=112,u8=18,h8=(e,t,n)=>{const r=H6(e),i=r+H6(t),o=new Uint8Array(i+n.byteLength);return V6(e,o,0),V6(t,o,r),o.set(n,i),o},d8=Symbol.for("@ipld/js-cid/CID"),f8={...Hn,...jn,...Vn,...Fn,...Kn,...Ln,...zn,...Mn,...Un,...Zn},p8=Symbol.for("nodejs.util.inspect.custom"),g8=Object.values(f8).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),f8.identity.decoder),y8=114,m8=36,v8=37;class b8{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,r6,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=H4.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return o8.createV1(y8,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return S8(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[p8](){return"PeerId(".concat(this.toString(),")")}}class w8 extends b8{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class E8 extends b8{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class A8 extends b8{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}function S8(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:g8,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=G6(H4.decode("z".concat(e)));return e.startsWith("12D")?new E8({multihash:t}):e.startsWith("16U")?new A8({multihash:t}):new w8({multihash:t})}return _8(g8.decode(e))}function _8(e){try{const t=G6(e);if(t.code===Y6.code){if(t.digest.length===m8)return new E8({multihash:t});if(t.digest.length===v8)return new A8({multihash:t})}if(t.code===e8.code)return new w8({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==y8)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===e8.code)return new w8({multihash:e.multihash});if(t.code===Y6.code){if(t.digest.length===m8)return new E8({multihash:e.multihash});if(t.digest.length===v8)return new A8({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(o8.decode(e))}throw new Error("Supplied PeerID CID is invalid")}class I8{constructor(e){if((0,Yo.Z)(this,"buffer",void 0),(0,Yo.Z)(this,"mask",void 0),(0,Yo.Z)(this,"top",void 0),(0,Yo.Z)(this,"btm",void 0),(0,Yo.Z)(this,"next",void 0),!(e>0)||0!==(e-1&e))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return void 0===this.buffer[this.btm]}}class C8{constructor(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,Yo.Z)(this,"size",void 0),(0,Yo.Z)(this,"hwm",void 0),(0,Yo.Z)(this,"head",void 0),(0,Yo.Z)(this,"tail",void 0),this.hwm=null!==(e=t.splitLimit)&&void 0!==e?e:16,this.head=new I8(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return null!=(null===e||void 0===e?void 0:e.byteLength)?e.byteLength:1}push(e){if(null!=(null===e||void 0===e?void 0:e.value)&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new I8(2*this.head.buffer.length),this.head.push(e)}}shift(){var e;let t=this.tail.shift();if(void 0===t&&null!=this.tail.next){const e=this.tail.next;this.tail.next=null,this.tail=e,t=this.tail.shift()}return null!=(null===(e=t)||void 0===e?void 0:e.value)&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}}class T8 extends Error{constructor(e,t){super(null!==e&&void 0!==e?e:"The operation was aborted"),(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"code",void 0),this.type="aborted",this.code=null!==t&&void 0!==t?t:"ABORT_ERR"}}function k8(){return R8((e=>{const t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}function R8(e,t){var n;let r,i,o,s=(t=null!==(n=t)&&void 0!==n?n:{}).onEnd,a=new C8,c=Ws();const l=e=>null!=i?i(e):(a.push(e),r),u=e=>{var n;if(o)return r;if(!0!==(null===(n=t)||void 0===n?void 0:n.objectMode)&&null==(null===e||void 0===e?void 0:e.byteLength))throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:e})},h=e=>o?r:(o=!0,null!=e?(e=>(a=new C8,null!=i?i({error:e}):(a.push({error:e}),r)))(e):l({done:!0}));if(r={[Symbol.asyncIterator](){return this},next:async()=>{try{return a.isEmpty()?o?{done:!0}:await new Promise(((t,n)=>{i=o=>{i=null,a.push(o);try{t(e(a))}catch(s){n(s)}return r}})):e(a)}finally{a.isEmpty()&&queueMicrotask((()=>{c.resolve(),c=Ws()}))}},return:()=>(a=new C8,h(),{done:!0}),throw:e=>(h(e),{done:!0}),push:u,end:h,get readableLength(){return a.size},onEmpty:async e=>{const t=null===e||void 0===e?void 0:e.signal;if(null===t||void 0===t||t.throwIfAborted(),a.isEmpty())return;let n,r;null!=t&&(n=new Promise(((e,n)=>{r=()=>{n(new T8)},t.addEventListener("abort",r)})));try{await Promise.race([c.promise,n])}finally{null!=r&&null!=t&&(null===t||void 0===t||t.removeEventListener("abort",r))}}},null==s)return r;const d=r;return r={[Symbol.asyncIterator](){return this},next:()=>d.next(),throw:e=>(d.throw(e),null!=s&&(s(e),s=void 0),{done:!0}),return:()=>(d.return(),null!=s&&(s(),s=void 0),{done:!0}),push:u,end:e=>(d.end(e),null!=s&&(s(e),s=void 0),r),get readableLength(){return d.readableLength},onEmpty:e=>d.onEmpty(e)},r}const x8=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const r=[];for(const i of t)null==i[Symbol.asyncIterator]&&r.push(i);return r.length===t.length?function*(){for(const e of r)yield*e}():async function*(){const e=k8({objectMode:!0});Promise.resolve().then((async()=>{try{await Promise.all(t.map((async t=>{for await(const n of t)e.push(n)}))),e.end()}catch(n){e.end(n)}})),yield*e}()};function P8(e){if(null==e)throw new Error("Empty pipeline");if(B8(e)){const t=e;e=()=>t.source}else if(N8(e)||O8(e)){const t=e;e=()=>t}for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];const i=[e,...n];if(i.length>1&&B8(i[i.length-1])&&(i[i.length-1]=i[i.length-1].sink),i.length>2)for(let o=1;o<i.length-1;o++)B8(i[o])&&(i[o]=L8(i[o]));return D8(...i)}const D8=function(){let e;for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(;n.length>0;)e=n.shift()(e);return e},O8=e=>null!=(null===e||void 0===e?void 0:e[Symbol.asyncIterator]),N8=e=>null!=(null===e||void 0===e?void 0:e[Symbol.iterator]),B8=e=>null!=e&&(null!=e.sink&&null!=e.source),L8=e=>t=>{const n=e.sink(t);if(null!=(null===n||void 0===n?void 0:n.then)){const t=k8({objectMode:!0});let r;n.then((()=>{t.end()}),(e=>{t.end(e)}));const i=e.source;if(O8(i))r=async function*(){yield*i,t.end()};else{if(!N8(i))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");r=function*(){yield*i,t.end()}}return x8(t,r())}return e.source},M8="/floodsub/1.0.0",U8="/meshsub/1.0.0",F8="/meshsub/1.1.0",K8=5e3;var j8=n(62001),Z8=n.n(j8);const z8={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};function V8(e,t){t={...t};const n=Z8().Reader.create(e),r=e.length,i=void 0===r?n.len:n.pos+r,o={};for(;n.pos<i;){const e=n.uint32();switch(e>>>3){case 1:null!=o.subscriptions&&o.subscriptions.length>0||(o.subscriptions=[]),o.subscriptions.length<t.maxSubscriptions?o.subscriptions.push(H8(n,n.uint32())):n.skipType(7&e);break;case 2:null!=o.messages&&o.messages.length>0||(o.messages=[]),o.messages.length<t.maxMessages?o.messages.push(q8(n,n.uint32())):n.skipType(7&e);break;case 3:o.control=G8(n,n.uint32(),t);break;default:n.skipType(7&e)}}return o}function H8(e,t){const n=void 0===t?e.len:e.pos+t,r={};for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.subscribe=e.bool();break;case 2:r.topic=e.string();break;default:e.skipType(7&t)}}return r}function q8(e,t){const n=void 0===t?e.len:e.pos+t,r={};for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.from=e.bytes();break;case 2:r.data=e.bytes();break;case 3:r.seqno=e.bytes();break;case 4:r.topic=e.string();break;case 5:r.signature=e.bytes();break;case 6:r.key=e.bytes();break;default:e.skipType(7&t)}}if(!r.topic)throw Error("missing required 'topic'");return r}function G8(e,t,n){const r=void 0===t?e.len:e.pos+t,i={};for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:null!=i.ihave&&i.ihave.length>0||(i.ihave=[]),i.ihave.length<n.maxControlMessages?i.ihave.push(W8(e,e.uint32(),n)):e.skipType(7&t);break;case 2:null!=i.iwant&&i.iwant.length>0||(i.iwant=[]),i.iwant.length<n.maxControlMessages?i.iwant.push(Q8(e,e.uint32(),n)):e.skipType(7&t);break;case 3:null!=i.graft&&i.graft.length>0||(i.graft=[]),i.graft.length<n.maxControlMessages?i.graft.push(Y8(e,e.uint32())):e.skipType(7&t);break;case 4:null!=i.prune&&i.prune.length>0||(i.prune=[]),i.prune.length<n.maxControlMessages?i.prune.push(J8(e,e.uint32(),n)):e.skipType(7&t);break;default:e.skipType(7&t)}}return i}function W8(e,t,n){const r=void 0===t?e.len:e.pos+t,i={};for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:i.topicID=e.string();break;case 2:null!=i.messageIDs&&i.messageIDs.length>0||(i.messageIDs=[]),n.maxIhaveMessageIDs-- >0?i.messageIDs.push(e.bytes()):e.skipType(7&t);break;default:e.skipType(7&t)}}return i}function Q8(e,t,n){const r=void 0===t?e.len:e.pos+t,i={};for(;e.pos<r;){const t=e.uint32();if(t>>>3===1)null!=i.messageIDs&&i.messageIDs.length>0||(i.messageIDs=[]),n.maxIwantMessageIDs-- >0?i.messageIDs.push(e.bytes()):e.skipType(7&t);else e.skipType(7&t)}return i}function Y8(e,t){const n=void 0===t?e.len:e.pos+t,r={};for(;e.pos<n;){const t=e.uint32();if(t>>>3===1)r.topicID=e.string();else e.skipType(7&t)}return r}function J8(e,t,n){const r=void 0===t?e.len:e.pos+t,i={};for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:i.topicID=e.string();break;case 2:null!=i.peers&&i.peers.length>0||(i.peers=[]),n.maxPeerInfos-- >0?i.peers.push(X8(e,e.uint32())):e.skipType(7&t);break;case 3:i.backoff=e.uint64();break;default:e.skipType(7&t)}}return i}function X8(e,t){const n=void 0===t?e.len:e.pos+t,r={};for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.peerID=e.bytes();break;case 2:r.signedPeerRecord=e.bytes();break;default:e.skipType(7&t)}}return r}const $8=n.p+"static/media/rpc.3ba5ca7bdb004060d5e2.cjs",{RPC:e7}=$8;class t7{constructor(e,t,n){(0,Yo.Z)(this,"gossip",void 0),(0,Yo.Z)(this,"msgs",new Map),(0,Yo.Z)(this,"msgIdToStrFn",void 0),(0,Yo.Z)(this,"history",[]),(0,Yo.Z)(this,"notValidatedCount",0),this.gossip=e,this.msgIdToStrFn=n;for(let r=0;r<t;r++)this.history[r]=[]}get size(){return this.msgs.size}put(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{msgIdStr:r}=e;return!this.msgs.has(r)&&(this.msgs.set(r,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),n||this.notValidatedCount++,!0)}observeDuplicate(e,t){const n=this.msgs.get(e);null==n||n.validated||n.originatingPeers.add(t)}get(e){var t;return null===(t=this.msgs.get(this.msgIdToStrFn(e)))||void 0===t?void 0:t.message}getWithIWantCount(e,t){var n;const r=this.msgs.get(e);if(null==r)return null;const i=(null!==(n=r.iwantCounts.get(t))&&void 0!==n?n:0)+1;return r.iwantCounts.set(t,i),{msg:r.message,count:i}}getGossipIDs(e){const t=new Map;for(let n=0;n<this.gossip;n++)this.history[n].forEach((n=>{var r;const i=this.msgs.get(n.msgIdStr);if(null!==(r=null===i||void 0===i?void 0:i.validated)&&void 0!==r&&r&&e.has(n.topic)){let e=t.get(n.topic);null==e&&(e=[],t.set(n.topic,e)),e.push(n.msgId)}}));return t}validate(e){const t=this.msgs.get(e);if(null==t)return null;t.validated||this.notValidatedCount--;const{message:n,originatingPeers:r}=t;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:r}}shift(){this.history[this.history.length-1].forEach((e=>{const t=this.msgs.get(e.msgIdStr);null!=t&&(this.msgs.delete(e.msgIdStr),t.validated||this.notValidatedCount--)})),this.history.pop(),this.history.unshift([])}remove(e){const t=this.msgs.get(e);return null==t?null:(this.msgs.delete(e),t)}}var n7,r7,i7,o7,s7,a7,c7,l7,u7,h7,d7;function f7(e){switch(e){case _4.Ignore:return i7.Ignore;case _4.Reject:return i7.Reject;default:throw new Error("Unreachable")}}!function(e){e.StrictSign="StrictSign",e.StrictNoSign="StrictNoSign"}(n7||(n7={})),function(e){e[e.Signing=0]="Signing",e[e.Anonymous=1]="Anonymous"}(r7||(r7={})),function(e){e.Error="error",e.Ignore="ignore",e.Reject="reject",e.Blacklisted="blacklisted"}(i7||(i7={})),function(e){e.InvalidSignature="invalid_signature",e.InvalidSeqno="invalid_seqno",e.InvalidPeerId="invalid_peerid",e.SignaturePresent="signature_present",e.SeqnoPresent="seqno_present",e.FromPresent="from_present",e.TransformFailed="transform_failed"}(o7||(o7={})),function(e){e.duplicate="duplicate",e.invalid="invalid",e.valid="valid"}(s7||(s7={})),function(e){e.forward="forward",e.publish="publish"}(a7||(a7={})),function(e){e.Fanout="fanout",e.Random="random",e.Subscribed="subscribed",e.Outbound="outbound",e.NotEnough="not_enough",e.Opportunistic="opportunistic"}(c7||(c7={})),function(e){e.Dc="disconnected",e.BadScore="bad_score",e.Prune="prune",e.Excess="excess"}(l7||(l7={})),function(e){e.GraftBackoff="graft_backoff",e.BrokenPromise="broken_promise",e.MessageDeficit="message_deficit",e.IPColocation="IP_colocation"}(u7||(u7={})),function(e){e.LowScore="low_score",e.MaxIhave="max_ihave",e.MaxIasked="max_iasked"}(h7||(h7={})),function(e){e.graylist="graylist",e.publish="publish",e.gossip="gossip",e.mesh="mesh"}(d7||(d7={}));const p7="ERR_INVALID_PEER_SCORE_PARAMS",g7={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:36e5},y7={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function m7(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{...g7,...e,topics:null!=e.topics?Object.entries(e.topics).reduce(((e,t)=>{let[n,r]=t;return e[n]=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{...y7,...e}}(r),e}),{}):{}}}function v7(e){if(e.topicWeight<0)throw new $4("invalid topic weight; must be >= 0",p7);if(0===e.timeInMeshQuantum)throw new $4("invalid TimeInMeshQuantum; must be non zero",p7);if(e.timeInMeshWeight<0)throw new $4("invalid TimeInMeshWeight; must be positive (or 0 to disable)",p7);if(0!==e.timeInMeshWeight&&e.timeInMeshQuantum<=0)throw new $4("invalid TimeInMeshQuantum; must be positive",p7);if(0!==e.timeInMeshWeight&&e.timeInMeshCap<=0)throw new $4("invalid TimeInMeshCap; must be positive",p7);if(e.firstMessageDeliveriesWeight<0)throw new $4("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)",p7);if(0!==e.firstMessageDeliveriesWeight&&(e.firstMessageDeliveriesDecay<=0||e.firstMessageDeliveriesDecay>=1))throw new $4("invalid FirstMessageDeliveriesDecay; must be between 0 and 1",p7);if(0!==e.firstMessageDeliveriesWeight&&e.firstMessageDeliveriesCap<=0)throw new $4("invalid FirstMessageDeliveriesCap; must be positive",p7);if(e.meshMessageDeliveriesWeight>0)throw new $4("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)",p7);if(0!==e.meshMessageDeliveriesWeight&&(e.meshMessageDeliveriesDecay<=0||e.meshMessageDeliveriesDecay>=1))throw new $4("invalid MeshMessageDeliveriesDecay; must be between 0 and 1",p7);if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesCap<=0)throw new $4("invalid MeshMessageDeliveriesCap; must be positive",p7);if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesThreshold<=0)throw new $4("invalid MeshMessageDeliveriesThreshold; must be positive",p7);if(e.meshMessageDeliveriesWindow<0)throw new $4("invalid MeshMessageDeliveriesWindow; must be non-negative",p7);if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesActivation<1e3)throw new $4("invalid MeshMessageDeliveriesActivation; must be at least 1s",p7);if(e.meshFailurePenaltyWeight>0)throw new $4("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)",p7);if(0!==e.meshFailurePenaltyWeight&&(e.meshFailurePenaltyDecay<=0||e.meshFailurePenaltyDecay>=1))throw new $4("invalid MeshFailurePenaltyDecay; must be between 0 and 1",p7);if(e.invalidMessageDeliveriesWeight>0)throw new $4("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)",p7);if(e.invalidMessageDeliveriesDecay<=0||e.invalidMessageDeliveriesDecay>=1)throw new $4("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1",p7)}const b7={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function w7(){return{...b7,...arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}}}function E7(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:()=>!0;const r=new Set;if(t<=0)return r;for(const i of e){if(r.size>=t)break;n(i)&&(r.add(i),e.delete(i))}return r}class A7 extends Map{constructor(e){super(),(0,Yo.Z)(this,"getDefault",void 0),this.getDefault=e}getOrDefault(e){let t=super.get(e);return void 0===t&&(t=this.getDefault(),this.set(e,t)),t}}function S7(e,t,n,r){let i=0;Object.entries(t.topics).forEach((e=>{let[t,r]=e;const o=n.topics[t];if(void 0===o)return;let s=0;if(r.inMesh){let e=r.meshTime/o.timeInMeshQuantum;e>o.timeInMeshCap&&(e=o.timeInMeshCap),s+=e*o.timeInMeshWeight}let a=r.firstMessageDeliveries;if(a>o.firstMessageDeliveriesCap&&(a=o.firstMessageDeliveriesCap),s+=a*o.firstMessageDeliveriesWeight,r.meshMessageDeliveriesActive&&r.meshMessageDeliveries<o.meshMessageDeliveriesThreshold){const e=o.meshMessageDeliveriesThreshold-r.meshMessageDeliveries;s+=e*e*o.meshMessageDeliveriesWeight}s+=r.meshFailurePenalty*o.meshFailurePenaltyWeight;s+=r.invalidMessageDeliveries*r.invalidMessageDeliveries*o.invalidMessageDeliveriesWeight,i+=s*o.topicWeight})),n.topicScoreCap>0&&i>n.topicScoreCap&&(i=n.topicScoreCap);const o=n.appSpecificScore(e);if(i+=o*n.appSpecificWeight,t.knownIPs.forEach((e=>{if(n.IPColocationFactorWhitelist.has(e))return;const t=r.get(e),o=null!=t?t.size:0;if(o>n.IPColocationFactorThreshold){const e=o-n.IPColocationFactorThreshold;i+=e*e*n.IPColocationFactorWeight}})),t.behaviourPenalty>n.behaviourPenaltyThreshold){const e=t.behaviourPenalty-n.behaviourPenaltyThreshold;i+=e*e*n.behaviourPenaltyWeight}return i}var _7,I7=n(43663),C7=n.n(I7);!function(e){e[e.unknown=0]="unknown",e[e.valid=1]="valid",e[e.invalid=2]="invalid",e[e.ignored=3]="ignored"}(_7||(_7={}));class T7{constructor(){(0,Yo.Z)(this,"records",void 0),(0,Yo.Z)(this,"queue",void 0),this.records=new Map,this.queue=new(C7())}getRecord(e){return this.records.get(e)}ensureRecord(e){let t=this.records.get(e);if(null!=t)return t;t={status:_7.unknown,firstSeenTsMs:Date.now(),validated:0,peers:new Set},this.records.set(e,t);const n={msgId:e,expire:Date.now()+12e4};return this.queue.push(n),t}gc(){const e=Date.now();let t=this.queue.peekFront();for(;null!=t&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}const k7=J4("libp2p:gossipsub:score");class R7{constructor(e,t,n){var r;(0,Yo.Z)(this,"params",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"peerStats",new Map),(0,Yo.Z)(this,"peerIPs",new A7((()=>new Set))),(0,Yo.Z)(this,"scoreCache",new Map),(0,Yo.Z)(this,"deliveryRecords",new T7),(0,Yo.Z)(this,"_backgroundInterval",void 0),(0,Yo.Z)(this,"scoreCacheValidityMs",void 0),(0,Yo.Z)(this,"computeScore",void 0),this.params=e,this.metrics=t,function(e){for(const[n,r]of Object.entries(e.topics))try{v7(r)}catch(t){throw new $4("invalid score parameters for topic ".concat(n,": ").concat(t.message),p7)}if(e.topicScoreCap<0)throw new $4("invalid topic score cap; must be positive (or 0 for no cap)",p7);if(null===e.appSpecificScore||void 0===e.appSpecificScore)throw new $4("missing application specific score function",p7);if(e.IPColocationFactorWeight>0)throw new $4("invalid IPColocationFactorWeight; must be negative (or 0 to disable)",p7);if(0!==e.IPColocationFactorWeight&&e.IPColocationFactorThreshold<1)throw new $4("invalid IPColocationFactorThreshold; must be at least 1",p7);if(e.behaviourPenaltyWeight>0)throw new $4("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)",p7);if(0!==e.behaviourPenaltyWeight&&(e.behaviourPenaltyDecay<=0||e.behaviourPenaltyDecay>=1))throw new $4("invalid BehaviourPenaltyDecay; must be between 0 and 1",p7);if(e.decayInterval<1e3)throw new $4("invalid DecayInterval; must be at least 1s",p7);if(e.decayToZero<=0||e.decayToZero>=1)throw new $4("invalid DecayToZero; must be between 0 and 1",p7)}(e),this.scoreCacheValidityMs=n.scoreCacheValidityMs,this.computeScore=null!==(r=n.computeScore)&&void 0!==r?r:S7}get size(){return this.peerStats.size}start(){null==this._backgroundInterval?(this._backgroundInterval=setInterval((()=>{this.background()}),this.params.decayInterval),k7("started")):k7("Peer score already running")}stop(){null!=this._backgroundInterval?(clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),k7("stopped")):k7("Peer score already stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map((e=>{let[t,n]=e;return[t,n]})))}messageFirstSeenTimestampMs(e){const t=this.deliveryRecords.getRecord(e);return null!=t?t.firstSeenTsMs:null}refreshScores(){const e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach(((n,r)=>{n.connected?(Object.entries(n.topics).forEach((n=>{let[r,i]=n;const o=this.params.topics[r];void 0!==o&&(i.firstMessageDeliveries*=o.firstMessageDeliveriesDecay,i.firstMessageDeliveries<t&&(i.firstMessageDeliveries=0),i.meshMessageDeliveries*=o.meshMessageDeliveriesDecay,i.meshMessageDeliveries<t&&(i.meshMessageDeliveries=0),i.meshFailurePenalty*=o.meshFailurePenaltyDecay,i.meshFailurePenalty<t&&(i.meshFailurePenalty=0),i.invalidMessageDeliveries*=o.invalidMessageDeliveriesDecay,i.invalidMessageDeliveries<t&&(i.invalidMessageDeliveries=0),i.inMesh&&(i.meshTime=e-i.graftTime,i.meshTime>o.meshMessageDeliveriesActivation&&(i.meshMessageDeliveriesActive=!0)))})),n.behaviourPenalty*=this.params.behaviourPenaltyDecay,n.behaviourPenalty<t&&(n.behaviourPenalty=0)):e>n.expire&&(this.removeIPsForPeer(r,n.knownIPs),this.peerStats.delete(r),this.scoreCache.delete(r))}))}score(e){var t,n;null===(t=this.metrics)||void 0===t||t.scoreFnCalls.inc();const r=this.peerStats.get(e);if(null==r)return 0;const i=Date.now(),o=this.scoreCache.get(e);if(null!=o&&o.cacheUntil>i)return o.score;null===(n=this.metrics)||void 0===n||n.scoreFnRuns.inc();const s=this.computeScore(e,r,this.params,this.peerIPs),a=i+this.scoreCacheValidityMs;var c;null!=o?(null===(c=this.metrics)||void 0===c||c.scoreCachedDelta.observe(Math.abs(s-o.score)),o.score=s,o.cacheUntil=a):this.scoreCache.set(e,{score:s,cacheUntil:a});return s}addPenalty(e,t,n){const r=this.peerStats.get(e);var i;null!=r&&(r.behaviourPenalty+=t,null===(i=this.metrics)||void 0===i||i.onScorePenalty(n))}addPeer(e){const t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}addIP(e,t){const n=this.peerStats.get(e);null!=n&&n.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}removeIP(e,t){const n=this.peerStats.get(e);null!=n&&n.knownIPs.delete(t);const r=this.peerIPs.get(t);null!=r&&(r.delete(e),0===r.size&&this.peerIPs.delete(t))}removePeer(e){const t=this.peerStats.get(e);if(null!=t){if(this.score(e)>0)return this.removeIPsForPeer(e,t.knownIPs),void this.peerStats.delete(e);Object.entries(t.topics).forEach((e=>{let[t,n]=e;n.firstMessageDeliveries=0;const r=this.params.topics[t].meshMessageDeliveriesThreshold;if(n.inMesh&&n.meshMessageDeliveriesActive&&n.meshMessageDeliveries<r){const e=r-n.meshMessageDeliveries;n.meshFailurePenalty+=e*e}n.inMesh=!1,n.meshMessageDeliveriesActive=!1})),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){const n=this.peerStats.get(e);if(null!=n){const e=this.getPtopicStats(n,t);null!=e&&(e.inMesh=!0,e.graftTime=Date.now(),e.meshTime=0,e.meshMessageDeliveriesActive=!1)}}prune(e,t){const n=this.peerStats.get(e);if(null!=n){const e=this.getPtopicStats(n,t);if(null!=e){const n=this.params.topics[t].meshMessageDeliveriesThreshold;if(e.meshMessageDeliveriesActive&&e.meshMessageDeliveries<n){const t=n-e.meshMessageDeliveries;e.meshFailurePenalty+=t*t}e.meshMessageDeliveriesActive=!1,e.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,n){this.markFirstMessageDelivery(e,n);const r=this.deliveryRecords.ensureRecord(t),i=Date.now();r.status===_7.unknown?(r.status=_7.valid,r.validated=i,r.peers.forEach((t=>{t!==e.toString()&&this.markDuplicateMessageDelivery(t,n)}))):k7("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,i-r.firstSeenTsMs,_7[r.status])}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,n,r){switch(r){case i7.Error:return void this.markInvalidMessageDelivery(e,n);case i7.Blacklisted:return}const i=this.deliveryRecords.ensureRecord(t);if(i.status===_7.unknown){if(r===i7.Ignore)return i.status=_7.ignored,void i.peers.clear();i.status=_7.invalid,this.markInvalidMessageDelivery(e,n),i.peers.forEach((e=>{this.markInvalidMessageDelivery(e,n)})),i.peers.clear()}else k7("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-i.firstSeenTsMs,_7[i.status])}duplicateMessage(e,t,n){const r=this.deliveryRecords.ensureRecord(t);if(!r.peers.has(e))switch(r.status){case _7.unknown:r.peers.add(e);break;case _7.valid:r.peers.add(e),this.markDuplicateMessageDelivery(e,n,r.validated);break;case _7.invalid:this.markInvalidMessageDelivery(e,n);case _7.ignored:}}markInvalidMessageDelivery(e,t){const n=this.peerStats.get(e);if(null!=n){const e=this.getPtopicStats(n,t);null!=e&&(e.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){const n=this.peerStats.get(e);if(null!=n){const e=this.getPtopicStats(n,t);if(null!=e){let n=this.params.topics[t].firstMessageDeliveriesCap;e.firstMessageDeliveries=Math.min(n,e.firstMessageDeliveries+1),e.inMesh&&(n=this.params.topics[t].meshMessageDeliveriesCap,e.meshMessageDeliveries=Math.min(n,e.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,n){const r=this.peerStats.get(e);if(null!=r){const e=void 0!==n?Date.now():0,o=this.getPtopicStats(r,t);if(null!=o&&o.inMesh){const r=this.params.topics[t];if(void 0!==n){var i;const o=e-n,s=o>r.meshMessageDeliveriesWindow;if(null===(i=this.metrics)||void 0===i||i.onDuplicateMsgDelivery(t,o,s),s)return}const s=r.meshMessageDeliveriesCap;o.meshMessageDeliveries=Math.min(s,o.meshMessageDeliveries+1)}}}removeIPsForPeer(e,t){for(const n of t){const t=this.peerIPs.get(n);null!=t&&(t.delete(e),0===t.size&&this.peerIPs.delete(n))}}getPtopicStats(e,t){let n=e.topics[t];return void 0!==n?n:void 0!==this.params.topics[t]?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}}function x7(e,t,n,r,i){let o=0;const s=new Map;if(Object.entries(t.topics).forEach((e=>{var t;let[r,a]=e;const c=null!==(t=i.get(r))&&void 0!==t?t:"unknown",l=n.topics[r];if(void 0===l)return;let u=s.get(c);null==u&&(u={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},s.set(c,u));let h=0,d=0,f=0,p=0,g=0;if(a.inMesh){h+=Math.max(a.meshTime/l.timeInMeshQuantum,l.timeInMeshCap)*l.timeInMeshWeight}let y=a.firstMessageDeliveries;if(y>l.firstMessageDeliveriesCap&&(y=l.firstMessageDeliveriesCap),d+=y*l.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<l.meshMessageDeliveriesThreshold){const e=l.meshMessageDeliveriesThreshold-a.meshMessageDeliveries;f+=e*e*l.meshMessageDeliveriesWeight}p+=a.meshFailurePenalty*l.meshFailurePenaltyWeight;g+=a.invalidMessageDeliveries*a.invalidMessageDeliveries*l.invalidMessageDeliveriesWeight,o+=(h+d+f+p+g)*l.topicWeight,u.p1w+=h,u.p2w+=d,u.p3w+=f,u.p3bw+=p,u.p4w+=g})),n.topicScoreCap>0&&o>n.topicScoreCap){o=n.topicScoreCap;const e=n.topicScoreCap/o;for(const t of s.values())t.p1w*=e,t.p2w*=e,t.p3w*=e,t.p3bw*=e,t.p4w*=e}let a=0,c=0,l=0;a+=n.appSpecificScore(e)*n.appSpecificWeight,t.knownIPs.forEach((e=>{if(n.IPColocationFactorWhitelist.has(e))return;const t=r.get(e),i=null!=t?t.size:0;if(i>n.IPColocationFactorThreshold){const e=i-n.IPColocationFactorThreshold;c+=e*e*n.IPColocationFactorWeight}}));return l+=t.behaviourPenalty*t.behaviourPenalty*n.behaviourPenaltyWeight,o+=a+c+l,{byTopic:s,p5w:a,p6w:c,p7w:l,score:o}}function P7(e){return null!=e[Symbol.asyncIterator]}const D7=e=>{const t=Bs.P$(e),n=(0,Us.E)(t);return Bs.cv(e,n),D7.bytes=t,n};function O7(e,t){var n,r;const i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:D7;function*o(e){const t=i(e.byteLength);t instanceof Uint8Array?yield t:yield*t,e instanceof Uint8Array?yield e:yield*e}return P7(e)?async function*(){for await(const t of e)yield*o(t)}():function*(){for(const t of e)yield*o(t)}()}D7.bytes=0,O7.single=(e,t)=>{var n,r;const i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:D7;return new Zs(i(e.byteLength),e)};var N7;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(N7||(N7={}));const B7=e=>{const t=Bs.Jx(e);return B7.bytes=Bs.P$(t),t};function L7(e,t){var n,r,i;const o=new Zs;let s=N7.LENGTH,a=-1;const c=null!==(n=null===t||void 0===t?void 0:t.lengthDecoder)&&void 0!==n?n:B7,l=null!==(r=null===t||void 0===t?void 0:t.maxLengthLength)&&void 0!==r?r:8,u=null!==(i=null===t||void 0===t?void 0:t.maxDataLength)&&void 0!==i?i:4194304;function*h(){for(;o.byteLength>0;){if(s===N7.LENGTH)try{if(a=c(o),a<0)throw Xo()(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(a>u)throw Xo()(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const e=c.bytes;o.consume(e),null!=(null===t||void 0===t?void 0:t.onLength)&&t.onLength(a),s=N7.DATA}catch(e){if(e instanceof RangeError){if(o.byteLength>l)throw Xo()(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw e}if(s===N7.DATA){if(o.byteLength<a)break;const e=o.sublist(0,a);o.consume(a),null!=(null===t||void 0===t?void 0:t.onData)&&t.onData(e),yield e,s=N7.LENGTH}}}return P7(e)?async function*(){for await(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}B7.bytes=0,L7.fromReader=(e,t)=>{let n=1;return L7(async function*(){for(;;)try{const{done:t,value:r}=await e.next(n);if(!0===t)return;null!=r&&(yield r)}catch(t){if("ERR_UNDER_READ"===t.code)return{done:!0,value:null};throw t}finally{n=1}}(),{...null!==t&&void 0!==t?t:{},onLength:e=>{n=e}})};class M7{constructor(e,t,n){var r;(0,Yo.Z)(this,"rawStream",void 0),(0,Yo.Z)(this,"pushable",void 0),(0,Yo.Z)(this,"closeController",void 0),(0,Yo.Z)(this,"maxBufferSize",void 0),this.rawStream=e,this.pushable=k8({objectMode:!1}),this.closeController=new AbortController,this.maxBufferSize=null!==(r=n.maxBufferSize)&&void 0!==r?r:1/0,P8(fF(this.pushable,this.closeController.signal,{returnOnAbort:!0}),(e=>O7(e)),this.rawStream).catch(t)}get protocol(){return this.rawStream.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error("OutboundStream buffer full, size > ".concat(this.maxBufferSize));this.pushable.push(e)}async close(){this.closeController.abort(),await this.pushable.return(),await this.rawStream.close()}}class U7{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"source",void 0),(0,Yo.Z)(this,"rawStream",void 0),(0,Yo.Z)(this,"closeController",void 0),this.rawStream=e,this.closeController=new AbortController,this.source=fF(P8(this.rawStream,(e=>L7(e,t))),this.closeController.signal,{returnOnAbort:!0})}async close(){this.closeController.abort(),await this.rawStream.close()}}class F7{constructor(e,t,n){(0,Yo.Z)(this,"gossipsubIWantFollowupMs",void 0),(0,Yo.Z)(this,"msgIdToStrFn",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"promises",new Map),(0,Yo.Z)(this,"requestMsByMsg",new Map),(0,Yo.Z)(this,"requestMsByMsgExpire",void 0),this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=n,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){const n=t[Math.floor(Math.random()*t.length)],r=this.msgIdToStrFn(n);let i=this.promises.get(r);null==i&&(i=new Map,this.promises.set(r,i));const o=Date.now();i.has(e)||(i.set(e,o+this.gossipsubIWantFollowupMs),null!=this.metrics&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(r)||this.requestMsByMsg.set(r,o)))}getBrokenPromises(){var e;const t=Date.now(),n=new Map;let r=0;return this.promises.forEach(((e,i)=>{e.forEach(((i,o)=>{var s;i<t&&(n.set(o,(null!==(s=n.get(o))&&void 0!==s?s:0)+1),e.delete(o),r++)})),0===e.size&&this.promises.delete(i)})),null===(e=this.metrics)||void 0===e||e.iwantPromiseBroken.inc(r),n}deliverMessage(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.trackMessage(e);const n=this.promises.get(e);null!=n&&(this.promises.delete(e),null!=this.metrics&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(n.size)))}rejectMessage(e,t){this.trackMessage(e),t!==i7.Error&&this.promises.delete(e)}clear(){this.promises.clear()}prune(){var e;const t=Date.now()-this.requestMsByMsgExpire;let n=0;for(const[r,i]of this.requestMsByMsg.entries()){if(!(i<t))break;this.requestMsByMsg.delete(r),n++}null===(e=this.metrics)||void 0===e||e.iwantMessagePruned.inc(n)}trackMessage(e){if(null!=this.metrics){const t=this.requestMsByMsg.get(e);void 0!==t&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}}const K7={get(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:globalThis).crypto;if(null==e||null==e.subtle)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p-crypto/blob/master/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}};const j7=32,Z7=64,z7=32;function V7(e,t){const n=new Uint8Array(Z7);for(let r=0;r<z7;r++)n[r]=e[r],n[z7+r]=t[r];return n}const H7={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};async function q7(e,t){const n=function(e){var t,n,r,i,o,s;const a=null!==(t=null===e||void 0===e?void 0:e.algorithm)&&void 0!==t?t:"AES-GCM";let c=null!==(n=null===e||void 0===e?void 0:e.keyLength)&&void 0!==n?n:16;const l=null!==(r=null===e||void 0===e?void 0:e.nonceLength)&&void 0!==r?r:12,u=null!==(i=null===e||void 0===e?void 0:e.digest)&&void 0!==i?i:"SHA-256",h=null!==(o=null===e||void 0===e?void 0:e.saltLength)&&void 0!==o?o:16,d=null!==(s=null===e||void 0===e?void 0:e.iterations)&&void 0!==s?s:32767,f=K7.get();return c*=8,{encrypt:async function(e,t){const n=f.getRandomValues(new Uint8Array(h)),r=f.getRandomValues(new Uint8Array(l)),i={name:a,iv:r};let o;if("string"===typeof t&&(t=(0,yu.m)(t)),0===t.length){o=await f.subtle.importKey("jwk",H7,{name:"AES-GCM"},!0,["encrypt"]);try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}catch{o=await f.subtle.importKey("jwk",H7,{name:"AES-GCM"},!0,["encrypt"])}}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}const s=await f.subtle.encrypt(i,o,e);return(0,Ls.z)([n,i.iv,new Uint8Array(s)])},decrypt:async function(e,t){const n=e.subarray(0,h),r=e.subarray(h,h+l),i=e.subarray(h+l),o={name:a,iv:r};let s;if("string"===typeof t&&(t=(0,yu.m)(t)),0===t.length)try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}catch{s=await f.subtle.importKey("jwk",H7,{name:"AES-GCM"},!0,["decrypt"])}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}const p=await f.subtle.decrypt(o,s,i);return new Uint8Array(p)}}}(),r=await n.encrypt(e,t);return G4.encode(r)}var G7,W7,Q7,Y7;!function(e){e.RSA="RSA",e.Ed25519="Ed25519",e.Secp256k1="Secp256k1"}(G7||(G7={})),function(e){e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.Secp256k1=2]="Secp256k1"}(W7||(W7={})),function(e){e.codec=()=>bs(W7)}(G7||(G7={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),G7.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=G7.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(Q7||(Q7={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),G7.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=G7.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(Y7||(Y7={}));class J7{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=r9(e,j7)}async verify(e,t){return async function(e,t,n){return ql.verify(t,n,e)}(this._key,t,e)}marshal(){return this._key}get bytes(){return Q7.encode({Type:G7.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await e8.digest(this.bytes);return e}}class X7{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=r9(e,Z7),this._publicKey=r9(t,j7)}async sign(e){return async function(e,t){const n=e.subarray(0,z7);return ql.sign(t,n)}(this._key,e)}get public(){return new J7(this._publicKey)}marshal(){return this._key}get bytes(){return Y7.encode({Type:G7.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await e8.digest(this.bytes);return e}async id(){const e=Y6.digest(this.public.bytes);return H4.encode(e.bytes).substring(1)}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return q7(this.bytes,e);throw new $4("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function $7(e){if(e.length>Z7){const t=(e=r9(e,Z7+j7)).subarray(0,Z7),n=e.subarray(Z7,e.length);return new X7(t,n)}const t=(e=r9(e,Z7)).subarray(0,Z7),n=e.subarray(j7);return new X7(t,n)}function e9(e){return e=r9(e,j7),new J7(e)}async function t9(){const{privateKey:e,publicKey:t}=await async function(){const e=ql.utils.randomPrivateKey(),t=ql.getPublicKey(e);return{privateKey:V7(e,t),publicKey:t}}();return new X7(e,t)}async function n9(e){const{privateKey:t,publicKey:n}=await async function(e){if(e.length!==z7)throw new TypeError('"seed" must be 32 bytes in length.');if(!(e instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const t=e,n=ql.getPublicKey(t);return{privateKey:V7(t,n),publicKey:n}}(e);return new X7(t,n)}function r9(e,t){var n;if((e=Uint8Array.from(null!==(n=e)&&void 0!==n?n:[])).length!==t)throw new $4("Key must be a Uint8Array of length ".concat(t,", got ").concat(e.length),"ERR_INVALID_KEY_TYPE");return e}function i9(e,t){let n=Uint8Array.from(e.abs().toByteArray());if(n=0===n[0]?n.subarray(1):n,null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return(0,Au.B)(n,"base64url")}function o9(e){const t=function(e,t){let n=(0,yu.m)(e,"base64urlpad");if(null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return n}(e);return new(gu().jsbn.BigInteger)((0,Au.B)(t,"base16"),16)}const s9={"P-256":256,"P-384":384,"P-521":521};Object.keys(s9).join(" / ");function a9(e){if(isNaN(e)||e<=0)throw new $4("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return _c(e)}function c9(e,t){return t.map((t=>o9(e[t])))}async function l9(e){const t=[await K7.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await h9(e)],n=await u9({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function u9(e){if(null==e.privateKey||null==e.publicKey)throw new $4("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([K7.get().subtle.exportKey("jwk",e.privateKey),K7.get().subtle.exportKey("jwk",e.publicKey)])}async function h9(e){return K7.get().subtle.importKey("jwk",{kty:e.kty,n:e.n,e:e.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function d9(e,t,n,r){const i=t?function(e){return gu().pki.setRsaPublicKey(...c9(e,["n","e"]))}(e):function(e){return gu().pki.setRsaPrivateKey(...c9(e,["n","e","d","p","q","dp","dq","qi"]))}(e),o=r((0,Au.B)(Uint8Array.from(n),"ascii"),i);return(0,yu.m)(o,"ascii")}function f9(e){if("RSA"!==e.kty)throw new $4("invalid key type","ERR_INVALID_KEY_TYPE");if(null==e.n)throw new $4("invalid key modulus","ERR_INVALID_KEY_MODULUS");return 8*(0,yu.m)(e.n,"base64url").length}const p9=8192;class g9{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=e}async verify(e,t){return async function(e,t,n){const r=await K7.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return K7.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,t,n)}(this._key,t,e)}marshal(){return function(e){if(null==e.n||null==e.e)throw new $4("JWK was missing components","ERR_INVALID_PARAMETERS");const t=gu().pki.publicKeyToAsn1({n:o9(e.n),e:o9(e.e)});return(0,yu.m)(gu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return Q7.encode({Type:G7.RSA,Data:this.marshal()}).subarray()}encrypt(e){return d9(this._key,!0,e,((e,t)=>t.encrypt(e)))}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await e8.digest(this.bytes);return e}}class y9{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=t}genSecret(){return a9(16)}async sign(e){return async function(e,t){const n=await K7.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await K7.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,Uint8Array.from(t));return new Uint8Array(r,0,r.byteLength)}(this._key,e)}get public(){if(null==this._publicKey)throw new $4("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new g9(this._publicKey)}decrypt(e){return d9(this._key,!1,e,((e,t)=>t.decrypt(e)))}marshal(){return function(e){if(null==e.n||null==e.e||null==e.d||null==e.p||null==e.q||null==e.dp||null==e.dq||null==e.qi)throw new $4("JWK was missing components","ERR_INVALID_PARAMETERS");const t=gu().pki.privateKeyToAsn1({n:o9(e.n),e:o9(e.e),d:o9(e.d),p:o9(e.p),q:o9(e.q),dP:o9(e.dp),dQ:o9(e.dq),qInv:o9(e.qi)});return(0,yu.m)(gu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return Y7.encode({Type:G7.RSA,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await e8.digest(this.bytes);return e}async id(){const e=await this.public.hash();return(0,Au.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"pkcs-8";if("pkcs-8"===t){const t=new(gu().util.ByteBuffer)(this.marshal()),n=gu().asn1.fromDer(t),r=gu().pki.privateKeyFromAsn1(n),i={algorithm:"aes256",count:1e4,saltSize:16,prfAlgorithm:"sha512"};return gu().pki.encryptRsaPrivateKey(r,e,i)}if("libp2p-key"===t)return q7(this.bytes,e);throw new $4("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}async function m9(e){const t=function(e){const t=gu().asn1.fromDer((0,Au.B)(e,"ascii")),n=gu().pki.privateKeyFromAsn1(t);return{kty:"RSA",n:i9(n.n),e:i9(n.e),d:i9(n.d),p:i9(n.p),q:i9(n.q),dp:i9(n.dP),dq:i9(n.dQ),qi:i9(n.qInv),alg:"RS256"}}(e);if(f9(t)>p9)throw new $4("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const n=await l9(t);return new y9(n.privateKey,n.publicKey)}function v9(e){const t=function(e){const t=gu().asn1.fromDer((0,Au.B)(e,"ascii")),n=gu().pki.publicKeyFromAsn1(t);return{kty:"RSA",n:i9(n.n),e:i9(n.e)}}(e);if(f9(t)>p9)throw new $4("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new g9(t)}async function b9(e){if(f9(e)>p9)throw new $4("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await l9(e);return new y9(t.privateKey,t.publicKey)}async function w9(e){if(e>p9)throw new $4("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await async function(e){const t=await K7.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:e,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await u9(t);return{privateKey:n[0],publicKey:n[1]}}(e);return new y9(t.privateKey,t.publicKey)}function E9(e){try{Eh.ProjectivePoint.fromHex(e)}catch(t){throw new $4(String(t),"ERR_INVALID_PUBLIC_KEY")}}class A9{constructor(e){(0,Yo.Z)(this,"_key",void 0),E9(e),this._key=e}async verify(e,t){return async function(e,t,n){try{const{digest:r}=await e8.digest(n);return Eh.verify(t,r,e)}catch(r){throw new $4(String(r),"ERR_INVALID_INPUT")}}(this._key,t,e)}marshal(){return e=this._key,Eh.ProjectivePoint.fromHex(e).toRawBytes(!0);var e}get bytes(){return Q7.encode({Type:G7.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await e8.digest(this.bytes);return e}}class S9{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=null!==t&&void 0!==t?t:function(e){try{return Eh.getPublicKey(e,!0)}catch(t){throw new $4(String(t),"ERR_INVALID_PRIVATE_KEY")}}(e),function(e){try{Eh.getPublicKey(e,!0)}catch(t){throw new $4(String(t),"ERR_INVALID_PRIVATE_KEY")}}(this._key),E9(this._publicKey)}async sign(e){return async function(e,t){const{digest:n}=await e8.digest(t);try{return Eh.sign(n,e).toDERRawBytes()}catch(r){throw new $4(String(r),"ERR_INVALID_INPUT")}}(this._key,e)}get public(){return new A9(this._publicKey)}marshal(){return this._key}get bytes(){return Y7.encode({Type:G7.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await e8.digest(this.bytes);return e}async id(){const e=await this.public.hash();return(0,Au.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return q7(this.bytes,e);throw new $4("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function _9(e){return new S9(e)}function I9(e){return new A9(e)}async function C9(){const e=Eh.utils.randomPrivateKey();return new S9(e)}const T9={rsa:Jn,ed25519:Yn,secp256k1:Xn};function k9(e){const t=Object.keys(T9).join(" / ");return new $4("invalid or unsupported key type ".concat(e,". Must be ").concat(t),"ERR_UNSUPPORTED_KEY_TYPE")}function R9(e){if("rsa"===(e=e.toLowerCase())||"ed25519"===e||"secp256k1"===e)return T9[e];throw k9(e)}function x9(e){var t,n;const r=Q7.decode(e),i=null!==(t=r.Data)&&void 0!==t?t:new Uint8Array;switch(r.Type){case G7.RSA:return T9.rsa.unmarshalRsaPublicKey(i);case G7.Ed25519:return T9.ed25519.unmarshalEd25519PublicKey(i);case G7.Secp256k1:return T9.secp256k1.unmarshalSecp256k1PublicKey(i);default:throw k9(null!==(n=r.Type)&&void 0!==n?n:"unknown")}}function P9(e,t){var n;return R9(t=(null!==(n=t)&&void 0!==n?n:"rsa").toLowerCase()),e.bytes}async function D9(e){var t,n;const r=Y7.decode(e),i=null!==(t=r.Data)&&void 0!==t?t:new Uint8Array;switch(r.Type){case G7.RSA:return T9.rsa.unmarshalRsaPrivateKey(i);case G7.Ed25519:return T9.ed25519.unmarshalEd25519PrivateKey(i);case G7.Secp256k1:return T9.secp256k1.unmarshalSecp256k1PrivateKey(i);default:throw k9(null!==(n=r.Type)&&void 0!==n?n:"RSA")}}const O9=(0,yu.m)("libp2p-pubsub:");function N9(e){if(e.length<=1)return e;for(let t=0;t<e.length;t++){const n=Math.floor(Math.random()*Math.floor(e.length)),r=e[t];e[t]=e[n],e[n]=r}return e}function B9(e){return(0,Au.B)(e,"base64")}const L9={get(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:globalThis).crypto;if(null==e||null==e.subtle)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}};var M9=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const U9=M9,F9=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class K9{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class j9{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return z9(this,e)}}class Z9{constructor(e){this.decoders=e}or(e){return z9(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const z9=(e,t)=>new Z9({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class V9{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new K9(e,t,n),this.decoder=new j9(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const H9=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new V9(t,n,r,i)},q9=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=U9(r,n);return H9({prefix:t,name:n,encode:i,decode:e=>F9(o(e))})},G9=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return H9({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},W9=q9({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Q9=q9({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Y9=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=$9;)n[r++]=255&t|J9,t/=128;for(;t&X9;)n[r++]=255&t|J9,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},J9=128,X9=-128,$9=Math.pow(2,31);var eee=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&nee)<<o:(r&nee)*Math.pow(2,o),o+=7}while(r>=tee);return e.bytes=s-n,i},tee=128,nee=127;var ree=Math.pow(2,7),iee=Math.pow(2,14),oee=Math.pow(2,21),see=Math.pow(2,28),aee=Math.pow(2,35),cee=Math.pow(2,42),lee=Math.pow(2,49),uee=Math.pow(2,56),hee=Math.pow(2,63);const dee={encode:Y9,decode:eee,encodingLength:function(e){return e<ree?1:e<iee?2:e<oee?3:e<see?4:e<aee?5:e<cee?6:e<lee?7:e<uee?8:e<hee?9:10}},fee=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return dee.encode(e,t,n),t},pee=e=>dee.encodingLength(e),gee=(e,t)=>{const n=t.byteLength,r=pee(e),i=r+pee(n),o=new Uint8Array(i+n);return fee(e,o,0),fee(n,o,r),o.set(t,i),new yee(e,n,t,o)};class yee{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const mee=F9,vee={code:0,name:"identity",encode:mee,digest:e=>gee(0,mee(e))},bee=e=>{let{name:t,code:n,encode:r}=e;return new wee(t,n,r)};class wee{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?gee(this.code,t):t.then((e=>gee(this.code,e)))}throw Error("Unknown type, must be binary type")}}const Eee=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),Aee=bee({name:"sha2-256",code:18,encode:Eee("SHA-256")}),See=bee({name:"sha2-512",code:19,encode:Eee("SHA-512")});function _ee(e,t){let n=Uint8Array.from(e.abs().toByteArray());if(n=0===n[0]?n.subarray(1):n,null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return(0,Au.B)(n,"base64url")}function Iee(e){const t=function(e,t){let n=(0,yu.m)(e,"base64urlpad");if(null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return n}(e);return new(gu().jsbn.BigInteger)((0,Au.B)(t,"base16"),16)}function Cee(e){return null!=e&&("function"===typeof e.then&&"function"===typeof e.catch&&"function"===typeof e.finally)}const Tee=32,kee=64,Ree=32;function xee(e,t){const n=new Uint8Array(kee);for(let r=0;r<Ree;r++)n[r]=e[r],n[Ree+r]=t[r];return n}const Pee=G9({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),Dee=G9({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),Oee=G9({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Nee=G9({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),Bee={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};async function Lee(e,t){const n=function(e){var t,n,r,i,o,s;const a=null!==(t=null===e||void 0===e?void 0:e.algorithm)&&void 0!==t?t:"AES-GCM";let c=null!==(n=null===e||void 0===e?void 0:e.keyLength)&&void 0!==n?n:16;const l=null!==(r=null===e||void 0===e?void 0:e.nonceLength)&&void 0!==r?r:12,u=null!==(i=null===e||void 0===e?void 0:e.digest)&&void 0!==i?i:"SHA-256",h=null!==(o=null===e||void 0===e?void 0:e.saltLength)&&void 0!==o?o:16,d=null!==(s=null===e||void 0===e?void 0:e.iterations)&&void 0!==s?s:32767,f=L9.get();return c*=8,{encrypt:async function(e,t){const n=f.getRandomValues(new Uint8Array(h)),r=f.getRandomValues(new Uint8Array(l)),i={name:a,iv:r};let o;if("string"===typeof t&&(t=(0,yu.m)(t)),0===t.length){o=await f.subtle.importKey("jwk",Bee,{name:"AES-GCM"},!0,["encrypt"]);try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}catch{o=await f.subtle.importKey("jwk",Bee,{name:"AES-GCM"},!0,["encrypt"])}}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}const s=await f.subtle.encrypt(i,o,e);return(0,Ls.z)([n,i.iv,new Uint8Array(s)])},decrypt:async function(e,t){const n=e.subarray(0,h),r=e.subarray(h,h+l),i=e.subarray(h+l),o={name:a,iv:r};let s;if("string"===typeof t&&(t=(0,yu.m)(t)),0===t.length)try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}catch{s=await f.subtle.importKey("jwk",Bee,{name:"AES-GCM"},!0,["decrypt"])}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}const p=await f.subtle.decrypt(o,s,i);return new Uint8Array(p)}}}(),r=await n.encrypt(e,t);return Pee.encode(r)}var Mee,Uee,Fee,Kee;!function(e){e.RSA="RSA",e.Ed25519="Ed25519",e.Secp256k1="Secp256k1"}(Mee||(Mee={})),function(e){e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.Secp256k1=2]="Secp256k1"}(Uee||(Uee={})),function(e){e.codec=()=>bs(Uee)}(Mee||(Mee={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),Mee.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=Mee.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(Fee||(Fee={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),Mee.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=Mee.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(Kee||(Kee={}));class jee{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=Gee(e,Tee)}verify(e,t){return function(e,t,n){return ql.verify(t,n instanceof Uint8Array?n:n.subarray(),e)}(this._key,t,e)}marshal(){return this._key}get bytes(){return Fee.encode({Type:Mee.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=Aee.digest(this.bytes);return Cee(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}}class Zee{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=Gee(e,kee),this._publicKey=Gee(t,Tee)}sign(e){return function(e,t){const n=e.subarray(0,Ree);return ql.sign(t instanceof Uint8Array?t:t.subarray(),n)}(this._key,e)}get public(){return new jee(this._publicKey)}marshal(){return this._key}get bytes(){return Kee.encode({Type:Mee.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const e=Aee.digest(this.bytes);let t;return Cee(e)?({bytes:t}=await e):t=e.bytes,t}async id(){const e=vee.digest(this.public.bytes);return W9.encode(e.bytes).substring(1)}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return Lee(this.bytes,e);throw new fu.sv("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function zee(e){if(e.length>kee){const t=(e=Gee(e,kee+Tee)).subarray(0,kee),n=e.subarray(kee,e.length);return new Zee(t,n)}const t=(e=Gee(e,kee)).subarray(0,kee),n=e.subarray(Tee);return new Zee(t,n)}function Vee(e){return e=Gee(e,Tee),new jee(e)}async function Hee(){const{privateKey:e,publicKey:t}=function(){const e=ql.utils.randomPrivateKey(),t=ql.getPublicKey(e);return{privateKey:xee(e,t),publicKey:t}}();return new Zee(e,t)}async function qee(e){const{privateKey:t,publicKey:n}=function(e){if(e.length!==Ree)throw new TypeError('"seed" must be 32 bytes in length.');if(!(e instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const t=e,n=ql.getPublicKey(t);return{privateKey:xee(t,n),publicKey:n}}(e);return new Zee(t,n)}function Gee(e,t){var n;if((e=Uint8Array.from(null!==(n=e)&&void 0!==n?n:[])).length!==t)throw new fu.sv("Key must be a Uint8Array of length ".concat(t,", got ").concat(e.length),"ERR_INVALID_KEY_TYPE");return e}const Wee={"P-256":256,"P-384":384,"P-521":521};Object.keys(Wee).join(" / ");function Qee(e,t){return t.map((t=>Iee(e[t])))}async function Yee(e){const t=[await L9.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await Xee(e)],n=await Jee({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function Jee(e){if(null==e.privateKey||null==e.publicKey)throw new fu.sv("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([L9.get().subtle.exportKey("jwk",e.privateKey),L9.get().subtle.exportKey("jwk",e.publicKey)])}async function Xee(e){return L9.get().subtle.importKey("jwk",{kty:e.kty,n:e.n,e:e.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function $ee(e,t,n,r){const i=t?function(e){return gu().pki.setRsaPublicKey(...Qee(e,["n","e"]))}(e):function(e){return gu().pki.setRsaPrivateKey(...Qee(e,["n","e","d","p","q","dp","dq","qi"]))}(e),o=r((0,Au.B)(n instanceof Uint8Array?n:n.subarray(),"ascii"),i);return(0,yu.m)(o,"ascii")}function ete(e){if("RSA"!==e.kty)throw new fu.sv("invalid key type","ERR_INVALID_KEY_TYPE");if(null==e.n)throw new fu.sv("invalid key modulus","ERR_INVALID_KEY_MODULUS");return 8*(0,yu.m)(e.n,"base64url").length}const tte=8192;class nte{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=e}verify(e,t){return async function(e,t,n){const r=await L9.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return L9.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,t,n instanceof Uint8Array?n:n.subarray())}(this._key,t,e)}marshal(){return function(e){if(null==e.n||null==e.e)throw new fu.sv("JWK was missing components","ERR_INVALID_PARAMETERS");const t=gu().pki.publicKeyToAsn1({n:Iee(e.n),e:Iee(e.e)});return(0,yu.m)(gu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return Fee.encode({Type:Mee.RSA,Data:this.marshal()}).subarray()}encrypt(e){return $ee(this._key,!0,e,((e,t)=>t.encrypt(e)))}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=Aee.digest(this.bytes);return Cee(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}}class rte{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=t}genSecret(){return function(e){if(isNaN(e)||e<=0)throw new fu.sv("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return _c(e)}(16)}sign(e){return async function(e,t){const n=await L9.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await L9.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,t instanceof Uint8Array?t:t.subarray());return new Uint8Array(r,0,r.byteLength)}(this._key,e)}get public(){if(null==this._publicKey)throw new fu.sv("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new nte(this._publicKey)}decrypt(e){return $ee(this._key,!1,e,((e,t)=>t.decrypt(e)))}marshal(){return function(e){if(null==e.n||null==e.e||null==e.d||null==e.p||null==e.q||null==e.dp||null==e.dq||null==e.qi)throw new fu.sv("JWK was missing components","ERR_INVALID_PARAMETERS");const t=gu().pki.privateKeyToAsn1({n:Iee(e.n),e:Iee(e.e),d:Iee(e.d),p:Iee(e.p),q:Iee(e.q),dP:Iee(e.dp),dQ:Iee(e.dq),qInv:Iee(e.qi)});return(0,yu.m)(gu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return Kee.encode({Type:Mee.RSA,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=Aee.digest(this.bytes);return Cee(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}async id(){const e=await this.public.hash();return(0,Au.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"pkcs-8";if("pkcs-8"===t){const t=new(gu().util.ByteBuffer)(this.marshal()),n=gu().asn1.fromDer(t),r=gu().pki.privateKeyFromAsn1(n),i={algorithm:"aes256",count:1e4,saltSize:16,prfAlgorithm:"sha512"};return gu().pki.encryptRsaPrivateKey(r,e,i)}if("libp2p-key"===t)return Lee(this.bytes,e);throw new fu.sv("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}async function ite(e){const t=function(e){const t=gu().asn1.fromDer((0,Au.B)(e,"ascii")),n=gu().pki.privateKeyFromAsn1(t);return{kty:"RSA",n:_ee(n.n),e:_ee(n.e),d:_ee(n.d),p:_ee(n.p),q:_ee(n.q),dp:_ee(n.dP),dq:_ee(n.dQ),qi:_ee(n.qInv),alg:"RS256"}}(e);if(ete(t)>tte)throw new fu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const n=await Yee(t);return new rte(n.privateKey,n.publicKey)}function ote(e){const t=function(e){const t=gu().asn1.fromDer((0,Au.B)(e,"ascii")),n=gu().pki.publicKeyFromAsn1(t);return{kty:"RSA",n:_ee(n.n),e:_ee(n.e)}}(e);if(ete(t)>tte)throw new fu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new nte(t)}async function ste(e){if(ete(e)>tte)throw new fu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await Yee(e);return new rte(t.privateKey,t.publicKey)}async function ate(e){if(e>tte)throw new fu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await async function(e){const t=await L9.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:e,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await Jee(t);return{privateKey:n[0],publicKey:n[1]}}(e);return new rte(t.privateKey,t.publicKey)}function cte(e){try{Eh.ProjectivePoint.fromHex(e)}catch(t){throw new fu.sv(String(t),"ERR_INVALID_PUBLIC_KEY")}}class lte{constructor(e){(0,Yo.Z)(this,"_key",void 0),cte(e),this._key=e}verify(e,t){return function(e,t,n){const r=Aee.digest(n instanceof Uint8Array?n:n.subarray());if(Cee(r))return r.then((n=>{let{digest:r}=n;return Eh.verify(t,r,e)})).catch((e=>{throw new fu.sv(String(e),"ERR_INVALID_INPUT")}));try{return Eh.verify(t,r.digest,e)}catch(i){throw new fu.sv(String(i),"ERR_INVALID_INPUT")}}(this._key,t,e)}marshal(){return e=this._key,Eh.ProjectivePoint.fromHex(e).toRawBytes(!0);var e}get bytes(){return Fee.encode({Type:Mee.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const e=Aee.digest(this.bytes);let t;return Cee(e)?({bytes:t}=await e):t=e.bytes,t}}class ute{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=null!==t&&void 0!==t?t:function(e){try{return Eh.getPublicKey(e,!0)}catch(t){throw new fu.sv(String(t),"ERR_INVALID_PRIVATE_KEY")}}(e),function(e){try{Eh.getPublicKey(e,!0)}catch(t){throw new fu.sv(String(t),"ERR_INVALID_PRIVATE_KEY")}}(this._key),cte(this._publicKey)}sign(e){return function(e,t){const n=Aee.digest(t instanceof Uint8Array?t:t.subarray());if(Cee(n))return n.then((t=>{let{digest:n}=t;return Eh.sign(n,e).toDERRawBytes()})).catch((e=>{throw new fu.sv(String(e),"ERR_INVALID_INPUT")}));try{return Eh.sign(n.digest,e).toDERRawBytes()}catch(r){throw new fu.sv(String(r),"ERR_INVALID_INPUT")}}(this._key,e)}get public(){return new lte(this._publicKey)}marshal(){return this._key}get bytes(){return Kee.encode({Type:Mee.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=Aee.digest(this.bytes);return Cee(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}async id(){const e=await this.public.hash();return(0,Au.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return Lee(this.bytes,e);throw new fu.sv("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function hte(e){return new ute(e)}function dte(e){return new lte(e)}async function fte(){const e=Eh.utils.randomPrivateKey();return new ute(e)}const pte=q9({prefix:"9",name:"base10",alphabet:"0123456789"}),gte=G9({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),yte=G9({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),mte=G9({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),vte=Array.from("\ud83d\ude80\ud83e\ude90\u2604\ud83d\udef0\ud83c\udf0c\ud83c\udf11\ud83c\udf12\ud83c\udf13\ud83c\udf14\ud83c\udf15\ud83c\udf16\ud83c\udf17\ud83c\udf18\ud83c\udf0d\ud83c\udf0f\ud83c\udf0e\ud83d\udc09\u2600\ud83d\udcbb\ud83d\udda5\ud83d\udcbe\ud83d\udcbf\ud83d\ude02\u2764\ud83d\ude0d\ud83e\udd23\ud83d\ude0a\ud83d\ude4f\ud83d\udc95\ud83d\ude2d\ud83d\ude18\ud83d\udc4d\ud83d\ude05\ud83d\udc4f\ud83d\ude01\ud83d\udd25\ud83e\udd70\ud83d\udc94\ud83d\udc96\ud83d\udc99\ud83d\ude22\ud83e\udd14\ud83d\ude06\ud83d\ude44\ud83d\udcaa\ud83d\ude09\u263a\ud83d\udc4c\ud83e\udd17\ud83d\udc9c\ud83d\ude14\ud83d\ude0e\ud83d\ude07\ud83c\udf39\ud83e\udd26\ud83c\udf89\ud83d\udc9e\u270c\u2728\ud83e\udd37\ud83d\ude31\ud83d\ude0c\ud83c\udf38\ud83d\ude4c\ud83d\ude0b\ud83d\udc97\ud83d\udc9a\ud83d\ude0f\ud83d\udc9b\ud83d\ude42\ud83d\udc93\ud83e\udd29\ud83d\ude04\ud83d\ude00\ud83d\udda4\ud83d\ude03\ud83d\udcaf\ud83d\ude48\ud83d\udc47\ud83c\udfb6\ud83d\ude12\ud83e\udd2d\u2763\ud83d\ude1c\ud83d\udc8b\ud83d\udc40\ud83d\ude2a\ud83d\ude11\ud83d\udca5\ud83d\ude4b\ud83d\ude1e\ud83d\ude29\ud83d\ude21\ud83e\udd2a\ud83d\udc4a\ud83e\udd73\ud83d\ude25\ud83e\udd24\ud83d\udc49\ud83d\udc83\ud83d\ude33\u270b\ud83d\ude1a\ud83d\ude1d\ud83d\ude34\ud83c\udf1f\ud83d\ude2c\ud83d\ude43\ud83c\udf40\ud83c\udf37\ud83d\ude3b\ud83d\ude13\u2b50\u2705\ud83e\udd7a\ud83c\udf08\ud83d\ude08\ud83e\udd18\ud83d\udca6\u2714\ud83d\ude23\ud83c\udfc3\ud83d\udc90\u2639\ud83c\udf8a\ud83d\udc98\ud83d\ude20\u261d\ud83d\ude15\ud83c\udf3a\ud83c\udf82\ud83c\udf3b\ud83d\ude10\ud83d\udd95\ud83d\udc9d\ud83d\ude4a\ud83d\ude39\ud83d\udde3\ud83d\udcab\ud83d\udc80\ud83d\udc51\ud83c\udfb5\ud83e\udd1e\ud83d\ude1b\ud83d\udd34\ud83d\ude24\ud83c\udf3c\ud83d\ude2b\u26bd\ud83e\udd19\u2615\ud83c\udfc6\ud83e\udd2b\ud83d\udc48\ud83d\ude2e\ud83d\ude46\ud83c\udf7b\ud83c\udf43\ud83d\udc36\ud83d\udc81\ud83d\ude32\ud83c\udf3f\ud83e\udde1\ud83c\udf81\u26a1\ud83c\udf1e\ud83c\udf88\u274c\u270a\ud83d\udc4b\ud83d\ude30\ud83e\udd28\ud83d\ude36\ud83e\udd1d\ud83d\udeb6\ud83d\udcb0\ud83c\udf53\ud83d\udca2\ud83e\udd1f\ud83d\ude41\ud83d\udea8\ud83d\udca8\ud83e\udd2c\u2708\ud83c\udf80\ud83c\udf7a\ud83e\udd13\ud83d\ude19\ud83d\udc9f\ud83c\udf31\ud83d\ude16\ud83d\udc76\ud83e\udd74\u25b6\u27a1\u2753\ud83d\udc8e\ud83d\udcb8\u2b07\ud83d\ude28\ud83c\udf1a\ud83e\udd8b\ud83d\ude37\ud83d\udd7a\u26a0\ud83d\ude45\ud83d\ude1f\ud83d\ude35\ud83d\udc4e\ud83e\udd32\ud83e\udd20\ud83e\udd27\ud83d\udccc\ud83d\udd35\ud83d\udc85\ud83e\uddd0\ud83d\udc3e\ud83c\udf52\ud83d\ude17\ud83e\udd11\ud83c\udf0a\ud83e\udd2f\ud83d\udc37\u260e\ud83d\udca7\ud83d\ude2f\ud83d\udc86\ud83d\udc46\ud83c\udfa4\ud83d\ude47\ud83c\udf51\u2744\ud83c\udf34\ud83d\udca3\ud83d\udc38\ud83d\udc8c\ud83d\udccd\ud83e\udd40\ud83e\udd22\ud83d\udc45\ud83d\udca1\ud83d\udca9\ud83d\udc50\ud83d\udcf8\ud83d\udc7b\ud83e\udd10\ud83e\udd2e\ud83c\udfbc\ud83e\udd75\ud83d\udea9\ud83c\udf4e\ud83c\udf4a\ud83d\udc7c\ud83d\udc8d\ud83d\udce3\ud83e\udd42"),bte=vte.reduce(((e,t,n)=>(e[n]=t,e)),[]),wte=vte.reduce(((e,t,n)=>(e[t.codePointAt(0)]=n,e)),[]);const Ete=H9({prefix:"\ud83d\ude80",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+=bte[t]),"")},decode:function(e){const t=[];for(const n of e){const e=wte[n.codePointAt(0)];if(void 0===e)throw new Error("Non-base256emoji character: ".concat(n));t.push(e)}return new Uint8Array(t)}}),Ate=G9({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),Ste=G9({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),_te=G9({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Ite=G9({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Cte=G9({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Tte=G9({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),kte=G9({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Rte=G9({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),xte=G9({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),Pte=q9({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Dte=q9({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Ote=G9({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Nte=H9({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),Bte=new TextEncoder,Lte=new TextDecoder,Mte="json",Ute=512,Fte=e=>Bte.encode(JSON.stringify(e)),Kte=e=>JSON.parse(Lte.decode(e)),jte="raw",Zte=85,zte=e=>F9(e),Vte=e=>F9(e);new WeakMap;Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom");Symbol.for("@ipld/js-cid/CID");const Hte={...fr,...cr,...dr,...sr,...ar,...ur,...hr,...$n,...nr,...lr},qte=Symbol.for("nodejs.util.inspect.custom");Object.values(Hte).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),Hte.identity.decoder);Symbol.toStringTag;function Gte(e){if("signed"!==e.type)throw new Error("expected signed message type");if(null==e.sequenceNumber)throw Error("missing seqno field");return((e,t)=>{const n=(0,yu.m)(t.toString(16).padStart(16,"0"),"base16"),r=new Uint8Array(e.length+n.length);return r.set(e,0),r.set(n,e.length),r})(e.from.toBytes(),e.sequenceNumber)}async function Wte(e){return e8.encode(e.data)}var Qte,Yte=n(37318);!function(e){e[e.ip4=4]="ip4",e[e.ip6=41]="ip6"}(Qte||(Qte={}));class Jte{constructor(e){(0,Yo.Z)(this,"entries",new Map),(0,Yo.Z)(this,"validityMs",void 0),this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){return!!this.entries.has(e)||(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){const e=Date.now();for(const[t,n]of this.entries.entries()){if(!(n.validUntilMs<e))break;this.entries.delete(t)}}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return null!=t&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}}var Xte,$te,ene;!function(e){e[e.started=0]="started",e[e.stopped=1]="stopped"}(Xte||(Xte={}));class tne extends b4{constructor(e){var t,n,r,i,o;let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),(0,Yo.Z)(this,"globalSignaturePolicy",void 0),(0,Yo.Z)(this,"multicodecs",[F8,U8]),(0,Yo.Z)(this,"publishConfig",void 0),(0,Yo.Z)(this,"dataTransform",void 0),(0,Yo.Z)(this,"peers",new Set),(0,Yo.Z)(this,"streamsInbound",new Map),(0,Yo.Z)(this,"streamsOutbound",new Map),(0,Yo.Z)(this,"outboundInflightQueue",k8({objectMode:!0})),(0,Yo.Z)(this,"direct",new Set),(0,Yo.Z)(this,"floodsubPeers",new Set),(0,Yo.Z)(this,"seenCache",void 0),(0,Yo.Z)(this,"acceptFromWhitelist",new Map),(0,Yo.Z)(this,"topics",new Map),(0,Yo.Z)(this,"subscriptions",new Set),(0,Yo.Z)(this,"mesh",new Map),(0,Yo.Z)(this,"fanout",new Map),(0,Yo.Z)(this,"fanoutLastpub",new Map),(0,Yo.Z)(this,"gossip",new Map),(0,Yo.Z)(this,"control",new Map),(0,Yo.Z)(this,"peerhave",new Map),(0,Yo.Z)(this,"iasked",new Map),(0,Yo.Z)(this,"backoff",new Map),(0,Yo.Z)(this,"outbound",new Map),(0,Yo.Z)(this,"msgIdFn",void 0),(0,Yo.Z)(this,"fastMsgIdFn",void 0),(0,Yo.Z)(this,"msgIdToStrFn",void 0),(0,Yo.Z)(this,"fastMsgIdCache",void 0),(0,Yo.Z)(this,"publishedMessageIds",void 0),(0,Yo.Z)(this,"mcache",void 0),(0,Yo.Z)(this,"score",void 0),(0,Yo.Z)(this,"topicValidators",new Map),(0,Yo.Z)(this,"log",void 0),(0,Yo.Z)(this,"heartbeatTicks",0),(0,Yo.Z)(this,"gossipTracer",void 0),(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"directPeerInitial",null),(0,Yo.Z)(this,"opts",void 0),(0,Yo.Z)(this,"decodeRpcLimits",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"status",{code:Xte.stopped}),(0,Yo.Z)(this,"maxInboundStreams",void 0),(0,Yo.Z)(this,"maxOutboundStreams",void 0),(0,Yo.Z)(this,"allowedTopics",void 0),(0,Yo.Z)(this,"heartbeatTimer",null),(0,Yo.Z)(this,"runHeartbeat",(()=>{var e;const t=null===(e=this.metrics)||void 0===e?void 0:e.heartbeatDuration.startTimer();this.heartbeat().catch((e=>{this.log("Error running heartbeat",e)})).finally((()=>{if(null!=t&&t(),this.status.code===Xte.started){clearTimeout(this.status.heartbeatTimeout);let t=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;var e;if(t<.25*this.opts.heartbeatInterval)t+=this.opts.heartbeatInterval,null===(e=this.metrics)||void 0===e||e.heartbeatSkipped.inc();this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,t)}}))}));const a={fallbackToFloodsub:!0,floodPublish:!0,doPX:!1,directPeers:[],D:6,Dlo:4,Dhi:12,Dscore:4,Dout:2,Dlazy:6,heartbeatInterval:1e3,fanoutTTL:6e4,mcacheLength:5,mcacheGossip:3,seenTTL:12e4,gossipsubIWantFollowupMs:3e3,prunePeers:16,pruneBackoff:6e4,unsubcribeBackoff:1e4,graftFloodThreshold:1e4,opportunisticGraftPeers:2,opportunisticGraftTicks:60,directConnectTicks:300,...s,scoreParams:m7(s.scoreParams),scoreThresholds:w7(s.scoreThresholds)};if(this.components=e,this.decodeRpcLimits=null!==(t=a.decodeRpcLimits)&&void 0!==t?t:z8,this.globalSignaturePolicy=null!==(n=a.globalSignaturePolicy)&&void 0!==n?n:A4,a.fallbackToFloodsub&&this.multicodecs.push(M8),this.log=J4(null!==(r=a.debugName)&&void 0!==r?r:"libp2p:gossipsub"),this.opts=a,this.direct=new Set(a.directPeers.map((e=>e.id.toString()))),this.seenCache=new Jte({validityMs:a.seenTTL}),this.publishedMessageIds=new Jte({validityMs:a.seenTTL}),null!=s.msgIdFn)this.msgIdFn=s.msgIdFn;else switch(this.globalSignaturePolicy){case A4:this.msgIdFn=Gte;break;case S4:this.msgIdFn=Wte;break;default:throw new Error("Invalid globalSignaturePolicy: ".concat(this.globalSignaturePolicy))}if(null!=s.fastMsgIdFn&&(this.fastMsgIdFn=s.fastMsgIdFn,this.fastMsgIdCache=new Jte({validityMs:a.seenTTL})),this.msgIdToStrFn=null!==(i=s.msgIdToStrFn)&&void 0!==i?i:B9,this.mcache=null!==(o=s.messageCache)&&void 0!==o?o:new t7(a.mcacheGossip,a.mcacheLength,this.msgIdToStrFn),null!=s.dataTransform&&(this.dataTransform=s.dataTransform),null!=s.metricsRegister){if(null==s.metricsTopicStrToLabel)throw Error("Must set metricsTopicStrToLabel with metrics");const e=Math.max(...Object.values(a.scoreParams.topics).map((e=>e.meshMessageDeliveriesWindow)),1e3),t=function(e,t,n){return{protocolsEnabled:e.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:e.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:e.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:e.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEventsFanout:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_fanout_total",help:"Number of times we include peers in a topic mesh for fanout reasons",labelNames:["topic"]}),meshPeerInclusionEventsRandom:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_random_total",help:"Number of times we include peers in a topic mesh for random reasons",labelNames:["topic"]}),meshPeerInclusionEventsSubscribed:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_subscribed_total",help:"Number of times we include peers in a topic mesh for subscribed reasons",labelNames:["topic"]}),meshPeerInclusionEventsOutbound:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_outbound_total",help:"Number of times we include peers in a topic mesh for outbound reasons",labelNames:["topic"]}),meshPeerInclusionEventsNotEnough:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_not_enough_total",help:"Number of times we include peers in a topic mesh for not_enough reasons",labelNames:["topic"]}),meshPeerInclusionEventsOpportunistic:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_opportunistic_total",help:"Number of times we include peers in a topic mesh for opportunistic reasons",labelNames:["topic"]}),meshPeerInclusionEventsUnknown:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_unknown_total",help:"Number of times we include peers in a topic mesh for unknown reasons",labelNames:["topic"]}),meshPeerChurnEventsDisconnected:e.gauge({name:"gossipsub_peer_churn_events_disconnected_total",help:"Number of times we remove peers in a topic mesh for disconnected reasons",labelNames:["topic"]}),meshPeerChurnEventsBadScore:e.gauge({name:"gossipsub_peer_churn_events_bad_score_total",help:"Number of times we remove peers in a topic mesh for bad_score reasons",labelNames:["topic"]}),meshPeerChurnEventsPrune:e.gauge({name:"gossipsub_peer_churn_events_prune_total",help:"Number of times we remove peers in a topic mesh for prune reasons",labelNames:["topic"]}),meshPeerChurnEventsExcess:e.gauge({name:"gossipsub_peer_churn_events_excess_total",help:"Number of times we remove peers in a topic mesh for excess reasons",labelNames:["topic"]}),meshPeerChurnEventsUnknown:e.gauge({name:"gossipsub_peer_churn_events_unknown_total",help:"Number of times we remove peers in a topic mesh for unknown reasons",labelNames:["topic"]}),peersPerProtocol:e.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:e.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:e.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),acceptedMessagesTotal:e.gauge({name:"gossipsub_accepted_messages_total",help:"Total accepted messages for each topic",labelNames:["topic"]}),ignoredMessagesTotal:e.gauge({name:"gossipsub_ignored_messages_total",help:"Total ignored messages for each topic",labelNames:["topic"]}),rejectedMessagesTotal:e.gauge({name:"gossipsub_rejected_messages_total",help:"Total rejected messages for each topic",labelNames:["topic"]}),unknownValidationResultsTotal:e.gauge({name:"gossipsub_unknown_validation_results_total",help:"Total unknown validation results for each topic",labelNames:["topic"]}),asyncValidationMcacheHit:e.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),asyncValidationDelayFromFirstSeenSec:e.histogram({name:"gossipsub_async_validation_delay_from_first_seen",help:"Async validation report delay from first seen in second",labelNames:["topic"],buckets:[.01,.03,.1,.3,1,3,10]}),asyncValidationUnknownFirstSeen:e.gauge({name:"gossipsub_async_validation_unknown_first_seen_count_total",help:"Async validation report unknown first seen value for message"}),peerReadStreamError:e.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:e.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:e.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:e.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:e.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:e.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:e.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:e.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:e.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:e.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:e.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:e.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:e.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:e.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:e.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:e.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:e.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:e.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:e.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:e.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:e.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:e.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),msgPublishCount:e.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeersByTopic:e.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),directPeersPublishedTotal:e.gauge({name:"gossipsub_direct_peers_published_total",help:"Total direct peers that we publish a msg to",labelNames:["topic"]}),floodsubPeersPublishedTotal:e.gauge({name:"gossipsub_floodsub_peers_published_total",help:"Total floodsub peers that we publish a msg to",labelNames:["topic"]}),meshPeersPublishedTotal:e.gauge({name:"gossipsub_mesh_peers_published_total",help:"Total mesh peers that we publish a msg to",labelNames:["topic"]}),fanoutPeersPublishedTotal:e.gauge({name:"gossipsub_fanout_peers_published_total",help:"Total fanout peers that we publish a msg to",labelNames:["topic"]}),msgPublishBytes:e.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgPublishTime:e.histogram({name:"gossipsub_msg_publish_seconds",help:"Total time in seconds to publish a message",buckets:[.001,.002,.005,.01,.1,.5,1],labelNames:["topic"]}),msgForwardCount:e.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:e.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:e.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:e.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),prevalidationInvalidTotal:e.gauge({name:"gossipsub_pre_validation_invalid_total",help:"Total count of invalid messages received",labelNames:["topic"]}),prevalidationValidTotal:e.gauge({name:"gossipsub_pre_validation_valid_total",help:"Total count of valid messages received",labelNames:["topic"]}),prevalidationDuplicateTotal:e.gauge({name:"gossipsub_pre_validation_duplicate_total",help:"Total count of duplicate messages received",labelNames:["topic"]}),prevalidationUnknownTotal:e.gauge({name:"gossipsub_pre_validation_unknown_status_total",help:"Total count of unknown_status messages received",labelNames:["topic"]}),msgReceivedInvalid:e.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["error"]}),msgReceivedInvalidByTopic:e.gauge({name:"gossipsub_msg_received_invalid_by_topic_total",help:"Tracks specific invalid message by topic",labelNames:["topic"]}),duplicateMsgDeliveryDelay:e.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*n.maxMeshMessageDeliveriesWindowSec,.5*n.maxMeshMessageDeliveriesWindowSec,Number(n.maxMeshMessageDeliveriesWindowSec),2*n.maxMeshMessageDeliveriesWindowSec,4*n.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:e.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:e.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:e.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:e.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:e.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:e.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:e.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores"}),scoreWeights:e.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:e.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:e.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:e.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*n.behaviourPenaltyThreshold,.5*n.behaviourPenaltyThreshold,Number(n.behaviourPenaltyThreshold),2*n.behaviourPenaltyThreshold,4*n.behaviourPenaltyThreshold]}),ihaveRcvIgnored:e.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:e.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:e.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:e.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:e.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),iwantPromiseStarted:e.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:e.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:e.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:e.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:e.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:e.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:e.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*n.gossipPromiseExpireSec,Number(n.gossipPromiseExpireSec),2*n.gossipPromiseExpireSec,4*n.gossipPromiseExpireSec]}),iwantPromiseUntracked:e.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),connectedPeersBackoffSec:e.histogram({name:"gossipsub_connected_peers_backoff_seconds",help:"Backoff time in seconds",buckets:[1,2,4,10,20,60,120]}),cacheSize:e.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:e.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:e.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:e.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:e.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:t,toTopic(e){var t;return null!==(t=this.topicStrToLabel.get(e))&&void 0!==t?t:e},onJoin(e){this.topicSubscriptionStatus.set({topicStr:e},1),this.meshPeerCounts.set({topicStr:e},0)},onLeave(e){this.topicSubscriptionStatus.set({topicStr:e},0),this.meshPeerCounts.set({topicStr:e},0)},onAddToMesh(e,t,n){const r=this.toTopic(e);switch(t){case c7.Fanout:this.meshPeerInclusionEventsFanout.inc({topic:r},n);break;case c7.Random:this.meshPeerInclusionEventsRandom.inc({topic:r},n);break;case c7.Subscribed:this.meshPeerInclusionEventsSubscribed.inc({topic:r},n);break;case c7.Outbound:this.meshPeerInclusionEventsOutbound.inc({topic:r},n);break;case c7.NotEnough:this.meshPeerInclusionEventsNotEnough.inc({topic:r},n);break;case c7.Opportunistic:this.meshPeerInclusionEventsOpportunistic.inc({topic:r},n);break;default:this.meshPeerInclusionEventsUnknown.inc({topic:r},n)}},onRemoveFromMesh(e,t,n){const r=this.toTopic(e);switch(t){case l7.Dc:this.meshPeerChurnEventsDisconnected.inc({topic:r},n);break;case l7.BadScore:this.meshPeerChurnEventsBadScore.inc({topic:r},n);break;case l7.Prune:this.meshPeerChurnEventsPrune.inc({topic:r},n);break;case l7.Excess:this.meshPeerChurnEventsExcess.inc({topic:r},n);break;default:this.meshPeerChurnEventsUnknown.inc({topic:r},n)}},onReportValidation(e,t,n){if(this.asyncValidationMcacheHit.inc({hit:null!=e?"hit":"miss"}),null!=e){const n=this.toTopic(e.message.topic);switch(t){case _4.Accept:this.acceptedMessagesTotal.inc({topic:n});break;case _4.Ignore:this.ignoredMessagesTotal.inc({topic:n});break;case _4.Reject:this.rejectedMessagesTotal.inc({topic:n});break;default:this.unknownValidationResultsTotal.inc({topic:n})}}null!=n?this.asyncValidationDelayFromFirstSeenSec.observe((Date.now()-n)/1e3):this.asyncValidationUnknownFirstSeen.inc()},onScorePenalty(e){this.scoringPenalties.inc({penalty:e},1)},onIhaveRcv(e,t,n){const r=this.toTopic(e);this.ihaveRcvMsgids.inc({topic:r},t),this.ihaveRcvNotSeenMsgids.inc({topic:r},n)},onIwantRcv(e,t){for(const[n,r]of e){const e=this.toTopic(n);this.iwantRcvMsgids.inc({topic:e},r)}this.iwantRcvDonthaveMsgids.inc(t)},onForwardMsg(e,t){const n=this.toTopic(e);this.msgForwardCount.inc({topic:n},1),this.msgForwardPeers.inc({topic:n},t)},onPublishMsg(e,t,n,r,i){const o=this.toTopic(e);this.msgPublishCount.inc({topic:o},1),this.msgPublishBytes.inc({topic:o},n*r),this.msgPublishPeersByTopic.inc({topic:o},n),this.directPeersPublishedTotal.inc({topic:o},t.direct),this.floodsubPeersPublishedTotal.inc({topic:o},t.floodsub),this.meshPeersPublishedTotal.inc({topic:o},t.mesh),this.fanoutPeersPublishedTotal.inc({topic:o},t.fanout),this.msgPublishTime.observe({topic:o},i/1e3)},onMsgRecvPreValidation(e){const t=this.toTopic(e);this.msgReceivedPreValidation.inc({topic:t},1)},onMsgRecvError(e){const t=this.toTopic(e);this.msgReceivedError.inc({topic:t},1)},onPrevalidationResult(e,t){const n=this.toTopic(e);switch(t){case s7.duplicate:this.prevalidationDuplicateTotal.inc({topic:n});break;case s7.invalid:this.prevalidationInvalidTotal.inc({topic:n});break;case s7.valid:this.prevalidationValidTotal.inc({topic:n});break;default:this.prevalidationUnknownTotal.inc({topic:n})}},onMsgRecvInvalid(e,t){const n=this.toTopic(e),r=t.reason===i7.Error?t.error:t.reason;this.msgReceivedInvalid.inc({error:r},1),this.msgReceivedInvalidByTopic.inc({topic:n},1)},onDuplicateMsgDelivery(e,t,n){if(this.duplicateMsgDeliveryDelay.observe(t/1e3),n){const t=this.toTopic(e);this.duplicateMsgLateDelivery.inc({topic:t},1)}},onPublishDuplicateMsg(e){const t=this.toTopic(e);this.duplicateMsgIgnored.inc({topic:t},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(e,t){this.rpcRecvBytes.inc(t),this.rpcRecvCount.inc(1),null!=e.subscriptions&&this.rpcRecvSubscription.inc(e.subscriptions.length),null!=e.messages&&this.rpcRecvMessage.inc(e.messages.length),null!=e.control&&(this.rpcRecvControl.inc(1),null!=e.control.ihave&&this.rpcRecvIHave.inc(e.control.ihave.length),null!=e.control.iwant&&this.rpcRecvIWant.inc(e.control.iwant.length),null!=e.control.graft&&this.rpcRecvGraft.inc(e.control.graft.length),null!=e.control.prune&&this.rpcRecvPrune.inc(e.control.prune.length))},onRpcSent(e,t){if(this.rpcSentBytes.inc(t),this.rpcSentCount.inc(1),null!=e.subscriptions&&this.rpcSentSubscription.inc(e.subscriptions.length),null!=e.messages&&this.rpcSentMessage.inc(e.messages.length),null!=e.control){var n,r,i,o,s,a,c,l;const t=null!==(n=null===(r=e.control.ihave)||void 0===r?void 0:r.length)&&void 0!==n?n:0,u=null!==(i=null===(o=e.control.iwant)||void 0===o?void 0:o.length)&&void 0!==i?i:0,h=null!==(s=null===(a=e.control.graft)||void 0===a?void 0:a.length)&&void 0!==s?s:0,d=null!==(c=null===(l=e.control.prune)||void 0===l?void 0:l.length)&&void 0!==c?c:0;t>0&&this.rpcSentIHave.inc(t),u>0&&this.rpcSentIWant.inc(u),h>0&&this.rpcSentGraft.inc(h),d>0&&this.rpcSentPrune.inc(d),(t>0||u>0||h>0||d>0)&&this.rpcSentControl.inc(1)}},registerScores(e,t){let n=0,r=0,i=0,o=0;for(const s of e)s>=t.graylistThreshold&&n++,s>=t.publishThreshold&&r++,s>=t.gossipThreshold&&i++,s>=0&&o++;this.peersByScoreThreshold.set({threshold:d7.graylist},n),this.peersByScoreThreshold.set({threshold:d7.publish},r),this.peersByScoreThreshold.set({threshold:d7.gossip},i),this.peersByScoreThreshold.set({threshold:d7.mesh},o),this.score.set(e)},registerScoreWeights(e){for(const[t,n]of e.byTopic)this.scoreWeights.set({topic:t,p:"p1"},n.p1w),this.scoreWeights.set({topic:t,p:"p2"},n.p2w),this.scoreWeights.set({topic:t,p:"p3"},n.p3w),this.scoreWeights.set({topic:t,p:"p3b"},n.p3bw),this.scoreWeights.set({topic:t,p:"p4"},n.p4w);this.scoreWeights.set({p:"p5"},e.p5w),this.scoreWeights.set({p:"p6"},e.p6w),this.scoreWeights.set({p:"p7"},e.p7w)},registerScorePerMesh(e,t){const n=new Map;e.forEach(((e,t)=>{var r;const i=null!==(r=this.topicStrToLabel.get(t))&&void 0!==r?r:"unknown";let o=n.get(i);null==o&&(o=new Set,n.set(i,o)),e.forEach((e=>{var t;return null===(t=o)||void 0===t?void 0:t.add(e)}))}));for(const[r,i]of n){const e=[];i.forEach((n=>{var r;e.push(null!==(r=t.get(n))&&void 0!==r?r:0)})),this.scorePerMesh.set({topic:r},e)}}}}(s.metricsRegister,s.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:a.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:e/1e3});t.mcacheSize.addCollect((()=>{this.onScrapeMetrics(t)}));for(const n of this.multicodecs)t.protocolsEnabled.set({protocol:n},1);this.metrics=t}else this.metrics=null;this.gossipTracer=new F7(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new R7(this.opts.scoreParams,this.metrics,{scoreCacheValidityMs:a.heartbeatInterval}),this.maxInboundStreams=s.maxInboundStreams,this.maxOutboundStreams=s.maxOutboundStreams,this.allowedTopics=null!=a.allowedTopics?new Set(a.allowedTopics):null}getPeers(){return[...this.peers.keys()].map((e=>S8(e)))}isStarted(){return this.status.code===Xte.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=await async function(e,t){switch(e){case A4:{if(null==t)throw Error("Must provide PeerId");if(null==t.privateKey)throw Error("Cannot sign message, no private key present");if(null==t.publicKey)throw Error("Cannot sign message, no public key present");const e=await D9(t.privateKey);return{type:r7.Signing,author:t,key:t.publicKey,privateKey:e}}case S4:return{type:r7.Anonymous};default:throw new Error('Unknown signature policy "'.concat(e,'"'))}}(this.globalSignaturePolicy,this.components.peerId),this.outboundInflightQueue=k8({objectMode:!0}),P8(this.outboundInflightQueue,(async e=>{for await(const{peerId:t,connection:n}of e)await this.createOutboundStream(t,n)})).catch((e=>{this.log.error("outbound inflight queue error",e)})),await Promise.all(this.opts.directPeers.map((async e=>{await this.components.peerStore.merge(e.id,{multiaddrs:e.addrs})})));const e=this.components.registrar;await Promise.all(this.multicodecs.map((async t=>e.handle(t,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))));const t={onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this)},n=await Promise.all(this.multicodecs.map((async n=>e.register(n,t)))),r=setTimeout(this.runHeartbeat,100);this.status={code:Xte.started,registrarTopologyIds:n,heartbeatTimeout:r,hearbeatStartMs:Date.now()+100},this.score.start(),this.directPeerInitial=setTimeout((()=>{Promise.resolve().then((async()=>{await Promise.all(Array.from(this.direct).map((async e=>this.connect(e))))})).catch((e=>{this.log(e)}))}),1e3),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==Xte.started)return;const{registrarTopologyIds:e}=this.status;this.status={code:Xte.stopped};const t=this.components.registrar;await Promise.all(this.multicodecs.map((async e=>t.unhandle(e)))),e.forEach((e=>{t.unregister(e)})),this.outboundInflightQueue.end();const n=[];for(const r of this.streamsOutbound.values())n.push(r.close());this.streamsOutbound.clear();for(const r of this.streamsInbound.values())n.push(r.close());this.streamsInbound.clear(),await Promise.all(n),this.peers.clear(),this.subscriptions.clear(),null!=this.heartbeatTimer&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),null!=this.fastMsgIdCache&&this.fastMsgIdCache.clear(),null!=this.directPeerInitial&&clearTimeout(this.directPeerInitial),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream(e){let{stream:t,connection:n}=e;if(!this.isStarted())return;const r=n.remotePeer;this.addPeer(r,n.direction,n.remoteAddr),this.createInboundStream(r,t),this.outboundInflightQueue.push({peerId:r,connection:n})}onPeerConnected(e,t){var n;null===(n=this.metrics)||void 0===n||n.newConnectionCount.inc({status:t.status}),this.isStarted()&&"open"===t.status&&(this.addPeer(e,t.direction,t.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:t}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(this.peers.has(n)&&!this.streamsOutbound.has(n))try{var r;const i=new M7(await t.newStream(this.multicodecs),(e=>{this.log.error("outbound pipe error",e)}),{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(n,i);const o=i.protocol;o===M8&&this.floodsubPeers.add(n),null===(r=this.metrics)||void 0===r||r.peersPerProtocol.inc({protocol:o},1),this.subscriptions.size>0&&(this.log("send subscriptions to",n),this.sendSubscriptions(n,Array.from(this.subscriptions),!0))}catch(i){this.log.error("createOutboundStream error",i)}}createInboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(!this.peers.has(n))return;const r=this.streamsInbound.get(n);void 0!==r&&(this.log("replacing existing inbound steam %s",n),r.close().catch((e=>{this.log.error(e)}))),this.log("create inbound stream %s",n);const i=new U7(t,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(n,i),this.pipePeerReadStream(e,i.source).catch((e=>{this.log(e)}))}addPeer(e,t,n){const r=e.toString();if(!this.peers.has(r)){this.log("new peer %p",e),this.peers.add(r),this.score.addPeer(r);const i=function(e){for(const t of e.tuples())switch(t[0]){case Qte.ip4:case Qte.ip6:return(0,Yte.xV)(t[0],t[1])}return null}(n);null!==i?this.score.addIP(r,i):this.log("Added peer has no IP in current address %s %s",r,n.toString()),this.outbound.has(r)||this.outbound.set(r,"outbound"===t)}}removePeer(e){const t=e.toString();if(!this.peers.has(t))return;this.log("delete peer %p",e),this.peers.delete(t);const n=this.streamsOutbound.get(t),r=this.streamsInbound.get(t);var i;null!=n&&(null===(i=this.metrics)||void 0===i||i.peersPerProtocol.inc({protocol:n.protocol},-1));null===n||void 0===n||n.close().catch((e=>{this.log.error(e)})),null===r||void 0===r||r.close().catch((e=>{this.log.error(e)})),this.streamsOutbound.delete(t),this.streamsInbound.delete(t);for(const s of this.topics.values())s.delete(t);for(const[s,a]of this.mesh){var o;if(a.delete(t))null===(o=this.metrics)||void 0===o||o.onRemoveFromMesh(s,l7.Dc,1)}for(const s of this.fanout.values())s.delete(t);this.floodsubPeers.delete(t),this.gossip.delete(t),this.control.delete(t),this.outbound.delete(t),this.score.removePeer(t),this.acceptFromWhitelist.delete(t)}get started(){return this.status.code===Xte.started}getMeshPeers(e){const t=this.mesh.get(e);return null!=t?Array.from(t):[]}getSubscribers(e){const t=this.topics.get(e);return(null!=t?Array.from(t):[]).map((e=>S8(e)))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,t){try{await P8(t,(async t=>{for await(const a of t)try{var n;const t=a.subarray(),i=V8(t,this.decodeRpcLimits);if(null===(n=this.metrics)||void 0===n||n.onRpcRecv(i,t.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(e,i)}catch(o){var r;null===(r=this.metrics)||void 0===r||r.onRpcRecvError(),this.log(o)}else this.handleReceivedRpc(e,i).catch((e=>{var t;null===(t=this.metrics)||void 0===t||t.onRpcRecvError(),this.log(e)}))}catch(s){var i;null===(i=this.metrics)||void 0===i||i.onRpcDataError(),this.log(s)}}))}catch(r){var n;null===(n=this.metrics)||void 0===n||n.onPeerReadStreamError(),this.handlePeerReadStreamError(r,e)}}handlePeerReadStreamError(e,t){this.log.error(e),this.onPeerDisconnected(t)}async handleReceivedRpc(e,t){var n;if(!this.acceptFrom(e.toString()))return this.log("received message from unacceptable peer %p",e),void(null===(n=this.metrics)||void 0===n||n.rpcRecvNotAccepted.inc());const r=null!=t.subscriptions?t.subscriptions.length:0,i=null!=t.messages?t.messages.length:0;let o=0,s=0,a=0,c=0;if(null!=t.control&&(null!=t.control.ihave&&(o=t.control.ihave.length),null!=t.control.iwant&&(s=t.control.iwant.length),null!=t.control.graft&&(a=t.control.graft.length),null!=t.control.prune&&(c=t.control.prune.length)),this.log("rpc.from ".concat(e.toString()," subscriptions ").concat(r," messages ").concat(i," ihave ").concat(o," iwant ").concat(s," graft ").concat(a," prune ").concat(c)),null!=t.subscriptions&&t.subscriptions.length>0){const n=[];t.subscriptions.forEach((t=>{const r=t.topic,i=!0===t.subscribe;if(null!=r){if(null!=this.allowedTopics&&!this.allowedTopics.has(r))return;this.handleReceivedSubscription(e,r,i),n.push({topic:r,subscribe:i})}})),this.safeDispatchEvent("subscription-change",{detail:{peerId:e,subscriptions:n}})}if(null!=t.messages)for(const l of t.messages){if(null!=this.allowedTopics&&!this.allowedTopics.has(l.topic))continue;const t=this.handleReceivedMessage(e,l).catch((e=>{var t;null===(t=this.metrics)||void 0===t||t.onMsgRecvError(l.topic),this.log(e)}));this.opts.awaitRpcMessageHandler&&await t}null!=t.control&&await this.handleControlMessage(e.toString(),t.control)}handleReceivedSubscription(e,t,n){this.log("subscription update from %p topic %s",e,t);let r=this.topics.get(t);null==r&&(r=new Set,this.topics.set(t,r)),n?r.add(e.toString()):r.delete(e.toString())}async handleReceivedMessage(e,t){var n,r,i;null===(n=this.metrics)||void 0===n||n.onMsgRecvPreValidation(t.topic);const o=await this.validateReceivedMessage(e,t);null===(r=this.metrics)||void 0===r||r.onPrevalidationResult(t.topic,o.code);const s=o.code;switch(s){case s7.duplicate:return this.score.duplicateMessage(e.toString(),o.msgIdStr,t.topic),this.gossipTracer.deliverMessage(o.msgIdStr,!0),void this.mcache.observeDuplicate(o.msgIdStr,e.toString());case s7.invalid:if(null!=o.msgIdStr){const n=o.msgIdStr;this.score.rejectMessage(e.toString(),n,t.topic,o.reason),this.gossipTracer.rejectMessage(n,o.reason)}else this.score.rejectInvalidMessage(e.toString(),t.topic);return void(null===(i=this.metrics)||void 0===i||i.onMsgRecvInvalid(t.topic,o));case s7.valid:if(this.score.validateMessage(o.messageId.msgIdStr),this.gossipTracer.deliverMessage(o.messageId.msgIdStr),this.mcache.put(o.messageId,t,!this.opts.asyncValidation),this.subscriptions.has(t.topic)){this.components.peerId.equals(e)&&!this.opts.emitSelf||(super.dispatchEvent(new E4("gossipsub:message",{detail:{propagationSource:e,msgId:o.messageId.msgIdStr,msg:o.msg}})),super.dispatchEvent(new E4("message",{detail:o.msg})))}this.opts.asyncValidation||this.forwardMessage(o.messageId.msgIdStr,t,e.toString());break;default:throw new Error("Invalid validation result: ".concat(s))}}async validateReceivedMessage(e,t){var n,r;const i=null===(n=this.fastMsgIdFn)||void 0===n?void 0:n.call(this,t),o=void 0!==i?null===(r=this.fastMsgIdCache)||void 0===r?void 0:r.get(i):void 0;if(null!=o)return{code:s7.duplicate,msgIdStr:o};const s=await async function(e,t){var n;switch(e){case S4:return null!=t.signature?{valid:!1,error:o7.SignaturePresent}:null!=t.seqno?{valid:!1,error:o7.SeqnoPresent}:null!=t.key?{valid:!1,error:o7.FromPresent}:{valid:!0,message:{type:"unsigned",topic:t.topic,data:null!==(n=t.data)&&void 0!==n?n:new Uint8Array(0)}};case A4:{var r,i;if(null==t.seqno)return{valid:!1,error:o7.InvalidSeqno};if(8!==t.seqno.length)return{valid:!1,error:o7.InvalidSeqno};if(null==t.signature)return{valid:!1,error:o7.InvalidSignature};if(null==t.from)return{valid:!1,error:o7.InvalidPeerId};let e,n;try{e=_8(t.from)}catch(o){return{valid:!1,error:o7.InvalidPeerId}}if(null!=t.key){if(n=x9(t.key),void 0!==e.publicKey&&!(0,Ms.f)(n.bytes,e.publicKey))return{valid:!1,error:o7.InvalidPeerId}}else{if(null==e.publicKey)return{valid:!1,error:o7.InvalidPeerId};n=x9(e.publicKey)}const s={from:t.from,data:t.data,seqno:t.seqno,topic:t.topic,signature:void 0,key:void 0},a=(0,Ls.z)([O9,e7.Message.encode(s).finish()]);return await n.verify(a,t.signature)?{valid:!0,message:{type:"signed",from:e,data:null!==(r=t.data)&&void 0!==r?r:new Uint8Array(0),sequenceNumber:BigInt("0x".concat((0,Au.B)(t.seqno,"base16"))),topic:t.topic,signature:t.signature,key:null!==(i=t.key)&&void 0!==i?i:P9(n)}}:{valid:!1,error:o7.InvalidSignature}}default:throw new Error("Unreachable")}}(this.globalSignaturePolicy,t);if(!s.valid)return{code:s7.invalid,reason:i7.Error,error:s.error};const a=s.message;try{null!=this.dataTransform&&(a.data=this.dataTransform.inboundTransform(t.topic,a.data))}catch(f){return this.log("Invalid message, transform failed",f),{code:s7.invalid,reason:i7.Error,error:o7.TransformFailed}}const c=await this.msgIdFn(a),l=this.msgIdToStrFn(c),u={msgId:c,msgIdStr:l};if(void 0!==i&&null!=this.fastMsgIdCache){var h;if(this.fastMsgIdCache.put(i,l))null===(h=this.metrics)||void 0===h||h.fastMsgIdCacheCollision.inc()}if(this.seenCache.has(l))return{code:s7.duplicate,msgIdStr:l};this.seenCache.put(l);const d=this.topicValidators.get(t.topic);if(null!=d){let t;try{t=await d(e,a)}catch(f){const e=f.code;"ERR_TOPIC_VALIDATOR_IGNORE"===e&&(t=_4.Ignore),t="ERR_TOPIC_VALIDATOR_REJECT"===e?_4.Reject:_4.Ignore}if(t!==_4.Accept)return{code:s7.invalid,reason:f7(t),msgIdStr:l}}return{code:s7.valid,messageId:u,msg:a}}getScore(e){return this.score.score(e)}sendSubscriptions(e,t,n){this.sendRpc(e,{subscriptions:t.map((e=>({topic:e,subscribe:n})))})}async handleControlMessage(e,t){var n;if(void 0===t)return;const r=null!=t.ihave?this.handleIHave(e,t.ihave):[],i=null!=t.iwant?this.handleIWant(e,t.iwant):[],o=null!=t.graft?await this.handleGraft(e,t.graft):[];if(null!=t.prune&&await this.handlePrune(e,t.prune),0===r.length&&0===i.length&&0===o.length)return;const s=this.sendRpc(e,{messages:i,control:{iwant:r,prune:o}}),a=null===(n=r[0])||void 0===n?void 0:n.messageIDs;var c;null!=a&&(s?this.gossipTracer.addPromise(e,a):null===(c=this.metrics)||void 0===c||c.iwantPromiseUntracked.inc(1))}acceptFrom(e){if(this.direct.has(e))return!0;const t=Date.now(),n=this.acceptFromWhitelist.get(e);if(null!=n&&n.messagesAccepted<128&&n.acceptUntil>=t)return n.messagesAccepted+=1,!0;const r=this.score.score(e);return r>=0?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:t+1e3}):this.acceptFromWhitelist.delete(e),r>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,t){var n,r;if(0===t.length)return[];const i=this.score.score(e);var o;if(i<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,i),null===(o=this.metrics)||void 0===o||o.ihaveRcvIgnored.inc({reason:h7.LowScore}),[];const s=(null!==(n=this.peerhave.get(e))&&void 0!==n?n:0)+1;var a;if(this.peerhave.set(e,s),s>10)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,s),null===(a=this.metrics)||void 0===a||a.ihaveRcvIgnored.inc({reason:h7.MaxIhave}),[];const c=null!==(r=this.iasked.get(e))&&void 0!==r?r:0;var l;if(c>=K8)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,c),null===(l=this.metrics)||void 0===l||l.ihaveRcvIgnored.inc({reason:h7.MaxIasked}),[];const u=new Map;if(t.forEach((e=>{var t;let{topicID:n,messageIDs:r}=e;if(null==n||null==r||!this.mesh.has(n))return;let i=0;r.forEach((e=>{const t=this.msgIdToStrFn(e);this.seenCache.has(t)||(u.set(t,e),i++)})),null===(t=this.metrics)||void 0===t||t.onIhaveRcv(n,r.length,i)})),0===u.size)return[];let h=u.size;h+c>K8&&(h=K8-c),this.log("IHAVE: Asking for %d out of %d messages from %s",h,u.size,e);let d=Array.from(u.values());return N9(d),d=d.slice(0,h),this.iasked.set(e,c+h),[{messageIDs:d}]}handleIWant(e,t){var n;if(0===t.length)return[];const r=this.score.score(e);if(r<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,r),[];const i=new Map,o=new Map;let s=0;return t.forEach((t=>{let{messageIDs:n}=t;null===n||void 0===n||n.forEach((t=>{var n;const r=this.msgIdToStrFn(t),a=this.mcache.getWithIWantCount(r,e);null!=a?(o.set(a.msg.topic,1+(null!==(n=o.get(a.msg.topic))&&void 0!==n?n:0)),a.count>3?this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,t):i.set(r,a.msg)):s++}))})),null===(n=this.metrics)||void 0===n||n.onIwantRcv(o,s),0===i.size?(this.log("IWANT: Could not provide any wanted messages to %s",e),[]):(this.log("IWANT: Sending %d messages to %s",i.size,e),Array.from(i.values()))}async handleGraft(e,t){const n=[],r=this.score.score(e),i=Date.now();let o=this.opts.doPX;if(t.forEach((t=>{var s,a,c;let{topicID:l}=t;if(null==l)return;const u=this.mesh.get(l);if(null==u)return void(o=!1);if(u.has(e))return;if(this.direct.has(e))return this.log("GRAFT: ignoring request from direct peer %s",e),n.push(l),void(o=!1);const h=null===(s=this.backoff.get(l))||void 0===s?void 0:s.get(e);if("number"===typeof h&&i<h){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,u7.GraftBackoff),o=!1;const t=h+this.opts.graftFloodThreshold-this.opts.pruneBackoff;return i<t&&this.score.addPenalty(e,1,u7.GraftBackoff),this.addBackoff(e,l),void n.push(l)}return r<0?(this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,r,l),n.push(l),o=!1,void this.addBackoff(e,l)):u.size>=this.opts.Dhi&&(null===(a=this.outbound.get(e))||void 0===a||!a)?(n.push(l),void this.addBackoff(e,l)):(this.log("GRAFT: Add mesh link from %s in %s",e,l),this.score.graft(e,l),u.add(e),void(null===(c=this.metrics)||void 0===c||c.onAddToMesh(l,c7.Subscribed,1)))})),0===n.length)return[];return Promise.all(n.map((async t=>this.makePrune(e,t,o,false))))}async handlePrune(e,t){const n=this.score.score(e);for(const{topicID:i,backoff:o,peers:s}of t){if(null==i)continue;const t=this.mesh.get(i);if(null==t)return;var r;if(this.log("PRUNE: Remove mesh link to %s in %s",e,i),this.score.prune(e,i),t.has(e))t.delete(e),null===(r=this.metrics)||void 0===r||r.onRemoveFromMesh(i,l7.Prune,1);if("number"===typeof o&&o>0?this.doAddBackoff(e,i,1e3*o):this.addBackoff(e,i),null!=s&&s.length>0){if(n<this.opts.scoreThresholds.acceptPXThreshold){this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,n,i);continue}await this.pxConnect(s)}}}addBackoff(e,t){this.doAddBackoff(e,t,this.opts.pruneBackoff)}doAddBackoff(e,t,n){var r;let i=this.backoff.get(t);null==i&&(i=new Map,this.backoff.set(t,i));const o=Date.now()+n;(null!==(r=i.get(e))&&void 0!==r?r:0)<o&&i.set(e,o)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach(((e,t)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",t,e),this.score.addPenalty(t,e,u7.BrokenPromise)}))}clearBackoff(){if(this.heartbeatTicks%15!==0)return;const e=Date.now();this.backoff.forEach(((t,n)=>{t.forEach(((n,r)=>{n+1*this.opts.heartbeatInterval<e&&t.delete(r)})),0===t.size&&this.backoff.delete(n)}))}async directConnect(){const e=[];this.direct.forEach((t=>{this.streamsOutbound.has(t)||e.push(t)})),await Promise.all(e.map((async e=>this.connect(e))))}async pxConnect(e){e.length>this.opts.prunePeers&&(N9(e),e=e.slice(0,this.opts.prunePeers));const t=[];await Promise.all(e.map((async e=>{if(null==e.peerID)return;const n=_8(e.peerID),r=n.toString();if(!this.peers.has(r))if(null!=e.signedPeerRecord)try{if(!await this.components.peerStore.consumePeerRecord(e.signedPeerRecord,n))return void this.log("bogus peer record obtained through px: could not add peer record to address book");t.push(r)}catch(i){this.log("bogus peer record obtained through px: invalid signature or not a peer record")}else t.push(r)}))),0!==t.length&&await Promise.all(t.map((async e=>this.connect(e))))}async connect(e){this.log("Initiating connection with %s",e);const t=S8(e),n=await this.components.connectionManager.openConnection(t);for(const i of this.multicodecs)for(const e of this.components.registrar.getTopologies(i)){var r;null===(r=e.onConnect)||void 0===r||r.call(e,t,n)}}subscribe(e){if(this.status.code!==Xte.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(const t of this.peers.keys())this.sendSubscriptions(t,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==Xte.started)throw new Error("Pubsub is not started");const t=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,t),t)for(const n of this.peers.keys())this.sendSubscriptions(n,[e],!1);this.leave(e)}join(e){var t;if(this.status.code!==Xte.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),null===(t=this.metrics)||void 0===t||t.onJoin(e);const n=new Set,r=this.backoff.get(e),i=this.fanout.get(e);var o;null!=i&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),i.forEach((e=>{this.direct.has(e)||!(this.score.score(e)>=0)||null!=r&&r.has(e)||n.add(e)})),null===(o=this.metrics)||void 0===o||o.onAddToMesh(e,c7.Fanout,n.size));if(n.size<this.opts.D){var s;const t=n.size;this.getRandomGossipPeers(e,this.opts.D,(e=>!n.has(e)&&!this.direct.has(e)&&this.score.score(e)>=0&&(null==r||!r.has(e)))).forEach((e=>{n.add(e)})),null===(s=this.metrics)||void 0===s||s.onAddToMesh(e,c7.Random,n.size-t)}this.mesh.set(e,n),n.forEach((t=>{this.log("JOIN: Add mesh link to %s in %s",t,e),this.sendGraft(t,e)}))}leave(e){var t;if(this.status.code!==Xte.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),null===(t=this.metrics)||void 0===t||t.onLeave(e);const n=this.mesh.get(e);null!=n&&(Promise.all(Array.from(n).map((async t=>{this.log("LEAVE: Remove mesh link to %s in %s",t,e),await this.sendPrune(t,e)}))).catch((e=>{this.log("Error sending prunes to mesh peers",e)})),this.mesh.delete(e))}selectPeersToForward(e,t,n){const r=new Set,i=this.topics.get(e);null!=i&&(this.direct.forEach((e=>{var o;!i.has(e)||t===e||null!==(o=null===n||void 0===n?void 0:n.has(e))&&void 0!==o&&o||r.add(e)})),this.floodsubPeers.forEach((e=>{var o;i.has(e)&&t!==e&&(null===(o=null===n||void 0===n?void 0:n.has(e))||void 0===o||!o)&&this.score.score(e)>=this.opts.scoreThresholds.publishThreshold&&r.add(e)})));const o=this.mesh.get(e);return null!=o&&o.size>0&&o.forEach((e=>{var i;t===e||null!==(i=null===n||void 0===n?void 0:n.has(e))&&void 0!==i&&i||r.add(e)})),r}selectPeersToPublish(e){const t=new Set,n={direct:0,floodsub:0,mesh:0,fanout:0},r=this.topics.get(e);if(null!=r)if(this.opts.floodPublish)r.forEach((e=>{this.direct.has(e)?(t.add(e),n.direct++):this.score.score(e)>=this.opts.scoreThresholds.publishThreshold&&(t.add(e),n.floodsub++)}));else{this.direct.forEach((e=>{r.has(e)&&(t.add(e),n.direct++)})),this.floodsubPeers.forEach((e=>{r.has(e)&&this.score.score(e)>=this.opts.scoreThresholds.publishThreshold&&(t.add(e),n.floodsub++)}));const i=this.mesh.get(e);if(null!=i&&i.size>0)i.forEach((e=>{t.add(e),n.mesh++}));else{const r=this.fanout.get(e);if(null!=r&&r.size>0)r.forEach((e=>{t.add(e),n.fanout++}));else{const r=this.getRandomGossipPeers(e,this.opts.D,(e=>this.score.score(e)>=this.opts.scoreThresholds.publishThreshold));r.size>0&&(this.fanout.set(e,r),r.forEach((e=>{t.add(e),n.fanout++})))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:t,tosendCount:n}}forwardMessage(e,t,n,r){var i;null!=n&&this.score.deliverMessage(n,e,t.topic);const o=this.selectPeersToForward(t.topic,n,r);o.forEach((e=>{this.sendRpc(e,{messages:[t]})})),null===(i=this.metrics)||void 0===i||i.onForwardMsg(t.topic,o.size)}async publish(e,t,n){var r,i,o;const s=Date.now(),a=null!=this.dataTransform?this.dataTransform.outboundTransform(e,t):t;if(null==this.publishConfig)throw Error("PublishError.Uninitialized");const{raw:c,msg:l}=await async function(e,t,n,r){switch(e.type){case r7.Signing:{const i={from:e.author.toBytes(),data:r,seqno:a9(8),topic:t,signature:void 0,key:void 0},o=(0,Ls.z)([O9,e7.Message.encode(i).finish()]);return i.signature=await e.privateKey.sign(o),i.key=e.key,{raw:i,msg:{type:"signed",from:e.author,data:n,sequenceNumber:BigInt("0x".concat((0,Au.B)(i.seqno,"base16"))),topic:t,signature:i.signature,key:i.key}}}case r7.Anonymous:return{raw:{from:void 0,data:r,seqno:void 0,topic:t,signature:void 0,key:void 0},msg:{type:"unsigned",data:n,topic:t}};default:throw new Error("Unreachable")}}(this.publishConfig,e,t,a),u=await this.msgIdFn(l),h=this.msgIdToStrFn(u),d=null!==(r=null===n||void 0===n?void 0:n.ignoreDuplicatePublishError)&&void 0!==r?r:this.opts.ignoreDuplicatePublishError;if(this.seenCa